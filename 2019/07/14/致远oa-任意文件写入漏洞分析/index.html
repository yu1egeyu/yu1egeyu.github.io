<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>致远oa 任意文件写入漏洞分析 | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  
  
  <meta name="keywords" content="Web">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="致远oa 任意文件写入漏洞分析"/>

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>致远oa 任意文件写入漏洞分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/07/14/致远oa-任意文件写入漏洞分析/" rel="bookmark">
        <time class="entry-date published" datetime="2019-07-14T12:03:24.000Z">
          2019-07-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><pre><code>之前写的文章了,一开始发到了其他地方,想了想还是copy一份到博客里增加点数量。</code></pre>
<p>​    前段时间致远oa爆出了任意文件写入漏洞, 当时广为流传的poc中数据包一些参数值被编码, 最初由于不知道加密方式编写poc不太方便,在拿到了致远oa的源码后对该漏洞进行了分析并编写poc。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>​    漏洞本身是一个很简单的漏洞,但是因为加密的原因稍微使利用麻烦了一点。</p>
<p>​    漏洞出现在 \WEB-INF\lib\seeyon-apps-common.jar!\com\seeyon\ctp\common\office\HtmlOfficeServlet.class,该类为一个Servlet。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>htmlofficeservlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/htmlofficeservlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>htmlofficeservlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        com.seeyon.ctp.common.office.HtmlOfficeServlet</span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    在web.xml中, 将/htmlofficeservlet映射到了该Servlet。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HtmlOfficeServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    ..............................</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        AppContext.initSystemEnvironmentContext(request, response);</span><br><span class="line">        HandWriteManager handWriteManager = (HandWriteManager)AppContext.getBean(<span class="string">&quot;handWriteManager&quot;</span>);</span><br><span class="line">        HtmlHandWriteManager htmlHandWriteManager = (HtmlHandWriteManager)AppContext.getBeanWithoutCache(<span class="string">&quot;htmlHandWriteManager&quot;</span>);</span><br><span class="line">        iMsgServer2000 msgObj = <span class="keyword">new</span> iMsgServer2000();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            handWriteManager.readVariant(request, msgObj);</span><br><span class="line">            <span class="keyword">if</span> (AppContext.currentUserId() == -<span class="number">1L</span>) &#123;</span><br><span class="line">                User user = handWriteManager.getCurrentUser(msgObj);</span><br><span class="line">                AppContext.putThreadContext(<span class="string">&quot;SESSION_CONTEXT_USERINFO_KEY&quot;</span>, user);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msgObj.SetMsgByName(<span class="string">&quot;CLIENTIP&quot;</span>, Strings.getRemoteAddr(request));</span><br><span class="line">            String option = msgObj.GetMsgByName(<span class="string">&quot;OPTION&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;LOADFILE&quot;</span>.equalsIgnoreCase(option)) &#123;</span><br><span class="line">                handWriteManager.LoadFile(msgObj);</span><br><span class="line">            .................................................</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;SAVEASIMG&quot;</span>.equalsIgnoreCase(option)) &#123;</span><br><span class="line">                String fileName = msgObj.GetMsgByName(<span class="string">&quot;FILENAME&quot;</span>);</span><br><span class="line">                String tempFolder = (<span class="keyword">new</span> File((<span class="keyword">new</span> File(<span class="string">&quot;&quot;</span>)).getAbsolutePath())).getParentFile().getParentFile().getPath();</span><br><span class="line">                String tempPath = tempFolder + <span class="string">&quot;/base/upload/taohongTemp&quot;</span>;</span><br><span class="line">                File folder = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">                <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">                    folder.mkdir();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                msgObj.MsgFileSave(tempPath + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>​    在该Servlet中, 存在一个SAVEASIMG操作, 从msgObj中获取到FILENAME后与tempPath拼接成最终保存路径,传递给MsgFileSave方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">MsgFileSave</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream var2 = <span class="keyword">new</span> FileOutputStream(var1);</span><br><span class="line">        var2.write(<span class="keyword">this</span>.FMsgFile);</span><br><span class="line">        var2.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">this</span>.FError = <span class="keyword">this</span>.FError + var3.toString();</span><br><span class="line">        System.out.println(var3.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在MsgFileSave方法当中, 直接使用拼接的路径与this.FMsgFile实现了文件保存。所以只要能够控制option、fileName和this.FMsgFile即可实现任意文件保存。这三个变量均来自iMsgServer2000实例对象, 在DBStep.jar包中能够找到iMsgServer2000类的代码。iMsgServer2000实例对象由handWriteManager.readVariant方法处理用户发送的request生成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readVariant</span><span class="params">(HttpServletRequest request, iMsgServer2000 msgObj)</span> </span>&#123;</span><br><span class="line">    msgObj.ReadPackage(request);</span><br><span class="line">    <span class="keyword">this</span>.fileId = Long.valueOf(msgObj.GetMsgByName(<span class="string">&quot;RECORDID&quot;</span>));</span><br><span class="line">    <span class="keyword">this</span>.createDate = Datetimes.parseDatetime(msgObj.GetMsgByName(<span class="string">&quot;CREATEDATE&quot;</span>));</span><br><span class="line">    String _originalFileId = msgObj.GetMsgByName(<span class="string">&quot;originalFileId&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.needClone = _originalFileId != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(_originalFileId.trim());</span><br><span class="line">    <span class="keyword">this</span>.needReadFile = Boolean.parseBoolean(msgObj.GetMsgByName(<span class="string">&quot;needReadFile&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.needClone) &#123;</span><br><span class="line">        String _originalCreateDate = msgObj.GetMsgByName(<span class="string">&quot;originalCreateDate&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.originalFileId = Long.valueOf(_originalFileId);</span><br><span class="line">        <span class="keyword">this</span>.originalCreateDate = Datetimes.parseDatetime(_originalCreateDate);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    接着调用iMsgServer2000#ReadPackage生成msgObj对象, 在生成msgObj对象后从该对象获取参数值, 可以看出msgObj中必须含有RECORDID、CREATEDATE参数并且需要符合它的数据类型, 在获取到参数值后有进行类型转换等操作, 如果获取不到参数值或获取到的参数值与相应的数据类型不匹配, 那么在进行类型转换时会出现异常进而退出流程。这两个参数值和最终的漏洞利用并无关系, 只是为了避免异常而必须设置, 在该方法中可以看到还获取了一些其他的参数值, 不过其他的就算不设置也不会发生异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] ReadPackage(HttpServletRequest var1) &#123;</span><br><span class="line">      <span class="keyword">int</span> var2 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var4 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.Charset = var1.getCharacterEncoding();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.Charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.Charset = var1.getHeader(<span class="string">&quot;charset&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.Charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.Charset = <span class="string">&quot;GB2312&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> var8 = var1.getContentLength();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">int</span> var7;</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">this</span>.FStream = <span class="keyword">new</span> <span class="keyword">byte</span>[var8]; var2 &lt; var8; var2 += var7) &#123;</span><br><span class="line">              var1.getInputStream();</span><br><span class="line">              var7 = var1.getInputStream().read(<span class="keyword">this</span>.FStream, var2, var8 - var2);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.FError == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.StreamToMsg();</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p>​    该方法中, 首先获取request中的Content-Length, 然后从request body中获取对应Content-Length字节数的内容保存到this.FStream中, 接着继续调用当前类中的StreamToMsg方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">StreamToMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span> var2 = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var4 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var5 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var6 = <span class="keyword">false</span>;</span><br><span class="line">    String var7 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String var8 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.FMd5Error = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span> var14 = <span class="number">0</span>;</span><br><span class="line">        String var1 = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var14, var2);</span><br><span class="line">        <span class="keyword">this</span>.FVersion = var1.substring(<span class="number">0</span>, <span class="number">15</span>); <span class="comment">// version</span></span><br><span class="line">        <span class="keyword">int</span> var11 = Integer.parseInt(var1.substring(<span class="number">16</span>, <span class="number">31</span>).trim());	<span class="comment">// 355</span></span><br><span class="line">        <span class="keyword">int</span> var12 = Integer.parseInt(var1.substring(<span class="number">32</span>, <span class="number">47</span>).trim());    <span class="comment">// 0  </span></span><br><span class="line">        <span class="keyword">int</span> var13 = Integer.parseInt(var1.substring(<span class="number">48</span>, <span class="number">63</span>).trim());    <span class="comment">// 666</span></span><br><span class="line">        <span class="keyword">this</span>.FFileSize = var13;		<span class="comment">//  var13 fileSize</span></span><br><span class="line">        <span class="keyword">int</span> var15 = var14 + var2;	<span class="comment">// 0 + 64 = 64</span></span><br><span class="line">        <span class="keyword">if</span> (var11 &gt; <span class="number">0</span>) &#123;			</span><br><span class="line">            <span class="keyword">this</span>.FMsgText = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, var11);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var15 += var11;</span><br><span class="line">        <span class="keyword">if</span> (var12 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.FError = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var15 += var12;</span><br><span class="line">        <span class="keyword">this</span>.FMsgFile = <span class="keyword">new</span> <span class="keyword">byte</span>[var13];</span><br><span class="line">        <span class="keyword">if</span> (var13 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; var13; ++var9) &#123;</span><br><span class="line">                <span class="keyword">this</span>.FMsgFile[var9] = <span class="keyword">this</span>.FStream[var9 + var15];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var15 += var13;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.FStream.length &gt;= var15 + <span class="number">32</span>) &#123;</span><br><span class="line">                var7 = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, <span class="number">32</span>);</span><br><span class="line">                var8 = <span class="keyword">this</span>.MD5Stream(<span class="keyword">this</span>.FMsgFile);</span><br><span class="line">                <span class="keyword">if</span> (var7.compareToIgnoreCase(var8) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.SetMsgByName(<span class="string">&quot;DBSTEP&quot;</span>, <span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.FMd5Error = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.FMd5Error = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>​    在该方法中获取流的前64字节保存到var1中, 前64字节类似报文头,前16字节为版本信息,16-31字节为FMsgText的大小(option、filename变量都是从FMsgText中获取),32到47字节为错误信息的大小 直接定义为0, 48到63字节为FMsgFile的大小。如果流中48到64字节转整后的内容(即var13变量)大于0, 那么会从 var15字节后开始读取内容保存到FMsgFile成员属性中, 从上面代码中可以看出var15 = var14 + var2 + var11 + var12 即跳过报文头和FMsgText,然后获取var13(即48到63字节内容转整)个字节保存到FMsgFile属性当中。</p>
<p>​    在获取到FMsgFile后, 后面有类似校验签名的一段代码, 校验的是FMsgFile内容的md5值是否与FMsgFile后32字节内容相等, 流传的poc中在最后也带了一段md5,不过可以看出如果整个流的长度如果不大于var15 + 32 (即FMsgFile后的内容不超过32字节)就不会进入该逻辑。不过就算进入该逻辑且签名错了也没有影响, 在其他操作的地方并没有管这签名的正确性。</p>
<p>​    option、fileName变量都是通过调用iMsgServer2000类的GetMsgByName方法获取参数值, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">GetMsgByName</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> var2 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">    String var4 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String var6 = var1.trim().concat(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> var7 = <span class="keyword">this</span>.FMsgText.indexOf(var6);</span><br><span class="line">    <span class="keyword">if</span> (var7 != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> var8 = <span class="keyword">this</span>.FMsgText.indexOf(<span class="string">&quot;\r\n&quot;</span>, var7 + <span class="number">1</span>);</span><br><span class="line">        var7 += var6.length();</span><br><span class="line">        <span class="keyword">if</span> (var8 != -<span class="number">1</span>) &#123;</span><br><span class="line">            String var5 = <span class="keyword">this</span>.FMsgText.substring(var7, var8);</span><br><span class="line">            var4 = <span class="keyword">this</span>.DecodeBase64(var5);</span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    GetMsgByName方法当中,  从FMsgText属性值中获取参数值, 获取到参数值为”=”与”\r\n”之间的内容, 获取到参数值后会调用当前对象的DecodeBase64方法进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">DecodeBase64</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        String var3 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] var8 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> var5 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] var7 = var1.getBytes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var5 &lt; var7.length) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt;= <span class="number">3</span>; ++var4) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (var5 &gt;= var7.length) &#123;</span><br><span class="line">                        var8[var4] = <span class="number">64</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">int</span> var6 = <span class="keyword">this</span>.TableBase64.indexOf(var7[var5]);</span><br><span class="line">                        <span class="keyword">if</span> (var6 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            var6 = <span class="number">65</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var8[var4] = (<span class="keyword">byte</span>)var6;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ++var5;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">0</span>] &amp; <span class="number">63</span>) &lt;&lt; <span class="number">2</span>) + ((var8[<span class="number">1</span>] &amp; <span class="number">48</span>) &gt;&gt; <span class="number">4</span>)));</span><br><span class="line">                <span class="keyword">if</span> (var8[<span class="number">2</span>] != <span class="number">64</span>) &#123;</span><br><span class="line">                    var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">1</span>] &amp; <span class="number">15</span>) &lt;&lt; <span class="number">4</span>) + ((var8[<span class="number">2</span>] &amp; <span class="number">60</span>) &gt;&gt; <span class="number">2</span>)));</span><br><span class="line">                    <span class="keyword">if</span> (var8[<span class="number">3</span>] != <span class="number">64</span>) &#123;</span><br><span class="line">                        var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">2</span>] &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) + (var8[<span class="number">3</span>] &amp; <span class="number">63</span>)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (StringIndexOutOfBoundsException var11) &#123;</span><br><span class="line">            <span class="keyword">this</span>.FError = <span class="keyword">this</span>.FError + var11.toString();</span><br><span class="line">            System.out.println(var11.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var3 = var2.toString(<span class="keyword">this</span>.Charset);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var10) &#123;</span><br><span class="line">            System.out.println(var10.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var3;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    DecodeBase64方法是原始base64decode方法的变异,  从EncodeBase64方法当中可以看出其实就是映射了一个转换表, 对应的转换表如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String TableBase64 = <span class="string">&quot;gx74KW1roM9qwzPFVOBLSlYaeyncdNbI=JfUCQRHtj2+Z05vshXi3GAEuT/m8Dpk6&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> String TableBase60 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>​    写个脚本实现该转换表即可加解密。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">STANDARD_ALPHABET = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#x27;</span></span><br><span class="line">CUSTOM_ALPHABET = <span class="string">&#x27;gx74KW1roM9qwzPFVOBLSlYaeyncdNbI=JfUCQRHtj2+Z05vshXi3GAEuT/m8Dpk6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    ENCODE_TRANS = string.maketrans(STANDARD_ALPHABET, CUSTOM_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(<span class="built_in">input</span>).translate(ENCODE_TRANS)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    DECODE_TRANS = string.maketrans(CUSTOM_ALPHABET, STANDARD_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(<span class="built_in">input</span>.translate(DECODE_TRANS))</span><br></pre></td></tr></table></figure>

<p>​    Python3.4 已经没有 string.maketrans() 方法, 所以3.4及后续版本需要稍微修改下代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    ENCODE_TRANS = <span class="built_in">input</span>.maketrans(STANDARD_ALPHABET, CUSTOM_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(base64.b64encode(<span class="built_in">input</span>.encode(<span class="string">&quot;utf-8&quot;</span>))).translate(ENCODE_TRANS)</span><br></pre></td></tr></table></figure>

<p>​    首先需要使option的参数值为SAVEASIMG才能进入保存文件逻辑,  加密后为S3WYOSWLBSGr。保存路径是由tempPath和fileName组成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String fileName = msgObj.GetMsgByName(<span class="string">&quot;FILENAME&quot;</span>);</span><br><span class="line">String tempFolder = (<span class="keyword">new</span> File((<span class="keyword">new</span> File(<span class="string">&quot;&quot;</span>)).getAbsolutePath())).getParentFile().getParentFile().getPath();</span><br><span class="line">String tempPath = tempFolder + <span class="string">&quot;/base/upload/taohongTemp&quot;</span>;</span><br><span class="line">File folder = <span class="keyword">new</span> File(tempPath);</span><br></pre></td></tr></table></figure>

<p>​    tempFolder中进行了两次目录穿越, 应该是为了防止用户把文件写入到web目录当中, 不过因为fileName完全未过滤可以按照默认配置补全路径最终实现保存文件到web目录当中。所以这里首先需要目录穿越出/base/upload/taohongTemp三层目录, 然后按照默认配置补全路径, 使fileName为<code>..\..\..\ApacheJetspeed\webapps\seeyon\abcd.txt</code>, 编码得到qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdeYMUy7T3brV6, 在算字节长度时, 需要算上\r\n。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/seeyon_1.png" alt="pic1"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/seeyon_2.png" alt="pic2"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>