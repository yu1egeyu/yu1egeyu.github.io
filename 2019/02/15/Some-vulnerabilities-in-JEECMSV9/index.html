<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Some vulnerabilities in JEECMSV9</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="shortcut icon" href="/img/favicon.png"><meta name="generator" content="Hexo 5.2.0"></head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">雨了个雨's blog</a></li><li class="menu-item"><a href="/blog/archives" class="menu-link">Archives</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">雨了个雨's blog</a></li><li class="menu-item"><a href="/blog/archives" class="menu-link">Archives</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li></ul></nav><div id="mobile-menu-toggle" class="toggle-menu"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Some vulnerabilities in JEECMSV9</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title">发表于: </span>2019-02-15</p><p class="meta-item meta-category"></p></div><div class="article-content"><p>之前遇到了一个JEECMS大概看了一下,  测试版本JEECMSV9.3</p>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>/src/main/java/com/jeecms/cms/action/member/UeditorAct.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/ueditor/getRemoteImage.jspx&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getRemoteImage</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	String url = request.getParameter(<span class="string">&quot;upfile&quot;</span>);</span><br><span class="line">	CmsSite site=CmsUtils.getSite(request);</span><br><span class="line">	JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">	String[] arr = url.split(UE_SEPARATE_UE);</span><br><span class="line">	String[] outSrc = <span class="keyword">new</span> String[arr.length];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">		outSrc[i]=saveRemoteImage(arr[i], site.getContextPath(), site.getUploadPath());</span><br><span class="line">	&#125;</span><br><span class="line">	String outstr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outSrc.length; i++) &#123;</span><br><span class="line">		outstr += outSrc[i] + UE_SEPARATE_UE;</span><br><span class="line">	&#125;</span><br><span class="line">	outstr = outstr.substring(<span class="number">0</span>, outstr.lastIndexOf(UE_SEPARATE_UE));</span><br><span class="line">	json.put(URL, outstr);</span><br><span class="line">	json.put(SRC_URL, url);</span><br><span class="line">	json.put(TIP, LocalizedMessages.getRemoteImageSuccessSpecified(request));</span><br><span class="line">	ResponseUtils.renderJson(response, json.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在接受了用户传递过来的url之后, 带入saveRemoteImage方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span>  String <span class="title">saveRemoteImage</span><span class="params">(String imgUrl,String contextPath,String uploadPath)</span> </span>&#123;</span><br><span class="line">	HttpClientBuilder httpClientBuilder = HttpClientBuilder.create(); </span><br><span class="line">    CloseableHttpClient client = httpClientBuilder.build();  </span><br><span class="line">	String outFileName=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(endWithImg(imgUrl))&#123;</span><br><span class="line">			HttpGet httpget = <span class="keyword">new</span> HttpGet(<span class="keyword">new</span> URI(imgUrl));</span><br><span class="line">			HttpResponse response = client.execute(httpget);</span><br><span class="line">			InputStream is = <span class="keyword">null</span>;</span><br><span class="line">			OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">			HttpEntity entity = <span class="keyword">null</span>;</span><br><span class="line">			entity = response.getEntity();</span><br><span class="line">			is = entity.getContent();</span><br><span class="line">			outFileName=UploadUtils.generateFilename(uploadPath, FileNameUtils.getFileSufix(imgUrl));</span><br><span class="line">			os = <span class="keyword">new</span> FileOutputStream(realPathResolver.get(outFileName));</span><br><span class="line">			IOUtils.copy(is, os);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>在saveRemoteImage方法当中,  如果通过了endWithImg方法的检测,就直接发起请求, 并且把请求到的结果输出到文件当中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">endWithImg</span><span class="params">(String imgUrl)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(StringUtils.isNotBlank(imgUrl)&amp;&amp;(imgUrl.endsWith(<span class="string">&quot;.bmp&quot;</span>)||imgUrl.endsWith(<span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">			||imgUrl.endsWith(<span class="string">&quot;.jpeg&quot;</span>)||imgUrl.endsWith(<span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">			||imgUrl.endsWith(<span class="string">&quot;.png&quot;</span>)))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>endWithImg的检测比较简单,  绕过也比较简单加个?.jpg就可以绕过了。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_1.jpg" alt="-w976"><br>不过本地测试时, 访问这个jpg文件的结果却是404.<br>首先来看看保存访问结果的文件的文件名生成方法, 是包含一个月份目录的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateFilename</span><span class="params">(String path, String ext)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> path + MONTH_FORMAT.format(<span class="keyword">new</span> Date())</span><br><span class="line">	+ RandomStringUtils.random(<span class="number">4</span>, Num62.N36_CHARS) + <span class="string">&quot;.&quot;</span> + ext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果类似为 /u/cms/www/201902/15002619t400.jpg<br>而在jeecms的默认源码当中, 是不存在201902这个目录的。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_2.jpg" alt="-w539"></p>
<p>并且在saveRemoteImage方法当中, 并没有”判断这个目录存不存在,如果不存在的话就创建该目录”这种逻辑。<br>在FileOutputStream时, 如果目录是不存在的话, 会出异常, 所以这里的文件并没有保存上。<br>要想保存上这个文件, 首先还是得创建这个目录。<br>在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/ueditor/upload.jspx&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">upload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="meta">@RequestParam(value = &quot;Type&quot;, required = false)</span> String typeStr,</span></span></span><br><span class="line"><span class="function"><span class="params">		Boolean mark,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	responseInit(response);</span><br><span class="line">	<span class="keyword">if</span> (Utils.isEmpty(typeStr)) &#123;</span><br><span class="line">		typeStr = <span class="string">&quot;File&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(mark==<span class="keyword">null</span>)&#123;</span><br><span class="line">		mark=<span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">	JSONObject ob = validateUpload(request, typeStr);</span><br><span class="line">	<span class="keyword">if</span> (ob == <span class="keyword">null</span>) &#123;</span><br><span class="line">		json = doUpload(request, typeStr, mark);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		json = ob;</span><br><span class="line">	&#125;</span><br><span class="line">	ResponseUtils.renderJson(response, json.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接查看调用的doUpload方法,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JSONObject <span class="title">doUpload</span><span class="params">(HttpServletRequest request, String typeStr,Boolean mark)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">					fileUrl = fileRepository.storeByExt(site.getUploadPath(),</span><br><span class="line">							ext, uplFile);</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>
<p>继续查看storeByExt方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">storeByExt</span><span class="params">(String path, String ext, MultipartFile file)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">//String filename = UploadUtils.generateFilename(path, ext);</span></span><br><span class="line">	<span class="comment">//File dest = new File(getRealPath(filename));</span></span><br><span class="line">	String fileName=UploadUtils.generateRamdonFilename(ext);</span><br><span class="line">	String fileUrl =path+fileName;</span><br><span class="line">	File dest = <span class="keyword">new</span> File(getRealPath(path),fileName);</span><br><span class="line">	dest = UploadUtils.getUniqueFile(dest);</span><br><span class="line">	store(file, dest);</span><br><span class="line">	<span class="keyword">return</span> fileUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件名和目录的生成方法和saveRemoteImage时使用的方法相同,然后调用了store方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(MultipartFile file, File dest)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		UploadUtils.checkDirAndCreate(dest.getParentFile());</span><br><span class="line">		file.transferTo(dest);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		log.error(<span class="string">&quot;Transfer file error when upload file&quot;</span>, e);</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkDirAndCreate</span><span class="params">(File dir)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!dir.exists())</span><br><span class="line">		dir.mkdirs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到虽然在下载远程图片的功能中, 没有”如果不存在这个日期目录就创建该目录”这个逻辑, 但是在上传的时候存在这个逻辑。 所以可以先通过上传, 创建了该目录之后, 再继续给SSRF利用。<br>上传这个功能, 需要登录之后才能正常使用。<br>因为在doupload方法之前,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JSONObject ob = validateUpload(request, typeStr);</span><br><span class="line">		<span class="keyword">if</span> (ob == <span class="keyword">null</span>) &#123;</span><br><span class="line">			json = doUpload(request, typeStr, mark);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			json = ob;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>经过了validateUpload方法, 在该方法当中 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CmsUser user = CmsUtils.getUser(request);</span><br><span class="line"><span class="comment">// 非允许的后缀</span></span><br><span class="line"><span class="keyword">if</span> (!user.isAllowSuffix(ext)) &#123;</span><br><span class="line">	result.put(STATE, LocalizedMessages</span><br><span class="line">			.getInvalidFileSuffixSpecified(request));</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是未登录状态, user为null 接下来就会出现空指针异常。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_3.jpg" alt="-w1412"><br>上传之后, 就成功创建了目录。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_4.jpg" alt="-w587"></p>
<p>再SSRF<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_5.jpg" alt="-w1029"><br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_6.jpg" alt="-w744"></p>
<p>不过发起请求的httpClientBuilder, 仅支持HTTP/HTTPS协议。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_7.jpg" alt="-w770"></p>
<h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><p>JEECMS中存在一些可以上传任意文件的点, 只举例一个<br>/src/main/java/com/jeecms/cms/action/member/SwfUploadAct.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/member/o_swfAttachsUpload.jspx&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swfAttachsUpload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		String root,</span></span></span><br><span class="line"><span class="function"><span class="params">		Integer uploadNum,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="meta">@RequestParam(value = &quot;Filedata&quot;, required = false)</span> MultipartFile file,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">		ModelMap model)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.swfAttachsUpload(root, uploadNum, file, request, response, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了父类的swfAttachsUpload方法, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">swfAttachsUpload</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		String root,</span></span></span><br><span class="line"><span class="function"><span class="params">		Integer uploadNum,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="meta">@RequestParam(value = &quot;Filedata&quot;, required = false)</span> MultipartFile file,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">		ModelMap model)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	JSONObject data=<span class="keyword">new</span> JSONObject();</span><br><span class="line">	WebCoreErrors errors = validateUpload( file, request);</span><br><span class="line">	<span class="keyword">if</span> (errors.hasErrors()) &#123;</span><br><span class="line">		data.put(<span class="string">&quot;error&quot;</span>, errors.getErrors().get(<span class="number">0</span>));</span><br><span class="line">		ResponseUtils.renderJson(response, data.toString());</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		CmsSite site = CmsUtils.getSite(request);</span><br><span class="line">		String ctx = request.getContextPath();</span><br><span class="line">		String origName = file.getOriginalFilename();</span><br><span class="line">		String ext = FilenameUtils.getExtension(origName).toLowerCase(</span><br><span class="line">				Locale.ENGLISH);</span><br><span class="line">		<span class="comment">// TODO 检查允许上传的后缀</span></span><br><span class="line">		String fileUrl=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (site.getConfig().getUploadToDb()) &#123;</span><br><span class="line">				String dbFilePath = site.getConfig().getDbFileUri();</span><br><span class="line">				fileUrl = dbFileMng.storeByExt(site.getUploadPath(), ext, file</span><br><span class="line">						.getInputStream());</span><br><span class="line">				<span class="comment">// 加上访问地址</span></span><br><span class="line">				fileUrl = request.getContextPath() + dbFilePath + fileUrl;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (site.getUploadFtp() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				Ftp ftp = site.getUploadFtp();</span><br><span class="line">				String ftpUrl = ftp.getUrl();</span><br><span class="line">				fileUrl = ftp.storeByExt(site.getUploadPath(), ext, file</span><br><span class="line">						.getInputStream());</span><br><span class="line">				<span class="comment">// 加上url前缀</span></span><br><span class="line">				fileUrl = ftpUrl + fileUrl;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span> (site.getUploadOss() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				CmsOss oss = site.getUploadOss();</span><br><span class="line">				fileUrl = oss.storeByExt(site.getUploadPath(), ext, file.getInputStream());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				fileUrl = fileRepository.storeByExt(site.getUploadPath(), ext,</span><br><span class="line">						file);</span><br><span class="line">				<span class="comment">// 加上部署路径</span></span><br><span class="line">				fileUrl = ctx + fileUrl;</span><br><span class="line">			&#125;</span><br><span class="line">			cmsUserMng.updateUploadSize(CmsUtils.getUserId(request), Integer.parseInt(String.valueOf(file.getSize()/<span class="number">1024</span>)));</span><br><span class="line">			fileMng.saveFileByPath(fileUrl, origName, <span class="keyword">false</span>);</span><br><span class="line">			model.addAttribute(<span class="string">&quot;attachmentPath&quot;</span>, fileUrl);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">			model.addAttribute(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			model.addAttribute(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		data.put(<span class="string">&quot;attachUrl&quot;</span>, fileUrl);</span><br><span class="line">		data.put(<span class="string">&quot;attachName&quot;</span>, origName);</span><br><span class="line">		ResponseUtils.renderJson(response, data.toString());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中, 上传时没有检查文件的后缀,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_8.jpg" alt="-w396"></p>
<p>从TODO注释中也能看出来, 检查允许上传的后缀这个功能还未实现就直接上线了。</p>
<p>不过在jeecms中上传的jsp,jspx文件并不能被访问到。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JeeCmsFront<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jspx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JeeCmsFront<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>jsp和jspx文件都经过了JeeCmsFront,</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JeeCmsFront<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">			/WEB-INF/config/jeecms-servlet-front.xml</span><br><span class="line">			/WEB-INF/config/plug/**/*-servlet-front-action.xml</span><br><span class="line">		<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>jsp和jspx文件都会经过org.springframework.web.servlet.DispatcherServlet, 上传上去的jsp文件肯定是没有对应的映射的 就直接404了。<br>这里得结合一些其他的点进行利用,<br>/src/main/java/com/jeecms/cms/action/front/CsiCustomAct.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/csi_custom*.jspx&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">custom</span><span class="params">(String tpl, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">		HttpServletResponse response, ModelMap model)</span> </span>&#123;</span><br><span class="line">	log.debug(<span class="string">&quot;visit csi custom template: &#123;&#125;&quot;</span>, tpl);</span><br><span class="line">	CmsSite site = CmsUtils.getSite(request);</span><br><span class="line">	<span class="keyword">if</span>(StringUtils.isNotBlank(tpl))&#123;</span><br><span class="line">		<span class="comment">// 将request中所有参数保存至model中。</span></span><br><span class="line">		model.putAll(RequestUtils.getQueryParams(request));</span><br><span class="line">		FrontUtils.frontData(request, model, site);</span><br><span class="line">		FrontUtils.frontPageData(request, model);</span><br><span class="line">		<span class="keyword">return</span> FrontUtils.getTplPath(site.getSolutionPath(), TPLDIR_CSI_CUSTOM,</span><br><span class="line">				tpl);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> FrontUtils.pageNotFound(request, response, model);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到将用户传递过来的tpl变量直接带入了getTplPath方法, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTplPath</span><span class="params">(String solution, String dir, String name)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> solution + <span class="string">&quot;/&quot;</span> + dir + <span class="string">&quot;/&quot;</span> + name + TPL_SUFFIX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可控的tpl变量直接拼接进了模板路径当中, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TPL_SUFFIX = <span class="string">&quot;.html&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>默认的模板后缀为.html, 高版本jdk当中已经不再能够截断, 所以这里先通过刚才的任意文件上传一个.html文件, 然后控制模板文件路径为自己上传的模板文件进行SSTI.</p>
<p>因为jeecms的模板引擎使用的是freemarker, 一开始以为直接用freemarker的SSTI就能rce了, 但是测试的时候失败了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">#assign</span> <span class="attr">ex</span>=<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="attr">new</span>()&gt;</span> $&#123; ex(&quot;id&quot;) &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_9.jpg" alt="-w1344"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_10.jpg" alt="-w770"></p>
<p>在新版本freemarker中, 多了一个TemplateClassResolver.SAFER_RESOLVER配置。</p>
<blockquote>
<p>TemplateClassResolver.SAFER_RESOLVER now disallows creating freemarker.template.utility.JythonRuntime and freemarker.template.utility.Execute. This change affects the behavior of the new built-in if FreeMarker was configured to use SAFER_RESOLVER, which is not the default until 2.4 and is hence improbable.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TemplateClassResolver SAFER_RESOLVER = <span class="keyword">new</span> TemplateClassResolver() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">resolve</span><span class="params">(String className, Environment env, Template template)</span> <span class="keyword">throws</span> TemplateException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!className.equals(ObjectConstructor.class.getName()) &amp;&amp; !className.equals(Execute.class.getName()) &amp;&amp; !className.equals(<span class="string">&quot;freemarker.template.utility.JythonRuntime&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ClassUtil.forName(className);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> _MiscTemplateException(var5, env);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> MessageUtil.newInstantiatingClassNotAllowedException(className, env);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用了TemplateClassResolver.SAFER_RESOLVER, 就不允许再调用freemarker.template.utility.Execute, freemarker.template.utility.ObjectConstructor以及freemarker.template.utility.JythonRuntime。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstructorFunction</span><span class="params">(String classname, Environment env, Template template)</span> <span class="keyword">throws</span> TemplateException </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.env = env;</span><br><span class="line">            <span class="keyword">this</span>.cl = env.getNewBuiltinClassResolver().resolve(classname, env, template);</span><br><span class="line">            <span class="keyword">if</span> (!TemplateModel.class.isAssignableFrom(<span class="keyword">this</span>.cl)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> _MiscTemplateException(NewBI.<span class="keyword">this</span>, env, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;Class &quot;</span>, <span class="keyword">this</span>.cl.getName(), <span class="string">&quot; does not implement freemarker.template.TemplateModel&quot;</span>&#125;);</span><br><span class="line">            &#125; </span><br></pre></td></tr></table></figure>

<p>并且允许调用的类只允许为实现了freemarker.template.TemplateModel接口的类, 大概看了下实现了该接口的类, 除了不允许使用的三个类,没有找到其他能利用的类, 就只有放弃RCE了。</p>
<p>从文档中可以看出, freemarker从2.4版本以后才默认打开TemplateClassResolver.SAFER_RESOLVER, jeecms使用的版本为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">freemarker.version</span>&gt;</span>2.3.25-incubating<span class="tag">&lt;/<span class="name">freemarker.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然没有默认打开该配置, 但是JEECMS中的freemarker手动打开了TemplateClassResolver.SAFER_RESOLVER,所以SSTI没办法RCE了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.initApplicationContext();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (getConfiguration() == <span class="keyword">null</span>) &#123;</span><br><span class="line">		FreeMarkerConfig config = autodetectConfiguration();</span><br><span class="line">		Configuration configuration=config.getConfiguration();</span><br><span class="line">		configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);</span><br><span class="line">		setConfiguration(configuration);</span><br><span class="line">	&#125;</span><br><span class="line">	checkTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在TemplateClassResolver.SAFER_RESOLVER的限制下， SSTI也就只能读读文件了, 并且只能读取WEB目录下的文件。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_11.jpg" alt="-w1222"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_12.jpg" alt="-w834"></p>
<h2 id="反序列"><a href="#反序列" class="headerlink" title="反序列"></a>反序列</h2><p>JEECMS中使用了shiro, 版本为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shiro.version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">shiro.version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>老版本shiro(1.2.4)曾爆过一个反序列,<br>看了一下maven下载的1.4.0的shiro包, 依然存在反序列的点<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_13.jpg" alt="-w899"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PrincipalCollection <span class="title">convertBytesToPrincipals</span><span class="params">(<span class="keyword">byte</span>[] bytes, SubjectContext subjectContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bytes = <span class="keyword">this</span>.decrypt(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.deserialize(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过decrypt, aes解密之后就开始反序列了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PrincipalCollection <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] serializedIdentity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (PrincipalCollection)<span class="keyword">this</span>.getSerializer().deserialize(serializedIdentity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (serialized == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">&quot;argument cannot be null.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(bais);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ClassResolvingObjectInputStream(bis);</span><br><span class="line">            T deserialized = ois.readObject();</span><br><span class="line">            ois.close();</span><br></pre></td></tr></table></figure>

<p>高版本shiro只是没有在AbstractRememberMeManager中硬编码了AES的key, 但是在JEECMS当中, 又再次硬编码了AES的key<br>/src/main/webapp/WEB-INF/config/shiro-context.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rememberMe管理器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rememberMeManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.CookieRememberMeManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cipherKey&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(org.apache.shiro.codec.Base64).decode(&#x27;4AvVhmFLUs0KTA3Kprsdag==&#x27;)&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cookie&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;rememberMeCookie&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接使用这个AES key就能打反序列了。<br>看了下JEECMS的jar包, 打反序列版本比较合适的为C3P0的jar包。<br>JEECMS的C3P0包版本和ysoserial自带的C3P0包版本相同。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c3p0.version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">c3p0.version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>一开始不知道C3P0这gadget到底是咋用, 看了下代码。<br>/com/mchange/c3p0/0.9.5.2/c3p0-0.9.5.2.jar!/com/mchange/v2/c3p0/impl/PoolBackedDataSourceBase.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">short</span> version = ois.readShort();</span><br><span class="line">    <span class="keyword">switch</span>(version) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Object o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>继续调用getObject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext var1;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.env == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext(<span class="keyword">this</span>.env);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Context var2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.contextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var2 = (Context)var1.lookup(<span class="keyword">this</span>.contextName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ReferenceableUtils.referenceToObject(<span class="keyword">this</span>.reference, <span class="keyword">this</span>.name, var2, <span class="keyword">this</span>.env);</span><br></pre></td></tr></table></figure>
<p>调用referenceToObject方法,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">referenceToObject</span><span class="params">(Reference var0, Name var1, Context var2, Hashtable var3)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String var4 = var0.getFactoryClassName();</span><br><span class="line">        String var11 = var0.getFactoryClassLocation();</span><br><span class="line">        ClassLoader var6 = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var6 = ReferenceableUtils.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object var7;</span><br><span class="line">        <span class="keyword">if</span> (var11 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var7 = var6;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            URL var8 = <span class="keyword">new</span> URL(var11);</span><br><span class="line">            var7 = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;var8&#125;, var6);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class var12 = Class.forName(var4, <span class="keyword">true</span>, (ClassLoader)var7);</span><br><span class="line">        ObjectFactory var9 = (ObjectFactory)var12.newInstance();</span><br><span class="line">        <span class="keyword">return</span> var9.getObjectInstance(var0, var1, var2, var3);</span><br></pre></td></tr></table></figure>
<p>通过URLClassLoader获取远程jar包中的类, 然后classforname后, newInstance实例化该类， 调用构造方法。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_14.jpg" alt="-w867"></p>
<p>不过在打反序列的时候, 出现了suid错误<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_15.jpg" alt="-w966"></p>
<p>明明yso的C3P0版本和jeecms的一样, 但是还是提示suid错误。</p>
<p>因为jeecms中依赖了quartz-scheduler包, 这个包又依赖了0.9.1.1的c3p0. 反序列的时候调用的是老版本的C3P0的包。(这里我也不太懂我本地为什么调用的是老版本的包, 按理maven解决依赖冲突时 优先最短路径优先, 应该调用的是0.9.5.2包。并且高版本的C3P0依赖在前,有大哥懂为啥调用老版本的jar包的麻烦教我一手。)</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_16.jpg" alt="-w476"></p>
<p>这时候ysoserial的C3P0版本和jeecms的版本就不相同了 suid就不同了, 这里直接修改一下ysoserial的C3P0版本,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_17.jpg" alt="-w488"><br>text变量的字符串为ysoserial生成的C3P0 payload base64编码,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_18.jpg" alt="-w715"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_19.jpg" alt="-w1399"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jeecms_20.jpg" alt="-w1136"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1.<a target="_blank" rel="noopener" href="https://freemarker.apache.org/docs/versions_2_3_19.html">https://freemarker.apache.org/docs/versions_2_3_19.html</a><br>2.<a target="_blank" rel="noopener" href="https://portswigger.net/blog/server-side-template-injection">https://portswigger.net/blog/server-side-template-injection</a></p>
</div></article><div id="base-discus"></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>雨了个雨 Using </span><a target="_blank" rel="noopener" href="https://github.com/chuguixin/Simple"><span>Simple</span></a><span> Presents For You.</span></div></footer><div class="dom-ready">
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="/js/base.js"></script>
</div></body></html>