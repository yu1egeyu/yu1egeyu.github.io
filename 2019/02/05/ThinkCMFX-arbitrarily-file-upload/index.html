<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ThinkCMFX arbitrarily file upload | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  
  
  <meta name="keywords" content="Web">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="ThinkCMFX arbitrarily file upload"/>

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>ThinkCMFX arbitrarily file upload</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/02/05/ThinkCMFX-arbitrarily-file-upload/" rel="bookmark">
        <time class="entry-date published" datetime="2019-02-05T08:57:11.000Z">
          2019-02-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <style>
    code {
        white-space: normal;
        word-break: break-all;
    }
</style>

<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>ThinkCMF存在两个版本, ThinkCMF基于Thinkphp5开发, ThinkCMFX基于Thinkphp3开发。 好久以前做测试的时候遇到了CMFX, 就下载了一份看了一下。还找到了一些SQL注入和其他的漏洞, 不过好像其他的都看到有人发过了, 这个文件上传还没看到有人谈过。<br><a target="_blank" rel="noopener" href="https://github.com/thinkcmf/cmfx">https://github.com/thinkcmf/cmfx</a></p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>在/application/Asset/Controller/UeditorController.class.php中,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_initialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	$adminid=sp_get_current_admin_id();</span><br><span class="line">	$userid=sp_get_current_userid();</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($adminid) &amp;&amp; <span class="keyword">empty</span>($userid))&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">&quot;非法上传！&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个Controller的”构造方法”中, 判断了是否登录, 可以看出这个是普通会员和管理员都可以使用的一个控制器。 Thinkcmfx默认是支持普通用户注册的, 所以没啥影响。</p>
<p>在UeditorController中的upload方法中,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	error_reporting(E_ERROR);</span><br><span class="line">	header(<span class="string">&quot;Content-Type: application/json; charset=utf-8&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	$action = $_GET[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> ($action) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;config&#x27;</span>:</span><br><span class="line">			$result = <span class="keyword">$this</span>-&gt;_ueditor_config();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">/* 上传图片 */</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;uploadimage&#x27;</span>:</span><br><span class="line">			<span class="comment">/* 上传涂鸦 */</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;uploadscrawl&#x27;</span>:</span><br><span class="line">			$result = <span class="keyword">$this</span>-&gt;_ueditor_upload(<span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">/* 上传视频 */</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;uploadvideo&#x27;</span>:</span><br><span class="line">			$result = <span class="keyword">$this</span>-&gt;_ueditor_upload(<span class="string">&#x27;video&#x27;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">/* 上传文件 */</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;uploadfile&#x27;</span>:</span><br><span class="line">			$result = <span class="keyword">$this</span>-&gt;_ueditor_upload(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>这里随便选择一个分支跟进就行, 这里选择uploadfile.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_ueditor_upload</span>(<span class="params">$filetype=<span class="string">&#x27;image&#x27;</span></span>)</span>&#123;</span><br><span class="line">    $upload_setting=sp_get_upload_setting();</span><br><span class="line">    </span><br><span class="line">    $file_extension=sp_get_file_extension($_FILES[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    $upload_max_filesize=$upload_setting[<span class="string">&#x27;upload_max_filesize&#x27;</span>][$file_extension];</span><br><span class="line">    $upload_max_filesize=<span class="keyword">empty</span>($upload_max_filesize)?<span class="number">2097152</span>:$upload_max_filesize;<span class="comment">//默认2M</span></span><br><span class="line">    </span><br><span class="line">    $allowed_exts=explode(<span class="string">&#x27;,&#x27;</span>, $upload_setting[$filetype]);</span><br><span class="line">    </span><br><span class="line">	$date=date(<span class="string">&quot;Ymd&quot;</span>);</span><br><span class="line">	<span class="comment">//上传处理类</span></span><br><span class="line">	$config=<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;rootPath&#x27;</span> =&gt; <span class="string">&#x27;./&#x27;</span>. C(<span class="string">&quot;UPLOADPATH&quot;</span>),</span><br><span class="line">			<span class="string">&#x27;savePath&#x27;</span> =&gt; <span class="string">&quot;ueditor/<span class="subst">$date</span>/&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;maxSize&#x27;</span> =&gt; $upload_max_filesize,<span class="comment">//10M</span></span><br><span class="line">			<span class="string">&#x27;saveName&#x27;</span>   =&gt;    <span class="keyword">array</span>(<span class="string">&#x27;uniqid&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">			<span class="string">&#x27;exts&#x27;</span>       =&gt;    $allowed_exts,</span><br><span class="line">			<span class="string">&#x27;autoSub&#x27;</span>    =&gt;    <span class="literal">false</span>,</span><br><span class="line">	);</span><br><span class="line">	</span><br><span class="line">	$upload = <span class="keyword">new</span> \Think\Upload($config);<span class="comment">//</span></span><br><span class="line">	</span><br><span class="line">	$file = $title = $oriName = $state =<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">	$info=$upload-&gt;upload();</span><br></pre></td></tr></table></figure>

<p>这里通过<code>$allowed_exts=explode(&#39;,&#39;,$upload_setting[$filetype])</code> 来获取允许上传的后缀。</p>
<p><code>$upload_setting=sp_get_upload_setting();</code><br>upload_setting通过sp_get_upload_setting方法来获取上传的配置。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sp_get_upload_setting</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $upload_setting=sp_get_option(<span class="string">&#x27;upload_setting&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($upload_setting))&#123;</span><br><span class="line">        $upload_setting = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;image&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;upload_max_filesize&#x27;</span> =&gt; <span class="string">&#x27;10240&#x27;</span>,<span class="comment">//单位KB</span></span><br><span class="line">                <span class="string">&#x27;extensions&#x27;</span> =&gt; <span class="string">&#x27;jpg,jpeg,png,gif,bmp4&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&#x27;video&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;upload_max_filesize&#x27;</span> =&gt; <span class="string">&#x27;10240&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;extensions&#x27;</span> =&gt; <span class="string">&#x27;mp4,avi,wmv,rm,rmvb,mkv&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&#x27;audio&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;upload_max_filesize&#x27;</span> =&gt; <span class="string">&#x27;10240&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;extensions&#x27;</span> =&gt; <span class="string">&#x27;mp3,wma,wav&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;upload_max_filesize&#x27;</span> =&gt; <span class="string">&#x27;10240&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;extensions&#x27;</span> =&gt; <span class="string">&#x27;txt,pdf,doc,docx,xls,xlsx,ppt,pptx,zip,rar&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($upload_setting[<span class="string">&#x27;upload_max_filesize&#x27;</span>]))&#123;</span><br><span class="line">        $upload_max_filesize_setting=<span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> ($upload_setting <span class="keyword">as</span> $setting)&#123;</span><br><span class="line">            $extensions=explode(<span class="string">&#x27;,&#x27;</span>, trim($setting[<span class="string">&#x27;extensions&#x27;</span>]));</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>($extensions))&#123;</span><br><span class="line">                $upload_max_filesize=intval($setting[<span class="string">&#x27;upload_max_filesize&#x27;</span>])*<span class="number">1024</span>;<span class="comment">//转化成KB</span></span><br><span class="line">                <span class="keyword">foreach</span> ($extensions <span class="keyword">as</span> $ext)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(!<span class="keyword">isset</span>($upload_max_filesize_setting[$ext]) || $upload_max_filesize&gt;$upload_max_filesize_setting[$ext]*<span class="number">1024</span>)&#123;</span><br><span class="line">                        $upload_max_filesize_setting[$ext]=$upload_max_filesize;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload_setting[<span class="string">&#x27;upload_max_filesize&#x27;</span>]=$upload_max_filesize_setting;</span><br><span class="line">        F(<span class="string">&quot;cmf_system_options_upload_setting&quot;</span>,$upload_setting);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $upload_setting=F(<span class="string">&quot;cmf_system_options_upload_setting&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $upload_setting;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先尝试通过sp_get_option方法获取文件上传的配置信息, 如果sp_get_option方法获取配置信息失败的话会返回一个默认的配置。<br>如果sp_get_option获取配置信息成功, 最后会再一次的调用F(“cmf_system_options_upload_setting”)来得到$upload_setting, 此次调用F方法是直接从缓存中获取配置信息了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sp_get_option</span>(<span class="params">$key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!is_string($key) || <span class="keyword">empty</span>($key))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $option_value=F(<span class="string">&quot;cmf_system_options_&quot;</span>.$key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($option_value))&#123;</span><br><span class="line">        $options_model = M(<span class="string">&quot;Options&quot;</span>);</span><br><span class="line">        $option_value = $options_model-&gt;where(<span class="keyword">array</span>(<span class="string">&#x27;option_name&#x27;</span>=&gt;$key))-&gt;getField(<span class="string">&#x27;option_value&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>($option_value)&#123;</span><br><span class="line">            $option_value = json_decode($option_value,<span class="literal">true</span>);</span><br><span class="line">            F(<span class="string">&quot;cmf_system_options_&quot;</span>.$key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $option_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>F方法尝试读上传的配置文件, 然后反序列该文件内容拿到上传配置信息。<br>从filename可以看出读取的配置文件为/data/runtime/Data/cmf_system_options_upload_setting.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params">$name, $value=<span class="string">&#x27;&#x27;</span>, $path=DATA_PATH</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> $_cache  =   <span class="keyword">array</span>();</span><br><span class="line">    $filename       =   $path . $name . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> !== $value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($value)) &#123;</span><br><span class="line">            <span class="comment">// 删除缓存</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">false</span> !== strpos($name,<span class="string">&#x27;*&#x27;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// TODO </span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">unset</span>($_cache[$name]);</span><br><span class="line">                <span class="keyword">return</span> Think\Storage::unlink($filename,<span class="string">&#x27;F&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Think\Storage::put($filename,serialize($value),<span class="string">&#x27;F&#x27;</span>);</span><br><span class="line">            <span class="comment">// 缓存数据</span></span><br><span class="line">            $_cache[$name]  =   $value;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取缓存数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_cache[$name]))</span><br><span class="line">        <span class="keyword">return</span> $_cache[$name];</span><br><span class="line">    <span class="keyword">if</span> (Think\Storage::has($filename,<span class="string">&#x27;F&#x27;</span>))&#123;</span><br><span class="line">        $value      =   unserialize(Think\Storage::read($filename,<span class="string">&#x27;F&#x27;</span>));</span><br><span class="line">        $_cache[$name]  =   $value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $value          =   <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认/data/runtime/Data/cmf_system_options_upload_setting.php的文件内容,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:5:&#123;s:5:&quot;image&quot;;a:2:&#123;s:19:&quot;upload_max_filesize&quot;;s:5:&quot;10240&quot;;s:10:&quot;extensions&quot;;s:21:&quot;jpg,jpeg,png,gif,bmp4&quot;;&#125;s:5:&quot;video&quot;;a:2:&#123;s:19:&quot;upload_max_filesize&quot;;s:5:&quot;10240&quot;;s:10:&quot;extensions&quot;;s:23:&quot;mp4,avi,wmv,rm,rmvb,mkv&quot;;&#125;s:5:&quot;audio&quot;;a:2:&#123;s:19:&quot;upload_max_filesize&quot;;s:5:&quot;10240&quot;;s:10:&quot;extensions&quot;;s:11:&quot;mp3,wma,wav&quot;;&#125;s:4:&quot;file&quot;;a:2:&#123;s:19:&quot;upload_max_filesize&quot;;s:5:&quot;10240&quot;;s:10:&quot;extensions&quot;;s:42:&quot;txt,pdf,doc,docx,xls,xlsx,ppt,pptx,zip,rar&quot;;&#125;s:19:&quot;upload_max_filesize&quot;;a:24:&#123;s:3:&quot;jpg&quot;;i:10485760;s:4:&quot;jpeg&quot;;i:10485760;s:3:&quot;png&quot;;i:10485760;s:3:&quot;gif&quot;;i:10485760;s:4:&quot;bmp4&quot;;i:10485760;s:3:&quot;mp4&quot;;i:10485760;s:3:&quot;avi&quot;;i:10485760;s:3:&quot;wmv&quot;;i:10485760;s:2:&quot;rm&quot;;i:10485760;s:4:&quot;rmvb&quot;;i:10485760;s:3:&quot;mkv&quot;;i:10485760;s:3:&quot;mp3&quot;;i:10485760;s:3:&quot;wma&quot;;i:10485760;s:3:&quot;wav&quot;;i:10485760;s:3:&quot;txt&quot;;i:10485760;s:3:&quot;pdf&quot;;i:10485760;s:3:&quot;doc&quot;;i:10485760;s:4:&quot;docx&quot;;i:10485760;s:3:&quot;xls&quot;;i:10485760;s:4:&quot;xlsx&quot;;i:10485760;s:3:&quot;ppt&quot;;i:10485760;s:4:&quot;pptx&quot;;i:10485760;s:3:&quot;zip&quot;;i:10485760;s:3:&quot;rar&quot;;i:10485760;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>经过反序列后的结果为,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/thinkcmf_upload_1.jpg" alt="-w473"><br>再回到之前获取允许上传后缀的地方, 就能够发现出问题了。<br>$allowed_exts=explode(‘,’,$upload_setting[$filetype])<br>upload_setting为反序列后的结果, $filetype是选择switch分支的时候硬编码传递进来的为file, 所以可以看到$upload_setting[‘file’]的结果依旧为一个数组,包含upload_max_filesize和extensions两个key, php explode的作用为把第二个参数通过字符串分割成数组, </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(explode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *str, *delim;</span><br><span class="line">	<span class="keyword">int</span> str_len = <span class="number">0</span>, delim_len = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">long</span> limit = LONG_MAX; <span class="comment">/* No limit */</span></span><br><span class="line">	zval zdelim, zstr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">&quot;ss|l&quot;</span>, &amp;delim, &amp;delim_len, &amp;str, &amp;str_len, &amp;limit) == FAILURE) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>通过zend_parse_parameters来接受传入函数的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_parse_parameters</span><span class="params">(<span class="keyword">int</span> num_args TSRMLS_DC, <span class="keyword">const</span> <span class="keyword">char</span> *type_spec, ...)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	va_list va;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">	RETURN_IF_ZERO_ARGS(num_args, type_spec, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	va_start(va, type_spec);</span><br><span class="line">	retval = zend_parse_va_args(num_args, type_spec, &amp;va, <span class="number">0</span> TSRMLS_CC);</span><br><span class="line">	va_end(va);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>zend_parse_va_args方法中, 首先获取到最少传入的参数个数, 和最多传入参数个数之后, 判断实际传入的参数数量是否在最少与最多的区间范围之内, 如果在这之内的话,继续调用zend_parse_arg方法来获取参数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zend_parse_arg(i+<span class="number">1</span>, arg, va, &amp;type_spec, quiet TSRMLS_CC) == FAILURE) &#123;</span><br><span class="line">	<span class="comment">/* clean up varargs array if it was used */</span></span><br><span class="line">	<span class="keyword">if</span> (varargs &amp;&amp; *varargs) &#123;</span><br><span class="line">		efree(*varargs);</span><br><span class="line">		*varargs = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zend_parse_arg</span><span class="params">(<span class="keyword">int</span> arg_num, zval **arg, va_list *va, <span class="keyword">const</span> <span class="keyword">char</span> **spec, <span class="keyword">int</span> quiet TSRMLS_DC)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *expected_type = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> *error = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> severity = E_WARNING;</span><br><span class="line"></span><br><span class="line">	expected_type = zend_parse_arg_impl(arg_num, arg, va, spec, &amp;error, &amp;severity TSRMLS_CC);</span><br><span class="line">	<span class="keyword">if</span> (expected_type) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!quiet &amp;&amp; (*expected_type || error)) &#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span> *space;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span> *class_name = get_active_class_name(&amp;space TSRMLS_CC);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (error) &#123;</span><br><span class="line">				zend_error(severity, <span class="string">&quot;%s%s%s() expects parameter %d %s&quot;</span>,</span><br><span class="line">						class_name, space, get_active_function_name(TSRMLS_C), arg_num, error);</span><br><span class="line">				efree(error);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				zend_error(severity, <span class="string">&quot;%s%s%s() expects parameter %d to be %s, %s given&quot;</span>,</span><br><span class="line">						class_name, space, get_active_function_name(TSRMLS_C), arg_num, expected_type,</span><br><span class="line">						zend_zval_type_name(*arg));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (severity != E_STRICT) &#123;</span><br><span class="line">			<span class="keyword">return</span> FAILURE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>severity 定义为了E_WARNING, 并且把severity的引用传递给了zend_parse_arg_impl方法, </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">zend_parse_arg_impl</span><span class="params">(<span class="keyword">int</span> arg_num, zval **arg, va_list *va, <span class="keyword">const</span> <span class="keyword">char</span> **spec, <span class="keyword">char</span> **error, <span class="keyword">int</span> *severity TSRMLS_DC)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *spec_walk = *spec;</span><br><span class="line">	<span class="keyword">char</span> c = *spec_walk++;</span><br><span class="line">	<span class="keyword">int</span> check_null = <span class="number">0</span>;</span><br><span class="line">.....................</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> **p = va_arg(*va, <span class="keyword">char</span> **);</span><br><span class="line">				<span class="keyword">int</span> *pl = va_arg(*va, <span class="keyword">int</span> *);</span><br><span class="line">				<span class="keyword">switch</span> (Z_TYPE_PP(arg)) &#123;</span><br><span class="line">					<span class="keyword">case</span> IS_NULL:</span><br><span class="line">						<span class="keyword">if</span> (check_null) &#123;</span><br><span class="line">							*p = <span class="literal">NULL</span>;</span><br><span class="line">							*pl = <span class="number">0</span>;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="comment">/* break omitted intentionally */</span></span><br><span class="line"></span><br><span class="line">					<span class="keyword">case</span> IS_STRING:</span><br><span class="line">					<span class="keyword">case</span> IS_LONG:</span><br><span class="line">					<span class="keyword">case</span> IS_DOUBLE:</span><br><span class="line">					<span class="keyword">case</span> IS_BOOL:</span><br><span class="line">						convert_to_string_ex(arg);</span><br><span class="line">						<span class="keyword">if</span> (UNEXPECTED(Z_ISREF_PP(arg) != <span class="number">0</span>)) &#123;</span><br><span class="line">							<span class="comment">/* it&#x27;s dangerous to return pointers to string</span></span><br><span class="line"><span class="comment">							   buffer of referenced variable, because it can</span></span><br><span class="line"><span class="comment">							   be clobbered throug magic callbacks */</span></span><br><span class="line">							SEPARATE_ZVAL(arg);</span><br><span class="line">						&#125;</span><br><span class="line">						*p = Z_STRVAL_PP(arg);</span><br><span class="line">						*pl = Z_STRLEN_PP(arg);</span><br><span class="line">						<span class="keyword">if</span> (c == <span class="string">&#x27;p&#x27;</span> &amp;&amp; CHECK_ZVAL_NULL_PATH(*arg)) &#123;</span><br><span class="line">							<span class="keyword">return</span> <span class="string">&quot;a valid path&quot;</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">case</span> IS_OBJECT:</span><br><span class="line">						<span class="keyword">if</span> (parse_arg_object_to_string(arg, p, pl, IS_STRING TSRMLS_CC) == SUCCESS) &#123;</span><br><span class="line">							<span class="keyword">if</span> (c == <span class="string">&#x27;p&#x27;</span> &amp;&amp; CHECK_ZVAL_NULL_PATH(*arg)) &#123;</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&quot;a valid path&quot;</span>;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">case</span> IS_ARRAY:</span><br><span class="line">					<span class="keyword">case</span> IS_RESOURCE:</span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line">						<span class="keyword">return</span> c == <span class="string">&#x27;s&#x27;</span> ? <span class="string">&quot;string&quot;</span> : <span class="string">&quot;a valid path&quot;</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>在处理字符串的这个分支下, 通过Z_TYPE_PP获取参数的数据类型, 如果参数是数组的话 直接进入default分支, return string。<br>不过在字符串分支下, 没有对传递进来的severity引用进行修改, 所以还是最开始的Warning, 然后进入zend_error方法 在severity为warning时, zend_error 并不会退出程序, 所以可以继续运行下去, 然后返回FAILURE意味着处理参数失败了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">&quot;ss|l&quot;</span>, &amp;delim, &amp;delim_len, &amp;str, &amp;str_len, &amp;limit) == FAILURE) &#123;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在处理参数失败了之后, 就直接return了。 这里在对return_value指针修改之前就返回了, 所以这里的return_value依旧为默认值。<br>则return_value为一个未初始化的zval结构体,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Variable information */</span></span><br><span class="line">	zvalue_value value;		<span class="comment">/* value */</span></span><br><span class="line">	zend_uint refcount__gc;</span><br><span class="line">	zend_uchar type;	<span class="comment">/* active type */</span></span><br><span class="line">	zend_uchar is_ref__gc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>typedef unsigned char zend_uchar;<br>当一个结构体未初始化时, 结构体内的每个属性根据自己的数据类型都会有自己的默认值, int/char都为0  指针为null之类的。<br>所以此时的return_value结构体的type属性为0, 0代表的为IS_NULL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define IS_NULL		0</span><br></pre></td></tr></table></figure>

<p>所以如果第二个参数数据类型为数组经过explode时会抛出warning并且返回null。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/thinkcmf_upload_2.jpg" alt="-w932"></p>
<p>所以此时的$allowed_exts为null, 然后加载到$config数组中, 然后传递给\Think\Upload的构造方法,</p>
<p>在/simplewind/Core/Library/Think/Upload.class.php中,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$config = <span class="keyword">array</span>(<span class="params"></span>), $driver = <span class="string">&#x27;&#x27;</span>, $driverConfig = <span class="literal">null</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* 获取配置 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;config   =   array_merge(<span class="keyword">$this</span>-&gt;config, $config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置上传驱动 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setDriver($driver, $driverConfig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调整配置，把字符串配置参数转换为数组 */</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;mimes&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_string(<span class="keyword">$this</span>-&gt;mimes)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;mimes&#x27;</span>] = explode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;mimes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;mimes&#x27;</span>] = array_map(<span class="string">&#x27;strtolower&#x27;</span>, <span class="keyword">$this</span>-&gt;mimes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;exts&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="keyword">$this</span>-&gt;exts))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;exts&#x27;</span>] = explode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;exts);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;exts&#x27;</span>] = array_map(<span class="string">&#x27;strtolower&#x27;</span>, <span class="keyword">$this</span>-&gt;exts);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造方法把传递进来的变量和默认的配置信息进行合并 赋值给config属性。</p>
<p>默认的配置信息为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> $config = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;mimes&#x27;</span>         =&gt;  <span class="keyword">array</span>(), <span class="comment">//允许上传的文件MiMe类型</span></span><br><span class="line">    <span class="string">&#x27;maxSize&#x27;</span>       =&gt;  <span class="number">0</span>, <span class="comment">//上传的文件大小限制 (0-不做限制)</span></span><br><span class="line">    <span class="string">&#x27;exts&#x27;</span>          =&gt;  <span class="keyword">array</span>(), <span class="comment">//允许上传的文件后缀</span></span><br><span class="line">    <span class="string">&#x27;autoSub&#x27;</span>       =&gt;  <span class="literal">true</span>, <span class="comment">//自动子目录保存文件</span></span><br><span class="line">    <span class="string">&#x27;subName&#x27;</span>       =&gt;  <span class="keyword">array</span>(<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;Y-m-d&#x27;</span>), <span class="comment">//子目录创建方式，[0]-函数名，[1]-参数，多个参数使用数组</span></span><br><span class="line">    <span class="string">&#x27;rootPath&#x27;</span>      =&gt;  <span class="string">&#x27;./Uploads/&#x27;</span>, <span class="comment">//保存根路径</span></span><br><span class="line">    <span class="string">&#x27;savePath&#x27;</span>      =&gt;  <span class="string">&#x27;&#x27;</span>, <span class="comment">//保存路径</span></span><br><span class="line">    <span class="string">&#x27;saveName&#x27;</span>      =&gt;  <span class="keyword">array</span>(<span class="string">&#x27;uniqid&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="comment">//上传文件命名规则，[0]-函数名，[1]-参数，多个参数使用数组</span></span><br><span class="line">    <span class="string">&#x27;saveExt&#x27;</span>       =&gt;  <span class="string">&#x27;&#x27;</span>, <span class="comment">//文件保存后缀，空则使用原后缀</span></span><br><span class="line">    <span class="string">&#x27;replace&#x27;</span>       =&gt;  <span class="literal">false</span>, <span class="comment">//存在同名是否覆盖</span></span><br><span class="line">    <span class="string">&#x27;hash&#x27;</span>          =&gt;  <span class="literal">true</span>, <span class="comment">//是否生成hash编码</span></span><br><span class="line">    <span class="string">&#x27;callback&#x27;</span>      =&gt;  <span class="literal">false</span>, <span class="comment">//检测文件是否存在回调，如果存在返回文件信息数组</span></span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span>        =&gt;  <span class="string">&#x27;&#x27;</span>, <span class="comment">// 文件上传驱动</span></span><br><span class="line">    <span class="string">&#x27;driverConfig&#x27;</span>  =&gt;  <span class="keyword">array</span>(), <span class="comment">// 上传驱动配置</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>If the input arrays have the same string keys, then the later value for that key will overwrite the previous one. If, however, the arrays contain numeric keys, the later value will not overwrite the original value, but will be appended.</p>
</blockquote>
<p>当两个进行合并的数组存在相同的key时, 第二个数组的key对应的value会覆盖掉第一个数组key的对应的value。<br>所以此时$this-&gt;config[‘ext’]从’’被覆盖为了null。</p>
<p>在经过构造方法把上传的配置信息配置好了之后, 就调用upload方法正式开始上传了。</p>
<p>upload方法中, 重点关注check方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过pathinfo获取文件的后缀名</span></span><br><span class="line">$file[<span class="string">&#x27;ext&#x27;</span>]    =   pathinfo($file[<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 文件上传检测 */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;check($file))&#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">..............</span><br><span class="line"></span><br><span class="line">$savename = <span class="keyword">$this</span>-&gt;getSaveName($file);</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span> == $savename)&#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $file[<span class="string">&#x27;savename&#x27;</span>] = $savename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 检测并创建子目录 */</span></span><br><span class="line">$subpath = <span class="keyword">$this</span>-&gt;getSubPath($file[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span> === $subpath)&#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $file[<span class="string">&#x27;savepath&#x27;</span>] = <span class="keyword">$this</span>-&gt;savePath . $subpath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">。。。。。。。。。。。</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 保存文件 并记录保存成功的文件 */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;uploader-&gt;save($file,<span class="keyword">$this</span>-&gt;replace)) &#123;</span><br><span class="line">    <span class="keyword">unset</span>($file[<span class="string">&#x27;error&#x27;</span>], $file[<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">    $info[$key] = $file;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;error = <span class="keyword">$this</span>-&gt;uploader-&gt;getError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">$file</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* 文件上传失败，捕获错误代码 */</span></span><br><span class="line">    <span class="keyword">if</span> ($file[<span class="string">&#x27;error&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error($file[<span class="string">&#x27;error&#x27;</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 无效上传 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($file[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;未知上传错误！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查是否合法上传 */</span></span><br><span class="line">    <span class="keyword">if</span> (!is_uploaded_file($file[<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;非法上传文件！&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查文件大小 */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checkSize($file[<span class="string">&#x27;size&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;上传文件大小不符！&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查文件Mime类型 */</span></span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span>FLASH上传的文件获取到的mime类型都为application/octet-stream</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checkMime($file[<span class="string">&#x27;type&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;上传文件MIME类型不允许！&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查文件后缀 */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checkExt($file[<span class="string">&#x27;ext&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;上传文件后缀不允许&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 通过检测 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只需要关注一下checkMime和checkExt方法,<br>checkMime方法中, 因为$this-&gt;config[‘mimes’]为array(),<br>empty(array()) 为true, 就直接返回true了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">checkMime</span>(<span class="params">$mime</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;mimes&#x27;</span>]) ? <span class="literal">true</span> : in_array(strtolower($mime), <span class="keyword">$this</span>-&gt;mimes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在checkExt方法中, 从刚才的分析可以知道$this-&gt;config[‘exts’]为null, empty(null)为true, 所以直接返回true了,不会再判断后缀了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">checkExt</span>(<span class="params">$ext</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;exts&#x27;</span>]) ? <span class="literal">true</span> : in_array(strtolower($ext), <span class="keyword">$this</span>-&gt;exts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在通过了check方法之后, 通过getSaveName生成最终保存的文件名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getSaveName</span>(<span class="params">$file</span>) </span>&#123;</span><br><span class="line">    $rule = <span class="keyword">$this</span>-&gt;saveName;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($rule)) &#123; <span class="comment">//保持文件名不变</span></span><br><span class="line">        <span class="comment">/* 解决pathinfo中文文件名BUG */</span></span><br><span class="line">        $filename = substr(pathinfo(<span class="string">&quot;_<span class="subst">&#123;$file[&#x27;name&#x27;]&#125;</span>&quot;</span>, PATHINFO_FILENAME), <span class="number">1</span>);</span><br><span class="line">        $savename = $filename;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $savename = <span class="keyword">$this</span>-&gt;getName($rule, $file[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($savename))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;文件命名规则错误！&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 文件保存后缀，支持强制更改文件后缀 */</span></span><br><span class="line">    $ext = <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;saveExt&#x27;</span>]) ? $file[<span class="string">&#x27;ext&#x27;</span>] : <span class="keyword">$this</span>-&gt;saveExt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $savename . <span class="string">&#x27;.&#x27;</span> . $ext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$rule为$config中的savename属性值 array(‘uniqid’,’’),</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params">$rule, $filename</span>)</span>&#123;</span><br><span class="line">    $name = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(is_array($rule))&#123; <span class="comment">//数组规则</span></span><br><span class="line">        $func     = $rule[<span class="number">0</span>];</span><br><span class="line">        $param    = (<span class="keyword">array</span>)$rule[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($param <span class="keyword">as</span> &amp;$value) &#123;</span><br><span class="line">           $value = str_replace(<span class="string">&#x27;__FILE__&#x27;</span>, $filename, $value);</span><br><span class="line">        &#125;</span><br><span class="line">        $name = call_user_func_array($func, $param);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_string($rule))&#123; <span class="comment">//字符串规则</span></span><br><span class="line">        <span class="keyword">if</span>(function_exists($rule))&#123;</span><br><span class="line">            $name = call_user_func($rule);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $name = $rule;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这里就是调用uniqid来生成文件名。<br>文件的后缀来自,<br><code>$ext = empty($this-&gt;config[&#39;saveExt&#39;]) ? $file[&#39;ext&#39;] : $this-&gt;saveExt;</code><br>在默认的上传配置信息中’saveExt’       =&gt;  ‘’,<br>saveExt为空, 所以这里不会强制修改文件的后缀而是直接使用的上传文件名的后缀。<br>生成好文件名之后, 就直接通过save方法进行上传了。<br>save方法中已经没有了任何后缀校验, 所以直接实现了任意文件上传。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">$file, $replace=<span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">    $filename = <span class="keyword">$this</span>-&gt;rootPath . $file[<span class="string">&#x27;savepath&#x27;</span>] . $file[<span class="string">&#x27;savename&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 不覆盖同名文件 */</span> </span><br><span class="line">    <span class="keyword">if</span> (!$replace &amp;&amp; is_file($filename)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;存在同名文件&#x27;</span> . $file[<span class="string">&#x27;savename&#x27;</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 移动文件 */</span></span><br><span class="line">    <span class="keyword">if</span> (!move_uploaded_file($file[<span class="string">&#x27;tmp_name&#x27;</span>], $filename)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;文件上传保存错误！&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上传完成之后, 最后还是直接输出了文件名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  	    <span class="keyword">if</span>(!<span class="keyword">empty</span>($first[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">  	        <span class="keyword">if</span>($filetype==<span class="string">&#x27;image&#x27;</span>)&#123;</span><br><span class="line">  	            $url=sp_get_image_preview_url($first[<span class="string">&#x27;savepath&#x27;</span>].$first[<span class="string">&#x27;savename&#x27;</span>]);</span><br><span class="line">  	        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	            $url=sp_get_file_download_url($first[<span class="string">&#x27;savepath&#x27;</span>].$first[<span class="string">&#x27;savename&#x27;</span>],<span class="number">3600</span>*<span class="number">24</span>*<span class="number">365</span>*<span class="number">50</span>);<span class="comment">//过期时间设置为50年</span></span><br><span class="line">  	        &#125;</span><br><span class="line">  	        </span><br><span class="line">  	    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	        $url = C(<span class="string">&quot;TMPL_PARSE_STRING.__UPLOAD__&quot;</span>).$first[<span class="string">&#x27;savepath&#x27;</span>].$first[<span class="string">&#x27;savename&#x27;</span>];</span><br><span class="line">  	    &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	$state = $upload-&gt;getError();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$response=<span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&quot;state&quot;</span> =&gt; $state,</span><br><span class="line">		<span class="string">&quot;url&quot;</span> =&gt; $url,</span><br><span class="line">		<span class="string">&quot;title&quot;</span> =&gt; $title,</span><br><span class="line">		<span class="string">&quot;original&quot;</span> =&gt;$oriName,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> json_encode($response);</span><br></pre></td></tr></table></figure>

<h2 id="0x03-测试"><a href="#0x03-测试" class="headerlink" title="0x03 测试"></a>0x03 测试</h2><p>注册好账户,登录之后,<br>直接调用这个控制器上传php文件即可。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/thinkcmf_upload_3.jpg" alt="-w1115"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/thinkcmf_upload_4.jpg" alt="-w767"></p>
<h2 id="0x04-修复"><a href="#0x04-修复" class="headerlink" title="0x04 修复"></a>0x04 修复</h2><p>/application/Asset/Controller/UeditorController.class.php<br>的upload方法中 将获取允许上传的文件后缀代码修改为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$allowed_exts=explode(<span class="string">&#x27;,&#x27;</span>, $upload_setting[$filetype][<span class="string">&#x27;extensions&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>获取这个数组的extensions的值, 再分割成数组即可。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>