<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JBOSS CVE-2017-12149 WAF绕过之旅 | 雨了个雨&#39;s blog</title>

  
  <meta name="author" content="雨了个雨">
  

  
  <meta name="description" content="Focus On Web Security">
  

  
  
  <meta name="keywords" content="Web">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="JBOSS CVE-2017-12149 WAF绕过之旅"/>

  <meta property="og:site_name" content="雨了个雨&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="雨了个雨&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">雨了个雨&#39;s blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/friends">Friends</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>JBOSS CVE-2017-12149 WAF绕过之旅</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/03/05/JBOSS-CVE-2017-12149-WAF绕过之旅/" rel="bookmark">
        <time class="entry-date published" datetime="2021-03-04T16:13:46.000Z">
          2021-03-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在近期做一次红蓝的时候，发现了一个目标存在CVE-2017-12149，也就是/invoker/readonly的反序列。虽然存在WAF对POST BODY反序列关键字有一定的检测，将请求类型修改为PUT后就绕过了，刚好/invoker/readonly路由是一个filter，所以请求模式并不重要(随意写XXX都可以)，也能够触发到，最终实现了RCE。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147752939265.jpg"><br>RCE后，在里面稍微折腾了一下就被防守方发现了。然后JBOSS就被下线系统，加强WAF不修漏洞，重新上线。<br>在重新上线后，再次对WAF测试了下，无论什么请求模式，只要请求/invoker/readonly 就会被拦截。/invoker/x/readonly、/invoker/x 不被拦截。当然也做了路径标准化，/invoker/x/../readonly、/invoker/./readonly，/invoker/readonlyxxxxx 都会被拦截。在折腾了一会发现绕不过去后，只能重新去看一下JBOSS代码，看看有没有什么其他方法来绕过。</p>
<h2 id="JBOSS-其他路由触发反序列"><a href="#JBOSS-其他路由触发反序列" class="headerlink" title="JBOSS 其他路由触发反序列"></a>JBOSS 其他路由触发反序列</h2><p>在看代码之前，最想知道的就是CVE-2017-12149除了/invoker/readonly有没有其他的触发路由，所以最开始看web.xml。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">   <span class="meta-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta">   <span class="meta-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- The http-invoker.sar/invoker.war web.xml descriptor</span></span><br><span class="line"><span class="comment">$Id: web.xml 96504 2009-11-18 19:01:09Z scott.stark@jboss.org $</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jboss.invocation.http.servlet.ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readOnlyContext<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>The top level JNDI context the filter will enforce</span><br><span class="line">         read-only access on. If specified only Context.lookup operations</span><br><span class="line">         will be allowed on this context. Another other operations or lookups</span><br><span class="line">         on any other context will fail. Do not associate this filter with the</span><br><span class="line">         JMXInvokerServlets if you want unrestricted access.</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>invokerName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=NamingBeanImpl<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>The JMX ObjectName of the naming service mbean</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ReadOnlyAccessFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/readonly/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ### Servlets --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EJBInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>The EJBInvokerServlet receives posts containing serlized</span><br><span class="line">        MarshalledInvocation objects that are routed to the EJB invoker given by</span><br><span class="line">        the invokerName init-param. The return content is a serialized</span><br><span class="line">        MarshalledValue containg the return value of the inovocation, or any</span><br><span class="line">        exception that may have been thrown.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.InvokerServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>invokerName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">description</span>&gt;</span>The RMI/HTTP EJB compatible invoker<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>The JMXInvokerServlet receives posts containing serlized</span><br><span class="line">       MarshalledInvocation objects that are routed to the invoker given by</span><br><span class="line">       the the MBean whose object name hash is specified by the</span><br><span class="line">       invocation.getObjectName() value. The return content is a serialized</span><br><span class="line">       MarshalledValue containg the return value of the inovocation, or any</span><br><span class="line">       exception that may have been thrown.</span><br><span class="line">       <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.InvokerServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>A servlet that exposes the JBoss JNDI Naming service stub</span><br><span class="line">        through http. The return content is a serialized</span><br><span class="line">        MarshalledValue containg the org.jnp.interfaces.Naming stub. This</span><br><span class="line">        configuration handles requests for the standard JNDI naming service.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.NamingFactoryServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>namingProxyMBean<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http,target=Naming<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>proxyAttribute<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>Proxy<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ReadOnlyJNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">description</span>&gt;</span>A servlet that exposes the JBoss JNDI Naming service stub</span><br><span class="line">       through http, but only for a single read-only context. The return content</span><br><span class="line">       is a serialized MarshalledValue containg the org.jnp.interfaces.Naming</span><br><span class="line">       stub.</span><br><span class="line">       <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.jboss.invocation.http.servlet.NamingFactoryServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>namingProxyMBean<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>jboss:service=invoker,type=http,target=Naming,readonly=true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>proxyAttribute<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>Proxy<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ### Servlet Mappings --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/JNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- A mapping for the NamingFactoryServlet that only allows invocations</span></span><br><span class="line"><span class="comment">    of lookups under a read-only context. This is enforced by the</span></span><br><span class="line"><span class="comment">    ReadOnlyAccessFilter</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ReadOnlyJNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ReadOnlyJNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EJBInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/EJBInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- A mapping for the JMXInvokerServlet that only allows invocations</span></span><br><span class="line"><span class="comment">    of lookups under a read-only context. This is enforced by the</span></span><br><span class="line"><span class="comment">    ReadOnlyAccessFilter</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/readonly/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Alternate mappings that place the servlets under the restricted</span></span><br><span class="line"><span class="comment">    path to required authentication for access. Remove the unsecure mappings</span></span><br><span class="line"><span class="comment">    if only authenticated users should be allowed.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JNDIFactory<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/JNDIFactory/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>JMXInvokerServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/JMXInvokerServlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- An example security constraint that restricts access to the HTTP invoker</span></span><br><span class="line"><span class="comment">   to users with the role HttpInvoker Edit the roles to what you want and</span></span><br><span class="line"><span class="comment">   configure the WEB-INF/jboss-web.xml/security-domain element to reference</span></span><br><span class="line"><span class="comment">   the security domain you want.</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>HttpInvokers<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">description</span>&gt;</span>An example security config that only allows users with the</span><br><span class="line">            role HttpInvoker to access the HTTP invoker servlets</span><br><span class="line">         <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>BASIC<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>JBoss HTTP Invoker<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">security-role</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">security-role</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以发现存在以下路由，<br>/invoker/JNDIFactory<br>/invoker/ReadOnlyJNDIFactory<br>/invoker/EJBInvokerServlet<br>/invoker/JMXInvokerServlet<br>/invoker/readonly/JMXInvokerServlet<br>/invoker/restricted/JNDIFactory<br>/invoker/restricted/JMXInvokerServlet</p>
<p>包含JNDIFactory的路由，都是触发的org.jboss.invocation.http.servlet.NamingFactoryServlet，该Servlet没有反序列，直接抛弃。<br>/invoker/EJBInvokerServlet<br>/invoker/JMXInvokerServlet<br>/invoker/readonly/JMXInvokerServlet # 存在/invoker/readonly 也直接被拦截<br>/invoker/restricted/JMXInvokerServlet<br>以上Servlet都能够触发到反序列，一个一个测试，发现竟然只有最后一个没被拦截。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147769233620.jpg"><br>但是最后一个路由访问是返回401， 在web.xml中有对/restricted/路由做验证，必须在登录之后才能触发，看起来是没毛用了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>HttpInvokers<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>An example security config that only allows users with the</span><br><span class="line">         role HttpInvoker to access the HTTP invoker servlets</span><br><span class="line">      <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/restricted/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>BASIC<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>JBoss HTTP Invoker<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">security-role</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>HttpInvoker<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-role</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在网上流传的CVE-2017-12149修复方法中，其中一个方法就是修改security-constraint的url-pattern为/*，这样/invoker/readonly也需要在登录后才能够使用，缓解了漏洞。</p>
<p><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147772150121.jpg"></p>
<p>在来仔细看一下JBOSS的security-constraint，很明显能够看出只对GET/POST请求模式进行验证，如果非GET/POST那么还是能够访问到/invoker/restricted/JMXInvokerServlet，但是因为这个路由是Servlet不是Filter，所以不能够随意修改请求模式，请求模式必须是RFC 2068里所定义的GET/POST/PUT/DELETE等。<br>再来看一下这个Servlet的代码，如果实现了doPut等其他方法并且存在反序列漏洞，那么还是可以绕过这个认证实现反序列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> trace = log.isTraceEnabled();</span><br><span class="line">        <span class="keyword">if</span> (trace) &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;processRequest, ContentLength: &quot;</span> + request.getContentLength());</span><br><span class="line">            log.trace(<span class="string">&quot;processRequest, ContentType: &quot;</span> + request.getContentType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Boolean returnValueAsAttribute = (Boolean)request.getAttribute(<span class="string">&quot;returnValueAsAttribute&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setContentType(RESPONSE_CONTENT_TYPE);</span><br><span class="line">            MarshalledInvocation mi = (MarshalledInvocation)request.getAttribute(<span class="string">&quot;MarshalledInvocation&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (mi == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ServletInputStream sis = request.getInputStream();</span><br><span class="line">                ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(sis);</span><br><span class="line">                mi = (MarshalledInvocation)ois.readObject();</span><br><span class="line">                ois.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mi.getPrincipal() == <span class="keyword">null</span> &amp;&amp; mi.getCredential() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mi.setPrincipal(InvokerServlet.GetPrincipalAction.getPrincipal());</span><br><span class="line">                mi.setCredential(InvokerServlet.GetCredentialAction.getCredential());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object[] params = <span class="keyword">new</span> Object[]&#123;mi&#125;;</span><br><span class="line">            String[] sig = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;org.jboss.invocation.Invocation&quot;</span>&#125;;</span><br><span class="line">            ObjectName invokerName = <span class="keyword">this</span>.localInvokerName;</span><br><span class="line">            <span class="keyword">if</span> (invokerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Integer nameHash = (Integer)mi.getObjectName();</span><br><span class="line">                invokerName = (ObjectName)Registry.lookup(nameHash);</span><br><span class="line">                <span class="keyword">if</span> (invokerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">&quot;Failed to find invoker name for hash(&quot;</span> + nameHash + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object value = <span class="keyword">this</span>.mbeanServer.invoke(invokerName, <span class="string">&quot;invoke&quot;</span>, params, sig);</span><br><span class="line">            <span class="keyword">if</span> (returnValueAsAttribute != <span class="keyword">null</span> &amp;&amp; returnValueAsAttribute) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">&quot;returnValue&quot;</span>, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MarshalledValue mv = <span class="keyword">new</span> MarshalledValue(value);</span><br><span class="line">                ServletOutputStream sos = response.getOutputStream();</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(sos);</span><br><span class="line">                oos.writeObject(mv);</span><br><span class="line">                oos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var13) &#123;</span><br><span class="line">            Throwable t = JMXExceptionDecoder.decode(var13);</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">                InvocationTargetException ite = (InvocationTargetException)t;</span><br><span class="line">                t = ite.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            InvocationException appException = <span class="keyword">new</span> InvocationException(t);</span><br><span class="line">            <span class="keyword">if</span> (returnValueAsAttribute != <span class="keyword">null</span> &amp;&amp; returnValueAsAttribute) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Invoke threw exception&quot;</span>, t);</span><br><span class="line">                request.setAttribute(<span class="string">&quot;returnValue&quot;</span>, appException);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Invoke threw exception, and response is already committed&quot;</span>, t);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                response.resetBuffer();</span><br><span class="line">                MarshalledValue mv = <span class="keyword">new</span> MarshalledValue(appException);</span><br><span class="line">                ServletOutputStream sos = response.getOutputStream();</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(sos);</span><br><span class="line">                oos.writeObject(mv);</span><br><span class="line">                oos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.processRequest(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.processRequest(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>很可惜在该Servlet中只实现了doGet和doPost方法，所以不能像预想的PUT绕过。不过观察代码发现反序列在processRequest方法中触发，在doGet和doPost中都调用了processRequest方法。这就有点意思了，GET也能触发反序列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">&quot;HEAD&quot;</span>)) &#123;</span><br><span class="line">            lastModified = <span class="keyword">this</span>.getLastModified(req);</span><br><span class="line">            <span class="keyword">this</span>.maybeSetLastModified(resp, lastModified);</span><br><span class="line">            <span class="keyword">this</span>.doHead(req, resp);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doHead</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DispatcherType.INCLUDE.equals(req.getDispatcherType())) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doGet(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        NoBodyResponse response = <span class="keyword">new</span> NoBodyResponse(resp);</span><br><span class="line">        <span class="keyword">this</span>.doGet(req, response);</span><br><span class="line">        response.setContentLength();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>虽然GET也需要认证，但是给Servlet发送Head请求时触发的还是Servlet的doGet方法，只是NoBodyResponse，同时security-constraint中没有限制HEAD方法，所以可以绕过登录实现反序列。同时因为Head是NobodyResponse，所以需要直接回显命令结果的话，可以将执行结果添加到Response Headers中。<br><img src="https://yulegeyublog.oss-cn-beijing.aliyuncs.com/2021/03/03/16147805940657.jpg"></p>
<p>最终通过该方法绕过了WAF :)</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Web/">Web</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 雨了个雨
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>